<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Time Tracker Dashboard v0.8.0_beta</title>
    <!-- 
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║                           TIME TRACKER DASHBOARD                            ║
    ║                                v0.8.0_beta                                  ║
    ║                                                                              ║
    ║  Copyright (c) 2024 Time Tracker Dashboard. All rights reserved.            ║
    ║                                                                              ║
    ║  This software is protected by copyright law and international treaties.    ║
    ║  Unauthorized reproduction, distribution, or modification is strictly       ║
    ║  prohibited and may result in severe civil and criminal penalties.          ║
    ║                                                                              ║
    ║  For licensing information, please contact the author.                       ║
    ║                                                                              ║
    ║  ⚠️  WARNING: This code is protected and monitored. Any attempt to          ║
    ║      reverse engineer, decompile, or modify this software without           ║
    ║      authorization is illegal and will be prosecuted to the full            ║
    ║      extent of the law.                                                     ║
    ╚══════════════════════════════════════════════════════════════════════════════╝
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <script>
      // ═══════════════════════════════════════════════════════════════════════════════
      // PROTECTION CONTROL - ИЗМЕНЯЙТЕ ТОЛЬКО ЭТУ СТРОКУ ДЛЯ УПРАВЛЕНИЯ ЗАЩИТОЙ
      // ═══════════════════════════════════════════════════════════════════════════════
      const PROTECTION_ENABLED = true // true = включено, false = отключено

      // ═══════════════════════════════════════════════════════════════════════════════
      // PROTECTION BLOCK 1: ОСНОВНАЯ ЗАЩИТА
      // ═══════════════════════════════════════════════════════════════════════════════
      if (PROTECTION_ENABLED) {
        ;(function () {
          'use strict'

          // Disable right-click
          document.addEventListener('contextmenu', function (e) {
            e.preventDefault()
            return false
          })

          // Disable F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+Shift+C, Ctrl+U
          document.addEventListener('keydown', function (e) {
            if (
              e.key === 'F12' ||
              (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) ||
              (e.ctrlKey && e.key === 'U')
            ) {
              e.preventDefault()
              return false
            }
          })

          // Anti-debugging
          let devtools = { open: false, orientation: null }
          setInterval(function () {
            if (
              window.outerHeight - window.innerHeight > 200 ||
              window.outerWidth - window.innerWidth > 200
            ) {
              if (!devtools.open) {
                devtools.open = true
                console.clear()
                console.log(
                  '%c⚠️ Developer tools detected!',
                  'color: red; font-size: 20px; font-weight: bold;'
                )
                console.log(
                  '%cThis application is protected. Please close developer tools.',
                  'color: red; font-size: 14px;'
                )
              }
            }
          }, 500)

          // Disable text selection
          document.addEventListener('selectstart', function (e) {
            e.preventDefault()
            return false
          })

          // Disable drag and drop
          document.addEventListener('dragstart', function (e) {
            e.preventDefault()
            return false
          })

          // Console warnings
          console.warn('%cСТОП!', 'color: red; font-size: 50px; font-weight: bold;')
          console.warn(
            '%cЭто браузерная функция, предназначенная для разработчиков.',
            'color: red; font-size: 16px;'
          )
          console.warn(
            '%cЕсли кто-то сказал вам скопировать и вставить что-то здесь, чтобы включить функцию или взломать чужой аккаунт, это мошенничество.',
            'color: red; font-size: 16px;'
          )
          console.warn(
            '%cЭто позволит им получить доступ к вашему аккаунту.',
            'color: red; font-size: 16px;'
          )

          // Console protection - ИСПРАВЛЕНО: избегаем рекурсии
          const originalLog = console.log
          const originalWarn = console.warn
          const originalError = console.error

          // Безопасная защита консоли без рекурсии
          console.log = function () {
            originalLog(
              '%c⚠️ This application is protected.',
              'color: red; font-size: 16px; font-weight: bold;'
            )
          }

          console.warn = function () {
            originalWarn(
              '%c⚠️ This application is protected.',
              'color: red; font-size: 16px; font-weight: bold;'
            )
          }

          console.error = function () {
            originalError(
              '%c⚠️ This application is protected.',
              'color: red; font-size: 16px; font-weight: bold;'
            )
          }
        })()
      }

      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
          },
        },
      }
    </script>
    <!-- React Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    <!-- Charting and Sound Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/Recharts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
      /* CSS Variables for Animations */
      :root {
        --animations-enabled: 1;
        --animation-duration-fast: calc(0.2s * var(--animations-enabled));
        --animation-duration-normal: calc(0.3s * var(--animations-enabled));
        --animation-duration-slow: calc(0.5s * var(--animations-enabled));
        --animation-duration-main: calc(0.4s * var(--animations-enabled));
        --animation-duration-new: calc(0.6s * var(--animations-enabled));
        --animation-duration-stagger: calc(0.3s * var(--animations-enabled));
        --animation-easing: cubic-bezier(0.4, 0, 0.2, 1);
        /* Material Design */
        --animation-easing-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
        /* Bounce */
      }

      /* Disable animations for users who prefer reduced motion */
      @media (prefers-reduced-motion: reduce) {
        :root {
          --animations-enabled: 0;
        }
      }

      /* Отключение анимаций при animationsEnabled: false */
      .animations-disabled {
        --animations-enabled: 0;
      }

      .animations-disabled * {
        animation-duration: 0s !important;
        transition-duration: 0s !important;
      }

      /* === АНИМАЦИИ ВЫСОКОГО ПРИОРИТЕТА === */

      /* 1. Анимации кнопок и интерактивных элементов */
      @keyframes buttonPress {
        0% {
          transform: scale(1);
        }

        50% {
          transform: scale(0.95);
        }

        100% {
          transform: scale(1);
        }
      }

      @keyframes buttonHover {
        0% {
          transform: translateY(0);
        }

        100% {
          transform: translateY(-2px);
        }
      }

      .button-animated {
        transition: all var(--animation-duration-fast) var(--animation-easing);
        transform: translateY(0);
      }

      .button-animated:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .button-animated:active {
        animation: buttonPress var(--animation-duration-fast) var(--animation-easing);
      }

      /* Специальные анимации для кнопок массовых операций */

      /* Анимация для кнопки "Изменить категорию" - морфинг и деформация */
      @keyframes categoryMorph {
        0% {
          transform: scale(1) rotate(0deg);
        }

        25% {
          transform: scale(1.05) rotate(-2deg) skewX(2deg);
        }

        50% {
          transform: scale(1.1) rotate(2deg) skewX(-2deg);
        }

        75% {
          transform: scale(1.05) rotate(-1deg) skewX(1deg);
        }

        100% {
          transform: scale(1) rotate(0deg);
        }
      }

      .button-bulk-category {
        transition: all var(--animation-duration-fast) var(--animation-easing);
      }

      .button-bulk-category:hover {
        animation: categoryMorph 0.6s var(--animation-easing);
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 6px 16px rgba(34, 197, 94, 0.4);
      }

      .button-bulk-category:active {
        animation: categoryMorph 0.6s var(--animation-easing);
      }

      /* Анимация для кнопки "Экспорт" - движение вверх (как экспорт данных) */
      @keyframes exportUpward {
        0% {
          transform: translateY(0) scale(1);
        }

        50% {
          transform: translateY(-8px) scale(1.1);
        }

        100% {
          transform: translateY(-4px) scale(1.05);
        }
      }

      .button-bulk-export {
        transition: all var(--animation-duration-fast) var(--animation-easing);
      }

      .button-bulk-export:hover {
        animation: exportUpward 0.5s var(--animation-easing);
        transform: translateY(-4px) scale(1.08);
        box-shadow: 0 8px 20px rgba(147, 51, 234, 0.4);
      }

      .button-bulk-export:active {
        animation: exportUpward 0.5s var(--animation-easing);
      }

      /* Анимация для кнопки "Удалить" - быстрое увеличение-уменьшение (предупреждение) */
      @keyframes deleteWarning {
        0% {
          transform: scale(1);
        }

        20% {
          transform: scale(1.3);
        }

        40% {
          transform: scale(0.9);
        }

        60% {
          transform: scale(1.2);
        }

        80% {
          transform: scale(0.95);
        }

        100% {
          transform: scale(1);
        }
      }

      .button-bulk-delete {
        transition: all var(--animation-duration-fast) var(--animation-easing);
      }

      .button-bulk-delete:hover {
        animation: deleteWarning 0.4s var(--animation-easing);
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
      }

      .button-bulk-delete:active {
        animation: deleteWarning 0.4s var(--animation-easing);
      }

      /* Анимации для кнопок отмены/повтора */

      /* Анимация для кнопки "Отменить" - движение назад */
      @keyframes undoBackward {
        0% {
          transform: translateX(0) scale(1);
        }

        50% {
          transform: translateX(-4px) scale(1.05);
        }

        100% {
          transform: translateX(-2px) scale(1.02);
        }
      }

      .button-undo {
        transition: all var(--animation-duration-fast) var(--animation-easing);
      }

      .button-undo:hover {
        animation: undoBackward 0.4s var(--animation-easing);
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }

      .button-undo:active {
        animation: undoBackward 0.4s var(--animation-easing);
      }

      /* Анимация для кнопки "Повторить" - движение вперед */
      @keyframes redoForward {
        0% {
          transform: translateX(0) scale(1);
        }

        50% {
          transform: translateX(4px) scale(1.05);
        }

        100% {
          transform: translateX(2px) scale(1.02);
        }
      }

      .button-redo {
        transition: all var(--animation-duration-fast) var(--animation-easing);
      }

      .button-redo:hover {
        animation: redoForward 0.4s var(--animation-easing);
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
      }

      .button-redo:active {
        animation: redoForward 0.4s var(--animation-easing);
      }

      /* 2. Анимации модальных окон */
      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: scale(0.9) translateY(-20px);
        }

        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      /* Анимация исчезновения модального окна */
      @keyframes modalSlideOut {
        from {
          opacity: 1;
          transform: scale(1) translateY(0);
        }

        to {
          opacity: 0;
          transform: scale(0.9) translateY(-20px);
        }
      }

      @keyframes backdropFadeIn {
        from {
          opacity: 0;
        }

        to {
          opacity: 1;
        }
      }

      /* Анимация исчезновения фона */
      @keyframes backdropFadeOut {
        from {
          opacity: 1;
        }

        to {
          opacity: 0;
        }
      }

      .modal-backdrop-animated {
        animation: backdropFadeIn var(--animation-duration-normal) var(--animation-easing);
      }

      .modal-backdrop-animated.closing {
        animation: backdropFadeOut var(--animation-duration-normal) var(--animation-easing) forwards;
      }

      .modal-content-animated {
        animation: modalSlideIn var(--animation-duration-normal) var(--animation-easing);
      }

      .modal-content-animated.closing {
        animation: modalSlideOut var(--animation-duration-normal) var(--animation-easing) forwards;
      }

      /* 3. Анимации появления/исчезновения записей */

      /* Основная анимация: Slide from top + Fade */
      @keyframes slideInFromTop {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Для новых записей: Scale + Fade */
      @keyframes scaleInBounce {
        from {
          opacity: 0;
          transform: scale(0.8);
        }

        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      /* Для массовых операций: Stagger */
      @keyframes staggerIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Анимация исчезновения записи */
      @keyframes slideOutToRight {
        from {
          opacity: 1;
          transform: translateX(0);
        }

        to {
          opacity: 0;
          transform: translateX(100%);
        }
      }

      /* Классы для анимации записей */

      .entry-item-animated.animate {
        animation: slideInFromTop var(--animation-duration-main) var(--animation-easing);
      }

      .entry-item-new {
        animation: scaleInBounce var(--animation-duration-new) var(--animation-easing-bounce);
        background-color: rgba(34, 197, 94, 0.1) !important;
        border: 1px solid rgba(34, 197, 94, 0.3) !important;
      }

      /* Задержки для новых записей */
      .entry-item-new:nth-child(1) {
        animation-delay: 0ms;
      }

      .entry-item-new:nth-child(2) {
        animation-delay: 50ms;
      }

      .entry-item-new:nth-child(3) {
        animation-delay: 100ms;
      }

      .entry-item-new:nth-child(4) {
        animation-delay: 150ms;
      }

      .entry-item-new:nth-child(5) {
        animation-delay: 200ms;
      }

      .entry-item-new:nth-child(6) {
        animation-delay: 250ms;
      }

      .entry-item-new:nth-child(7) {
        animation-delay: 300ms;
      }

      .entry-item-new:nth-child(8) {
        animation-delay: 350ms;
      }

      .entry-item-new:nth-child(9) {
        animation-delay: 400ms;
      }

      .entry-item-new:nth-child(10) {
        animation-delay: 450ms;
      }

      .entry-item-removing {
        animation: slideOutToRight var(--animation-duration-normal) var(--animation-easing) forwards;
      }

      /* Анимации для спойлеров (детали) */
      .spoiler-entries .entry-item-animated.animate {
        animation: staggerIn calc(var(--animation-duration-stagger) * 2) var(--animation-easing);
      }

      /* Staggered анимации для записей в спойлерах */
      .spoiler-entries .entry-item-animated.animate:nth-child(1) {
        animation-delay: 200ms;
      }

      .spoiler-entries .entry-item-animated.animate:nth-child(2) {
        animation-delay: 250ms;
      }

      .spoiler-entries .entry-item-animated.animate:nth-child(3) {
        animation-delay: 300ms;
      }

      .spoiler-entries .entry-item-animated.animate:nth-child(4) {
        animation-delay: 350ms;
      }

      .spoiler-entries .entry-item-animated.animate:nth-child(5) {
        animation-delay: 400ms;
      }

      .spoiler-entries .entry-item-animated.animate:nth-child(6) {
        animation-delay: 450ms;
      }

      .spoiler-entries .entry-item-animated.animate:nth-child(7) {
        animation-delay: 500ms;
      }

      .spoiler-entries .entry-item-animated.animate:nth-child(8) {
        animation-delay: 550ms;
      }

      .spoiler-entries .entry-item-animated.animate:nth-child(9) {
        animation-delay: 600ms;
      }

      .spoiler-entries .entry-item-animated.animate:nth-child(10) {
        animation-delay: 650ms;
      }

      /* Hover эффекты для записей */
      .entry-item-animated:hover {
        transform: translateY(-2px);
        transition: transform 0.2s ease;
      }

      /* Click эффекты для записей */
      .entry-item-animated:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
      }

      /* Анимации для спойлеров (детали) */
      details {
        transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      }

      details[open] {
        animation: spoilerOpen 1.2s cubic-bezier(0.4, 0, 0.2, 1);
      }

      @keyframes spoilerOpen {
        0% {
          opacity: 0;
          transform: translateY(-15px);
        }

        50% {
          opacity: 0.7;
          transform: translateY(-5px);
        }

        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Анимации загрузки */
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }

        50% {
          opacity: 0.5;
        }
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }

        to {
          transform: rotate(360deg);
        }
      }

      @keyframes shimmer {
        0% {
          background-position: -200px 0;
        }

        100% {
          background-position: calc(200px + 100%) 0;
        }
      }

      .loading-spinner {
        animation: spin 1s linear infinite;
      }

      .loading-pulse {
        animation: pulse 1.5s ease-in-out infinite;
      }

      .loading-skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200px 100%;
        animation: shimmer 1.5s infinite;
      }

      /* Анимации переходов между представлениями */
      @keyframes subtleFadeIn {
        from {
          opacity: 0;
        }

        to {
          opacity: 1;
        }
      }

      @keyframes subtleFadeOut {
        from {
          opacity: 1;
        }

        to {
          opacity: 0;
        }
      }

      @keyframes gentleScaleIn {
        from {
          transform: scale(0.95);
          opacity: 0;
        }

        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      @keyframes gentleScaleOut {
        from {
          transform: scale(1);
          opacity: 1;
        }

        to {
          transform: scale(0.95);
          opacity: 0;
        }
      }

      @keyframes gentleFadeScaleIn {
        from {
          opacity: 0;
          transform: scale(0.98);
        }

        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      /* Анимации уведомлений */
      @keyframes toastSlideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }

        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes toastSlideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }

        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      @keyframes toastBounceIn {
        0% {
          transform: scale(0.3);
          opacity: 0;
        }

        50% {
          transform: scale(1.05);
        }

        70% {
          transform: scale(0.9);
        }

        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .toast-notification {
        animation: toastSlideIn 0.3s var(--animation-easing);
      }

      .toast-notification.removing {
        animation: toastSlideOut 0.3s var(--animation-easing) forwards;
      }

      /* Тестовая анимация для проверки работы CSS */
      @keyframes testPulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 1;
        }

        50% {
          transform: scale(1.02);
          opacity: 0.8;
        }
      }

      .test-animation {
        animation: testPulse 2s ease-in-out infinite;
      }

      /* ПРОСТАЯ ТЕСТОВАЯ АНИМАЦИЯ */
      @keyframes testFade {
        from {
          opacity: 0;
          transform: translateY(20px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .test-fade {
        animation: testFade 1s ease-out;
      }

      /* Cascade Drop Animation - классический каскад падающих карточек */
      @keyframes cascadeDrop {
        0% {
          opacity: 0;
          transform: translateY(-50px) scale(0.9);
        }

        60% {
          opacity: 0.8;
          transform: translateY(5px) scale(1.02);
        }

        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .simple-slide {
        animation: cascadeDrop 0.6s cubic-bezier(0.4, 0, 0.2, 1) !important;
      }

      .cascade-drop {
        animation: cascadeDrop 0.6s cubic-bezier(0.4, 0, 0.2, 1) !important;
      }

      /* Анимации для модальных окон */
      @keyframes modalFadeIn {
        0% {
          opacity: 0;
          transform: scale(0.9) translateY(-20px);
        }

        100% {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      @keyframes modalResize {
        0% {
          transform: scale(1);
        }

        50% {
          transform: scale(0.98);
        }

        100% {
          transform: scale(1);
        }
      }

      @keyframes modalFadeOut {
        0% {
          opacity: 1;
          transform: scale(1) translateY(0);
        }

        100% {
          opacity: 0;
          transform: scale(0.9) translateY(-20px);
        }
      }

      @keyframes backdropFadeIn {
        from {
          opacity: 0;
        }

        to {
          opacity: 1;
        }
      }

      @keyframes backdropFadeOut {
        from {
          opacity: 1;
        }

        to {
          opacity: 0;
        }
      }

      /* Анимации для выпадающих списков и меню */
      @keyframes dropdownSlideIn {
        0% {
          opacity: 0;
          transform: translateY(-4px);
        }

        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes dropdownSlideOut {
        0% {
          opacity: 1;
          transform: translateY(0);
        }

        100% {
          opacity: 0;
          transform: translateY(-4px);
        }
      }

      @keyframes dropdownSlideInUp {
        0% {
          opacity: 0;
          transform: translateY(4px);
        }

        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes dropdownSlideOutDown {
        0% {
          opacity: 1;
          transform: translateY(0);
        }

        100% {
          opacity: 0;
          transform: translateY(4px);
        }
      }

      @keyframes menuItemSlideIn {
        0% {
          opacity: 0;
          transform: translateX(-5px);
        }

        100% {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes menuItemHover {
        0% {
          transform: translateX(0);
        }

        100% {
          transform: translateX(2px);
        }
      }

      /* Классы для анимации модальных окон */
      .modal-enter {
        animation: modalFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .modal-exit {
        animation: modalFadeOut 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .animate-fadeIn {
        animation: subtleFadeIn 0.3s ease-out;
      }

      .modal-resize {
        animation: modalResize 0.4s ease-in-out;
      }

      .modal-backdrop-enter {
        animation: backdropFadeIn 0.3s ease-out;
      }

      .modal-backdrop-exit {
        animation: backdropFadeOut 0.2s ease-in;
      }

      /* Классы для анимации выпадающих списков */
      .dropdown-enter {
        animation: dropdownSlideIn var(--animation-duration-fast) ease-out;
      }

      .dropdown-exit {
        animation: dropdownSlideOut var(--animation-duration-fast) ease-in;
      }

      .dropdown-enter-up {
        animation: dropdownSlideInUp var(--animation-duration-fast) ease-out;
      }

      .dropdown-exit-down {
        animation: dropdownSlideOutDown var(--animation-duration-fast) ease-in;
      }

      .menu-item-hover {
        transition: transform 0.15s ease;
      }

      .menu-item-hover:hover {
        transform: translateX(2px);
      }

      /* Специальные классы для Portal компонентов */
      .dropdown-portal-enter {
        animation: dropdownSlideIn var(--animation-duration-fast) ease-out;
      }

      .dropdown-portal-exit {
        animation: dropdownSlideOut var(--animation-duration-fast) ease-in;
      }

      .dropdown-portal-enter-up {
        animation: dropdownSlideInUp var(--animation-duration-fast) ease-out;
      }

      .dropdown-portal-exit-down {
        animation: dropdownSlideOutDown var(--animation-duration-fast) ease-in;
      }

      /* Transition-based dropdown panels (always mounted) */
      .dropdown-panel {
        opacity: 0;
        transform: translateY(-4px);
        transition:
          opacity var(--animation-duration-fast) ease-out,
          transform var(--animation-duration-fast) ease-out;
        pointer-events: none;
      }

      .dropdown-panel[data-open='true'] {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }

      .dropdown-panel[data-open-up='true'] {
        transform: translateY(0);
      }

      .dropdown-panel[data-open-up='false'] {
        transform: translateY(4px);
      }

      /* Disable transitions when animations are disabled */
      .animations-disabled .dropdown-panel {
        transition: none !important;
      }

      .animations-disabled .dropdown-panel[data-open='true'] {
        opacity: 1 !important;
        transform: translateY(0) !important;
        pointer-events: auto !important;
      }

      .animations-disabled .dropdown-panel[data-open='false'] {
        opacity: 0 !important;
        pointer-events: none !important;
      }

      /* Исправление для grid режима */
      .view-content.grid {
        display: grid !important;
        grid-template-columns: repeat(1, 1fr) !important;
        overflow-x: hidden !important;
        width: 100% !important;
      }

      @media (min-width: 768px) {
        .view-content.grid {
          grid-template-columns: repeat(2, 1fr) !important;
        }
      }

      @media (min-width: 1024px) {
        .view-content.grid {
          grid-template-columns: repeat(3, 1fr) !important;
        }
      }

      /* Предотвращение горизонтальной прокрутки для карточек в grid */
      .view-content.grid > div {
        min-width: 0 !important;
        max-width: 100% !important;
        overflow: hidden !important;
      }

      body {
        font-family: 'Inter', sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }

      .dark .custom-scrollbar::-webkit-scrollbar-track {
        background: #1f2937;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 4px;
      }

      .dark .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #4b5563;
      }

      .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #6b7280;
      }

      .glass-effect {
        background-color: rgba(17, 24, 39, 0.5);
        -webkit-backdrop-filter: blur(16px);
        backdrop-filter: blur(16px);
        will-change: transform;
      }

      html.light .glass-effect {
        background-color: rgba(255, 255, 255, 0.7);
      }

      .text-shadow {
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      /* --- Timeline Styles v2.0 --- */
      .timeline::before {
        content: '';
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 1px;
        height: 100%;
        background: linear-gradient(to bottom, transparent, #4c1d95, transparent);
        will-change: transform;
      }

      .timeline-dot {
        position: absolute;
        top: 28px;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 1.25rem;
        height: 1.25rem;
        border-radius: 9999px;
        background-color: #3b82f6;
        /* Изменен на синий */
        box-shadow: 0 0 12px 2px rgba(59, 130, 246, 0.5);
        /* Изменен на более мягкое синее свечение */
        will-change: transform;
      }

      .timeline-item:nth-child(even) .timeline-main,
      .timeline-item:nth-child(odd) .timeline-info {
        margin-left: calc(50% + 3rem);
      }

      .timeline-item:nth-child(odd) .timeline-main,
      .timeline-item:nth-child(even) .timeline-info {
        margin-right: calc(50% + 3rem);
      }

      .timeline-item:nth-child(odd) .timeline-main .card-header {
        flex-direction: row-reverse;
      }

      /* Light theme fix for info card */
      html.light .timeline-info .glass-effect {
        background: rgba(229, 231, 235, 0.7);
        /* gray-200 */
        border-color: rgba(0, 0, 0, 0.1);
      }

      /* --- Новые эффекты при наведении --- */

      /* 1. Эффект свечения для основных карточек */
      .timeline-main-card {
        transition: box-shadow 0.3s ease-in-out;
        will-change: transform, box-shadow;
      }

      .loading-container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        font-family: 'Inter', sans-serif;
        color: #4a5568;
        text-align: center;
        padding: 1rem;
      }

      .timeline-main-card:hover {
        box-shadow: 0 0 20px 2px rgba(59, 130, 246, 0.3);
      }

      /* 2. Комбинированный эффект для плашек инсайтов */
      .timeline-info-card .insight-icon {
        transition: transform 0.3s ease-in-out;
        will-change: transform;
      }

      .timeline-info-card:hover .insight-icon {
        transform: scale(1.25) rotate(-8deg);
        /* Увеличенный эффект */
      }

      .timeline-info-card .insight-value {
        transition: color 0.3s ease-in-out;
      }

      .timeline-info-card:hover .insight-value {
        color: #3b82f6;
        /* Tailwind's blue-500 */
      }

      html.light .timeline-info-card:hover .insight-value {
        color: #2563eb;
        /* Tailwind's blue-600 для светлой темы */
      }

      /* Hover glow utility for cards (looks good in both themes) */
      .hover-glow {
        transition: box-shadow 0.3s ease-in-out;
        will-change: box-shadow;
      }

      html.light .hover-glow:hover {
        box-shadow: 0 0 20px 2px rgba(37, 99, 235, 0.2);
      }

      .dark .hover-glow:hover {
        box-shadow: 0 0 20px 2px rgba(59, 130, 246, 0.25);
      }

      /* Concept: accordion styles for list view */
      .details-icon {
        transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        will-change: transform;
      }

      details[open] .details-icon {
        transform: rotate(180deg);
      }

      .details-content {
        overflow: hidden;
        transition:
          max-height 1s cubic-bezier(0.4, 0, 0.2, 1),
          padding 1s cubic-bezier(0.4, 0, 0.2, 1),
          opacity 1s ease-in-out;
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
        opacity: 0;
      }

      details[open] .details-content {
        max-height: 2000px;
        opacity: 1;
        padding-top: 1rem;
        padding-bottom: 1rem;
      }

      /* Logo image blending helpers to hide baked checker backgrounds */
      .app-logo {
        pointer-events: none;
      }

      .dark .app-logo {
        mix-blend-mode: screen;
      }

      html.light .app-logo {
        mix-blend-mode: multiply;
      }

      /* Performance optimizations */
      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }

      /* Print styles */
      @media print {
        .no-print {
          display: none !important;
        }

        .glass-effect {
          background: white !important;
        }

        .dark {
          color: black !important;
        }
      }

      /* Dropdown optimizations */
      .dropdown-menu {
        min-width: 160px !important;
        max-width: 200px !important;
        width: auto !important;
      }

      .dropdown-menu button {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* Placeholder для contentEditable */
      [contenteditable]:empty:before {
        content: attr(data-placeholder);
        color: #9ca3af;
        pointer-events: none;
      }

      /* ================================================================================= */
      /* ПЛАВАЮЩАЯ ПАНЕЛЬ - СТЕКЛЯННЫЙ ДИЗАЙН */
      /* ================================================================================= */
      .floating-panel {
        position: fixed;
        z-index: 1000;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        -webkit-user-select: none;
        user-select: none;
        cursor: move;
      }

      .floating-panel.dragging {
        cursor: grabbing;
        transform: scale(1.02);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      }

      /* Стеклянный эффект */
      .floating-panel.glass-theme {
        background: rgba(255, 255, 255, 0.1);
        -webkit-backdrop-filter: blur(20px);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .dark .floating-panel.glass-theme {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }

      /* Твердый дизайн */
      .floating-panel.solid-theme {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(0, 0, 0, 0.1);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      }

      .dark .floating-panel.solid-theme {
        background: rgba(31, 41, 55, 0.95);
        border: 1px solid rgba(75, 85, 99, 0.3);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      }

      /* Минималистичный дизайн */
      .floating-panel.minimal-theme {
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(0, 0, 0, 0.05);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .dark .floating-panel.minimal-theme {
        background: rgba(17, 24, 39, 0.8);
        border: 1px solid rgba(75, 85, 99, 0.2);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      /* Размеры панели */
      .floating-panel.compact {
        width: 200px;
        height: 80px;
        border-radius: 16px;
        padding: 12px;
      }

      .floating-panel.expanded {
        width: 300px;
        height: 120px;
        border-radius: 20px;
        padding: 16px;
      }

      /* Содержимое панели */
      .floating-panel-content {
        display: flex;
        flex-direction: column;
        height: 100%;
        gap: 8px;
      }

      /* Расширенная статистика */
      .floating-panel-stats {
        margin: 4px 0;
        padding: 6px;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }

      .dark .floating-panel-stats {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      /* Карточки статистики */
      .floating-stat-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 4px;
        border-radius: 6px;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
      }

      .floating-stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        opacity: 0.1;
        transition: opacity 0.2s ease;
        border-radius: 6px;
      }

      /* Часы работы - синий акцент */
      .hours-stat {
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.2);
      }

      .hours-stat::before {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      }

      .dark .hours-stat {
        background: rgba(59, 130, 246, 0.15);
        border: 1px solid rgba(59, 130, 246, 0.3);
      }

      /* Средняя ставка - зеленый акцент */
      .rate-stat {
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.2);
      }

      .rate-stat::before {
        background: linear-gradient(135deg, #10b981, #059669);
      }

      .dark .rate-stat {
        background: rgba(16, 185, 129, 0.15);
        border: 1px solid rgba(16, 185, 129, 0.3);
      }

      /* Заработок - фиолетовый акцент */
      .earned-stat {
        background: rgba(139, 92, 246, 0.1);
        border: 1px solid rgba(139, 92, 246, 0.2);
      }

      .earned-stat::before {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      }

      .dark .earned-stat {
        background: rgba(139, 92, 246, 0.15);
        border: 1px solid rgba(139, 92, 246, 0.3);
      }

      /* Элементы карточек */
      .stat-value {
        font-weight: bold;
        font-size: 12px;
        line-height: 1.2;
        margin-bottom: 2px;
        color: #1f2937;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      .dark .stat-value {
        color: #f9fafb;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      }

      .stat-label {
        font-size: 9px;
        font-weight: 500;
        opacity: 0.8;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .dark .stat-label {
        color: #9ca3af;
      }

      /* Hover эффекты */
      .floating-stat-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .floating-stat-card:hover::before {
        opacity: 0.2;
      }

      .dark .floating-stat-card:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .floating-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .floating-panel-timer {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        font-size: 14px;
        color: #1f2937;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      .dark .floating-panel-timer {
        color: #f9fafb;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      }

      .floating-panel-status {
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.8;
      }

      .floating-panel-controls {
        display: flex;
        gap: 6px;
        align-items: center;
      }

      .floating-panel-button {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 10px;
      }

      .floating-panel-button:hover {
        transform: scale(1.1);
      }

      .floating-panel-button.start {
        background: #10b981;
        color: white;
      }

      .floating-panel-button.stop {
        background: #ef4444;
        color: white;
      }

      .floating-panel-button.pause {
        background: #f59e0b;
        color: white;
      }

      .floating-panel-button.settings {
        background: rgba(107, 114, 128, 0.2);
        color: #6b7280;
      }

      .dark .floating-panel-button.settings {
        background: rgba(156, 163, 175, 0.2);
        color: #9ca3af;
      }

      .floating-panel-button.toggle {
        background: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
      }

      .dark .floating-panel-button.toggle {
        background: rgba(59, 130, 246, 0.3);
        color: #60a5fa;
      }

      /* Статус индикатор */
      .floating-panel-status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      .floating-panel-status-dot.active {
        background: #10b981;
      }

      .floating-panel-status-dot.paused {
        background: #f59e0b;
      }

      .floating-panel-status-dot.stopped {
        background: #6b7280;
        animation: none;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }

        50% {
          opacity: 0.5;
        }
      }

      /* Анимации появления */
      .floating-panel-enter {
        opacity: 0;
        transform: scale(0.8) translateY(20px);
      }

      .floating-panel-enter-active {
        opacity: 1;
        transform: scale(1) translateY(0);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .floating-panel-exit {
        opacity: 1;
        transform: scale(1) translateY(0);
      }

      .floating-panel-exit-active {
        opacity: 0;
        transform: scale(0.8) translateY(20px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* Анимация изменения размера */
      .floating-panel-size-transition {
        transition:
          width 0.3s cubic-bezier(0.4, 0, 0.2, 1),
          height 0.3s cubic-bezier(0.4, 0, 0.2, 1),
          border-radius 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* Анимация смены темы */
      .floating-panel-theme-transition {
        transition:
          background 0.3s ease,
          border-color 0.3s ease,
          box-shadow 0.3s ease;
      }

      /* Анимация появления статистики */
      .floating-panel-stats-enter {
        opacity: 0;
        transform: translateY(10px);
      }

      .floating-panel-stats-enter-active {
        opacity: 1;
        transform: translateY(0);
        transition: all 0.2s ease;
      }

      /* Анимация карточек статистики */
      .floating-stat-card {
        animation: slideInUp 0.3s ease forwards;
      }

      .floating-stat-card:nth-child(1) {
        animation-delay: 0.1s;
      }

      .floating-stat-card:nth-child(2) {
        animation-delay: 0.2s;
      }

      .floating-stat-card:nth-child(3) {
        animation-delay: 0.3s;
      }

      @keyframes slideInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Анимации модального окна настроек панели */
      .floating-panel-settings-modal {
        animation: modalEnter 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .floating-panel-settings-modal.closing {
        animation: modalExit 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      @keyframes modalEnter {
        from {
          opacity: 0;
          transform: scale(0.9) translateY(-20px);
        }

        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      @keyframes modalExit {
        from {
          opacity: 1;
          transform: scale(1) translateY(0);
        }

        to {
          opacity: 0;
          transform: scale(0.9) translateY(-20px);
        }
      }

      /* Анимация элементов настроек */
      .floating-panel-settings-content > * {
        animation: slideInUp 0.3s ease forwards;
      }

      .floating-panel-settings-content > *:nth-child(1) {
        animation-delay: 0.1s;
      }

      .floating-panel-settings-content > *:nth-child(2) {
        animation-delay: 0.2s;
      }

      .floating-panel-settings-content > *:nth-child(3) {
        animation-delay: 0.3s;
      }

      .floating-panel-settings-content > *:nth-child(4) {
        animation-delay: 0.4s;
      }

      /* Стеклянные кнопки в стиле проекта */
      .glass-button {
        position: relative;
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
      }

      .glass-button::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        border-radius: inherit;
        z-index: -1;
      }

      .glass-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .glass-button:active {
        transform: translateY(0);
      }

      /* Стеклянные кнопки с цветовыми акцентами */
      .glass-button-green {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
        border-color: rgba(34, 197, 94, 0.3);
        color: #10b981;
      }

      .glass-button-green:hover {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(34, 197, 94, 0.2));
        border-color: rgba(34, 197, 94, 0.4);
        color: #059669;
      }

      .glass-button-red {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
        border-color: rgba(239, 68, 68, 0.3);
        color: #dc2626;
      }

      .glass-button-red:hover {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(239, 68, 68, 0.2));
        border-color: rgba(239, 68, 68, 0.4);
        color: #b91c1c;
      }

      .glass-button-blue {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1));
        border-color: rgba(59, 130, 246, 0.3);
        color: #2563eb;
      }

      .glass-button-blue:hover {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(59, 130, 246, 0.2));
        border-color: rgba(59, 130, 246, 0.4);
        color: #1d4ed8;
      }

      .glass-button-green {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.35), rgba(34, 197, 94, 0.25));
        border-color: rgba(34, 197, 94, 0.4);
        color: #059669;
      }

      .glass-button-green:hover {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.45), rgba(34, 197, 94, 0.35));
        border-color: rgba(34, 197, 94, 0.5);
        color: #047857;
      }

      .glass-button-gray {
        background: linear-gradient(135deg, rgba(107, 114, 128, 0.2), rgba(107, 114, 128, 0.1));
        border-color: rgba(107, 114, 128, 0.3);
        color: #6b7280;
      }

      .glass-button-gray:hover {
        background: linear-gradient(135deg, rgba(107, 114, 128, 0.3), rgba(107, 114, 128, 0.2));
        border-color: rgba(107, 114, 128, 0.4);
        color: #4b5563;
      }

      /* Workday Indicator Styles */
      .workday-indicator {
        position: relative;
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(59, 130, 246, 0.4);
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.35), rgba(59, 130, 246, 0.25));
        color: #1d4ed8;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .dark .workday-indicator {
        color: #93c5fd;
        border-color: rgba(96, 165, 250, 0.4);
        background: linear-gradient(135deg, rgba(96, 165, 250, 0.28), rgba(96, 165, 250, 0.18));
      }

      .workday-indicator:hover {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.45), rgba(59, 130, 246, 0.35));
        border-color: rgba(59, 130, 246, 0.5);
        transform: scale(1.05);
      }

      .dark .workday-indicator:hover {
        background: linear-gradient(135deg, rgba(96, 165, 250, 0.38), rgba(96, 165, 250, 0.28));
        border-color: rgba(96, 165, 250, 0.5);
      }

      .workday-indicator::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: inherit;
        padding: 1px;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.4), transparent);
        -webkit-mask:
          linear-gradient(#fff 0 0) content-box,
          linear-gradient(#fff 0 0);
        mask:
          linear-gradient(#fff 0 0) content-box,
          linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        pointer-events: none;
      }

      .glass-button-purple {
        background: linear-gradient(135deg, rgba(147, 51, 234, 0.2), rgba(147, 51, 234, 0.1));
        border-color: rgba(147, 51, 234, 0.3);
        color: #7c3aed;
      }

      .glass-button-purple:hover {
        background: linear-gradient(135deg, rgba(147, 51, 234, 0.3), rgba(147, 51, 234, 0.2));
        border-color: rgba(147, 51, 234, 0.4);
        color: #6d28d9;
      }

      /* Темная тема для стеклянных кнопок */
      .dark .glass-button-green {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.08));
        border-color: rgba(34, 197, 94, 0.25);
        color: #22c55e;
      }

      .dark .glass-button-green:hover {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.25), rgba(34, 197, 94, 0.15));
        border-color: rgba(34, 197, 94, 0.35);
        color: #16a34a;
      }

      .dark .glass-button-red {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.08));
        border-color: rgba(239, 68, 68, 0.25);
        color: #ef4444;
      }

      .dark .glass-button-red:hover {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.25), rgba(239, 68, 68, 0.15));
        border-color: rgba(239, 68, 68, 0.35);
        color: #dc2626;
      }

      .dark .glass-button-blue {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.08));
        border-color: rgba(59, 130, 246, 0.25);
        color: #3b82f6;
      }

      .dark .glass-button-blue:hover {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(59, 130, 246, 0.15));
        border-color: rgba(59, 130, 246, 0.35);
        color: #2563eb;
      }

      .dark .glass-button-green {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.28), rgba(34, 197, 94, 0.18));
        border-color: rgba(34, 197, 94, 0.4);
        color: #4ade80;
      }

      .dark .glass-button-green:hover {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.38), rgba(34, 197, 94, 0.28));
        border-color: rgba(34, 197, 94, 0.5);
        color: #22c55e;
      }

      .dark .glass-button-gray {
        background: linear-gradient(135deg, rgba(107, 114, 128, 0.15), rgba(107, 114, 128, 0.08));
        border-color: rgba(107, 114, 128, 0.25);
        color: #9ca3af;
      }

      .dark .glass-button-gray:hover {
        background: linear-gradient(135deg, rgba(107, 114, 128, 0.25), rgba(107, 114, 128, 0.15));
        border-color: rgba(107, 114, 128, 0.35);
        color: #6b7280;
      }

      .dark .glass-button-purple {
        background: linear-gradient(135deg, rgba(147, 51, 234, 0.15), rgba(147, 51, 234, 0.08));
        border-color: rgba(147, 51, 234, 0.25);
        color: #a855f7;
      }

      .dark .glass-button-purple:hover {
        background: linear-gradient(135deg, rgba(147, 51, 234, 0.25), rgba(147, 51, 234, 0.15));
        border-color: rgba(147, 51, 234, 0.35);
        color: #9333ea;
      }

      /* Адаптивность */
      @media (max-width: 768px) {
        .floating-panel.compact {
          width: 180px;
          height: 70px;
          padding: 10px;
        }

        .floating-panel.expanded {
          width: 280px;
          height: 100px;
          padding: 14px;
        }

        .floating-panel-timer {
          font-size: 12px;
        }

        .floating-panel-button {
          width: 20px;
          height: 20px;
          font-size: 8px;
        }
      }
    </style>

    <script>
      // ═══════════════════════════════════════════════════════════════════════════════
      // PROTECTION BLOCK 2: ЗАЩИТА ОТ КОПИРОВАНИЯ
      // ═══════════════════════════════════════════════════════════════════════════════
      if (PROTECTION_ENABLED) {
        ;(function () {
          'use strict'

          // Отключение правой кнопки мыши - ВРЕМЕННО ОТКЛЮЧЕНО ДЛЯ ОТЛАДКИ
          // Уже отключено выше

          // Отключение некоторых горячих клавиш
          document.addEventListener('keydown', function (e) {
            // Ctrl+U (просмотр кода)
            if (e.ctrlKey && e.key === 'u') {
              e.preventDefault()
              return false
            }
            // F12 (инструменты разработчика)
            if (e.key === 'F12') {
              e.preventDefault()
              return false
            }
          })

          // Предупреждение в консоли - АКТИВИРОВАНО
          console.clear()
          console.log('%c⚠️ ВНИМАНИЕ!', 'color: red; font-size: 20px; font-weight: bold;')
          console.log(
            '%cЭто приложение защищено авторскими правами.',
            'color: red; font-size: 14px;'
          )
          console.log(
            '%cНесанкционированное копирование запрещено!',
            'color: red; font-size: 14px;'
          )
        })()
      }
    </script>

    <!-- ═══════════════════════════════════════════════════════════════════════════════ -->
    <!-- PROTECTION BLOCK 3: РАСШИРЕННАЯ ЗАЩИТА -->
    <!-- ═══════════════════════════════════════════════════════════════════════════════ -->
    <script>
      if (PROTECTION_ENABLED) {
        // Предупреждение о копирайте
        console.warn('%c⚠️ ВНИМАНИЕ! ⚠️', 'color: red; font-size: 20px; font-weight: bold;')
        console.warn(
          '%cЭтот код защищен авторским правом. Копирование запрещено!',
          'color: red; font-size: 14px;'
        )
        console.warn('%c© 2024 Time Tracker. Все права защищены.', 'color: red; font-size: 12px;')

        // Блокировка правой кнопки мыши - АКТИВИРОВАНО
        document.addEventListener('contextmenu', function (e) {
          e.preventDefault()
          return false
        })

        // Блокировка горячих клавиш - АКТИВИРОВАНО
        document.addEventListener('keydown', function (e) {
          // Ctrl+U (просмотр кода)
          if (e.ctrlKey && e.keyCode === 85) {
            e.preventDefault()
            return false
          }
          // Ctrl+S (сохранение)
          if (e.ctrlKey && e.keyCode === 83) {
            e.preventDefault()
            return false
          }
          // F12 (DevTools)
          if (e.keyCode === 123) {
            e.preventDefault()
            return false
          }
          // Ctrl+Shift+I (DevTools)
          if (e.ctrlKey && e.shiftKey && e.keyCode === 73) {
            e.preventDefault()
            return false
          }
        })

        // Блокировка выделения текста - АКТИВИРОВАНО
        document.addEventListener('selectstart', function (e) {
          e.preventDefault()
          return false
        })

        // Блокировка копирования - АКТИВИРОВАНО
        document.addEventListener('copy', function (e) {
          e.preventDefault()
          return false
        })

        // Водяной знак
        const watermark = document.createElement('div')
        watermark.innerHTML = '© 2024 Time Tracker'
        watermark.style.cssText = `
            position: fixed;
            bottom: 10px;
            right: 10px;
            color: rgba(0,0,0,0.1);
            font-size: 12px;
            pointer-events: none;
            z-index: 9999;
        `
        if (document.body) {
          document.body.appendChild(watermark)
        }

        // Предупреждение при попытке открыть DevTools - ОТКЛЮЧЕНО ДЛЯ ОТЛАДКИ
        // let devtools = { open: false, orientation: null };
        // setInterval(function () {
        //   if (window.outerHeight - window.innerHeight > 200 || window.outerWidth - window.innerWidth > 200) {
        //     if (!devtools.open) {
        //       devtools.open = true;
        //       console.warn('%c⚠️ DevTools обнаружены! ⚠️', 'color: red; font-size: 16px; font-weight: bold;');
        //       console.warn('%cИспользование DevTools запрещено!', 'color: red; font-size: 14px;');
        //     }
        //   } else {
        //     devtools.open = false;
        //   }
        // }, 500);
      }
    </script>
  </head>
  <!--
    ╔══════════════════════════════════════════════════════════════╗
    ║                    ВНИМАНИЕ! АВТОРСКИЕ ПРАВА                ║
    ╠══════════════════════════════════════════════════════════════╣
    ║  © 2024 Time Tracker Dashboard. Все права защищены.         ║
    ║  Этот код является интеллектуальной собственностью.         ║
    ║  Несанкционированное копирование, распространение          ║
    ║  или модификация строго запрещены.                          ║
    ║                                                              ║
    ║  Для получения лицензии обращайтесь к разработчику.         ║
    ╚══════════════════════════════════════════════════════════════╝
-->

  <body class="bg-gray-100 dark:bg-[#111827] transition-colors duration-300">
    <div id="root">
      <div class="loading-container">
        <p>Загрузка приложения...</p>
      </div>
    </div>
    <div id="portal-container"></div>
    <script>
      window.onload = function () {
        console.log('Window loaded, starting app initialization...')
        const h = React.createElement
        const {
          useState,
          useMemo,
          useRef,
          useEffect,
          useCallback,
          createContext,
          useContext,
          useLayoutEffect,
        } = React
        const { createPortal } = ReactDOM
        console.log('React hooks loaded')
        if (!window.Recharts) {
          console.error('Recharts library not loaded.')
          document.getElementById('root').innerHTML =
            '<div style="color: red; text-align: center; padding-top: 50px;">Ошибка: Не удалось загрузить библиотеку графиков. Пожалуйста, проверьте подключение к интернету и обновите страницу.</div>'
          return
        }
        console.log('Recharts library loaded')
        const {
          LineChart,
          Line,
          XAxis,
          YAxis,
          CartesianGrid,
          Tooltip,
          Legend,
          ResponsiveContainer,
          Area,
          AreaChart,
          ComposedChart,
          BarChart,
          Bar,
          ScatterChart,
          Scatter,
          ZAxis,
          Cell,
          Brush,
          PieChart,
          Pie,
        } = window.Recharts

        // ================================================================================= //
        // MARK: - PERFORMANCE OPTIMIZATIONS
        // ================================================================================= //

        // Performance utilities
        const PerformanceUtils = {
          debounce: (func, wait) => {
            let timeout
            return function executedFunction(...args) {
              const later = () => {
                clearTimeout(timeout)
                func(...args)
              }
              clearTimeout(timeout)
              timeout = setTimeout(later, wait)
            }
          },

          throttle: (func, limit) => {
            let inThrottle
            return function (...args) {
              if (!inThrottle) {
                func.apply(this, args)
                inThrottle = true
                setTimeout(() => (inThrottle = false), limit)
              }
            }
          },

          memoize: fn => {
            const cache = new Map()
            return (...args) => {
              const key = JSON.stringify(args)
              if (cache.has(key)) {
                return cache.get(key)
              }
              const result = fn(...args)
              cache.set(key, result)
              return result
            }
          },
        }

        // Error handling utility
        const ErrorHandler = {
          log: (error, context = '') => {
            console.error(`[TimeTracker${context ? ` - ${context}` : ''}]:`, error)
          },

          handle: (error, fallback = null) => {
            this.log(error)
            return fallback
          },

          wrap: (fn, fallback = null) => {
            return (...args) => {
              try {
                return fn(...args)
              } catch (error) {
                return this.handle(error, fallback)
              }
            }
          },
        }

        // Safe localStorage wrapper
        const SafeStorage = {
          get: (key, defaultValue = null) => {
            try {
              const item = localStorage.getItem(key)
              return item ? JSON.parse(item) : defaultValue
            } catch (error) {
              ErrorHandler.log(error, `Storage get - ${key}`)
              return defaultValue
            }
          },

          set: (key, value) => {
            try {
              localStorage.setItem(key, JSON.stringify(value))
              return true
            } catch (error) {
              ErrorHandler.log(error, `Storage set - ${key}`)
              return false
            }
          },

          remove: key => {
            try {
              localStorage.removeItem(key)
              return true
            } catch (error) {
              ErrorHandler.log(error, `Storage remove - ${key}`)
              return false
            }
          },
        }

        // Cached regular expressions
        const REGEX = {
          DATE: /^\d{4}-\d{2}-\d{2}$/,
          TIME: /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/,
        }

        // ================================================================================= //
        // MARK: - BACKUP MANAGER (IndexedDB)
        // ================================================================================= //
        class BackupManager {
          constructor(dbName = 'TimeTrackerBackupDB', storeName = 'backups') {
            this.dbName = dbName
            this.storeName = storeName
            this.maxBackups = 10
            this.dbPromise = null // Cache DB connection
          }
          async openDB() {
            if (this.dbPromise) {
              return this.dbPromise
            }

            this.dbPromise = new Promise((resolve, reject) => {
              const request = indexedDB.open(this.dbName, 1)
              request.onerror = () => {
                ErrorHandler.log(request.error, 'IndexedDB open')
                reject(request.error)
              }
              request.onsuccess = () => resolve(request.result)
              request.onupgradeneeded = event => {
                const db = event.target.result
                if (!db.objectStoreNames.contains(this.storeName)) {
                  const store = db.createObjectStore(this.storeName, { keyPath: 'timestamp' })
                  store.createIndex('timestamp', 'timestamp', { unique: false })
                }
              }
            })

            return this.dbPromise
          }
          async saveBackup(data) {
            try {
              const db = await this.openDB()
              const transaction = db.transaction([this.storeName], 'readwrite')
              const store = transaction.objectStore(this.storeName)
              const timestamp = Date.now()
              await store.add({ timestamp, data })
              await this.cleanupOldBackups(store)
              return { success: true, timestamp }
            } catch (error) {
              ErrorHandler.log(error, 'Backup save')
              return { success: false, error }
            }
          }
          async cleanupOldBackups(store) {
            return new Promise(resolve => {
              const req = store.index('timestamp').openKeyCursor(null, 'prev')
              const keys = []
              req.onsuccess = () => {
                const cursor = req.result
                if (cursor) {
                  keys.push(cursor.key)
                  if (keys.length > this.maxBackups) {
                    store.delete(cursor.key)
                  }
                  cursor.continue()
                } else {
                  resolve()
                }
              }
              req.onerror = () => resolve()
            })
          }
          async listBackups() {
            try {
              const db = await this.openDB()
              const transaction = db.transaction([this.storeName], 'readonly')
              const store = transaction.objectStore(this.storeName)
              const req = store.index('timestamp').openCursor(null, 'prev')
              return new Promise(resolve => {
                const backups = []
                req.onsuccess = () => {
                  const cursor = req.result
                  if (cursor) {
                    const { timestamp, data } = cursor.value
                    const entriesCount = Array.isArray(data.entries) ? data.entries.length : 0
                    backups.push({ timestamp, entriesCount })
                    cursor.continue()
                  } else {
                    resolve(backups)
                  }
                }
                req.onerror = () => resolve([])
              })
            } catch (error) {
              ErrorHandler.log(error, 'Backup list')
              return []
            }
          }
          async restoreBackup(timestamp) {
            try {
              const db = await this.openDB()
              const transaction = db.transaction([this.storeName], 'readonly')
              const store = transaction.objectStore(this.storeName)
              const req = store.get(timestamp)
              return new Promise(resolve => {
                req.onsuccess = () => resolve(req.result?.data || null)
                req.onerror = () => resolve(null)
              })
            } catch (error) {
              ErrorHandler.log(error, 'Backup restore')
              return null
            }
          }
        }
        const backupManager = new BackupManager()

        // Утилита для получения времени анимации из CSS переменных
        const getAnimationDuration = (variable = '--animation-duration-fast') => {
          const raw = getComputedStyle(document.documentElement).getPropertyValue(variable)
          // Нормализуем значение: убираем пробелы и суффикс 's'
          const seconds = parseFloat((raw || '').toString().trim().replace('s', ''))
          const ms = Number.isFinite(seconds) ? Math.max(0, seconds * 1000) : 200
          return ms
        }

        // Проверка, включены ли анимации (учитываем reduced-motion и кастомный флаг)
        const areAnimationsEnabled = () => {
          const raw = getComputedStyle(document.documentElement).getPropertyValue(
            '--animations-enabled'
          )
          const flag = (raw || '').toString().trim()
          // Если системная настройка просит уменьшить движение — считаем, что анимации выключены
          const prefersReduced =
            typeof window !== 'undefined' &&
            window.matchMedia &&
            window.matchMedia('(prefers-reduced-motion: reduce)').matches
          return flag !== '0' && !prefersReduced
        }

        // ================================================================================= //
        // MARK: - RECOVERY MODAL
        // ================================================================================= //
        const RecoveryModal = ({ show, onClose, onRestore }) => {
          const [backups, setBackups] = useState([])
          const [loading, setLoading] = useState(true)
          const [isClosing, setIsClosing] = useState(false)

          // Блокировка скролла фона
          useEffect(() => {
            if (show) {
              document.body.style.overflow = 'hidden'
            } else {
              document.body.style.overflow = ''
            }
            return () => {
              document.body.style.overflow = ''
            }
          }, [show])

          // Обработка закрытия с анимацией
          const handleClose = () => {
            setIsClosing(true)
            setTimeout(() => {
              onClose()
              setIsClosing(false)
            }, 200) // Длительность анимации закрытия
          }

          useEffect(() => {
            if (!show) return
            setLoading(true)
            backupManager
              .listBackups()
              .then(list => {
                setBackups(list)
                setLoading(false)
              })
              .catch(error => {
                ErrorHandler.log(error, 'Recovery modal')
                setLoading(false)
              })
          }, [show])
          if (!show) return null
          return h(
            'div',
            {
              className: `fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 backdrop-blur-sm ${isClosing ? 'modal-backdrop-exit' : 'modal-backdrop-enter'}`,
            },
            h(
              'div',
              {
                className: `glass-effect p-6 rounded-xl shadow-2xl w-full max-w-lg border border-gray-200 dark:border-gray-700 ${isClosing ? 'modal-exit' : 'modal-enter'}`,
              },
              h(
                'h2',
                { className: 'text-xl font-bold text-gray-900 dark:text-white mb-4' },
                'Восстановление данных'
              ),
              loading
                ? h('p', {}, 'Загрузка резервных копий...')
                : backups.length === 0
                  ? h(
                      'p',
                      { className: 'text-gray-600 dark:text-gray-400' },
                      'Резервные копии не найдены.'
                    )
                  : h(
                      'div',
                      { className: 'space-y-2 max-h-80 overflow-y-auto pr-2 custom-scrollbar' },
                      backups.map(backup =>
                        h(
                          'div',
                          {
                            key: backup.timestamp,
                            className:
                              'flex justify-between items-center p-3 bg-white/50 dark:bg-gray-800 rounded-lg',
                          },
                          h(
                            'div',
                            {},
                            h(
                              'p',
                              { className: 'font-medium' },
                              new Date(backup.timestamp).toLocaleString('ru-RU')
                            ),
                            h(
                              'p',
                              { className: 'text-sm text-gray-500 dark:text-gray-400' },
                              `${backup.entriesCount} записей`
                            )
                          ),
                          h(
                            'button',
                            {
                              onClick: () => onRestore(backup.timestamp),
                              className:
                                'px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 button-animated',
                            },
                            'Восстановить'
                          )
                        )
                      )
                    ),
              h(
                'div',
                { className: 'mt-4 flex justify-end' },
                h(
                  'button',
                  {
                    onClick: handleClose,
                    className:
                      'px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 button-animated',
                  },
                  'Отмена'
                )
              )
            )
          )
        }

        // ================================================================================= //
        // MARK: - CONSTANTS
        // ================================================================================= //
        const CHART_FILTER_OPTIONS = {
          today: 'Сегодня',
          week: 'Эта неделя',
          month: 'Этот месяц',
          year: 'Этот год',
          all: 'Все время',
          custom: 'Выбор даты',
        }
        const FILTER_OPTIONS = {
          today: 'Сегодня',
          firstHalfMonth: '1/2 месяца',
          secondHalfMonth: '2/2 месяца',
          month: 'Месяц',
          year: 'Год',
          all: 'Все записи',
          custom: 'Выбор даты',
        }
        const FORECAST_OPTIONS = { today: 'Сегодня', month: 'Месяц', year: 'Год' }
        const HEADER_FILTER_OPTIONS = {
          today: 'Сегодня',
          week: 'Эта неделя',
          month: 'Этот месяц',
          year: 'Этот год',
          all: 'Все время',
          custom: 'Выбор даты',
        }
        const IDEAL_DAY_OPTIONS = { month: 'Месяц', year: 'Год', all: 'Все' }
        const HISTORY_LIMIT = 50
        const getChartTooltipStyle = isDark => ({
          contentStyle: {
            backgroundColor: isDark ? 'rgba(17, 24, 39, 0.6)' : 'rgba(255, 255, 255, 0.6)',
            border: `1px solid ${isDark ? 'rgba(55, 65, 81, 0.4)' : 'rgba(229, 231, 235, 0.8)'}`,
            borderRadius: '0.75rem',
            backdropFilter: 'blur(12px)',
            WebkitBackdropFilter: 'blur(12px)',
          },
          labelStyle: { fontWeight: 'bold', color: isDark ? '#f9fafb' : '#1f2937' },
          itemStyle: { color: isDark ? '#e5e7eb' : '#374151' },
        })

        // ================================================================================= //
        // MARK: - UTILS
        // ================================================================================= //
        const calculateDuration = PerformanceUtils.memoize((start, end) => {
          if (!start || !end) return 0
          const [sh, sm] = start.split(':').map(Number)
          const [eh, em] = end.split(':').map(Number)
          let startMinutes = sh * 60 + sm
          let endMinutes = eh * 60 + em
          if (endMinutes < startMinutes) endMinutes += 24 * 60
          return Math.max(0, (endMinutes - startMinutes) / 60)
        })
        const getFilteredEntries = PerformanceUtils.memoize(
          (entries, filterType, dateFrom, dateTo) => {
            const now = new Date()
            if (!entries) return []
            return entries.filter(e => {
              if (!e.date || !REGEX.DATE.test(e.date)) return false
              const [year, month, day] = e.date.split('-').map(Number)
              const entryDate = new Date(year, month - 1, day)
              switch (filterType) {
                case 'today':
                  return entryDate.toDateString() === now.toDateString()
                case 'week': {
                  const monday = new Date(now)
                  monday.setDate(now.getDate() - now.getDay() + 1)
                  monday.setHours(0, 0, 0, 0)
                  const sunday = new Date(monday)
                  sunday.setDate(monday.getDate() + 6)
                  sunday.setHours(23, 59, 59, 999)
                  return entryDate >= monday && entryDate <= sunday
                }
                case 'month':
                  return (
                    entryDate.getFullYear() === now.getFullYear() &&
                    entryDate.getMonth() === now.getMonth()
                  )
                case 'year':
                  return entryDate.getFullYear() === now.getFullYear()
                case 'firstHalfMonth':
                  return (
                    entryDate.getFullYear() === now.getFullYear() &&
                    entryDate.getMonth() === now.getMonth() &&
                    entryDate.getDate() <= 15
                  )
                case 'secondHalfMonth': {
                  const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate()
                  return (
                    entryDate.getFullYear() === now.getFullYear() &&
                    entryDate.getMonth() === now.getMonth() &&
                    entryDate.getDate() > 15 &&
                    entryDate.getDate() <= lastDay
                  )
                }
                case 'custom':
                  if (!dateFrom || !dateTo) return true
                  const from = new Date(dateFrom)
                  from.setHours(0, 0, 0, 0)
                  const to = new Date(dateTo)
                  to.setHours(23, 59, 59, 999)
                  return entryDate >= from && entryDate <= to
                default:
                  return true
              }
            })
          }
        )
        const minutesToTime = PerformanceUtils.memoize(totalMinutes => {
          if (totalMinutes <= 0) return '00:00'
          const hours = Math.floor(totalMinutes / 60)
          const minutes = Math.round(totalMinutes % 60)
          return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`
        })
        const timeToMinutes = PerformanceUtils.memoize(timeStr => {
          if (!timeStr || !timeStr.includes(':')) return 0
          const [hours, minutes] = timeStr.split(':').map(Number)
          return hours * 60 + minutes
        })

        // Общая функция для расчета рабочих дней в месяце на основе настроек
        const calculateWorkingDaysInMonth = (
          year,
          month,
          startDay = 1,
          endDay = null,
          settings = {}
        ) => {
          const daysInMonth = new Date(year, month + 1, 0).getDate()
          const actualEndDay = endDay || daysInMonth
          let workingDays = 0

          // Если есть кастомные настройки дней
          if (settings?.customWorkDates && Object.keys(settings.customWorkDates).length > 0) {
            for (let day = startDay; day <= actualEndDay; day++) {
              const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`
              if (settings.customWorkDates[dateKey] !== false) {
                workingDays++
              }
            }
          } else {
            // Используем шаблон рабочего графика
            const template = settings?.workScheduleTemplate || '5/2'
            const weekStartDay = settings?.workScheduleStartDay || 1 // 1 = Monday

            if (template === '5/2') {
              // Стандартный недельный график: 5 рабочих, 2 выходных
              for (let day = startDay; day <= actualEndDay; day++) {
                const date = new Date(year, month, day)
                let dayOfWeek = date.getDay() // 0 = Sunday, 1 = Monday, etc.

                // Конвертируем в систему где Monday = 1
                dayOfWeek = dayOfWeek === 0 ? 7 : dayOfWeek

                // Сдвигаем относительно начального дня недели
                const adjustedDay = (dayOfWeek - weekStartDay + 7) % 7

                // Первые 5 дней недели - рабочие
                if (adjustedDay < 5) {
                  workingDays++
                }
              }
            } else {
              // Сменные графики: считаем от начала месяца
              const patterns = {
                '2/2': { work: 2, total: 4 }, // 2 рабочих, 2 выходных
                '3/3': { work: 3, total: 6 }, // 3 рабочих, 3 выходных
                '5/5': { work: 5, total: 10 }, // 5 рабочих, 5 выходных
              }

              const pattern = patterns[template]
              if (pattern) {
                // Находим первый день месяца, который соответствует началу рабочей недели
                const weekStartDay = settings?.workScheduleStartDay || 1
                let firstWorkDay = 1
                for (let day = 1; day <= 7; day++) {
                  const date = new Date(year, month, day)
                  let dayOfWeek = date.getDay()
                  dayOfWeek = dayOfWeek === 0 ? 7 : dayOfWeek

                  if (dayOfWeek === weekStartDay) {
                    firstWorkDay = day
                    break
                  }
                }

                // Рассчитываем рабочие дни относительно первого рабочего дня
                for (let day = startDay; day <= actualEndDay; day++) {
                  const daysSinceFirstWorkDay = day - firstWorkDay
                  const cyclePosition =
                    ((daysSinceFirstWorkDay % pattern.total) + pattern.total) % pattern.total
                  const isWorkDay = cyclePosition < pattern.work
                  if (isWorkDay) {
                    workingDays++
                  }
                }
              }
            }
          }

          return workingDays
        }

        // ================================================================================= //
        // MARK: - GLOBAL CRITICAL ERROR HANDLER
        // ================================================================================= //
        // Export a minimal backup from localStorage to help the user preserve data
        function handleCriticalError() {
          try {
            const entries = SafeStorage.get('timeTrackerEntries', [])
            const dailyPlan = SafeStorage.get('timeTrackerDailyPlan', 6000)
            const dataToSave = { entries, dailyPlan }
            const blob = new Blob([JSON.stringify(dataToSave, null, 2)], {
              type: 'application/json',
            })
            const url = URL.createObjectURL(blob)
            const a = document.createElement('a')
            const now = new Date()
            const date = `${String(now.getDate()).padStart(2, '0')}_${String(now.getMonth() + 1).padStart(2, '0')}_${now.getFullYear()}`
            const time = `${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}`
            a.href = url
            a.download = `tracker-data_critical-backup_${date}_${time}.json`
            a.click()
            URL.revokeObjectURL(url)
          } catch (err) {
            ErrorHandler.log(err, 'Critical error handler')
          }
        }

        // ================================================================================= //
        // MARK: - CONTEXTS
        // ================================================================================= //
        const DataContext = createContext()
        const SettingsContext = createContext()
        const HistoryContext = createContext()
        const useData = () => useContext(DataContext)
        const useSettings = () => useContext(SettingsContext)
        const useHistory = () => useContext(HistoryContext)

        const HistoryProvider = ({
          children,
          entries,
          setEntries,
          showNotification,
          handleExport,
        }) => {
          const [undoStack, setUndoStack] = useState([])
          const [redoStack, setRedoStack] = useState([])
          const backupPending = useRef(false)

          const scheduleBackup = useCallback(() => {
            if (backupPending.current) return
            backupPending.current = true
            setTimeout(async () => {
              try {
                const dailyPlan = JSON.parse(localStorage.getItem('timeTrackerDailyPlan') || '6000')
                await backupManager.saveBackup({ entries, dailyPlan })
              } catch (err) {
                console.error('Backup failed:', err)
                handleExport()
                showNotification('Критическая ошибка! Скачайте резервную копию', 'error', {
                  showUndo: true,
                  onUndo: handleExport,
                })
              }
              backupPending.current = false
            }, 1000)
          }, [entries, showNotification, handleExport])

          const pushToUndo = useCallback(
            (prevState, description) => {
              setUndoStack(prev =>
                [{ state: prevState, description }, ...prev].slice(0, HISTORY_LIMIT)
              )
              setRedoStack([])
              scheduleBackup()
            },
            [scheduleBackup]
          )

          const undo = useCallback(() => {
            if (undoStack.length === 0) return
            const [lastAction, ...restUndo] = undoStack
            setRedoStack(prev => [{ state: entries, description: lastAction.description }, ...prev])
            setEntries(lastAction.state)
            setUndoStack(restUndo)
            scheduleBackup()
          }, [undoStack, entries, setEntries, scheduleBackup])

          const redo = useCallback(() => {
            if (redoStack.length === 0) return
            const [nextAction, ...restRedo] = redoStack
            setUndoStack(prev => [{ state: entries, description: nextAction.description }, ...prev])
            setEntries(nextAction.state)
            setRedoStack(restRedo)
            scheduleBackup()
          }, [redoStack, entries, setEntries, scheduleBackup])

          const canUndo = undoStack.length > 0
          const canRedo = redoStack.length > 0
          const undoDescription = canUndo ? undoStack[0].description : null
          const value = { pushToUndo, undo, redo, canUndo, canRedo, undoDescription }
          return h(HistoryContext.Provider, { value }, children)
        }

        // ================================================================================= //
        // MARK: - HOOKS
        // ================================================================================= //

        // Оптимизированный хук для фильтрации записей с мемоизацией
        const useFilteredEntries = (entries, filterType, dateFrom, dateTo) => {
          return useMemo(() => {
            console.time('useFilteredEntries')
            const result = getFilteredEntries(entries, filterType, dateFrom, dateTo)
            console.timeEnd('useFilteredEntries')
            return result
          }, [entries, filterType, dateFrom, dateTo])
        }

        const useEditableEntry = ({ entry, isEditing, onUpdate, onCancel }) => {
          const [editedEntry, setEditedEntry] = useState(entry)
          const earnedInputRef = useRef(null)
          useEffect(() => {
            setEditedEntry(entry)
          }, [entry, isEditing])
          useEffect(() => {
            if (isEditing) {
              setTimeout(() => {
                if (earnedInputRef.current) {
                  earnedInputRef.current.focus()
                  earnedInputRef.current.select()
                }
              }, 50)
            }
          }, [isEditing])
          const handleChange = (field, value) => {
            setEditedEntry(current => {
              const temp = { ...current, [field]: value }
              const hours = calculateDuration(temp.start, temp.end)
              if (field === 'earned') {
                temp.rate = hours > 0 ? Math.round((Number(value) || 0) / hours) : 0
              } else if (field === 'start' || field === 'end' || field === 'rate') {
                temp.earned = Math.round(hours * (temp.rate || 0))
              }
              return temp
            })
          }
          const handleSave = () => {
            onUpdate({ ...editedEntry, earned: Number(editedEntry.earned) || 0 })
          }
          const handleKeyDown = e => {
            if (e.code === 'Enter') {
              e.preventDefault()
              handleSave()
            } else if (e.code === 'Escape') {
              e.preventDefault()
              onCancel()
            }
          }
          return {
            editedEntry,
            handleChange,
            handleSave,
            handleKeyDown,
            earnedInputRef,
          }
        }

        const useLocalStorage = (key, initialValue) => {
          const [storedValue, setStoredValue] = useState(() => {
            try {
              return SafeStorage.get(key, initialValue)
            } catch (error) {
              ErrorHandler.log(error, `useLocalStorage get - ${key}`)
              return initialValue
            }
          })
          const setValue = useCallback(
            value => {
              try {
                const valueToStore = value instanceof Function ? value(storedValue) : value
                setStoredValue(valueToStore)
                SafeStorage.set(key, valueToStore)
              } catch (error) {
                ErrorHandler.log(error, `useLocalStorage set - ${key}`)
              }
            },
            [key, storedValue]
          )
          return [storedValue, setValue]
        }

        // Отложенное сохранение в localStorage с визуальным индикатором
        const useDebouncedLocalStorage = (key, initialValue, delay = 2000) => {
          const [storedValue, setStoredValue] = useState(() => {
            try {
              return SafeStorage.get(key, initialValue)
            } catch (error) {
              ErrorHandler.log(error, `useDebouncedLocalStorage get - ${key}`)
              return initialValue
            }
          })
          const [saveStatus, setSaveStatus] = useState('saved') // 'saving', 'saved', 'error'
          const timeoutRef = useRef(null)
          const pendingValueRef = useRef(null)

          const setValue = useCallback(
            value => {
              try {
                const valueToStore = value instanceof Function ? value(storedValue) : value
                setStoredValue(valueToStore)
                pendingValueRef.current = valueToStore
                setSaveStatus('saving')

                // Очищаем предыдущий таймер
                if (timeoutRef.current) {
                  clearTimeout(timeoutRef.current)
                }

                // Устанавливаем новый таймер
                timeoutRef.current = setTimeout(() => {
                  try {
                    SafeStorage.set(key, pendingValueRef.current)
                    setSaveStatus('saved')
                  } catch (error) {
                    ErrorHandler.log(error, `useDebouncedLocalStorage set - ${key}`)
                    setSaveStatus('error')
                  }
                }, delay)
              } catch (error) {
                ErrorHandler.log(error, `useDebouncedLocalStorage set - ${key}`)
                setSaveStatus('error')
              }
            },
            [key, storedValue, delay]
          )

          // Немедленное сохранение при размонтировании
          useEffect(() => {
            return () => {
              if (timeoutRef.current) {
                clearTimeout(timeoutRef.current)
              }
              if (pendingValueRef.current !== null) {
                try {
                  SafeStorage.set(key, pendingValueRef.current)
                } catch (error) {
                  ErrorHandler.log(error, `useDebouncedLocalStorage cleanup - ${key}`)
                }
              }
            }
          }, [key])

          // Немедленное сохранение при закрытии страницы
          useEffect(() => {
            const handleBeforeUnload = () => {
              if (pendingValueRef.current !== null) {
                try {
                  SafeStorage.set(key, pendingValueRef.current)
                } catch (error) {
                  ErrorHandler.log(error, `useDebouncedLocalStorage beforeunload - ${key}`)
                }
              }
            }

            window.addEventListener('beforeunload', handleBeforeUnload)
            return () => window.removeEventListener('beforeunload', handleBeforeUnload)
          }, [key])

          return [storedValue, setValue, saveStatus]
        }

        const useNotifications = () => {
          const [notification, setNotification] = useState({
            show: false,
            message: '',
            type: 'success',
            showUndo: false,
          })
          const [lastUndoCallback, setLastUndoCallback] = useState(null)
          const showNotification = useCallback((message, type = 'success', options = {}) => {
            if (options.showUndo && options.onUndo) {
              setLastUndoCallback(() => options.onUndo)
            } else {
              setLastUndoCallback(null)
            }
            setNotification({ show: true, message, type, showUndo: !!options.showUndo })
          }, [])
          const NotificationComponent = useMemo(() => {
            if (!notification.show) return null
            const handleClose = () => setNotification(n => ({ ...n, show: false }))
            const handleUndo = () => {
              if (lastUndoCallback) lastUndoCallback()
              handleClose()
            }
            return h(NotificationToast, {
              message: notification.message,
              type: notification.type,
              onClose: handleClose,
              showUndo: notification.showUndo,
              onUndo: handleUndo,
            })
          }, [notification, lastUndoCallback])
          return { showNotification, NotificationComponent }
        }

        const usePortalPosition = ({ triggerRef, portalRef, isOpen, gap = 4, margin = 8 }) => {
          const [style, setStyle] = useState({ opacity: 0, pointerEvents: 'none' })
          const [directions, setDirections] = useState({ openUp: false, openLeft: false })
          useLayoutEffect(() => {
            const triggerEl = triggerRef.current
            const portalEl = portalRef.current
            if (!isOpen || !triggerEl || !portalEl) {
              setStyle(s => ({ ...s, opacity: 0, pointerEvents: 'none' }))
              return
            }
            // Новый, исправленный код
            const calculatePosition = () => {
              if (!triggerEl || !portalEl || !portalEl.offsetHeight) return
              const triggerRect = triggerEl.getBoundingClientRect()
              const portalHeight = portalEl.offsetHeight
              const portalWidth = portalEl.offsetWidth // <-- ИЗМЕНЕНИЕ: Берем реальную ширину меню
              const viewport = { width: window.innerWidth, height: window.innerHeight }

              // ... (логика для top остается без изменений)
              let openUp = false
              let top = triggerRect.bottom + gap
              if (
                triggerRect.bottom + portalHeight + gap > viewport.height &&
                triggerRect.top - portalHeight - gap > 0
              ) {
                top = triggerRect.top - portalHeight - gap
                openUp = true
              }

              let openLeft = false
              // ИЗМЕНЕНИЕ: Выравниваем меню по правому краю кнопки, а не по левому
              let left = triggerRect.right - portalWidth
              if (left < margin) {
                // Если выходит за левый край экрана
                left = margin
                openLeft = false
              } else {
                openLeft = true // Технически, оно всегда открывается "влево" от правого края
              }

              setStyle({
                position: 'fixed',
                top: `${top}px`,
                left: `${left}px`,
                // width: ... <-- ЭТУ СТРОКУ НУЖНО ПОЛНОСТЬЮ УДАЛИТЬ
                opacity: 1,
                pointerEvents: 'auto',
              })
              setDirections({ openUp, openLeft })
            }
            const frameId = requestAnimationFrame(calculatePosition)
            const resizeObserver = new ResizeObserver(calculatePosition)
            resizeObserver.observe(document.body)
            const intersectionObserver = new IntersectionObserver(calculatePosition, { root: null })
            intersectionObserver.observe(triggerEl)
            return () => {
              cancelAnimationFrame(frameId)
              resizeObserver.disconnect()
              intersectionObserver.disconnect()
            }
          }, [isOpen, triggerRef, portalRef, gap, margin])
          return { style, openUp: directions.openUp, openLeft: directions.openLeft }
        }

        const useTimer = (entries, addEntry, updateEntry) => {
          const { settings } = useSettings()
          const [activeTimer, setActiveTimer] = useState(null)
          const [elapsedTime, setElapsedTime] = useState(0)
          const lastNotificationTime = useRef(0)
          const faviconInterval = useRef(null)
          const playNotificationSound = useCallback(sound => {
            try {
              if (!window.Tone) {
                console.warn('Tone.js not loaded.')
                return
              }
              const synth = new Tone.Synth().toDestination()
              switch (sound) {
                case 'chime':
                  synth.triggerAttackRelease('E5', '8n', Tone.now())
                  synth.triggerAttackRelease('C5', '8n', Tone.now() + 0.2)
                  break
                case 'alert':
                  synth.triggerAttackRelease('G5', '16n', Tone.now())
                  synth.triggerAttackRelease('C6', '16n', Tone.now() + 0.1)
                  break
                case 'phone':
                  synth.triggerAttackRelease('C5', '4n', Tone.now())
                  synth.triggerAttackRelease('E5', '4n', Tone.now() + 0.5)
                  break
                case 'doorbell':
                  synth.triggerAttackRelease('G4', '8n', Tone.now())
                  synth.triggerAttackRelease('B4', '8n', Tone.now() + 0.3)
                  synth.triggerAttackRelease('D5', '8n', Tone.now() + 0.6)
                  break
                case 'alarm':
                  synth.triggerAttackRelease('A4', '16n', Tone.now())
                  synth.triggerAttackRelease('A4', '16n', Tone.now() + 0.2)
                  synth.triggerAttackRelease('A4', '16n', Tone.now() + 0.4)
                  break
                case 'notification':
                  synth.triggerAttackRelease('F5', '8n', Tone.now())
                  synth.triggerAttackRelease('A5', '8n', Tone.now() + 0.2)
                  break
                case 'bell':
                  synth.triggerAttackRelease('C6', '4n', Tone.now())
                  synth.triggerAttackRelease('G5', '4n', Tone.now() + 0.5)
                  break
                case 'beep':
                  synth.triggerAttackRelease('C5', '8n')
                  break
                default:
                  synth.triggerAttackRelease('C5', '8n')
                  break
              }
            } catch (e) {
              console.error('Could not play sound:', e)
            }
          }, [])
          useEffect(() => {
            let interval = null
            if (activeTimer) {
              interval = setInterval(() => setElapsedTime(Date.now() - activeTimer.startTime), 1000)
            }
            return () => {
              if (interval) clearInterval(interval)
            }
          }, [activeTimer])
          useEffect(() => {
            const formatElapsedTime = ms => {
              const totalSeconds = Math.floor(ms / 1000)
              const hours = Math.floor(totalSeconds / 3600)
              const minutes = Math.floor((totalSeconds % 3600) / 60)
              const seconds = totalSeconds % 60
              return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`
            }
            const updateFavicon = url => {
              let link = document.querySelector("link[rel~='icon']")
              if (!link) {
                link = document.createElement('link')
                link.rel = 'icon'
                document.head.appendChild(link)
              }
              link.href = url
            }
            const drawFavicon = (isPaused = false, animationValue = 1) => {
              const canvas = document.createElement('canvas')
              canvas.width = 32
              canvas.height = 32
              const ctx = canvas.getContext('2d')
              const color = settings.faviconAnimationColor || '#22c55e'

              if (isPaused || !settings.faviconAnimationEnabled) {
                ctx.fillStyle = isPaused ? '#9ca3af' : color
                ctx.beginPath()
                ctx.arc(16, 16, 14, 0, 2 * Math.PI)
                ctx.fill()
              } else {
                ctx.save()
                const style = settings.faviconAnimationStyle || 'pulse'

                switch (style) {
                  case 'pulse':
                    ctx.fillStyle = color
                    ctx.beginPath()
                    const radius = 14 * animationValue
                    ctx.arc(16, 16, Math.max(5, radius), 0, 2 * Math.PI)
                    ctx.fill()
                    break

                  case 'blink':
                    ctx.globalAlpha = animationValue
                    ctx.fillStyle = color
                    ctx.beginPath()
                    ctx.arc(16, 16, 14, 0, 2 * Math.PI)
                    ctx.fill()
                    break

                  case 'rotate':
                    ctx.translate(16, 16)
                    ctx.rotate(animationValue * Math.PI * 2)
                    ctx.translate(-16, -16)
                    // Основной круг
                    ctx.fillStyle = color
                    ctx.beginPath()
                    ctx.arc(16, 16, 14, 0, 2 * Math.PI)
                    ctx.fill()
                    // Добавляем стрелку для видимости вращения
                    ctx.fillStyle = '#ffffff'
                    ctx.beginPath()
                    ctx.moveTo(16, 4)
                    ctx.lineTo(12, 12)
                    ctx.lineTo(20, 12)
                    ctx.closePath()
                    ctx.fill()
                    break

                  case 'wave':
                    ctx.fillStyle = color
                    for (let i = 0; i < 3; i++) {
                      ctx.globalAlpha = (1 - Math.abs(animationValue - i * 0.5)) * 0.7
                      ctx.beginPath()
                      const waveRadius = 14 + Math.sin(animationValue * Math.PI * 2 + i) * 3
                      ctx.arc(16, 16, waveRadius, 0, 2 * Math.PI)
                      ctx.fill()
                    }
                    break

                  case 'gradient':
                    const gradient = ctx.createRadialGradient(16, 16, 0, 16, 16, 14)
                    const hue = (animationValue * 360) % 360
                    gradient.addColorStop(0, `hsl(${hue}, 70%, 50%)`)
                    gradient.addColorStop(1, `hsl(${hue}, 70%, 30%)`)
                    ctx.fillStyle = gradient
                    ctx.beginPath()
                    ctx.arc(16, 16, 14, 0, 2 * Math.PI)
                    ctx.fill()
                    break

                  case 'morph':
                    // Яндекс Крауд: буква "К" превращается в букву "Я"
                    const morphProgress = Math.sin(animationValue * Math.PI * 2) * 0.5 + 0.5 // 0-1

                    if (morphProgress < 0.5) {
                      // Фаза 1: Буква "К" уменьшается
                      const letterScale = 1 - morphProgress * 2 // 1 → 0
                      ctx.fillStyle = color
                      ctx.font = `bold ${28 * letterScale}px Arial`
                      ctx.textAlign = 'center'
                      ctx.textBaseline = 'middle'
                      ctx.globalAlpha = letterScale
                      ctx.fillText('К', 16, 16)
                      ctx.globalAlpha = 1
                    } else {
                      // Фаза 2: Буква "Я" появляется и увеличивается
                      const letterScale = (morphProgress - 0.5) * 2 // 0 → 1
                      ctx.fillStyle = '#ef4444' // Красный цвет
                      ctx.font = `bold ${28 * letterScale}px Arial`
                      ctx.textAlign = 'center'
                      ctx.textBaseline = 'middle'
                      ctx.globalAlpha = letterScale
                      ctx.fillText('Я', 16, 16)
                      ctx.globalAlpha = 1
                    }
                    break

                  case 'particles':
                    ctx.fillStyle = color
                    ctx.beginPath()
                    ctx.arc(16, 16, 14, 0, 2 * Math.PI)
                    ctx.fill()
                    // Частицы вокруг иконки - больше и контрастнее
                    ctx.fillStyle = '#ffffff' // Белые частицы для контраста
                    for (let i = 0; i < 6; i++) {
                      const angle = (i / 6) * Math.PI * 2 + animationValue * Math.PI * 2
                      const particleX = 16 + Math.cos(angle) * 22
                      const particleY = 16 + Math.sin(angle) * 22
                      ctx.globalAlpha = 0.8
                      ctx.beginPath()
                      ctx.arc(particleX, particleY, 4, 0, 2 * Math.PI) // Увеличили размер с 2 до 4
                      ctx.fill()
                    }
                    break

                  case 'breathe':
                    ctx.fillStyle = color
                    ctx.beginPath()
                    const breatheRadius = 14 + Math.sin(animationValue * Math.PI * 2) * 3
                    ctx.arc(16, 16, breatheRadius, 0, 2 * Math.PI)
                    ctx.fill()
                    break

                  default:
                    ctx.fillStyle = color
                    ctx.beginPath()
                    ctx.arc(16, 16, 14, 0, 2 * Math.PI)
                    ctx.fill()
                }

                ctx.restore()
              }
              return canvas.toDataURL('image/png')
            }
            if (activeTimer) {
              const speedMap = { slow: 4000, normal: 2000, fast: 1000 }
              const animationSpeed = speedMap[settings.faviconAnimationSpeed] || 2000
              faviconInterval.current = setInterval(() => {
                let animationValue = 1
                if (settings.faviconAnimationEnabled) {
                  const style = settings.faviconAnimationStyle || 'pulse'
                  const time = Date.now() / animationSpeed

                  switch (style) {
                    case 'pulse':
                      animationValue = 0.75 + Math.sin(time * Math.PI * 2) * 0.25
                      break
                    case 'blink':
                      animationValue = Math.floor(time) % 2 === 0 ? 1 : 0.2
                      break
                    case 'rotate':
                      animationValue = (time * 0.5) % 1 // Медленное вращение
                      break
                    case 'wave':
                      animationValue = (time * 2) % 1 // Быстрая волна
                      break
                    case 'gradient':
                      animationValue = (time * 0.3) % 1 // Медленное изменение цвета
                      break
                    case 'morph':
                      animationValue = (time * 1.5) % 1 // Средняя скорость морфинга
                      break
                    case 'particles':
                      animationValue = (time * 0.8) % 1 // Вращение частиц
                      break
                    case 'breathe':
                      animationValue = 0.5 + Math.sin(time * Math.PI * 2) * 0.5 // Плавное дыхание
                      break
                    default:
                      animationValue = 1
                  }
                }
                updateFavicon(drawFavicon(false, animationValue))
              }, 50)
              const notificationIntervalMs = settings.notificationInterval * 60 * 1000
              if (
                settings.soundNotificationsEnabled &&
                notificationIntervalMs > 0 &&
                elapsedTime > 0
              ) {
                const nextNotificationTarget = lastNotificationTime.current + notificationIntervalMs
                if (elapsedTime >= nextNotificationTarget) {
                  playNotificationSound(settings.notificationSound)
                  lastNotificationTime.current =
                    Math.floor(elapsedTime / notificationIntervalMs) * notificationIntervalMs
                }
              }
              document.title = `${formatElapsedTime(elapsedTime)} - Работаем`
            } else {
              clearInterval(faviconInterval.current)
              updateFavicon(drawFavicon(true))
              const todayEntries = getFilteredEntries(entries, 'today')
              const totalSecondsToday = todayEntries.reduce((acc, entry) => {
                const durationHours = calculateDuration(entry.start, entry.end)
                return acc + durationHours * 3600
              }, 0)
              if (totalSecondsToday > 0) {
                const totalMs = totalSecondsToday * 1000
                document.title = `${formatElapsedTime(totalMs)} - Пауза`
              } else {
                document.title = 'Time Tracker Dashboard'
              }
            }
            return () => clearInterval(faviconInterval.current)
          }, [activeTimer, elapsedTime, settings, playNotificationSound, entries])
          const handleStartTimer = useCallback(() => {
            if (activeTimer) return
            lastNotificationTime.current = 0
            const now = new Date()
            const newId = Date.now()
            const newEntry = {
              id: newId,
              date: now.toISOString().split('T')[0],
              start: now.toTimeString().slice(0, 5),
              end: '',
              rate: 0,
              earned: 0,
            }
            addEntry(newEntry)
            setActiveTimer({ id: newId, startTime: Date.now() })
          }, [activeTimer, addEntry])
          const handleStopTimer = useCallback(() => {
            if (!activeTimer) return
            const now = new Date()
            const endTime = now.toTimeString().slice(0, 5)
            updateEntry(activeTimer.id, entry => {
              const hours = calculateDuration(entry.start, endTime)
              return { ...entry, end: endTime, earned: Math.round(hours * entry.rate) }
            })
            setActiveTimer(null)
            setElapsedTime(0)
            return activeTimer.id
          }, [activeTimer, updateEntry])
          return { activeTimer, elapsedTime, handleStartTimer, handleStopTimer }
        }

        // ================================================================================= //
        // MARK: - ICONS & UI COMPONENTS (without JSX)
        // ================================================================================= //
        const Icon = ({ children, size = 24, className = '' }) =>
          h(
            'svg',
            {
              xmlns: 'http://www.w3.org/2000/svg',
              width: size,
              height: size,
              viewBox: '0 0 24 24',
              fill: 'none',
              stroke: 'currentColor',
              strokeWidth: '2',
              strokeLinecap: 'round',
              strokeLinejoin: 'round',
              className,
            },
            children
          )

        const Activity = props =>
          h(Icon, props, h('polyline', { points: '22 12 18 12 15 21 9 3 6 12 2 12' }))
        const AlertTriangle = props =>
          h(
            Icon,
            props,
            h('path', {
              d: 'm21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z',
            }),
            h('line', { x1: '12', y1: '9', x2: '12', y2: '13' }),
            h('line', { x1: '12', y1: '17', x2: '12.01', y2: '17' })
          )
        const TimelineIcon = props =>
          h(
            Icon,
            props,
            h('path', { d: 'M2 12h2' }),
            h('path', { d: 'M20 12h2' }),
            h('path', { d: 'M12 2v2' }),
            h('path', { d: 'M12 20v2' }),
            h('path', { d: 'M12 7a5 5 0 1 0 0 10 5 5 0 1 0 0-10z' })
          )
        const ArrowDown = props =>
          h(
            Icon,
            props,
            h('line', { x1: '12', y1: '5', x2: '12', y2: '19' }),
            h('polyline', { points: '19 12 12 19 5 12' })
          )
        const ArrowRight = props =>
          h(
            Icon,
            props,
            h('line', { x1: '5', y1: '12', x2: '19', y2: '12' }),
            h('polyline', { points: '12 5 19 12 12 19' })
          )
        const ArrowUp = props =>
          h(
            Icon,
            props,
            h('line', { x1: '12', y1: '19', x2: '12', y2: '5' }),
            h('polyline', { points: '5 12 12 5 19 12' })
          )
        const BarChart2 = props =>
          h(
            Icon,
            props,
            h('line', { x1: '18', y1: '20', x2: '18', y2: '10' }),
            h('line', { x1: '12', y1: '20', x2: '12', y2: '4' }),
            h('line', { x1: '6', y1: '20', x2: '6', y2: '14' })
          )
        const Bell = props =>
          h(
            Icon,
            props,
            h('path', { d: 'M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9' }),
            h('path', { d: 'M13.73 21a2 2 0 0 1-3.46 0' })
          )
        const BellOff = props =>
          h(
            Icon,
            props,
            h('path', { d: 'M13.73 21a2 2 0 0 1-3.46 0' }),
            h('path', { d: 'M18.63 13A17.89 17.89 0 0 1 18 8' }),
            h('path', { d: 'M6.26 6.26A5.86 5.86 0 0 0 6 8c0 7-3 9-3 9h14' }),
            h('path', { d: 'M18 8a6 6 0 0 0-9.33-5' }),
            h('line', { x1: '1', y1: '1', x2: '23', y2: '23' })
          )
        const Calendar = props =>
          h(
            Icon,
            props,
            h('rect', { x: '3', y: '4', width: '18', height: '18', rx: '2', ry: '2' }),
            h('line', { x1: '16', y1: '2', x2: '16', y2: '6' }),
            h('line', { x1: '8', y1: '2', x2: '8', y2: '6' }),
            h('line', { x1: '3', y1: '10', x2: '21', y2: '10' })
          )
        const CheckCircle = props =>
          h(
            Icon,
            props,
            h('path', { d: 'M22 11.08V12a10 10 0 1 1-5.93-9.14' }),
            h('polyline', { points: '22 4 12 14.01 9 11.01' })
          )
        const ChevronLeft = props => h(Icon, props, h('polyline', { points: '15 18 9 12 15 6' }))
        const ChevronRight = props => h(Icon, props, h('polyline', { points: '9 18 15 12 9 6' }))
        const Clock = props =>
          h(
            Icon,
            props,
            h('circle', { cx: '12', cy: '12', r: '10' }),
            h('polyline', { points: '12 6 12 12 16 14' })
          )
        const CloseIcon = props =>
          h(
            Icon,
            props,
            h('line', { x1: '18', y1: '6', x2: '6', y2: '18' }),
            h('line', { x1: '6', y1: '6', x2: '18', y2: '18' })
          )
        const CornerUpLeft = props =>
          h(
            Icon,
            props,
            h('polyline', { points: '9 14 4 9 9 4' }),
            h('path', { d: 'M20 20v-7a4 4 0 0 0-4-4H4' })
          )
        const CornerUpRight = props =>
          h(
            Icon,
            props,
            h('polyline', { points: '15 14 20 9 15 4' }),
            h('path', { d: 'M4 20v-7a4 4 0 0 1 4-4h12' })
          )
        const DollarSign = props =>
          h(
            Icon,
            props,
            h('line', { x1: '12', y1: '1', x2: '12', y2: '23' }),
            h('path', { d: 'M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6' })
          )
        const Download = props =>
          h(
            Icon,
            props,
            h('path', { d: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4' }),
            h('polyline', { points: '7 10 12 15 17 10' }),
            h('line', { x1: '12', y1: '15', x2: '12', y2: '3' })
          )
        const Edit2 = props =>
          h(
            Icon,
            props,
            h('path', { d: 'M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z' })
          )
        const Grid = props =>
          h(
            Icon,
            props,
            h('rect', { x: '3', y: '3', width: '7', height: '7' }),
            h('rect', { x: '14', y: '3', width: '7', height: '7' }),
            h('rect', { x: '14', y: '14', width: '7', height: '7' }),
            h('rect', { x: '3', y: '14', width: '7', height: '7' })
          )
        const Layers = props =>
          h(
            Icon,
            props,
            h('polygon', { points: '12,2 2,7 12,12 22,7 12,2' }),
            h('polyline', { points: '2,17 12,22 22,17' }),
            h('polyline', { points: '2,12 12,17 22,12' })
          )
        const HelpCircle = props =>
          h(
            Icon,
            props,
            h('circle', { cx: '12', cy: '12', r: '10' }),
            h('path', { d: 'M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3' }),
            h('line', { x1: '12', y1: '17', x2: '12.01', y2: '17' })
          )
        const Info = props =>
          h(
            Icon,
            props,
            h('circle', { cx: '12', cy: '12', r: '10' }),
            h('path', { d: 'M12 16v-4' }),
            h('path', { d: 'M12 8h.01' })
          )
        const InfoIcon = props =>
          h(
            Icon,
            props,
            h('circle', { cx: '12', cy: '12', r: '10' }),
            h('line', { x1: '12', y1: '16', x2: '12', y2: '12' }),
            h('line', { x1: '12', y1: '8', x2: '12.01', y2: '8' })
          )
        const List = props =>
          h(
            Icon,
            props,
            h('line', { x1: '8', y1: '6', x2: '21', y2: '6' }),
            h('line', { x1: '8', y1: '12', x2: '21', y2: '12' }),
            h('line', { x1: '8', y1: '18', x2: '21', y2: '18' }),
            h('line', { x1: '3', y1: '6', x2: '3.01', y2: '6' }),
            h('line', { x1: '3', y1: '12', x2: '3.01', y2: '12' }),
            h('line', { x1: '3', y1: '18', x2: '3.01', y2: '18' })
          )
        const Moon = props => h(Icon, props, h('path', { d: 'M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z' }))
        const MoreVertical = props =>
          h(
            Icon,
            props,
            h('circle', { cx: '12', cy: '12', r: '1' }),
            h('circle', { cx: '12', cy: '5', r: '1' }),
            h('circle', { cx: '12', cy: '19', r: '1' })
          )
        const Paperclip = props =>
          h(
            Icon,
            props,
            h('path', {
              d: 'm21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48',
            })
          )
        const Play = props => h(Icon, props, h('polygon', { points: '6 3 20 12 6 21 6 3' }))
        const Pause = props =>
          h(
            Icon,
            props,
            h('rect', { x: '6', y: '4', width: '4', height: '16' }),
            h('rect', { x: '14', y: '4', width: '4', height: '16' })
          )
        const PlusCircle = props =>
          h(
            Icon,
            props,
            h('circle', { cx: '12', cy: '12', r: '10' }),
            h('line', { x1: '12', y1: '8', x2: '12', y2: '16' }),
            h('line', { x1: '8', y1: '12', x2: '16', y2: '12' })
          )
        const Save = props =>
          h(
            Icon,
            props,
            h('path', { d: 'M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z' }),
            h('polyline', { points: '17 21 17 13 7 13 7 21' }),
            h('polyline', { points: '7 3 7 8 15 8' })
          )
        const Settings = props =>
          h(
            Icon,
            props,
            h('circle', { cx: '12', cy: '12', r: '3' }),
            h('path', {
              d: 'M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z',
            })
          )
        const Square = props =>
          h(Icon, props, h('rect', { x: '3', y: '3', width: '18', height: '18', rx: '2', ry: '2' }))
        const Sun = props =>
          h(
            Icon,
            props,
            h('circle', { cx: '12', cy: '12', r: '4' }),
            h('path', { d: 'M12 2v2' }),
            h('path', { d: 'M12 20v2' }),
            h('path', { d: 'm4.93 4.93 1.41 1.41' }),
            h('path', { d: 'm17.66 17.66 1.41 1.41' }),
            h('path', { d: 'M2 12h2' }),
            h('path', { d: 'M20 12h2' }),
            h('path', { d: 'm6.34 17.66-1.41 1.41' }),
            h('path', { d: 'm19.07 4.93-1.41 1.41' })
          )
        const Trash2 = props =>
          h(
            Icon,
            props,
            h('polyline', { points: '3 6 5 6 21 6' }),
            h('path', {
              d: 'M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2',
            }),
            h('line', { x1: '10', y1: '11', x2: '10', y2: '17' }),
            h('line', { x1: '14', y1: '11', x2: '14', y2: '17' })
          )
        const TrendingUp = props =>
          h(
            Icon,
            props,
            h('polyline', { points: '23 6 13.5 15.5 8.5 10.5 1 18' }),
            h('polyline', { points: '17 6 23 6 23 12' })
          )
        const Upload = props =>
          h(
            Icon,
            props,
            h('path', { d: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4' }),
            h('polyline', { points: '17 8 12 3 7 8' }),
            h('line', { x1: '12', y1: '3', x2: '12', y2: '15' })
          )
        const Volume2 = props =>
          h(
            Icon,
            props,
            h('polygon', { points: '11 5 6 9 2 9 2 15 6 15 11 19 11 5' }),
            h('path', { d: 'M15.54 8.46a5 5 0 0 1 0 7.07' }),
            h('path', { d: 'M19.07 4.93a10 10 0 0 1 0 14.14' })
          )
        const ChevronDown = props => h(Icon, props, h('polyline', { points: '6 9 12 15 18 9' }))
        const Database = props =>
          h(
            Icon,
            props,
            h('ellipse', { cx: 12, cy: 5, rx: 9, ry: 3 }),
            h('path', { d: 'M3 5v6c0 1.66 4.03 3 9 3s9-1.34 9-3V5' }),
            h('path', { d: 'M3 11v6c0 1.66 4.03 3 9 3s9-1.34 9-3v-6' })
          )
        const Folder = props =>
          h(
            Icon,
            props,
            h('path', {
              d: 'M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z',
            })
          )
        const FileText = props =>
          h(
            Icon,
            props,
            h('path', { d: 'M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z' }),
            h('polyline', { points: '14 2 14 8 20 8' }),
            h('line', { x1: '16', y1: '13', x2: '8', y2: '13' }),
            h('line', { x1: '16', y1: '17', x2: '8', y2: '17' }),
            h('polyline', { points: '10 9 9 9 8 9' })
          )
        const CheckSquare = props =>
          h(
            Icon,
            props,
            h('polyline', { points: '9 11 12 14 22 4' }),
            h('path', { d: 'M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11' })
          )
        const X = props =>
          h(
            Icon,
            props,
            h('line', { x1: '18', y1: '6', x2: '6', y2: '18' }),
            h('line', { x1: '6', y1: '6', x2: '18', y2: '18' })
          )
        const Users = props =>
          h(
            Icon,
            props,
            h('path', { d: 'M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2' }),
            h('circle', { cx: '9', cy: '7', r: '4' }),
            h('path', { d: 'M23 21v-2a4 4 0 0 0-3-3.87' }),
            h('path', { d: 'M16 3.13a4 4 0 0 1 0 7.75' })
          )
        const Pin = props =>
          h(
            Icon,
            props,
            h('path', {
              d: 'M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L9.64 16.2a2 2 0 0 1-2.83-2.83l8.49-8.49',
            })
          )

        // ================================================================================= //
        // MARK: - CATEGORY UTILITIES
        // ================================================================================= //

        // Функция для получения иконки категории
        const getCategoryIcon = iconName => {
          const iconMap = {
            Grid: Grid,
            Activity: Activity,
            Calendar: Calendar,
            Clock: Clock,
            DollarSign: DollarSign,
            Settings: Settings,
            Play: Play,
            CheckCircle: CheckCircle,
            Bell: Bell,
            Upload: Upload,
            Download: Download,
            Database: Database,
            Folder: Folder,
            FileText: FileText,
            Users: Users,
            Layers: Layers,
            CheckSquare: CheckSquare,
            X: X,
            Pin: Pin,
          }
          return iconMap[iconName] || Grid
        }

        // Кастомный выпадающий список для категорий с иконками
        const CategoryDropdown = ({ value, onChange, categories, className = '', onKeyDown }) => {
          const [isOpen, setIsOpen] = useState(false)
          const dropdownRef = useRef(null)
          const selectedCategory = categories?.find(cat => cat.id === value)

          useEffect(() => {
            const handleClickOutside = event => {
              if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                setIsOpen(false)
              }
            }
            document.addEventListener('mousedown', handleClickOutside)
            return () => document.removeEventListener('mousedown', handleClickOutside)
          }, [])

          return h(
            'div',
            { ref: dropdownRef, className: `relative ${className}` },
            h(
              'button',
              {
                type: 'button',
                onClick: () => setIsOpen(!isOpen),
                onKeyDown: onKeyDown,
                className:
                  'w-full px-4 py-3 border border-gray-200 dark:border-gray-700 rounded-xl glass-effect text-gray-900 dark:text-white text-sm flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 transition-all duration-200 hover:border-gray-300 dark:hover:border-gray-600 hover:scale-105',
              },
              selectedCategory
                ? h(
                    'div',
                    { className: 'flex items-center gap-3' },
                    h('div', {
                      className: 'w-3 h-3 rounded-full shadow-sm',
                      style: { backgroundColor: selectedCategory.color },
                    }),
                    h(getCategoryIcon(selectedCategory.icon), {
                      size: 16,
                      className: 'text-gray-500 dark:text-gray-400',
                    }),
                    h('span', { className: 'font-medium' }, selectedCategory.name)
                  )
                : h(
                    'span',
                    { className: 'text-gray-500 dark:text-gray-400' },
                    'Выберите категорию'
                  ),
              h(
                'svg',
                {
                  className: `w-4 h-4 transition-transform duration-200 text-gray-400 ${isOpen ? 'rotate-180' : ''}`,
                  fill: 'none',
                  stroke: 'currentColor',
                  viewBox: '0 0 24 24',
                },
                h('path', {
                  strokeLinecap: 'round',
                  strokeLinejoin: 'round',
                  strokeWidth: 2,
                  d: 'M19 9l-7 7-7-7',
                })
              )
            ),
            h(
              'div',
              {
                className:
                  'absolute z-[9999999999] w-full mt-2 glass-effect border border-gray-200 dark:border-gray-700 rounded-xl shadow-2xl max-h-48 overflow-y-auto custom-scrollbar backdrop-blur-sm dropdown-panel',
                'data-open': isOpen,
              },
              categories?.map(category =>
                h(
                  'button',
                  {
                    key: category.id,
                    type: 'button',
                    onClick: () => {
                      onChange(category.id)
                      setIsOpen(false)
                    },
                    className: `w-full px-4 py-3 text-left hover:bg-gray-100/50 dark:hover:bg-gray-700/50 flex items-center gap-3 transition-colors duration-150 first:rounded-t-xl last:rounded-b-xl menu-item-hover ${value === category.id ? 'bg-blue-50/50 dark:bg-blue-900/20 border-l-2 border-l-blue-500' : ''}`,
                  },
                  h('div', {
                    className: 'w-3 h-3 rounded-full shadow-sm',
                    style: { backgroundColor: category.color },
                  }),
                  h(getCategoryIcon(category.icon), {
                    size: 16,
                    className: 'text-gray-500 dark:text-gray-400',
                  }),
                  h(
                    'span',
                    { className: 'text-sm font-medium text-gray-900 dark:text-white' },
                    category.name
                  )
                )
              )
            )
          )
        }

        const InfoTooltip = ({ text }) =>
          h(
            'div',
            { className: 'relative flex items-center group' },
            h(InfoIcon, { size: 16, className: 'text-gray-400 dark:text-gray-500 cursor-pointer' }),
            h(
              'div',
              {
                className:
                  'absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-2 text-sm text-gray-900 dark:text-gray-100 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10 glass-effect border border-gray-200/60 dark:border-gray-700/60 bg-white/40 dark:bg-gray-900/40',
              },
              text
            )
          )

        // Модальное окно для редактирования записей
        const EditEntryModal = ({ isOpen, onClose, entry, onSave, categories, allEntries }) => {
          const [isClosing, setIsClosing] = useState(false)

          // Блокировка скролла фона
          useEffect(() => {
            if (isOpen) {
              document.body.style.overflow = 'hidden'
            } else {
              document.body.style.overflow = ''
            }
            return () => {
              document.body.style.overflow = ''
            }
          }, [isOpen])

          const [editedEntry, setEditedEntry] = useState(
            entry || {
              start: '',
              end: '',
              categoryId: categories?.find(cat => cat.isDefault)?.id || categories?.[0]?.id || '',
              breakMinutes: 0,
              rate: 0,
              earned: '',
            }
          )

          const [validationErrors, setValidationErrors] = useState({})
          const [isValidating, setIsValidating] = useState(false)
          const validationTimeoutRef = useRef(null)

          // Функция для расчета дневного заработка
          const getDailyEarnings = () => {
            if (!entry?.date) return 0

            const dayEntries = allEntries.filter(e => e.date === entry.date)
            const totalEarned = dayEntries.reduce((sum, e) => sum + (e.earned || 0), 0)
            return totalEarned
          }

          // Функция для обработки закрытия с анимацией
          const handleClose = () => {
            setIsClosing(true)
            setTimeout(() => {
              onClose()
              setIsClosing(false)
            }, 300) // Длительность анимации закрытия
          }

          // Debounce функция для оптимизации
          const debounce = (func, delay) => {
            return (...args) => {
              clearTimeout(validationTimeoutRef.current)
              validationTimeoutRef.current = setTimeout(() => func.apply(null, args), delay)
            }
          }

          // Функция валидации
          const validateEntry = entryData => {
            const errors = {}

            // Проверка обязательных полей
            if (!entryData.start) {
              errors.start = 'Время начала обязательно'
            }
            if (!entryData.end) {
              errors.end = 'Время окончания обязательно'
            }
            if (!entryData.earned || entryData.earned <= 0) {
              errors.earned = 'Сумма должна быть больше 0'
            }

            // Проверка логики времени
            if (entryData.start && entryData.end) {
              const startMinutes = timeToMinutes(entryData.start)
              const endMinutes = timeToMinutes(entryData.end)

              if (startMinutes >= endMinutes) {
                errors.timeLogic = 'Время начала должно быть раньше времени окончания'
              }
            }

            // Проверка пересечений с другими записями
            if (entryData.start && entryData.end && allEntries) {
              const currentDate = entryData.date || new Date().toISOString().split('T')[0]
              const currentEntryId = entryData.id

              const sameDayEntries = allEntries.filter(
                e => e.date === currentDate && e.id !== currentEntryId
              )

              const startMinutes = timeToMinutes(entryData.start)
              const endMinutes = timeToMinutes(entryData.end)

              for (const otherEntry of sameDayEntries) {
                if (otherEntry.start && otherEntry.end) {
                  const otherStart = timeToMinutes(otherEntry.start)
                  const otherEnd = timeToMinutes(otherEntry.end)

                  // Проверяем пересечение: (start < otherEnd) && (end > otherStart)
                  if (startMinutes < otherEnd && endMinutes > otherStart) {
                    errors.timeOverlap = `Время пересекается с записью ${otherEntry.start} → ${otherEntry.end}`
                    break
                  }
                }
              }
            }

            return errors
          }

          // Оптимизированная валидация для реального времени (только пересечения)
          const validateTimeOverlap = entryData => {
            if (!entryData.start || !entryData.end || !allEntries) return null

            const currentDate = entryData.date || new Date().toISOString().split('T')[0]
            const currentEntryId = entryData.id

            // Фильтруем только записи за тот же день
            const sameDayEntries = allEntries.filter(
              e => e.date === currentDate && e.id !== currentEntryId && e.start && e.end
            )

            // Если нет записей за этот день, пересечений нет
            if (sameDayEntries.length === 0) return null

            const startMinutes = timeToMinutes(entryData.start)
            const endMinutes = timeToMinutes(entryData.end)

            // Проверяем только пересечения
            for (const otherEntry of sameDayEntries) {
              const otherStart = timeToMinutes(otherEntry.start)
              const otherEnd = timeToMinutes(otherEntry.end)

              if (startMinutes < otherEnd && endMinutes > otherStart) {
                return `Время пересекается с записью ${otherEntry.start} → ${otherEntry.end}`
              }
            }

            return null
          }

          // Debounced функция для валидации пересечений
          const debouncedValidateOverlap = debounce(entryData => {
            setIsValidating(true)
            const overlapError = validateTimeOverlap(entryData)

            setValidationErrors(prev => ({
              ...prev,
              timeOverlap: overlapError,
            }))

            setIsValidating(false)
          }, 500) // 500ms задержка

          useEffect(() => {
            if (entry) {
              setEditedEntry(entry)
            } else {
              // При создании новой записи устанавливаем текущее время в начало
              const now = new Date()
              const currentTime = now.toTimeString().slice(0, 5) // HH:MM формат
              setEditedEntry({
                start: currentTime,
                end: '',
                categoryId: categories?.find(cat => cat.isDefault)?.id || categories?.[0]?.id || '',
                breakMinutes: 0,
                rate: 0,
                earned: '',
              })
            }
          }, [entry, categories, isOpen]) // Добавляем isOpen в зависимости

          // Очищаем таймер при закрытии модального окна
          useEffect(() => {
            if (!isOpen) {
              clearTimeout(validationTimeoutRef.current)
              setValidationErrors({})
              setIsValidating(false)
            }
          }, [isOpen])

          const handleSave = () => {
            const errors = validateEntry(editedEntry)
            setValidationErrors(errors)

            if (Object.keys(errors).length === 0) {
              onSave(editedEntry)
              onClose()
            }
          }

          const handleKeyDown = e => {
            if (e.key === 'Escape') onClose()
            if (e.key === 'Enter' && e.ctrlKey) handleSave()
          }

          const handleFieldChange = (field, value) => {
            const newEntry = { ...editedEntry, [field]: value }
            setEditedEntry(newEntry)

            // Очищаем ошибку для этого поля при изменении
            if (validationErrors[field]) {
              setValidationErrors({ ...validationErrors, [field]: null })
            }

            // Запускаем валидацию пересечений в реальном времени для полей времени
            if ((field === 'start' || field === 'end') && newEntry.start && newEntry.end) {
              debouncedValidateOverlap(newEntry)
            }

            // Мгновенная валидация логики времени
            if (field === 'start' || field === 'end') {
              if (newEntry.start && newEntry.end) {
                const startMinutes = timeToMinutes(newEntry.start)
                const endMinutes = timeToMinutes(newEntry.end)

                if (startMinutes >= endMinutes) {
                  setValidationErrors(prev => ({
                    ...prev,
                    timeLogic: 'Время начала должно быть раньше времени окончания',
                  }))
                } else {
                  setValidationErrors(prev => ({
                    ...prev,
                    timeLogic: null,
                  }))
                }
              }
            }
          }

          if (!isOpen) return null

          return ReactDOM.createPortal(
            h(
              'div',
              {
                className: `fixed inset-0 z-[9999999999] flex items-center justify-center bg-black/50 backdrop-blur-sm modal-backdrop-animated ${isClosing ? 'closing' : ''}`,
                onClick: handleClose,
              },
              h(
                'div',
                {
                  className: `glass-effect rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 w-full max-w-md mx-4 modal-content-animated ${isClosing ? 'closing' : ''}`,
                  onClick: e => e.stopPropagation(),
                  onKeyDown: handleKeyDown,
                },
                // Заголовок
                h(
                  'div',
                  {
                    className:
                      'flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700',
                  },
                  h(
                    'h3',
                    { className: 'text-lg font-semibold text-gray-900 dark:text-white' },
                    entry ? 'Редактирование записи' : 'Новая запись'
                  ),
                  h(
                    'button',
                    {
                      onClick: handleClose,
                      className:
                        'p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400 button-animated',
                    },
                    h(
                      'svg',
                      {
                        width: 20,
                        height: 20,
                        viewBox: '0 0 24 24',
                        fill: 'none',
                        stroke: 'currentColor',
                        strokeWidth: 2,
                        strokeLinecap: 'round',
                        strokeLinejoin: 'round',
                      },
                      h('line', { x1: 18, y1: 6, x2: 6, y2: 18 }),
                      h('line', { x1: 6, y1: 6, x2: 18, y2: 18 })
                    )
                  )
                ),

                // Форма
                h(
                  'div',
                  { className: 'p-6 space-y-4' },
                  // Время начала
                  h(
                    'div',
                    {},
                    h(
                      'label',
                      {
                        className:
                          'block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1',
                      },
                      'Начало'
                    ),
                    h('input', {
                      type: 'time',
                      value: editedEntry.start,
                      onChange: e => handleFieldChange('start', e.target.value),
                      className: `w-full px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent ${validationErrors.start ? 'border-red-500 dark:border-red-500' : 'border-gray-300 dark:border-gray-600'}`,
                    }),
                    validationErrors.start &&
                      h('p', { className: 'text-red-500 text-xs mt-1' }, validationErrors.start)
                  ),

                  // Время окончания
                  h(
                    'div',
                    {},
                    h(
                      'label',
                      {
                        className:
                          'block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1',
                      },
                      'Конец'
                    ),
                    h('input', {
                      type: 'time',
                      value: editedEntry.end,
                      onChange: e => handleFieldChange('end', e.target.value),
                      className: `w-full px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent ${validationErrors.end ? 'border-red-500 dark:border-red-500' : 'border-gray-300 dark:border-gray-600'}`,
                    }),
                    validationErrors.end &&
                      h('p', { className: 'text-red-500 text-xs mt-1' }, validationErrors.end)
                  ),

                  // Категория
                  h(
                    'div',
                    {},
                    h(
                      'label',
                      {
                        className:
                          'block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1',
                      },
                      'Категория'
                    ),
                    h(CategoryDropdown, {
                      value: editedEntry.categoryId || '',
                      onChange: categoryId => setEditedEntry({ ...editedEntry, categoryId }),
                      categories: categories,
                      className: 'w-full',
                    })
                  ),

                  // Сумма
                  h(
                    'div',
                    {},
                    h(
                      'label',
                      {
                        className:
                          'block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1',
                      },
                      'Сумма (₽)'
                    ),
                    h('input', {
                      type: 'number',
                      min: 0,
                      value: editedEntry.earned || '',
                      onChange: e => handleFieldChange('earned', parseInt(e.target.value) || 0),
                      className: `w-full px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent ${validationErrors.earned ? 'border-red-500 dark:border-red-500' : 'border-gray-300 dark:border-gray-600'}`,
                    }),
                    validationErrors.earned &&
                      h('p', { className: 'text-red-500 text-xs mt-1' }, validationErrors.earned)
                  ),

                  // Индикатор валидации
                  isValidating &&
                    h(
                      'div',
                      {
                        className:
                          'p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg',
                      },
                      h(
                        'div',
                        { className: 'flex items-center gap-2' },
                        h('div', {
                          className: 'animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600',
                        }),
                        h(
                          'p',
                          { className: 'text-blue-600 dark:text-blue-400 text-sm' },
                          'Проверка пересечений...'
                        )
                      )
                    ),

                  // Общие ошибки валидации
                  (validationErrors.timeLogic || validationErrors.timeOverlap) &&
                    h(
                      'div',
                      {
                        className:
                          'p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg',
                      },
                      validationErrors.timeLogic &&
                        h(
                          'p',
                          { className: 'text-red-600 dark:text-red-400 text-sm' },
                          validationErrors.timeLogic
                        ),
                      validationErrors.timeOverlap &&
                        h(
                          'p',
                          { className: 'text-red-600 dark:text-red-400 text-sm' },
                          validationErrors.timeOverlap
                        )
                    )
                ),

                // Дневной заработок
                entry?.date &&
                  h(
                    'div',
                    {
                      className:
                        'px-6 py-4 border-t border-gray-200 dark:border-gray-700 modal-content',
                    },
                    h(
                      'div',
                      { className: 'flex items-center justify-between' },
                      h(
                        'div',
                        { className: 'flex items-center gap-2' },
                        h('div', { className: 'w-2 h-2 bg-green-500 rounded-full' }),
                        h(
                          'span',
                          { className: 'text-sm font-medium text-gray-700 dark:text-gray-300' },
                          'Заработок за день:'
                        )
                      ),
                      h(
                        'span',
                        { className: 'text-lg font-bold text-green-600 dark:text-green-400' },
                        `${getDailyEarnings().toLocaleString('ru-RU')} ₽`
                      )
                    )
                  ),

                // Кнопки
                h(
                  'div',
                  {
                    className:
                      'flex justify-end gap-3 p-6 border-t border-gray-200 dark:border-gray-700',
                  },
                  h(
                    'button',
                    {
                      onClick: onClose,
                      className:
                        'glass-button glass-button-gray px-4 py-2 rounded-lg transition-all duration-200 hover:scale-105',
                    },
                    'Отмена'
                  ),
                  h(
                    'button',
                    {
                      onClick: handleSave,
                      className:
                        'glass-button glass-button-blue px-4 py-2 rounded-lg transition-all duration-200 hover:scale-105',
                    },
                    'Сохранить'
                  )
                )
              )
            ),
            document.body
          )
        }

        // Лого программы (адаптивные цвета по теме)
        const ProgramLogo = ({ size = 96, className = '', theme = 'dark' }) => {
          const isDark = theme === 'dark'
          const clockGradientStart = isDark ? '#60a5fa' : '#1d4ed8'
          const clockGradientEnd = isDark ? '#1e3a8a' : '#3b82f6'
          const tickColor = isDark ? '#9fb3c8' : '#64748b'
          const handColor = isDark ? '#fca5a5' : '#fb7185'
          const barGradientTop = isDark ? '#60a5fa' : '#2563eb'
          const barGradientBottom = isDark ? '#4c1d95' : '#7c3aed'
          const arrowColor = isDark ? '#22c55e' : '#10b981'
          return h(
            'svg',
            {
              xmlns: 'http://www.w3.org/2000/svg',
              width: size,
              height: size,
              viewBox: '0 0 128 128',
              className,
            },
            // мягкое свечение
            h(
              'defs',
              {},
              h(
                'linearGradient',
                { id: 'pl-clock', x1: '0', y1: '0', x2: '1', y2: '1' },
                h('stop', { offset: '0%', stopColor: clockGradientStart }),
                h('stop', { offset: '100%', stopColor: clockGradientEnd })
              ),
              h(
                'linearGradient',
                { id: 'pl-bars', x1: '0', y1: '0', x2: '0', y2: '1' },
                h('stop', { offset: '0%', stopColor: barGradientTop }),
                h('stop', { offset: '100%', stopColor: barGradientBottom })
              ),
              h(
                'filter',
                { id: 'pl-glow', x: '-50%', y: '-50%', width: '200%', height: '200%' },
                h('feGaussianBlur', { stdDeviation: 2, result: 'coloredBlur' }),
                h(
                  'feMerge',
                  {},
                  h('feMergeNode', { in: 'coloredBlur' }),
                  h('feMergeNode', { in: 'SourceGraphic' })
                )
              )
            ),
            // дуга часов
            h('path', {
              d: 'M30 54 a34 34 0 0 1 60 0',
              fill: 'none',
              stroke: 'url(#pl-clock)',
              strokeWidth: 8,
              strokeLinecap: 'round',
              filter: 'url(#pl-glow)',
            }),
            // риски
            h('circle', { cx: 60, cy: 68, r: 6, fill: barGradientTop }),
            h('line', {
              x1: 60,
              y1: 44,
              x2: 60,
              y2: 60,
              stroke: tickColor,
              strokeWidth: 6,
              strokeLinecap: 'round',
            }),
            h('line', {
              x1: 72,
              y1: 76,
              x2: 92,
              y2: 88,
              stroke: handColor,
              strokeWidth: 6,
              strokeLinecap: 'round',
            }),
            // бары
            h('rect', { x: 38, y: 84, width: 12, height: 28, rx: 3, fill: 'url(#pl-bars)' }),
            h('rect', { x: 56, y: 78, width: 12, height: 34, rx: 3, fill: 'url(#pl-bars)' }),
            h('rect', { x: 74, y: 66, width: 12, height: 46, rx: 3, fill: 'url(#pl-bars)' }),
            h('rect', { x: 92, y: 52, width: 12, height: 60, rx: 3, fill: 'url(#pl-bars)' }),
            // линия/стрелка роста
            h('path', {
              d: 'M28 96 L50 80 L72 92 L96 58 L114 44',
              fill: 'none',
              stroke: arrowColor,
              strokeWidth: 8,
              strokeLinecap: 'round',
              strokeLinejoin: 'round',
            }),
            h('polygon', { points: '114,44 114,58 126,34 112,34 112,22', fill: arrowColor })
          )
        }

        const ChartTypeSwitcher = ({ currentType, onChange }) => {
          const types = ['bar', 'line', 'area']
          const labels = { bar: 'Столбцы', line: 'Линия', area: 'Область' }
          return h(
            'div',
            {
              className:
                'flex items-center gap-1 p-1 glass-effect rounded-lg border border-gray-300 dark:border-gray-500/30',
            },
            types.map(type =>
              h(
                'button',
                {
                  key: type,
                  onClick: () => onChange(type),
                  className: `px-3 py-1 text-xs rounded-md transition-all ${currentType === type ? 'glass-button glass-button-blue text-blue-600 dark:text-blue-300 font-semibold' : 'text-gray-500 dark:text-gray-300 hover:bg-gray-300/50 dark:hover:bg-gray-700/50'}`,
                },
                labels[type]
              )
            )
          )
        }

        const ConfirmModal = ({ show, onClose, onConfirm, title, children }) => {
          const [isClosing, setIsClosing] = useState(false)

          // Блокировка скролла фона
          useEffect(() => {
            if (show) {
              document.body.style.overflow = 'hidden'
            } else {
              document.body.style.overflow = ''
            }
            return () => {
              document.body.style.overflow = ''
            }
          }, [show])

          // Обработка закрытия с анимацией
          const handleClose = () => {
            setIsClosing(true)
            setTimeout(() => {
              onClose()
              setIsClosing(false)
            }, 200)
          }

          if (!show) return null
          return h(
            'div',
            {
              className: `fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 backdrop-blur-sm ${isClosing ? 'modal-backdrop-exit' : 'modal-backdrop-enter'}`,
            },
            h(
              'div',
              {
                className: `glass-effect p-8 rounded-xl shadow-2xl w-full max-w-md border border-gray-200 dark:border-gray-700 ${isClosing ? 'modal-exit' : 'modal-enter'}`,
              },
              h(
                'div',
                { className: 'flex items-center gap-4 mb-4' },
                h(
                  'div',
                  {
                    className:
                      'w-12 h-12 rounded-full bg-red-100 dark:bg-red-500/20 flex items-center justify-center',
                  },
                  h(AlertTriangle, { className: 'text-red-600', size: 28 })
                ),
                h('h2', { className: 'text-2xl font-bold text-gray-900 dark:text-white' }, title)
              ),
              h('p', { className: 'text-gray-600 dark:text-gray-400 mb-6' }, children),
              h(
                'div',
                { className: 'flex justify-end gap-4' },
                h(
                  'button',
                  {
                    onClick: handleClose,
                    className:
                      'px-6 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-all button-animated',
                  },
                  'Отмена'
                ),
                h(
                  'button',
                  {
                    onClick: onConfirm,
                    className:
                      'glass-button glass-button-red px-6 py-2 rounded-lg font-semibold button-animated',
                  },
                  'Да, удалить'
                )
              )
            )
          )
        }

        // ================================================================================= //
        // MARK: - ABOUT MODAL
        // ================================================================================= //
        const AboutModal = ({ show, onClose }) => {
          const [activeTab, setActiveTab] = useState('about')
          const [isClosing, setIsClosing] = useState(false)
          const [isResizing, setIsResizing] = useState(false)

          // Блокировка скролла фона
          useEffect(() => {
            if (show) {
              document.body.style.overflow = 'hidden'
            } else {
              document.body.style.overflow = ''
            }
            return () => {
              document.body.style.overflow = ''
            }
          }, [show])

          // Обработка закрытия с анимацией
          const handleClose = () => {
            setIsClosing(true)
            setTimeout(() => {
              onClose()
              setIsClosing(false)
            }, 200)
          }

          if (!show) return null

          const versionHistory = [
            {
              version: 'v0.8.0_beta',
              title: 'Настройка рабочего графика и кастомные графики',
              changes: [
                'Добавлена настройка рабочего графика с выбором шаблонов',
                'Поддержка стандартного графика 5/2 и сменных графиков 2/2, 3/3, 5/5',
                'Кастомный график с возможностью выбора рабочих дней вручную',
                'Автоматический пересчет месячных планов на основе выбранного графика',
                'Интерактивный календарь для настройки индивидуального графика',
                'Выбор начала рабочей недели для всех типов графиков',
                'Синхронизация настроек между компонентами приложения',
                'Обновленная аналитика с корректными расчетами планов',
              ],
            },
            {
              version: 'v0.7.9_beta',
              title: 'Плавающая панель таймера и улучшения интерфейса',
              changes: [
                'Добавлена плавающая панель таймера с расширенными возможностями',
                'Стеклянный дизайн для всех кнопок и выпадающих меню',
                'Отображение дневного заработка в модальном окне редактирования',
                'Исправлены графики с видом "Область" во всех разделах аналитики',
                'Улучшена прозрачность выпадающих меню',
                'Добавлены настройки плавающей панели в основном интерфейсе',
                'Анимации появления и исчезновения плавающей панели',
                'Единый стеклянный стиль для всех элементов интерфейса',
              ],
            },
            {
              version: 'v0.7.7_beta',
              title: 'Массовые операции и улучшения UI',
              changes: [
                'Система массовых операций с записями',
                'Выбор записей через чекбоксы',
                'Массовое удаление, экспорт и изменение категорий',
                'Улучшенные плашки статистики',
                'Оптимизированные отступы в заголовках',
                'Исправлены синтаксические ошибки',
                'Улучшена стабильность приложения',
                'Обновленное приветственное окно с новым функционалом',
              ],
            },
            {
              version: 'v0.7.6_beta',
              title: 'Улучшенное приветственное окно',
              changes: [
                'Переработанное окно Добро пожаловать с новой структурой',
                'Добавлена инструкция по работе с категориями',
                'Улучшена навигация и читаемость',
                'Цветовое разделение разделов',
                'Обновленная документация импорта',
              ],
            },
            {
              version: 'v0.7.5_beta',
              title: 'Категоризация записей и аналитика',
              changes: [
                'Полная система категоризации записей',
                'Модальное окно редактирования записей',
                'Графики аналитики по категориям',
                'Управление категориями',
                'Цветовая кодировка и иконки',
                'Двойной клик для редактирования',
                'Контекстные меню',
                'Валидация данных',
                'Автоматические расчеты',
                'Улучшенный UI/UX',
              ],
            },
            {
              version: 'v0.7.0_beta',
              title: 'Бета-версия с оптимизациями',
              changes: [
                'Мемоизация функций',
                'Оптимизация localStorage',
                'Дебаунсинг событий',
                'GPU ускорение',
                'Единый стиль модальных окон',
              ],
            },
            {
              version: 'v6.18.3.2',
              title: 'Новый режим "Таймлайн"',
              changes: [
                'Визуализация временной шкалы',
                'Интерактивные эффекты',
                'Улучшенный дизайн',
              ],
            },
            {
              version: 'v6.18.2',
              title: 'Новые инсайты',
              changes: ['Самая длинная сессия', 'Улучшенная логика инсайтов', 'Визуальные правки'],
            },
            {
              version: 'v6.18.1',
              title: 'Редизайн инсайтов',
              changes: ['Новый дизайн с градиентами', 'Крупные иконки', 'Улучшенная читаемость'],
            },
            {
              version: 'v6.18.0',
              title: 'Блок "Инсайты"',
              changes: [
                'Автоматический анализ данных',
                'Лучший день недели',
                'Пик продуктивности',
                'Тренд заработка',
              ],
            },
            {
              version: 'v6.17.7',
              title: 'Резервное копирование',
              changes: ['Автоматические бэкапы', 'Восстановление данных', 'Проверка бэкапов'],
            },
            {
              version: 'v6.17.6',
              title: 'Система Undo/Redo',
              changes: ['Отмена действий', 'Горячие клавиши', 'Быстрая отмена'],
            },
            {
              version: 'v6.17.0',
              title: 'Оптимизация',
              changes: ['Ленивая загрузка аналитики', 'Ускорение загрузки'],
            },
            {
              version: 'v6.13.0',
              title: 'UI Overhaul',
              changes: ['Glassmorphism дизайн', 'Новый шрифт Inter', 'Календарь доходов'],
            },
            {
              version: 'v6.1.0',
              title: 'Масштабный редизайн',
              changes: ['Режимы отображения', 'Группировка по дням', 'Настройки по умолчанию'],
            },
          ]

          return h(
            'div',
            {
              className: `fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 backdrop-blur-sm ${isClosing ? 'modal-backdrop-exit' : 'modal-backdrop-enter'}`,
            },
            h(
              'div',
              {
                className: `glass-effect p-8 rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col border border-gray-200 dark:border-gray-700 transition-all duration-500 ease-in-out ${isClosing ? 'modal-exit' : 'modal-enter'} ${isResizing ? 'modal-resize' : ''}`,
              },
              // Header
              h(
                'div',
                { className: 'flex justify-between items-center mb-4' },
                h(
                  'h2',
                  { className: 'text-2xl font-bold text-gray-900 dark:text-white' },
                  'О программе'
                ),
                h(
                  'button',
                  {
                    onClick: handleClose,
                    className:
                      'p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors',
                  },
                  h(CloseIcon, { size: 24 })
                )
              ),

              // Tabs
              h(
                'div',
                { className: 'flex border-b border-gray-200 dark:border-gray-700' },
                h(
                  'button',
                  {
                    onClick: () => {
                      setIsResizing(true)
                      setTimeout(() => {
                        setActiveTab('about')
                        setTimeout(() => setIsResizing(false), 100)
                      }, 200)
                    },
                    className: `px-6 py-3 text-sm font-medium transition-colors ${activeTab === 'about' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200'}`,
                  },
                  'О программе'
                ),
                h(
                  'button',
                  {
                    onClick: () => {
                      setIsResizing(true)
                      setTimeout(() => {
                        setActiveTab('history')
                        setTimeout(() => setIsResizing(false), 100)
                      }, 200)
                    },
                    className: `px-6 py-3 text-sm font-medium transition-colors ${activeTab === 'history' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200'}`,
                  },
                  'История версий'
                ),
                h(
                  'button',
                  {
                    onClick: () => {
                      setIsResizing(true)
                      setTimeout(() => {
                        setActiveTab('tech')
                        setTimeout(() => setIsResizing(false), 100)
                      }, 200)
                    },
                    className: `px-6 py-3 text-sm font-medium transition-colors ${activeTab === 'tech' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200'}`,
                  },
                  'Технологии'
                )
              ),

              // Content
              h(
                'div',
                {
                  className:
                    'overflow-y-auto custom-scrollbar pr-4 text-gray-600 dark:text-gray-400 space-y-6 transition-all duration-300 ease-in-out',
                },
                activeTab === 'about' &&
                  h(
                    'div',
                    { className: 'space-y-6 animate-fadeIn' },
                    h(
                      'div',
                      {},
                      h(
                        'h3',
                        { className: 'font-bold text-lg text-gray-900 dark:text-white mb-2' },
                        'Описание'
                      ),
                      h(
                        'p',
                        {},
                        'Time Tracker Dashboard - это современное веб-приложение для отслеживания рабочего времени, анализа продуктивности и управления доходами. Приложение построено на React с использованием современных технологий и оптимизировано для максимальной производительности.'
                      )
                    ),
                    h(
                      'div',
                      {},
                      h(
                        'h3',
                        { className: 'font-bold text-lg text-gray-900 dark:text-white mb-2' },
                        'Основные возможности'
                      ),
                      h(
                        'ul',
                        { className: 'space-y-2' },
                        h(
                          'li',
                          { className: 'flex items-center gap-2' },
                          h('span', { className: 'text-blue-500' }, '•'),
                          'Отслеживание рабочего времени с таймером'
                        ),
                        h(
                          'li',
                          { className: 'flex items-center gap-2' },
                          h('span', { className: 'text-blue-500' }, '•'),
                          'Детальная аналитика и графики'
                        ),
                        h(
                          'li',
                          { className: 'flex items-center gap-2' },
                          h('span', { className: 'text-blue-500' }, '•'),
                          'Автоматические инсайты и рекомендации'
                        ),
                        h(
                          'li',
                          { className: 'flex items-center gap-2' },
                          h('span', { className: 'text-blue-500' }, '•'),
                          'Планирование и прогнозирование доходов'
                        ),
                        h(
                          'li',
                          { className: 'flex items-center gap-2' },
                          h('span', { className: 'text-blue-500' }, '•'),
                          'Резервное копирование и восстановление'
                        ),
                        h(
                          'li',
                          { className: 'flex items-center gap-2' },
                          h('span', { className: 'text-blue-500' }, '•'),
                          'Современный Glassmorphism дизайн'
                        ),
                        h(
                          'li',
                          { className: 'flex items-center gap-2' },
                          h('span', { className: 'text-blue-500' }, '•'),
                          'Поддержка темной и светлой темы'
                        )
                      )
                    )
                  ),

                activeTab === 'history' &&
                  h(
                    'div',
                    { className: 'space-y-4 animate-fadeIn' },
                    h(
                      'div',
                      { className: 'flex items-center justify-between mb-4' },
                      h(
                        'h3',
                        { className: 'font-bold text-lg text-gray-900 dark:text-white' },
                        'Последние версии'
                      ),
                      h(
                        'a',
                        {
                          href: 'VERSION_HISTORY.md',
                          target: '_blank',
                          download: 'VERSION_HISTORY.md',
                          className: 'text-sm text-blue-600 hover:text-blue-700 underline',
                        },
                        'Полная история →'
                      )
                    ),
                    ...versionHistory.map((item, index) =>
                      h(
                        'div',
                        {
                          key: index,
                          className: 'border border-gray-200 dark:border-gray-700 rounded-lg p-4',
                        },
                        h(
                          'div',
                          { className: 'flex items-center gap-3 mb-2' },
                          h(
                            'span',
                            {
                              className:
                                'px-2 py-1 bg-blue-100 dark:bg-blue-500/20 text-blue-800 dark:text-blue-300 text-xs font-semibold rounded',
                            },
                            item.version
                          ),
                          h(
                            'h4',
                            { className: 'font-semibold text-gray-900 dark:text-white' },
                            item.title
                          )
                        ),
                        h(
                          'ul',
                          { className: 'space-y-1 text-sm text-gray-600 dark:text-gray-400' },
                          ...item.changes.map((change, changeIndex) =>
                            h(
                              'li',
                              { key: changeIndex, className: 'flex items-center gap-2' },
                              h('span', { className: 'text-blue-500' }, '•'),
                              change
                            )
                          )
                        )
                      )
                    )
                  ),

                activeTab === 'tech' &&
                  h(
                    'div',
                    { className: 'space-y-6 animate-fadeIn' },
                    h(
                      'div',
                      {},
                      h(
                        'h3',
                        { className: 'font-bold text-lg text-gray-900 dark:text-white mb-2' },
                        'Технологии'
                      ),
                      h(
                        'div',
                        { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
                        h(
                          'div',
                          { className: 'space-y-3' },
                          h(
                            'h4',
                            { className: 'font-medium text-gray-900 dark:text-white' },
                            'Frontend'
                          ),
                          h(
                            'ul',
                            { className: 'space-y-1 text-sm text-gray-600 dark:text-gray-400' },
                            h(
                              'li',
                              { className: 'flex items-center gap-2' },
                              h('span', { className: 'text-blue-500' }, '•'),
                              'React 18'
                            ),
                            h(
                              'li',
                              { className: 'flex items-center gap-2' },
                              h('span', { className: 'text-blue-500' }, '•'),
                              'HTML5 & CSS3'
                            ),
                            h(
                              'li',
                              { className: 'flex items-center gap-2' },
                              h('span', { className: 'text-blue-500' }, '•'),
                              'Tailwind CSS'
                            ),
                            h(
                              'li',
                              { className: 'flex items-center gap-2' },
                              h('span', { className: 'text-blue-500' }, '•'),
                              'Glassmorphism'
                            )
                          )
                        ),
                        h(
                          'div',
                          { className: 'space-y-3' },
                          h(
                            'h4',
                            { className: 'font-medium text-gray-900 dark:text-white' },
                            'Библиотеки'
                          ),
                          h(
                            'ul',
                            { className: 'space-y-1 text-sm text-gray-600 dark:text-gray-400' },
                            h(
                              'li',
                              { className: 'flex items-center gap-2' },
                              h('span', { className: 'text-blue-500' }, '•'),
                              'Recharts'
                            ),
                            h(
                              'li',
                              { className: 'flex items-center gap-2' },
                              h('span', { className: 'text-blue-500' }, '•'),
                              'Tone.js'
                            ),
                            h(
                              'li',
                              { className: 'flex items-center gap-2' },
                              h('span', { className: 'text-blue-500' }, '•'),
                              'Lucide React'
                            ),
                            h(
                              'li',
                              { className: 'flex items-center gap-2' },
                              h('span', { className: 'text-blue-500' }, '•'),
                              'Inter Font'
                            )
                          )
                        )
                      )
                    ),
                    h(
                      'div',
                      {},
                      h(
                        'h3',
                        { className: 'text-lg font-semibold text-gray-900 dark:text-white mb-3' },
                        'Хранение данных'
                      ),
                      h(
                        'ul',
                        { className: 'space-y-2 text-gray-600 dark:text-gray-400' },
                        h(
                          'li',
                          { className: 'flex items-center gap-2' },
                          h('span', { className: 'text-blue-500' }, '•'),
                          'localStorage - основное хранение'
                        ),
                        h(
                          'li',
                          { className: 'flex items-center gap-2' },
                          h('span', { className: 'text-blue-500' }, '•'),
                          'IndexedDB - резервные копии'
                        ),
                        h(
                          'li',
                          { className: 'flex items-center gap-2' },
                          h('span', { className: 'text-blue-500' }, '•'),
                          'Автоматическая синхронизация'
                        ),
                        h(
                          'li',
                          { className: 'flex items-center gap-2' },
                          h('span', { className: 'text-blue-500' }, '•'),
                          'Экспорт/Импорт JSON'
                        )
                      )
                    )
                  )
              )
            )
          )
        }

        const Dropdown = ({ options, selected, onSelect, buttonClassName, children }) => {
          const [isOpen, setIsOpen] = useState(false)
          const buttonRef = useRef(null)
          const dropdownRef = useRef(null)
          const { style, openUp } = usePortalPosition({
            triggerRef: buttonRef,
            portalRef: dropdownRef,
            isOpen,
            gap: 4,
          })

          useEffect(() => {
            if (!isOpen) return
            const handleClickOutside = event => {
              if (buttonRef.current?.contains(event.target)) return
              if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                setIsOpen(false)
              }
            }
            document.addEventListener('mousedown', handleClickOutside)
            return () => document.removeEventListener('mousedown', handleClickOutside)
          }, [isOpen])

          return h(
            'div',
            {},
            h(
              'button',
              {
                ref: buttonRef,
                onClick: () => setIsOpen(!isOpen),
                className: `${buttonClassName} transition-all duration-200 hover:scale-105`,
              },
              typeof children === 'function'
                ? selected && options[selected]
                  ? h('span', {}, options[selected])
                  : null
                : children ||
                    (selected && options[selected] ? h('span', {}, options[selected]) : null)
            ),
            createPortal(
              h(
                'div',
                {
                  ref: dropdownRef,
                  style: { ...style, minWidth: '200px', maxWidth: '300px' },
                  className:
                    'dropdown-menu glass-effect rounded-lg shadow-xl z-50 p-2 border border-gray-200 dark:border-gray-700 dropdown-panel backdrop-blur-md',
                  'data-open': isOpen,
                  'data-open-up': openUp,
                },
                Object.entries(options).map(([key, label]) => {
                  if (typeof children === 'function') {
                    const childElement = children({
                      optionKey: key,
                      label,
                      closeMenu: () => setIsOpen(false),
                    })
                    return React.cloneElement(childElement, {
                      key,
                      className: `${childElement.props.className || ''} menu-item-hover`,
                    })
                  }
                  return h(
                    'button',
                    {
                      key,
                      className:
                        'text-left w-full px-2 py-1.5 text-sm hover:bg-gray-500/10 rounded-md text-gray-800 dark:text-gray-200 transition-colors duration-150 menu-item-hover',
                      onClick: () => {
                        onSelect(key)
                        setIsOpen(false)
                      },
                    },
                    label
                  )
                })
              ),
              document.getElementById('portal-container')
            )
          )
        }

        const NotificationToast = ({ message, type, onClose, showUndo, onUndo }) => {
          useEffect(() => {
            const timer = setTimeout(onClose, showUndo ? 6000 : 4000)
            return () => clearTimeout(timer)
          }, [onClose, showUndo])
          const isSuccess = type === 'success'
          const mainClasses = isSuccess
            ? 'bg-green-500/10 text-green-800 dark:text-green-300 border-green-500/20'
            : 'bg-red-500/10 text-red-800 dark:text-red-300 border-red-500/20'
          const iconContainerClasses = isSuccess ? 'bg-green-500/20' : 'bg-red-500/20'
          const iconClasses = isSuccess
            ? 'text-green-600 dark:text-green-400'
            : 'text-red-600 dark:text-red-400'
          return createPortal(
            h(
              'div',
              {
                className: `fixed top-5 right-5 z-50 flex items-center p-4 rounded-xl shadow-lg glass-effect border ${mainClasses}`,
              },
              h(
                'div',
                { className: `mr-3 p-2 rounded-full ${iconContainerClasses}` },
                isSuccess
                  ? h(CheckCircle, { size: 20, className: iconClasses })
                  : h(AlertTriangle, { size: 20, className: iconClasses })
              ),
              h(
                'div',
                { className: 'flex-grow' },
                h('span', { className: 'font-medium' }, message),
                showUndo &&
                  h(
                    'button',
                    {
                      onClick: onUndo,
                      className:
                        'ml-4 text-sm font-semibold text-blue-600 dark:text-blue-400 hover:underline',
                    },
                    'Отменить'
                  )
              ),
              h(
                'button',
                {
                  onClick: onClose,
                  className:
                    'ml-auto -mr-1 p-1.5 rounded-full hover:bg-black/10 dark:hover:bg-white/10 transition-colors',
                },
                h(CloseIcon, { size: 18 })
              )
            ),
            document.getElementById('portal-container')
          )
        }
        const Portal = ({ children }) =>
          createPortal(children, document.getElementById('portal-container'))

        const TutorialModal = ({ show, onClose, onImport }) => {
          const [detailsOpen, setDetailsOpen] = useState(false)
          const [isClosing, setIsClosing] = useState(false)

          // Блокировка скролла фона
          useEffect(() => {
            if (show) {
              document.body.style.overflow = 'hidden'
            } else {
              document.body.style.overflow = ''
            }
            return () => {
              document.body.style.overflow = ''
            }
          }, [show])

          // Обработка закрытия с анимацией
          const handleClose = () => {
            setIsClosing(true)
            setTimeout(() => {
              onClose()
              setIsClosing(false)
            }, 200)
          }

          if (!show) return null
          return h(
            'div',
            {
              className: `fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 backdrop-blur-sm ${isClosing ? 'modal-backdrop-exit' : 'modal-backdrop-enter'}`,
            },
            h(
              'div',
              {
                className: `glass-effect p-8 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col border border-gray-200 dark:border-gray-700 ${isClosing ? 'modal-exit' : 'modal-enter'}`,
              },
              h(
                'div',
                { className: 'flex justify-between items-center mb-4' },
                h(
                  'h2',
                  { className: 'text-2xl font-bold text-gray-900 dark:text-white' },
                  'Добро пожаловать в Трекер!'
                ),
                h(
                  'button',
                  {
                    onClick: handleClose,
                    className:
                      'p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors',
                  },
                  h(CloseIcon, { size: 24 })
                )
              ),
              h(
                'div',
                {
                  className:
                    'overflow-y-auto custom-scrollbar pr-4 text-gray-600 dark:text-gray-400 space-y-6',
                },
                // ИДЕЯ
                h(
                  'div',
                  {
                    className:
                      'p-4 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-500/30',
                  },
                  h(
                    'h3',
                    {
                      className:
                        'font-bold text-lg text-blue-800 dark:text-blue-300 mb-2 flex items-center gap-2',
                    },
                    h(Info, { size: 20 }),
                    'Идея'
                  ),
                  h(
                    'p',
                    { className: 'text-blue-700 dark:text-blue-400' },
                    'Это приложение помогает отслеживать ваше рабочее время и доходы. Все данные хранятся локально в вашем браузере для максимальной приватности.'
                  )
                ),

                // ИНСТРУКЦИЯ
                h(
                  'div',
                  {
                    className:
                      'p-4 rounded-lg bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-500/30',
                  },
                  h(
                    'h3',
                    {
                      className:
                        'font-bold text-lg text-green-800 dark:text-green-300 mb-3 flex items-center gap-2',
                    },
                    h(HelpCircle, { size: 20 }),
                    'Инструкция'
                  ),
                  h(
                    'div',
                    { className: 'space-y-3' },
                    h(
                      'div',
                      {},
                      h(
                        'h4',
                        { className: 'font-semibold text-green-700 dark:text-green-400 mb-1' },
                        'Основные действия:'
                      ),
                      h(
                        'ul',
                        { className: 'list-disc list-inside space-y-1 ml-2' },
                        h(
                          'li',
                          {},
                          h('strong', {}, 'Добавить запись:'),
                          ' Нажмите "Добавить" или клавишу ',
                          h(
                            'kbd',
                            {
                              className:
                                'px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg dark:bg-gray-600 dark:text-gray-100 dark:border-gray-500',
                            },
                            'N'
                          ),
                          '. Заполните время начала, конца и заработок.'
                        ),
                        h(
                          'li',
                          {},
                          h('strong', {}, 'Таймер:'),
                          ' Нажмите "Старт" (',
                          h(
                            'kbd',
                            {
                              className:
                                'px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg dark:bg-gray-600 dark:text-gray-100 dark:border-gray-500',
                            },
                            'S'
                          ),
                          ') для начала отсчета. После остановки вы сможете отредактировать заработок.'
                        ),
                        h(
                          'li',
                          {},
                          h('strong', {}, 'Редактирование:'),
                          ' Двойной клик на запись или правый клик → "Редактировать". Для сохранения нажмите ',
                          h(
                            'kbd',
                            {
                              className:
                                'px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg dark:bg-gray-600 dark:text-gray-100 dark:border-gray-500',
                            },
                            'Enter'
                          ),
                          ', для отмены - ',
                          h(
                            'kbd',
                            {
                              className:
                                'px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg dark:bg-gray-600 dark:text-gray-100 dark:border-gray-500',
                            },
                            'Esc'
                          ),
                          '.'
                        ),
                        h(
                          'li',
                          {},
                          h('strong', {}, 'Отмена/Повтор:'),
                          ' Используйте ',
                          h('kbd', {}, 'Ctrl+Z'),
                          ' для отмены и ',
                          h('kbd', {}, 'Ctrl+Shift+Z'),
                          ' для повтора действий.'
                        )
                      )
                    ),
                    h(
                      'div',
                      {},
                      h(
                        'h4',
                        { className: 'font-semibold text-green-700 dark:text-green-400 mb-1' },
                        'Работа с категориями:'
                      ),
                      h(
                        'ul',
                        { className: 'list-disc list-inside space-y-1 ml-2' },
                        h(
                          'li',
                          {},
                          h('strong', {}, 'Настройка категорий:'),
                          ' Нажмите на иконку шестеренки (',
                          h(Settings, { size: 14, className: 'inline-block' }),
                          ') → "Настройка категорий" для создания и редактирования категорий.'
                        ),
                        h(
                          'li',
                          {},
                          h('strong', {}, 'Выбор категории:'),
                          ' При создании/редактировании записи выберите категорию из выпадающего списка. По умолчанию используется категория по умолчанию.'
                        ),
                        h(
                          'li',
                          {},
                          h('strong', {}, 'Аналитика по категориям:'),
                          ' В разделе "Аналитика" доступны графики "Время по категориям" и "Эффективность по категориям" для анализа работы по проектам.'
                        )
                      )
                    )
                  )
                ),

                // ДОПОЛНИТЕЛЬНЫЕ ВОЗМОЖНОСТИ
                h(
                  'div',
                  {
                    className:
                      'p-4 rounded-lg bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-500/30',
                  },
                  h(
                    'h3',
                    {
                      className:
                        'font-bold text-lg text-purple-800 dark:text-purple-300 mb-3 flex items-center gap-2',
                    },
                    h(Settings, { size: 20 }),
                    'Дополнительные возможности'
                  ),
                  h(
                    'ul',
                    { className: 'list-disc list-inside space-y-1' },
                    h(
                      'li',
                      {},
                      h('strong', {}, 'Смена темы:'),
                      ' Нажимайте на иконку солнца (',
                      h(Sun, { size: 14, className: 'inline-block' }),
                      ') или луны (',
                      h(Moon, { size: 14, className: 'inline-block' }),
                      ') в шапке приложения для переключения между светлой и темной темами.'
                    ),
                    h(
                      'li',
                      {},
                      h('strong', {}, 'Звуковые уведомления:'),
                      ' В меню настроек (',
                      h(Bell, { size: 14, className: 'inline-block' }),
                      ') можно включить/выключить звуковые оповещения таймера, а также настроить их интервал и тип звука.'
                    ),
                    h(
                      'li',
                      {},
                      h('strong', {}, 'Анимация иконки:'),
                      ' Там же, в настройках, можно управлять анимацией иконки в заголовке вкладки во время работы таймера: включать/выключать, менять стиль, скорость и цвет.'
                    ),
                    h(
                      'li',
                      {},
                      h('strong', {}, 'Плавающая панель таймера:'),
                      ' Новая функция - плавающая панель с расширенными возможностями. Показывает быструю статистику (часы, ставка, доход) и позволяет переключать темы оформления. Настройки доступны через кнопку мобильного устройства в шапке.'
                    ),
                    h(
                      'li',
                      {},
                      h('strong', {}, 'Настройка рабочего графика:'),
                      ' Теперь вы можете выбрать шаблон рабочего графика (стандартный 5/2, сменные 2/2, 3/3, 5/5) или настроить кастомный график, выбрав рабочие дни вручную. Это влияет на расчет месячных планов и отображение статистики.'
                    ),
                    h(
                      'li',
                      {},
                      h('strong', {}, 'Аналитика:'),
                      ' Раздел "Аналитика" содержит множество графиков для визуализации ваших данных с возможностью настройки отображения и закрепления по умолчанию.'
                    ),
                    h(
                      'li',
                      {},
                      h('strong', {}, 'Массовые операции:'),
                      ' В разделе "Записи о работе" нажмите кнопку "Выбрать" для активации режима выбора записей. Выберите нужные записи чекбоксами и выполните массовые операции: удаление, экспорт или изменение категории.'
                    )
                  )
                ),

                // ВАЖНО: СОХРАННОСТЬ ДАННЫХ
                h(
                  'div',
                  {
                    className:
                      'p-4 rounded-lg bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-500/30',
                  },
                  h(
                    'h3',
                    {
                      className:
                        'font-bold text-lg text-red-800 dark:text-red-300 mb-2 flex items-center gap-2',
                    },
                    h(AlertTriangle, { size: 20 }),
                    '⚠️ ВАЖНО: Сохранность данных'
                  ),
                  h(
                    'p',
                    { className: 'text-red-700 dark:text-red-400' },
                    'Все ваши записи хранятся ',
                    h('strong', {}, 'только в вашем браузере'),
                    ' (`localStorage`). Если вы очистите данные сайта или смените браузер/компьютер, ',
                    h('strong', {}, 'все записи будут потеряны!')
                  ),
                  h(
                    'p',
                    { className: 'mt-2 text-red-700 dark:text-red-400' },
                    'Чтобы избежать потерь, регулярно используйте кнопку ',
                    h('strong', {}, '"Экспорт"'),
                    ' для сохранения резервной копии в файл. С помощью кнопки ',
                    h('strong', {}, '"Импорт"'),
                    ' вы можете восстановить данные из этого файла на любом устройстве.'
                  )
                ),

                // ИМПОРТ И ЭКСПОРТ
                h(
                  'div',
                  {},
                  h(
                    'h3',
                    {
                      className:
                        'font-bold text-lg text-gray-900 dark:text-white mb-2 flex items-center gap-2',
                    },
                    h(Upload, { size: 20 }),
                    'Импорт и Экспорт'
                  ),
                  h(
                    'p',
                    {},
                    'Если у вас есть данные за прошлый период работы, их можно импортировать через файл .json. Для этого воспользуйтесь кнопкой "Импорт".'
                  ),
                  h(
                    'details',
                    {
                      className: 'mt-2 text-sm bg-gray-100 dark:bg-gray-800/50 p-3 rounded-lg',
                      onToggle: e => setDetailsOpen(e.target.open),
                    },
                    h(
                      'summary',
                      {
                        className:
                          'cursor-pointer font-medium text-blue-600 dark:text-blue-400 hover:underline',
                      },
                      detailsOpen
                        ? 'Скрыть структуру файла для импорта'
                        : 'Показать структуру файла для импорта'
                    ),
                    h(
                      'pre',
                      {
                        className:
                          'bg-gray-200 dark:bg-gray-900 p-3 rounded-md text-xs mt-2 overflow-x-auto',
                      },
                      h(
                        'code',
                        {},
                        `{ "entries": [ { "id": 1728034080000, "date": "2025-10-04", "start": "07:48", "end": "08:13", "rate": 360, "earned": 150, "category": "Проект 1" } ], "dailyPlan": 6000 }`
                      )
                    ),
                    h(
                      'p',
                      { className: 'mt-2' },
                      'Ключи ',
                      h(
                        'code',
                        { className: 'text-xs bg-gray-200 dark:bg-gray-700 p-1 rounded' },
                        'dailyPlan'
                      ),
                      ' и ',
                      h(
                        'code',
                        { className: 'text-xs bg-gray-200 dark:bg-gray-700 p-1 rounded' },
                        'category'
                      ),
                      ' являются необязательными.'
                    )
                  )
                )
              ),
              h(
                'div',
                {
                  className:
                    'mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 flex justify-between',
                },
                h(
                  'button',
                  {
                    onClick: onImport,
                    className:
                      'glass-button glass-button-blue px-6 py-2 rounded-lg flex items-center gap-2 font-semibold button-animated',
                  },
                  h(Upload, { size: 18 }),
                  'Импортировать базу'
                ),
                h(
                  'button',
                  {
                    onClick: onClose,
                    className:
                      'px-6 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-all font-semibold button-animated',
                  },
                  'Начать с нуля'
                )
              )
            )
          )
        }

        const ScatterCustomTooltip = ({ active, payload }) => {
          if (active && payload && payload.length) {
            const data = payload[0].payload
            return h(
              'div',
              {
                className:
                  'glass-effect p-3 rounded-lg shadow-lg text-sm border border-gray-200 dark:border-gray-700',
              },
              h(
                'p',
                { className: 'font-bold text-gray-900 dark:text-white mb-1' },
                new Date(data.date).toLocaleDateString('ru-RU')
              ),
              h(
                'p',
                { className: 'text-gray-700 dark:text-gray-300' },
                `Часы: ${data.hours.toFixed(2)} ч`
              ),
              h(
                'p',
                { className: 'text-gray-700 dark:text-gray-300' },
                `Заработано: ${data.earned.toLocaleString('ru-RU')} ₽`
              )
            )
          }
          return null
        }

        // ================================================================================= //
        // MARK: - MAIN APP COMPONENTS (with useMemo/useCallback cleaned)
        // ================================================================================= //

        const getDailyTotalStyle = (dailyTotal, dailyPlan, theme) => {
          const percentage = Math.min(100, dailyPlan > 0 ? (dailyTotal / dailyPlan) * 100 : 0)
          const hue = (percentage / 100) * 120
          const saturation = theme === 'dark' ? 80 : 70
          const lightness = theme === 'dark' ? 60 : 40
          return { color: `hsl(${hue}, ${saturation}%, ${lightness}%)` }
        }

        const EditableRow = ({
          entry,
          isEditing,
          onUpdate,
          onCancel,
          onEdit,
          onDelete,
          breakMinutes,
          categories,
        }) => {
          const { editedEntry, handleChange, handleSave, handleKeyDown, earnedInputRef } =
            useEditableEntry({ entry, isEditing, onUpdate, onCancel })
          if (!isEditing) {
            return h(
              'div',
              { className: 'group relative border-t border-gray-200 dark:border-gray-700/50' },
              h(
                'div',
                {
                  className:
                    'grid grid-cols-[1fr_auto_80px_90px_96px_56px] gap-x-4 items-center py-1.5 px-3 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-md transition-colors',
                },
                h(
                  'div',
                  { className: 'flex items-center gap-2 truncate min-w-0' },
                  h(
                    'div',
                    { className: 'flex items-center gap-2' },
                    h(
                      'span',
                      { className: 'font-mono text-base text-gray-800 dark:text-gray-200' },
                      entry.start
                    ),
                    h(ArrowRight, {
                      size: 16,
                      className: 'text-gray-300 dark:text-gray-600 shrink-0',
                    }),
                    h(
                      'span',
                      { className: 'font-mono text-base text-gray-800 dark:text-gray-200' },
                      entry.end
                    )
                  )
                ),
                h(
                  'div',
                  { className: 'text-right' },
                  breakMinutes > 0 &&
                    h(
                      'div',
                      {
                        className:
                          'inline-flex items-center gap-1 text-xs text-blue-600 dark:text-blue-300 bg-blue-100 dark:bg-blue-900/30 px-2 py-0.5 rounded-full',
                      },
                      h(Clock, { size: 12 }),
                      h('span', {}, minutesToTime(breakMinutes))
                    )
                ),
                h(
                  'div',
                  { className: 'text-right font-semibold text-gray-800 dark:text-gray-200' },
                  `${calculateDuration(entry.start, entry.end).toFixed(2)} ч`
                ),
                h(
                  'div',
                  { className: 'flex items-center gap-1 justify-end' },
                  entry.categoryId &&
                    categories &&
                    (() => {
                      const category = categories.find(cat => cat.id === entry.categoryId)
                      return category
                        ? h(
                            'div',
                            { className: 'flex items-center gap-1' },
                            h('div', {
                              className: 'w-2 h-2 rounded-full',
                              style: { backgroundColor: category.color },
                            }),
                            h(getCategoryIcon(category.icon), {
                              size: 12,
                              className: 'text-gray-500 dark:text-gray-400',
                            }),
                            h(
                              'span',
                              { className: 'text-xs text-gray-500 dark:text-gray-400' },
                              category.name
                            )
                          )
                        : null
                    })()
                ),
                h(
                  'div',
                  { className: 'text-right text-gray-500 dark:text-gray-400 truncate' },
                  `${entry.rate.toLocaleString('ru-RU')} ₽/ч`
                ),
                h(
                  'div',
                  { className: 'text-right font-bold text-green-600 dark:text-green-400' },
                  `${entry.earned.toLocaleString('ru-RU', { maximumFractionDigits: 0 })} ₽`
                ),
                h(
                  'div',
                  {
                    className:
                      'flex items-center opacity-0 group-hover:opacity-100 transition-opacity duration-200',
                  },
                  h(
                    'button',
                    {
                      onClick: () => onEdit(entry.id),
                      className:
                        'p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-blue-600 dark:text-blue-400 transition-colors',
                    },
                    h(Edit2, { size: 16 })
                  ),
                  h(
                    'button',
                    {
                      onClick: () => onDelete(entry.id),
                      className:
                        'p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-red-500 transition-colors',
                    },
                    h(Trash2, { size: 16 })
                  )
                )
              )
            )
          }
          return h(
            'div',
            {
              className:
                'relative z-10 grid grid-cols-[1fr_1fr_1fr_auto] gap-4 p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-500/30',
            },
            h(
              'div',
              { className: 'flex flex-col' },
              h('label', { className: 'text-xs text-gray-500 dark:text-gray-400' }, 'Начало'),
              h('input', {
                type: 'time',
                value: editedEntry.start,
                onChange: e => handleChange('start', e.target.value),
                onKeyDown: handleKeyDown,
                className:
                  'p-1 border rounded w-full bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-800 dark:text-white [&::-webkit-calendar-picker-indicator]:hidden',
              })
            ),
            h(
              'div',
              { className: 'flex flex-col' },
              h('label', { className: 'text-xs text-gray-500 dark:text-gray-400' }, 'Конец'),
              h('input', {
                type: 'time',
                value: editedEntry.end,
                onChange: e => handleChange('end', e.target.value),
                onKeyDown: handleKeyDown,
                className:
                  'p-1 border rounded w-full bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-800 dark:text-white [&::-webkit-calendar-picker-indicator]:hidden',
              })
            ),
            h(
              'div',
              { className: 'flex flex-col' },
              h('label', { className: 'text-xs text-gray-500 dark:text-gray-400' }, 'Категория'),
              h(CategoryDropdown, {
                value: editedEntry.categoryId || '',
                onChange: categoryId => handleChange('categoryId', categoryId),
                onKeyDown: handleKeyDown,
                categories: categories,
                className: 'text-xs',
              })
            ),
            h(
              'div',
              { className: 'flex flex-col' },
              h(
                'label',
                { className: 'text-xs text-gray-500 dark:text-gray-400' },
                'Заработано (₽)'
              ),
              h('input', {
                ref: earnedInputRef,
                type: 'number',
                value: editedEntry.earned || '',
                placeholder: '0',
                onChange: e => handleChange('earned', e.target.value),
                onKeyDown: handleKeyDown,
                className:
                  'p-1 border rounded w-full bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-800 dark:text-white',
              })
            ),
            h(
              'div',
              { className: 'flex items-end gap-2 pb-1' },
              h(
                'button',
                {
                  onClick: handleSave,
                  className:
                    'p-2 rounded-full hover:bg-green-100 dark:hover:bg-green-900/50 text-green-500 transition-colors',
                },
                h(Save, { size: 18 })
              ),
              h(
                'button',
                {
                  onClick: onCancel,
                  className:
                    'p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-500 transition-colors',
                },
                h(CloseIcon, { size: 18 })
              )
            )
          )
        }

        const GridItem = ({
          entry,
          isEditing,
          onUpdate,
          onCancel,
          onEdit,
          onDelete,
          breakMinutes,
          categories,
        }) => {
          const [isMenuOpen, setIsMenuOpen] = useState(false)
          const menuRef = useRef(null)
          const { editedEntry, handleChange, handleSave, handleKeyDown, earnedInputRef } =
            useEditableEntry({ entry, isEditing, onUpdate, onCancel })
          useEffect(() => {
            const handleClickOutside = event => {
              if (menuRef.current && !menuRef.current.contains(event.target)) {
                setIsMenuOpen(false)
              }
            }
            document.addEventListener('mousedown', handleClickOutside)
            return () => document.removeEventListener('mousedown', handleClickOutside)
          }, [])
          if (isEditing) {
            return h(
              'div',
              {
                className:
                  'p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-xs border border-blue-200 dark:border-blue-500/30',
              },
              h(
                'div',
                { className: 'grid grid-cols-[1fr_1fr_1fr_auto] gap-2 items-end' },
                h(
                  'div',
                  {},
                  h(
                    'label',
                    { className: 'block text-gray-500 dark:text-gray-400 text-xs mb-1' },
                    'Время'
                  ),
                  h(
                    'div',
                    { className: 'flex items-center gap-1' },
                    h('input', {
                      type: 'time',
                      value: editedEntry.start,
                      onChange: e => handleChange('start', e.target.value),
                      onKeyDown: handleKeyDown,
                      className:
                        'p-1 border rounded bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-800 dark:text-white text-xs [&::-webkit-calendar-picker-indicator]:hidden w-20',
                    }),
                    h('span', {}, '-'),
                    h('input', {
                      type: 'time',
                      value: editedEntry.end,
                      onChange: e => handleChange('end', e.target.value),
                      onKeyDown: handleKeyDown,
                      className:
                        'p-1 border rounded bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-800 dark:text-white text-xs [&::-webkit-calendar-picker-indicator]:hidden w-20',
                    })
                  )
                ),
                h(
                  'div',
                  {},
                  h(
                    'label',
                    { className: 'block text-gray-500 dark:text-gray-400 text-xs mb-1' },
                    'Категория'
                  ),
                  h(CategoryDropdown, {
                    value: editedEntry.categoryId || '',
                    onChange: categoryId => handleChange('categoryId', categoryId),
                    onKeyDown: handleKeyDown,
                    categories: categories,
                    className: 'text-xs',
                  })
                ),
                h(
                  'div',
                  {},
                  h(
                    'label',
                    { className: 'block text-gray-500 dark:text-gray-400 text-xs mb-1' },
                    'Заработано (₽)'
                  ),
                  h('input', {
                    ref: earnedInputRef,
                    type: 'number',
                    value: editedEntry.earned || '',
                    onChange: e => handleChange('earned', e.target.value),
                    onKeyDown: handleKeyDown,
                    className:
                      'p-1 border rounded w-full bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-800 dark:text-white text-xs',
                    placeholder: 'Доход',
                  })
                ),
                h(
                  'div',
                  { className: 'flex items-center gap-1' },
                  h(
                    'button',
                    {
                      onClick: handleSave,
                      className:
                        'p-2 rounded-full hover:bg-green-100 dark:hover:bg-green-900/50 text-green-500 transition-colors',
                    },
                    h(Save, { size: 16 })
                  ),
                  h(
                    'button',
                    {
                      onClick: onCancel,
                      className:
                        'p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-500 transition-colors',
                    },
                    h(CloseIcon, { size: 16 })
                  )
                )
              )
            )
          }
          const isNewEntry = false // Можно добавить логику для определения новых записей
          return h(
            'div',
            {
              className: `${isNewEntry ? 'entry-item-new' : `entry-item-animated ${shouldAnimateEntries ? 'animate' : ''}`} ${shouldAnimateEntries ? 'cascade-drop' : ''} group relative grid grid-cols-[1fr_auto_auto_auto_auto_auto] gap-1 px-1 py-0.5 text-xs hover:bg-gray-100 dark:hover:bg-gray-800 rounded transition-colors`,
            },
            h(
              'div',
              { className: 'flex items-center' },
              h(
                'span',
                { className: 'font-mono text-gray-600 dark:text-gray-300' },
                `${entry.start}-${entry.end}`
              )
            ),
            h(
              'div',
              { className: 'flex items-center justify-end' },
              breakMinutes > 0 &&
                h(
                  'div',
                  {
                    className:
                      'inline-flex items-center gap-1 text-blue-600 dark:text-blue-300 bg-blue-100 dark:bg-blue-900/30 px-1.5 py-0.5 rounded-full',
                  },
                  h(Clock, { size: 10 }),
                  h('span', {}, minutesToTime(breakMinutes))
                )
            ),
            h(
              'div',
              { className: 'flex items-center justify-end' },
              h(
                'span',
                { className: 'font-mono text-gray-500 dark:text-gray-400' },
                `${entry.rate.toLocaleString('ru-RU')}₽/ч`
              )
            ),
            h(
              'div',
              { className: 'flex items-center justify-end' },
              entry.categoryId &&
                categories &&
                (() => {
                  const category = categories.find(cat => cat.id === entry.categoryId)
                  return category
                    ? h(
                        'div',
                        { className: 'flex items-center gap-1' },
                        h('div', {
                          className: 'w-1 h-1 rounded-full',
                          style: { backgroundColor: category.color },
                        }),
                        h(getCategoryIcon(category.icon), {
                          size: 8,
                          className: 'text-gray-400 dark:text-gray-500',
                        })
                      )
                    : null
                })()
            ),
            h(
              'div',
              { className: 'flex items-center justify-end' },
              h(
                'span',
                { className: 'font-semibold text-green-600 dark:text-green-400' },
                `${entry.earned.toLocaleString('ru-RU', { maximumFractionDigits: 0 })}₽`
              )
            ),
            h(
              'div',
              { className: 'flex items-center justify-center', ref: menuRef },
              h(
                'button',
                {
                  onClick: () => setIsMenuOpen(s => !s),
                  className:
                    'p-0.5 rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-gray-200 dark:hover:bg-gray-700',
                },
                h(MoreVertical, { size: 12 })
              ),
              isMenuOpen &&
                h(
                  'div',
                  {
                    className:
                      'absolute right-full top-1/2 -translate-y-1/2 mr-1 flex items-center bg-gray-200 dark:bg-gray-700 rounded-md shadow-lg z-20 border border-gray-300 dark:border-gray-600 p-1',
                  },
                  h(
                    'button',
                    {
                      onClick: () => {
                        onEdit(entry.id)
                        setIsMenuOpen(false)
                      },
                      className:
                        'p-1 text-blue-600 dark:text-blue-400 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-sm transition-colors',
                    },
                    h(Edit2, { size: 16 })
                  ),
                  h(
                    'button',
                    {
                      onClick: () => {
                        onDelete(entry.id)
                        setIsMenuOpen(false)
                      },
                      className:
                        'p-1 text-red-500 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-sm transition-colors',
                    },
                    h(Trash2, { size: 14 })
                  )
                )
            )
          )
        }

        const ComparisonStat = ({ current, previous }) => {
          if (previous == null || previous === 0) {
            if (current > 0)
              return h(
                'div',
                {
                  className:
                    'absolute top-4 right-4 text-xs font-bold flex items-center text-green-300',
                  style: { textShadow: '0 0 5px rgba(0,0,0,0.7)' },
                },
                h(ArrowUp, { size: 14 }),
                '∞%'
              )
            return null
          }
          const percentageChange = ((current - previous) / previous) * 100
          const isPositive = percentageChange >= 0
          return h(
            'div',
            {
              className: `absolute top-4 right-4 text-xs font-bold flex items-center ${isPositive ? 'text-green-300' : 'text-red-300'}`,
              style: { textShadow: '0 0 5px rgba(0,0,0,0.7)' },
            },
            isPositive ? h(ArrowUp, { size: 14 }) : h(ArrowDown, { size: 14 }),
            `${Math.abs(percentageChange).toFixed(1)}%`
          )
        }

        const StatCard = ({ title, value, icon, gradient, children, accentClass }) => {
          const getFontSize = text => {
            const len = String(text).length
            if (len > 11) return '1.4rem'
            if (len > 8) return '1.6rem'
            return '1.875rem'
          }

          return h(
            'div',
            {
              className: `relative overflow-hidden rounded-xl p-4 ${gradient} border ${accentClass ? `border-${accentClass}/20 dark:border-${accentClass}/40` : ''} transition-all duration-300 timeline-info-card hover:translate-y-0.5`,
            },
            // Иконка (маленькая, в правом нижнем углу, полупрозрачная)
            h(
              'div',
              {
                className: `absolute right-4 bottom-4 w-16 h-16 text-${accentClass}/50 dark:text-${accentClass}/10 insight-icon`,
              },
              icon
            ),
            // Заголовок (добавлен text-gray-900 dark:text-white)
            h(
              'h3',
              { className: 'font-bold text-sm mb-1 text-gray-900 dark:text-white text-shadow' },
              title
            ),
            // Значение (добавлен text-gray-900 dark:text-white и восстановлен динамический размер шрифта)
            h(
              'div',
              { className: 'mt-2' },
              h(
                'span',
                {
                  className: 'font-semibold text-gray-900 dark:text-white text-shadow',
                  style: { fontSize: getFontSize(value) },
                },
                value
              )
            ),
            children
          )
        }

        const StatisticsDashboard = ({ compareMode }) => {
          const { entries } = useData()
          const { settings } = useSettings()
          const { headerFilter, customDateFrom, customDateTo } = settings
          const quickStats = (() => {
            const calculateStats = data => {
              if (data.length === 0)
                return {
                  totalHours: 0,
                  totalEarned: 0,
                  avgRate: 0,
                  daysWorked: 0,
                  totalBreaks: 0,
                  daysOff: 0,
                }
              const totalHours = data.reduce((sum, e) => sum + calculateDuration(e.start, e.end), 0)
              const totalEarned = data.reduce((sum, e) => sum + (e.earned || 0), 0)
              const breaksByDay = data.reduce(
                (acc, entry) => ({ ...acc, [entry.date]: [...(acc[entry.date] || []), entry] }),
                {}
              )
              let totalBreakMinutes = 0
              Object.values(breaksByDay).forEach(dayEntries => {
                const sorted = [...dayEntries].sort((a, b) => a.start.localeCompare(b.start))
                for (let i = 1; i < sorted.length; i++) {
                  const breakMinutes =
                    (timeToMinutes(sorted[i].start) + 24 * 60 - timeToMinutes(sorted[i - 1].end)) %
                    (24 * 60)
                  if (breakMinutes > 0) totalBreakMinutes += breakMinutes
                }
              })

              // Вычисляем выходные дни (дни БЕЗ записей)
              const workedDays = new Set(data.map(e => e.date))
              const daysWorked = workedDays.size

              // Определяем все дни в периоде и считаем дни БЕЗ записей
              let daysOff = 0
              const now = new Date()

              if (headerFilter === 'today') {
                // Сегодня: если есть записи = 0 выходных, если нет = 1 выходной
                daysOff = data.length === 0 ? 1 : 0
              } else if (headerFilter === 'week') {
                // Неделя: считаем дни без записей в текущей неделе
                const startOfWeek = new Date(now)
                startOfWeek.setDate(now.getDate() - now.getDay())
                for (let i = 0; i < 7; i++) {
                  const date = new Date(startOfWeek)
                  date.setDate(startOfWeek.getDate() + i)
                  const dateStr = date.toISOString().split('T')[0]
                  if (!workedDays.has(dateStr)) {
                    daysOff++
                  }
                }
              } else if (headerFilter === 'month') {
                // Месяц: количество всех дней в текущем месяце без записей
                const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate()
                for (let i = 1; i <= daysInMonth; i++) {
                  const date = new Date(now.getFullYear(), now.getMonth(), i)
                  const dateStr = date.toISOString().split('T')[0]
                  if (!workedDays.has(dateStr)) {
                    daysOff++
                  }
                }
              } else if (headerFilter === 'year') {
                // Год: количество всех дней в текущем году без записей
                const startOfYear = new Date(now.getFullYear(), 0, 1)
                const endOfYear = new Date(now.getFullYear(), 11, 31)
                const daysInYear = Math.ceil((endOfYear - startOfYear) / (1000 * 60 * 60 * 24)) + 1
                for (let i = 0; i < daysInYear; i++) {
                  const date = new Date(startOfYear)
                  date.setDate(startOfYear.getDate() + i)
                  const dateStr = date.toISOString().split('T')[0]
                  if (!workedDays.has(dateStr)) {
                    daysOff++
                  }
                }
              } else if (headerFilter === 'custom' && customDateFrom && customDateTo) {
                // Кастомный период: дни без записей в выбранном диапазоне
                const from = new Date(customDateFrom)
                const to = new Date(customDateTo)
                const daysInRange = Math.ceil((to - from) / (1000 * 60 * 60 * 24)) + 1
                for (let i = 0; i < daysInRange; i++) {
                  const date = new Date(from)
                  date.setDate(from.getDate() + i)
                  const dateStr = date.toISOString().split('T')[0]
                  if (!workedDays.has(dateStr)) {
                    daysOff++
                  }
                }
              } else {
                // Все время: количество всех дней в базе без записей до текущего момента
                if (data.length > 0) {
                  const firstDate = new Date(Math.min(...data.map(e => new Date(e.date))))
                  const today = new Date()
                  const daysInRange = Math.ceil((today - firstDate) / (1000 * 60 * 60 * 24)) + 1
                  for (let i = 0; i < daysInRange; i++) {
                    const date = new Date(firstDate)
                    date.setDate(firstDate.getDate() + i)
                    const dateStr = date.toISOString().split('T')[0]
                    if (!workedDays.has(dateStr) && date <= today) {
                      daysOff++
                    }
                  }
                }
              }

              return {
                totalHours,
                totalEarned,
                avgRate: totalHours > 0 ? totalEarned / totalHours : 0,
                daysWorked,
                totalBreaks: totalBreakMinutes / 60,
                daysOff,
              }
            }
            const filtered = getFilteredEntries(entries, headerFilter, customDateFrom, customDateTo)
            const currentStats = calculateStats(filtered)
            let previousStats = null
            const now = new Date()
            if (compareMode) {
              let prevFrom, prevTo
              if (headerFilter === 'today') {
                const yesterday = new Date()
                yesterday.setDate(now.getDate() - 1)
                prevFrom = prevTo = yesterday.toISOString().split('T')[0]
              } else if (headerFilter === 'week') {
                // Предыдущая неделя (понедельник-воскресенье)
                const lastWeek = new Date(now)
                lastWeek.setDate(now.getDate() - 7)
                const monday = new Date(lastWeek)
                monday.setDate(lastWeek.getDate() - lastWeek.getDay() + 1)
                const sunday = new Date(monday)
                sunday.setDate(monday.getDate() + 6)
                prevFrom = monday.toISOString().split('T')[0]
                prevTo = sunday.toISOString().split('T')[0]
              } else if (headerFilter === 'month') {
                const prevMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1)
                prevFrom = new Date(prevMonth.getFullYear(), prevMonth.getMonth(), 1)
                  .toISOString()
                  .split('T')[0]
                prevTo = new Date(prevMonth.getFullYear(), prevMonth.getMonth() + 1, 0)
                  .toISOString()
                  .split('T')[0]
              } else if (headerFilter === 'year') {
                const prevYear = now.getFullYear() - 1
                prevFrom = `${prevYear}-01-01`
                prevTo = `${prevYear}-12-31`
              }
              if (prevFrom && prevTo) {
                const previousFiltered = getFilteredEntries(entries, 'custom', prevFrom, prevTo)
                previousStats = calculateStats(previousFiltered)
              }
            }
            return { current: currentStats, previous: previousStats }
          })()
          return h(
            'div',
            { className: 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-6 mb-0' },
            h(
              StatCard,
              {
                title: 'Затрачено',
                value: `${quickStats.current.totalHours.toFixed(2)} ч.`,
                icon: h(Clock, { size: 80 }),
                gradient:
                  'bg-gradient-to-br from-blue-500/80 to-gray-900/20 dark:from-blue-500/20 dark:to-gray-900/20',
                accentClass: 'blue-500',
              },
              compareMode &&
                h(ComparisonStat, {
                  current: quickStats.current.totalHours,
                  previous: quickStats.previous?.totalHours,
                })
            ),
            h(
              StatCard,
              {
                title: 'Перерывы',
                value: `${quickStats.current.totalBreaks.toFixed(2)} ч.`,
                icon: h(Clock, { size: 80 }),
                gradient:
                  'bg-gradient-to-br from-teal-500/80 to-gray-900/20 dark:from-teal-500/20 dark:to-gray-900/20',
                accentClass: 'teal-500',
              },
              compareMode &&
                h(ComparisonStat, {
                  current: quickStats.current.totalBreaks,
                  previous: quickStats.previous?.totalBreaks,
                })
            ),
            h(
              StatCard,
              {
                title: 'Заработано',
                value: `${quickStats.current.totalEarned.toLocaleString('ru-RU', { maximumFractionDigits: 0 })} ₽`,
                icon: h(DollarSign, { size: 80 }),
                gradient:
                  'bg-gradient-to-br from-green-500/80 to-gray-900/20 dark:from-green-500/20 dark:to-gray-900/20',
                accentClass: 'green-500',
              },
              compareMode &&
                h(ComparisonStat, {
                  current: quickStats.current.totalEarned,
                  previous: quickStats.previous?.totalEarned,
                })
            ),
            h(
              StatCard,
              {
                title: 'Ставка',
                value: `${quickStats.current.avgRate.toFixed(0)} ₽/ч`,
                icon: h(TrendingUp, { size: 80 }),
                gradient:
                  'bg-gradient-to-br from-purple-500/80 to-gray-900/20 dark:from-purple-500/20 dark:to-gray-900/20',
                accentClass: 'purple-500',
              },
              compareMode &&
                h(ComparisonStat, {
                  current: quickStats.current.avgRate,
                  previous: quickStats.previous?.avgRate,
                })
            ),
            h(
              StatCard,
              {
                title: 'Рабочих дней',
                value: `${quickStats.current.daysWorked} д.`,
                icon: h(Calendar, { size: 80 }),
                gradient:
                  'bg-gradient-to-br from-orange-500/80 to-gray-900/20 dark:from-orange-500/20 dark:to-gray-900/20',
                accentClass: 'orange-500',
              },
              compareMode &&
                h(ComparisonStat, {
                  current: quickStats.current.daysWorked,
                  previous: quickStats.previous?.daysWorked,
                })
            ),
            h(StatCard, {
              title: 'Выходных',
              value: `${quickStats.current.daysOff || 0} д.`,
              icon: h(Moon, { size: 80 }),
              gradient:
                'bg-gradient-to-br from-yellow-500/80 to-gray-900/20 dark:from-yellow-500/20 dark:to-gray-900/20',
              accentClass: 'yellow-500',
            })
          )
        }

        const PlanFactCompactView = ({ onShowWorkSchedule }) => {
          const { entries } = useData()
          const { settings } = useSettings()
          const dailyPlan = settings?.dailyPlan || 6000

          // Функция для получения названия текущего рабочего графика
          const getWorkScheduleInfo = () => {
            if (settings?.customWorkDates && Object.keys(settings.customWorkDates).length > 0) {
              const now = new Date()
              const currentYear = now.getFullYear()
              const currentMonth = now.getMonth()
              const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate()

              // Считаем рабочие дни из customWorkDates
              let workDaysCount = 0
              for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`
                if (settings.customWorkDates[dateKey] !== false) {
                  workDaysCount++
                }
              }

              return {
                name: `Кастомный ${workDaysCount}/${daysInMonth}`,
              }
            }

            const template = settings?.workScheduleTemplate || '5/2'
            const templateNames = {
              '5/2': 'Стандартный 5/2',
              '2/2': 'Сменный 2/2',
              '3/3': 'Сменный 3/3',
              '5/5': 'Интенсивный 5/5',
            }

            return {
              name: templateNames[template] || templateNames['5/2'],
            }
          }

          const planFactData = (() => {
            const calculateFact = filter =>
              getFilteredEntries(entries, filter, null, null).reduce((sum, e) => sum + e.earned, 0)
            return {
              day: calculateFact('today'),
              firstHalfMonth: calculateFact('firstHalfMonth'),
              secondHalfMonth: calculateFact('secondHalfMonth'),
              month: calculateFact('month'),
              year: calculateFact('year'),
              allTime: entries.reduce((sum, e) => sum + e.earned, 0),
            }
          })()
          const { monthlyPlan, halfMonthPlan, firstHalfPlan, secondHalfPlan } = (() => {
            const now = new Date()
            const currentYear = now.getFullYear()
            const currentMonth = now.getMonth()

            // Рассчитываем рабочие дни в текущем месяце на основе настроек
            const workingDaysInMonth = calculateWorkingDaysInMonth(
              currentYear,
              currentMonth,
              1,
              null,
              settings
            )

            // Рассчитываем рабочие дни в первой и второй половине месяца
            const workingDaysFirstHalf = calculateWorkingDaysInMonth(
              currentYear,
              currentMonth,
              1,
              15,
              settings
            )
            const workingDaysSecondHalf = workingDaysInMonth - workingDaysFirstHalf

            const dailyPlanValue = typeof dailyPlan === 'number' && dailyPlan > 0 ? dailyPlan : 6000
            const calculatedMonthlyPlan = Math.round(dailyPlanValue * workingDaysInMonth)
            const firstHalfPlan = Math.round(dailyPlanValue * workingDaysFirstHalf)
            const secondHalfPlan = Math.round(dailyPlanValue * workingDaysSecondHalf)

            return {
              monthlyPlan: calculatedMonthlyPlan,
              halfMonthPlan: calculatedMonthlyPlan / 2, // Для обратной совместимости
              firstHalfPlan,
              secondHalfPlan,
            }
          })()
          const { day, firstHalfMonth, secondHalfMonth, month, year, allTime } = planFactData
          const now = new Date()
          const currentMonth = String(now.getMonth() + 1).padStart(2, '0')
          const nextMonthDate = new Date(now.getFullYear(), now.getMonth() + 1, 1)
          const nextMonth = String(nextMonthDate.getMonth() + 1).padStart(2, '0')
          return h(
            'div',
            { className: 'p-6 sm:p-8' },
            // Header
            h(
              'div',
              { className: 'flex justify-between items-center mb-8' },
              h(
                'div',
                {},
                h(
                  'h3',
                  {
                    className:
                      'text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2',
                  },
                  'План/факт заработка',
                  h(InfoTooltip, {
                    text: 'Этот раздел показывает ваш текущий доход, выплаты и общие итоги заработков. Для правильной работы статистики необходимо выставить ежедневный план.',
                  })
                )
              )
            ),
            // Stats Grid
            h(
              'div',
              { className: 'grid grid-cols-1 lg:grid-cols-3 gap-6' },
              // Card 1: Tekushij period
              h(
                'div',
                {
                  className:
                    'relative bg-blue-200 dark:bg-blue-500/10 border border-blue-300 dark:border-gray-700 rounded-2xl p-4 overflow-hidden transition-all duration-300 timeline-info-card hover-glow',
                },
                h(
                  'div',
                  { className: 'relative z-10' },
                  h(
                    'div',
                    { className: 'flex justify-between items-center mb-4' },
                    h(
                      'div',
                      { className: 'flex items-center gap-3' },
                      h(
                        'h4',
                        { className: 'font-semibold text-gray-800 dark:text-white' },
                        'План/факт'
                      ),
                      h(
                        'span',
                        {
                          className:
                            'px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 text-xs rounded-full font-medium',
                        },
                        getWorkScheduleInfo().name
                      )
                    ),
                    h(
                      'div',
                      { className: 'flex gap-1' },
                      h(
                        'button',
                        {
                          onClick: onShowWorkSchedule,
                          className:
                            'p-1.5 rounded-lg hover:bg-black/10 transition-colors text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white',
                          title: 'Настройка рабочего графика',
                        },
                        h(Settings, { className: 'w-4 h-4' })
                      )
                    )
                  ),
                  h(
                    'div',
                    { className: 'space-y-4' },
                    // День
                    h(
                      'div',
                      {},
                      h(
                        'div',
                        { className: 'flex justify-between items-baseline' },
                        h('p', { className: 'text-gray-500 dark:text-gray-400 text-sm' }, 'День'),
                        h(
                          'p',
                          {
                            className:
                              'insight-value text-xl font-bold text-gray-900 dark:text-white',
                          },
                          `${day.toLocaleString('ru-RU')} `,
                          h(
                            'span',
                            { className: 'text-base text-gray-500 dark:text-gray-400 font-medium' },
                            '₽'
                          )
                        )
                      ),
                      h(
                        'div',
                        {
                          className: 'w-full bg-gray-300 dark:bg-gray-700/50 rounded-full h-1 mt-1',
                        },
                        h('div', {
                          className: 'bg-blue-500 h-1 rounded-full',
                          style: {
                            width: `${dailyPlan > 0 ? Math.min(100, (day / dailyPlan) * 100) : 0}%`,
                          },
                        })
                      ),
                      h(
                        'p',
                        { className: 'text-right text-xs text-gray-500 dark:text-gray-400 mt-1' },
                        `План: ${dailyPlan.toLocaleString('ru-RU')} ₽`
                      )
                    ),
                    // Месяц
                    h(
                      'div',
                      {},
                      h(
                        'div',
                        { className: 'flex justify-between items-baseline' },
                        h('p', { className: 'text-gray-500 dark:text-gray-400 text-sm' }, 'Месяц'),
                        h(
                          'p',
                          {
                            className:
                              'insight-value text-xl font-bold text-gray-900 dark:text-white',
                          },
                          `${month.toLocaleString('ru-RU')} `,
                          h(
                            'span',
                            { className: 'text-base text-gray-500 dark:text-gray-400 font-medium' },
                            '₽'
                          )
                        )
                      ),
                      h(
                        'div',
                        {
                          className: 'w-full bg-gray-300 dark:bg-gray-700/50 rounded-full h-1 mt-1',
                        },
                        h('div', {
                          className: 'bg-purple-500 h-1 rounded-full',
                          style: {
                            width: `${monthlyPlan > 0 ? Math.min(100, (month / monthlyPlan) * 100) : 0}%`,
                          },
                        })
                      ),
                      h(
                        'p',
                        { className: 'text-right text-xs text-gray-500 dark:text-gray-400 mt-1' },
                        `План: ${monthlyPlan.toLocaleString('ru-RU')} ₽`
                      )
                    )
                  )
                ),
                h(Calendar, {
                  className:
                    'insight-icon absolute -right-5 -bottom-5 w-32 h-32 text-blue-400/30 dark:text-purple-500/5',
                })
              ),
              // Card 2: Vyplaty
              h(
                'div',
                {
                  className:
                    'relative bg-green-200 dark:bg-green-500/10 border border-green-300 dark:border-gray-700 rounded-2xl p-4 overflow-hidden transition-all duration-300 timeline-info-card hover-glow',
                },
                h(
                  'div',
                  { className: 'relative z-10' },
                  h(
                    'h4',
                    { className: 'font-semibold text-gray-800 dark:text-white mb-4' },
                    'Выплаты'
                  ),
                  h(
                    'div',
                    { className: 'space-y-4' },
                    // 1/2 месяца
                    h(
                      'div',
                      {},
                      h(
                        'div',
                        { className: 'flex justify-between items-baseline' },
                        h(
                          'p',
                          { className: 'text-gray-500 dark:text-gray-400 text-sm' },
                          `1/2 месяца `,
                          h(
                            'span',
                            { className: 'text-xs text-gray-400 dark:text-gray-500' },
                            `(выплата 25.${currentMonth})`
                          )
                        ),
                        h(
                          'p',
                          {
                            className:
                              'insight-value text-xl font-bold text-gray-900 dark:text-white',
                          },
                          `${firstHalfMonth.toLocaleString('ru-RU')} `,
                          h(
                            'span',
                            { className: 'text-base text-gray-500 dark:text-gray-400 font-medium' },
                            '₽'
                          )
                        )
                      ),
                      h(
                        'div',
                        {
                          className: 'w-full bg-gray-300 dark:bg-gray-700/50 rounded-full h-1 mt-1',
                        },
                        h('div', {
                          className: 'bg-green-500 h-1 rounded-full',
                          style: {
                            width: `${firstHalfPlan > 0 ? Math.min(100, (firstHalfMonth / firstHalfPlan) * 100) : 0}%`,
                          },
                        })
                      ),
                      h(
                        'p',
                        { className: 'text-right text-xs text-gray-500 dark:text-gray-400 mt-1' },
                        `План: ${firstHalfPlan.toLocaleString('ru-RU')} ₽`
                      )
                    ),
                    // 2/2 месяца
                    h(
                      'div',
                      {},
                      h(
                        'div',
                        { className: 'flex justify-between items-baseline' },
                        h(
                          'p',
                          { className: 'text-gray-500 dark:text-gray-400 text-sm' },
                          `2/2 месяца `,
                          h(
                            'span',
                            { className: 'text-xs text-gray-400 dark:text-gray-500' },
                            `(выплата 10.${nextMonth})`
                          )
                        ),
                        h(
                          'p',
                          {
                            className:
                              'insight-value text-xl font-bold text-gray-900 dark:text-white',
                          },
                          `${secondHalfMonth.toLocaleString('ru-RU')} `,
                          h(
                            'span',
                            { className: 'text-base text-gray-500 dark:text-gray-400 font-medium' },
                            '₽'
                          )
                        )
                      ),
                      h(
                        'div',
                        {
                          className: 'w-full bg-gray-300 dark:bg-gray-700/50 rounded-full h-1 mt-1',
                        },
                        h('div', {
                          className: 'bg-teal-500 h-1 rounded-full',
                          style: {
                            width: `${secondHalfPlan > 0 ? Math.min(100, (secondHalfMonth / secondHalfPlan) * 100) : 0}%`,
                          },
                        })
                      ),
                      h(
                        'p',
                        { className: 'text-right text-xs text-gray-500 dark:text-gray-400 mt-1' },
                        `План: ${secondHalfPlan.toLocaleString('ru-RU')} ₽`
                      )
                    )
                  )
                ),
                h(DollarSign, {
                  className:
                    'insight-icon absolute -right-5 -bottom-5 w-32 h-32 text-green-400/30 dark:text-green-500/5',
                })
              ),
              // Card 3: Obshie itogi
              h(
                'div',
                {
                  className:
                    'relative bg-orange-200 dark:bg-yellow-500/10 border border-orange-300 dark:border-gray-700 rounded-2xl p-4 overflow-hidden transition-all duration-300 timeline-info-card hover-glow',
                },
                h(
                  'div',
                  { className: 'relative z-10' },
                  h(
                    'h4',
                    { className: 'font-semibold text-gray-800 dark:text-white mb-4' },
                    'Общие итоги'
                  ),
                  h(
                    'div',
                    { className: 'space-y-6 flex flex-col justify-center h-full' },
                    // Год
                    h(
                      'div',
                      { className: 'border-l-4 border-orange-400 pl-4' },
                      h('p', { className: 'text-gray-500 dark:text-gray-400 text-sm' }, 'Год'),
                      h(
                        'p',
                        {
                          className:
                            'insight-value text-3xl font-bold text-gray-900 dark:text-white',
                        },
                        `${year.toLocaleString('ru-RU')} `,
                        h(
                          'span',
                          { className: 'text-xl text-gray-500 dark:text-gray-400 font-medium' },
                          '₽'
                        )
                      )
                    ),
                    // За все время
                    h(
                      'div',
                      { className: 'border-l-4 border-red-400 pl-4' },
                      h(
                        'p',
                        { className: 'text-gray-500 dark:text-gray-400 text-sm' },
                        'За все время'
                      ),
                      h(
                        'p',
                        {
                          className:
                            'insight-value text-3xl font-bold text-gray-900 dark:text-white',
                        },
                        `${allTime.toLocaleString('ru-RU')} `,
                        h(
                          'span',
                          { className: 'text-xl text-gray-500 dark:text-gray-400 font-medium' },
                          '₽'
                        )
                      )
                    )
                  )
                ),
                h(DollarSign, {
                  className:
                    'insight-icon absolute -right-5 -bottom-5 w-32 h-32 text-orange-400/30 dark:text-red-500/5',
                })
              )
            )
          )
        }

        const CalendarHeatmap = ({ data, theme }) => {
          const [currentDate, setCurrentDate] = useState(new Date())
          const [compareDate, setCompareDate] = useState(
            () => new Date(new Date().setMonth(new Date().getMonth() - 1))
          )
          const [isComparing, setIsComparing] = useState(false)
          const [hoveredDay, setHoveredDay] = useState(null)
          const [focusedDayIndex, setFocusedDayIndex] = useState(null)
          const tooltipRef = useRef(null)
          const calendarRef = useRef(null)

          const handleDateChange = setter => e => {
            const [year, month] = e.target.value.split('-').map(Number)
            setter(current => new Date(year, month - 1, 1))
          }
          const navigateMonth = (setter, amount) => () => {
            setter(current => new Date(current.getFullYear(), current.getMonth() + amount, 1))
          }
          const handleMouseMove = e => {
            if (tooltipRef.current) {
              tooltipRef.current.style.left = `${e.clientX + 15}px`
              tooltipRef.current.style.top = `${e.clientY + 15}px`
            }
          }
          useEffect(() => {
            window.addEventListener('mousemove', handleMouseMove)
            return () => window.removeEventListener('mousemove', handleMouseMove)
          }, [])

          const generateCalendar = date => {
            const year = date.getFullYear()
            const month = date.getMonth()
            const firstDay = new Date(year, month, 1)
            const lastDay = new Date(year, month + 1, 0)
            const days = []
            let startOffset = firstDay.getDay() - 1
            if (startOffset === -1) startOffset = 6
            for (let i = 0; i < startOffset; i++) {
              days.push({ key: `prev-${i}`, isPlaceholder: true })
            }
            for (let i = 1; i <= lastDay.getDate(); i++) {
              const dayDate = new Date(year, month, i)
              const dateString = dayDate.toISOString().split('T')[0]
              days.push({
                key: dateString,
                date: dayDate,
                data: data[dateString],
                isToday: dateString === new Date().toISOString().split('T')[0],
              })
            }
            return days
          }

          const handleKeyDown = (e, days) => {
            if (focusedDayIndex === null) return
            const totalDays = days.length
            let newIndex = focusedDayIndex

            switch (e.key) {
              case 'ArrowRight':
                newIndex = (focusedDayIndex + 1) % totalDays
                break
              case 'ArrowLeft':
                newIndex = (focusedDayIndex - 1 + totalDays) % totalDays
                break
              case 'ArrowDown':
                newIndex = (focusedDayIndex + 7) % totalDays
                break
              case 'ArrowUp':
                newIndex = (focusedDayIndex - 7 + totalDays) % totalDays
                break
              default:
                return
            }

            // Если вышли за пределы текущего месяца — переключаем месяц
            if (newIndex < 0 || newIndex >= totalDays) {
              if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                setCurrentDate(d => new Date(d.getFullYear(), d.getMonth() + 1, 1))
              } else {
                setCurrentDate(d => new Date(d.getFullYear(), d.getMonth() - 1, 1))
              }
              // Новый индекс будет рассчитан при следующем рендере
              return
            }

            setFocusedDayIndex(newIndex)
            const newDay = days[newIndex]
            if (!newDay.isPlaceholder) {
              setHoveredDay(newDay)
            }
            e.preventDefault()
          }

          const handleDayClick = (day, index) => {
            if (!day.isPlaceholder) {
              setFocusedDayIndex(index)
              setHoveredDay(day)
            }
          }

          const renderCalendar = (date, setDate, title) => {
            const monthDays = generateCalendar(date)
            const monthDataValues = monthDays.filter(d => d.data).map(d => d.data.totalEarned)
            const minEarned = Math.min(...monthDataValues)
            const maxEarned = Math.max(...monthDataValues)
            const getColor = value => {
              if (!value || maxEarned === minEarned) return 'rgba(34, 197, 94, 0.1)'
              const ratio = (value - minEarned) / (maxEarned - minEarned)
              const opacity = 0.1 + ratio * 0.9
              return `rgba(34, 197, 94, ${opacity})`
            }

            return h(
              'div',
              { className: 'flex flex-col' },
              h(
                'div',
                { className: 'flex justify-between items-center mb-2' },
                h(
                  'div',
                  { className: 'flex items-center gap-2' },
                  h(
                    'button',
                    {
                      onClick: navigateMonth(setDate, -1),
                      className: 'p-1 rounded-full hover:bg-gray-500/10',
                    },
                    h(ChevronLeft, { size: 20 })
                  ),
                  h('input', {
                    type: 'month',
                    value: date.toISOString().slice(0, 7),
                    onChange: handleDateChange(setDate),
                    className: 'bg-transparent font-bold text-lg p-1 rounded-md',
                  }),
                  h(
                    'button',
                    {
                      onClick: navigateMonth(setDate, 1),
                      className: 'p-1 rounded-full hover:bg-gray-500/10',
                    },
                    h(ChevronRight, { size: 20 })
                  )
                ),
                h('h4', { className: 'font-bold text-lg text-gray-800 dark:text-white' }, title)
              ),
              h(
                'div',
                {
                  className:
                    'grid grid-cols-7 gap-1 text-center text-xs text-gray-500 dark:text-gray-400 mb-2',
                },
                ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'].map(d => h('div', { key: d }, d))
              ),
              h(
                'div',
                {
                  ref: calendarRef,
                  className: 'grid grid-cols-7 gap-1 focus:outline-none',
                  tabIndex: 0,
                  onKeyDown: e => handleKeyDown(e, monthDays),
                },
                monthDays.map((day, index) =>
                  h(
                    'div',
                    {
                      key: day.key,
                      tabIndex: day.isPlaceholder ? -1 : 0,
                      className: `relative aspect-square flex items-center justify-center rounded-md transition-all duration-200 text-sm 
                ${day.isPlaceholder ? 'opacity-0' : 'cursor-pointer focus:ring-2 focus:ring-blue-500 hover:ring-2 hover:ring-blue-500'} 
                ${day.isToday ? 'font-bold ring-2 ring-blue-500 dark:ring-blue-400' : ''}
                ${focusedDayIndex === index && !day.isPlaceholder ? 'ring-4 ring-blue-500' : ''}
              `,
                      style: {
                        backgroundColor: day.data
                          ? getColor(day.data.totalEarned)
                          : theme === 'dark'
                            ? '#374151'
                            : '#f3f4f6',
                      },
                      onMouseEnter: () => !day.isPlaceholder && setHoveredDay(day),
                      onMouseLeave: () => setHoveredDay(null),
                      onClick: () => handleDayClick(day, index),
                      onFocus: () => !day.isPlaceholder && setHoveredDay(day),
                    },
                    !day.isPlaceholder && h('span', {}, day.date.getDate())
                  )
                )
              )
            )
          }

          return h(
            'div',
            {},
            h(
              'div',
              { className: 'flex justify-between items-center mb-4' },
              h(
                'h3',
                {
                  className:
                    'text-lg font-bold flex items-center gap-2 text-gray-900 dark:text-white',
                },
                'Календарь доходов',
                h(InfoTooltip, {
                  text: 'Визуализация ежедневных доходов. Цвет ячейки зависит от заработанной суммы: чем она выше, тем насыщеннее цвет.',
                })
              ),
              h(
                'button',
                {
                  onClick: () => setIsComparing(c => !c),
                  className: `px-3 py-1.5 border rounded-lg text-xs transition-colors font-semibold ${isComparing ? 'bg-blue-500 text-white border-blue-500/50' : 'bg-white/50 dark:bg-gray-900/30 border-gray-300 dark:border-gray-500/30'}`,
                },
                h(BarChart2, { size: 14, className: 'inline-block mr-1' }),
                ' Сравнить'
              )
            ),
            h(
              'div',
              {
                className: `grid ${isComparing ? 'grid-cols-1 md:grid-cols-2 gap-6' : 'grid-cols-1'}`,
              },
              renderCalendar(currentDate, setCurrentDate, 'Текущий период'),
              isComparing && renderCalendar(compareDate, setCompareDate, 'Сравниваемый период')
            ),
            hoveredDay &&
              hoveredDay.data &&
              h(
                Portal,
                {},
                h(
                  'div',
                  {
                    ref: tooltipRef,
                    className:
                      'fixed glass-effect p-3 rounded-lg shadow-xl text-sm border border-gray-200 dark:border-gray-700 pointer-events-none z-50',
                  },
                  h(
                    'p',
                    { className: 'font-bold text-gray-900 dark:text-white mb-1' },
                    hoveredDay.date.toLocaleDateString('ru-RU', {
                      day: 'numeric',
                      month: 'long',
                      year: 'numeric',
                    })
                  ),
                  h(
                    'p',
                    { className: 'text-green-600 dark:text-green-400 font-semibold' },
                    `Заработано: ${hoveredDay.data.totalEarned.toLocaleString('ru-RU')} ₽`
                  ),
                  h(
                    'p',
                    { className: 'text-gray-700 dark:text-gray-300' },
                    `Часы: ${hoveredDay.data.totalHours.toFixed(2)} ч`
                  ),
                  h(
                    'p',
                    { className: 'text-gray-700 dark:text-gray-300' },
                    `Средняя ставка: ${hoveredDay.data.avgRate.toFixed(0)} ₽/ч`
                  )
                )
              )
          )
        }

        const ChartManager = ({
          chartVisibility,
          onVisibilityChange,
          onSetDefault,
          defaultSettings,
          chartDisplay,
          onDisplayChange,
        }) => {
          const [isOpen, setIsOpen] = useState(false)
          const managerRef = useRef(null)

          useEffect(() => {
            const handleClickOutside = event => {
              if (managerRef.current && !managerRef.current.contains(event.target)) {
                setIsOpen(false)
              }
            }
            document.addEventListener('mousedown', handleClickOutside)
            return () => document.removeEventListener('mousedown', handleClickOutside)
          }, [])
          const chartLabels = {
            dynamics: 'Динамика доходов',
            rate: 'Динамика руб/час',
            weekday: 'Доход по дням недели',
            distribution: 'Распределение ставок',
            scatter: 'Часы vs Доход',
            idealDay: 'Идеальный час',
            forecast: 'Прогноз заработка',
            calendar: 'Календарь доходов',
            categoryEfficiency: 'Доходы по категориям',
            timeDistribution: 'Время по категориям',
          }
          return h(
            'div',
            { className: 'flex items-center gap-4' },
            h(
              'div',
              {
                className:
                  'flex items-center gap-1 p-1 glass-effect rounded-lg border border-gray-300 dark:border-gray-500/30',
              },
              h(
                'button',
                {
                  onClick: () => onDisplayChange('separate'),
                  className: `px-4 py-1 text-sm font-medium rounded-md transition-all ${chartDisplay === 'separate' ? 'glass-button glass-button-blue text-blue-600 dark:text-blue-300' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-300/50 dark:hover:bg-gray-700/50'}`,
                },
                'Раздельно'
              ),
              h(
                'button',
                {
                  onClick: () => onDisplayChange('combined'),
                  className: `px-4 py-1 text-sm font-medium rounded-md transition-all ${chartDisplay === 'combined' ? 'glass-button glass-button-blue text-blue-600 dark:text-blue-300' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-300/50 dark:hover:bg-gray-700/50'}`,
                },
                'Совместно'
              )
            ),
            h(
              'div',
              { className: 'relative', ref: managerRef },
              h(
                'button',
                {
                  onClick: () => setIsOpen(!isOpen),
                  className:
                    'p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700/50 transition-all duration-200 hover:scale-105',
                },
                h(Settings, { size: 20, className: 'text-gray-600 dark:text-gray-300' })
              ),
              h(
                'div',
                {
                  className:
                    'absolute right-0 mt-2 w-80 glass-effect rounded-lg shadow-xl z-20 p-4 border border-gray-200 dark:border-gray-700 dropdown-panel',
                  'data-open': isOpen,
                },
                h(
                  'p',
                  { className: 'font-bold mb-2 text-gray-900 dark:text-white' },
                  'Отобразить графики'
                ),
                Object.keys(chartVisibility).map(key =>
                  h(
                    'div',
                    {
                      key,
                      className:
                        'flex items-center justify-between p-1 hover:bg-gray-500/10 rounded-md transition-colors duration-150 menu-item-hover',
                    },
                    h(
                      'label',
                      {
                        className:
                          'flex items-center gap-2 cursor-pointer text-gray-800 dark:text-gray-200',
                      },
                      h('input', {
                        type: 'checkbox',
                        checked: chartVisibility[key],
                        onChange: () => onVisibilityChange(key),
                        className:
                          'form-checkbox h-4 w-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600',
                      }),
                      h('span', { className: 'whitespace-nowrap' }, chartLabels[key])
                    ),
                    h(
                      'button',
                      { onClick: () => onSetDefault(key), title: 'Закрепить по умолчанию' },
                      h(Paperclip, {
                        size: 16,
                        className: defaultSettings[key]
                          ? 'text-blue-500'
                          : 'text-gray-400 hover:text-gray-600',
                      })
                    )
                  )
                )
              )
            )
          )
        }
        const InsightsPanel = () => {
          const { entries } = useData()
          const { settings } = useSettings()
          // === 1. Лучший день недели ===
          // === 1. Лучший день недели ===
          const getBestWeekday = () => {
            // Шаг 1: Суммируем заработок по каждой уникальной дате
            const dailyTotals = entries.reduce((acc, e) => {
              if (!acc[e.date]) {
                acc[e.date] = 0
              }
              acc[e.date] += e.earned
              return acc
            }, {})

            // Шаг 2: Группируем дневные суммы по дням недели
            const weekdayEarnings = { 0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: [] } // 0-Вс, 1-Пн...
            for (const date in dailyTotals) {
              const dayOfWeek = new Date(date).getDay()
              weekdayEarnings[dayOfWeek].push(dailyTotals[date])
            }

            // Шаг 3: Рассчитываем средний заработок для каждого дня недели
            let bestDayIndex = 0
            let bestAvg = 0
            const weekdayAvgs = {}

            for (let dayIndex in weekdayEarnings) {
              const earnings = weekdayEarnings[dayIndex]
              if (earnings.length > 0) {
                const total = earnings.reduce((sum, val) => sum + val, 0)
                const avg = total / earnings.length
                weekdayAvgs[dayIndex] = avg
                if (avg > bestAvg) {
                  bestAvg = avg
                  bestDayIndex = Number(dayIndex)
                }
              } else {
                weekdayAvgs[dayIndex] = 0
              }
            }

            const dayNames = [
              'Воскресенье',
              'Понедельник',
              'Вторник',
              'Среда',
              'Четверг',
              'Пятница',
              'Суббота',
            ]
            // Возвращаем краткое название дня недели, как было раньше в инсайте
            const shortDayNames = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб']

            return { day: shortDayNames[bestDayIndex], avg: bestAvg }
          }
          // === 2. Пик продуктивности (часы с лучшей ставкой) ===
          const getPeakProductivity = () => {
            const hourlyStats = Array(24)
              .fill()
              .map(() => ({ totalEarned: 0, totalHours: 0 }))
            entries.forEach(e => {
              if (!e.start || !e.end) return
              const duration = calculateDuration(e.start, e.end)
              if (duration <= 0) return
              const rate = e.earned / duration
              const startMin = timeToMinutes(e.start)
              const endMin = timeToMinutes(e.start) + duration * 60
              let current = startMin
              while (current < endMin) {
                const hour = Math.floor((current / 60) % 24)
                const minInHour = 60 - (current % 60)
                const toProcess = Math.min(minInHour, endMin - current)
                hourlyStats[hour].totalEarned += (toProcess / 60) * rate
                hourlyStats[hour].totalHours += toProcess / 60
                current += toProcess
              }
            })
            let bestHour = 9,
              bestRate = 0
            hourlyStats.forEach((stat, i) => {
              const rate = stat.totalHours > 0 ? stat.totalEarned / stat.totalHours : 0
              if (rate > bestRate) {
                bestRate = rate
                bestHour = i
              }
            })
            const nextHour = (bestHour + 1) % 24
            return {
              start: String(bestHour).padStart(2, '0'),
              end: String(nextHour).padStart(2, '0'),
              rate: bestRate,
            }
          }
          // === 3. Тренд заработка за последний месяц ===
          const getEarningsTrend = () => {
            const now = new Date()
            const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate())
            const recentEntries = entries.filter(e => new Date(e.date) >= monthAgo)
            if (recentEntries.length < 7)
              return {
                trend: 'недостаточно данных',
                icon: h(AlertTriangle, { size: 20, className: 'text-gray-400' }),
              }
            // Разбиваем на недели
            const weeks = [[], [], [], []]
            recentEntries.forEach(e => {
              const daysDiff = Math.floor((now - new Date(e.date)) / (1000 * 60 * 60 * 24))
              const weekIndex = Math.min(3, Math.floor(daysDiff / 7))
              weeks[3 - weekIndex].push(e.earned)
            })
            const weeklyAvg = weeks.map(w =>
              w.length ? w.reduce((a, b) => a + b, 0) / w.length : 0
            )
            const validWeeks = weeklyAvg.filter(v => v > 0)
            if (validWeeks.length < 2)
              return {
                trend: 'недостаточно данных',
                icon: h(AlertTriangle, { size: 20, className: 'text-gray-400' }),
              }
            const first = validWeeks[0]
            const last = validWeeks[validWeeks.length - 1]
            const change = ((last - first) / first) * 100
            if (Math.abs(change) < 5)
              return {
                trend: 'стабилен',
                icon: h(BarChart2, { size: 20, className: 'text-blue-500' }),
              }
            if (change > 0)
              return {
                trend: 'растёт',
                icon: h(TrendingUp, { size: 20, className: 'text-green-500' }),
              }
            return { trend: 'падает', icon: h(ArrowDown, { size: 20, className: 'text-red-500' }) }
          }
          // === 4. Аномалия сегодня ===
          const getTodayAnomaly = () => {
            const today = new Date().toISOString().split('T')[0]

            // --- ИЗМЕНЕНИЕ: Ищем только ЗАВЕРШЕННЫЕ сессии за сегодня (где есть время окончания) ---
            const todayCompletedEntries = entries.filter(e => e.date === today && e.end)

            // Если завершенных сессий еще нет, аномалию не показываем
            if (todayCompletedEntries.length === 0) return null

            const historical = entries.filter(e => e.date !== today)
            // Требуем минимум 5 дней с записями для адекватного сравнения
            if (new Set(historical.map(e => e.date)).size < 5) return null

            const avgDaily =
              historical.reduce((sum, e) => sum + e.earned, 0) /
              new Set(historical.map(e => e.date)).size

            // Считаем сумму только по завершенным сессиям
            const todayTotal = todayCompletedEntries.reduce((sum, e) => sum + e.earned, 0)

            if (avgDaily === 0) return null // Избегаем деления на ноль

            const diff = ((todayTotal - avgDaily) / avgDaily) * 100

            // Показываем аномалию только при значительной разнице
            if (Math.abs(diff) < 20) return null

            return {
              type: diff > 0 ? 'выше' : 'ниже',
              percent: Math.abs(diff).toFixed(0),
              total: todayTotal,
            }
          }
          // === 5. Самая длинная сессия ===
          const getLongestSession = () => {
            const { entries } = useData()
            if (entries.length === 0) return null
            // Находим запись с максимальной длительностью
            const longestEntry = entries.reduce((max, entry) => {
              const duration = calculateDuration(entry.start, entry.end)
              return duration > calculateDuration(max.start, max.end) ? entry : max
            }, entries[0])
            // Возвращаем объект с нужными данными
            const duration = calculateDuration(longestEntry.start, longestEntry.end)
            return {
              date: longestEntry.date,
              start: longestEntry.start,
              end: longestEntry.end,
              duration: duration,
              earned: longestEntry.earned,
            }
          }
          // === Генерация всех инсайтов ===
          const allInsights = (() => {
            const insights = []
            // 1. Лучший день недели
            const bestDay = getBestWeekday()
            insights.push({
              id: 'best-weekday',
              title: 'Лучший день недели',
              description: `Вы зарабатываете больше всего по ${bestDay.day} — в среднем ${bestDay.avg.toLocaleString('ru-RU', { maximumFractionDigits: 0 })} ₽ в день.`,
              icon: h(Calendar, { size: 80, className: 'text-blue-500' }),
              gradient:
                'bg-gradient-to-br from-blue-500/80 to-gray-900/20 dark:from-blue-500/20 dark:to-gray-900/20',
              accentClass: 'blue-500',
            })
            // 2. Пик продуктивности
            const peak = getPeakProductivity()
            insights.push({
              id: 'peak-productivity',
              title: 'Пик продуктивности',
              description: `Ваша средняя ставка максимальна с ${peak.start}:00 до ${peak.end}:00 — ${Math.round(peak.rate)} ₽/ч.`,
              icon: h(Clock, { size: 80, className: 'text-purple-500' }),
              gradient:
                'bg-gradient-to-br from-purple-500/80 to-gray-900/20 dark:from-purple-500/20 dark:to-gray-900/20',
              accentClass: 'purple-500',
            })
            // 3. Тренд
            const trend = getEarningsTrend()
            insights.push({
              id: 'earnings-trend',
              title: 'Тренд заработка',
              description: `За последний месяц ваш заработок ${trend.trend}.`,
              icon: h(trend.icon.type, {
                ...trend.icon.props,
                size: 80,
                className: trend.icon.props.className,
              }),
              gradient:
                'bg-gradient-to-br from-green-500/80 to-gray-900/20 dark:from-green-500/20 dark:to-gray-900/20',
              accentClass: 'green-500',
            })
            // 4. Самая длинная сессия
            const longest = getLongestSession()
            if (longest) {
              insights.push({
                id: 'longest-session',
                title: 'Самая длинная сессия',
                description: `Самая продолжительная сессия была ${new Date(longest.date).toLocaleDateString('ru-RU')} — ${longest.duration.toFixed(2)} ч (${longest.earned.toLocaleString('ru-RU')} ₽).`,
                icon: h(Activity, { size: 80, className: 'text-orange-500' }),
                gradient:
                  'bg-gradient-to-br from-orange-500/80 to-gray-900/20 dark:from-orange-500/20 dark:to-gray-900/20',
                accentClass: 'orange-500',
              })
            } else {
              // Заглушка для 4-го инсайта
              insights.push({
                id: 'longest-session-placeholder',
                title: 'Самая длинная сессия',
                description: 'Здесь будет информация о самой длительной рабочей сессии.',
                icon: h(HelpCircle, { size: 80, className: 'text-gray-400' }),
                gradient:
                  'bg-gradient-to-br from-gray-500/80 to-gray-900/20 dark:from-gray-500/20 dark:to-gray-900/20',
                accentClass: 'gray-500',
              })
            }
            // 5. Аномалия сегодня (динамический)
            const anomaly = getTodayAnomaly()
            if (anomaly) {
              insights.push({
                id: 'today-anomaly',
                title: 'Аномалия сегодня',
                description: `Сегодня вы заработали ${anomaly.type} среднего на ${anomaly.percent}% (${anomaly.total.toLocaleString('ru-RU')} ₽).`,
                icon:
                  anomaly.type === 'выше'
                    ? h(TrendingUp, { size: 80, className: 'text-green-500' })
                    : h(ArrowDown, { size: 80, className: 'text-red-500' }),
                gradient:
                  'bg-gradient-to-br from-red-500/80 to-gray-900/20 dark:from-red-500/20 dark:to-gray-900/20',
                accentClass: 'red-500',
              })
            } else {
              // Заглушка для 5-го инсайта
              insights.push({
                id: 'today-anomaly-placeholder',
                title: 'Аномалия сегодня',
                description:
                  'Здесь появится уведомление, если сегодняшний доход сильно отличается от вашего среднего.',
                icon: h(HelpCircle, { size: 80, className: 'text-gray-400' }),
                gradient:
                  'bg-gradient-to-br from-gray-500/80 to-gray-900/20 dark:from-gray-500/20 dark:to-gray-900/20',
                accentClass: 'gray-500',
              })
            }
            return insights
          })()

          // Показываем инсайты только при >=30 записях
          if (entries.length < 30) {
            return null
          }

          // === Выводим ВСЕ инсайты в одну строку ===
          return h(
            'div',
            { className: 'px-6 pt-0 pb-6 mb-6' },
            // --- НОВЫЙ ЗАГОЛОВОК С ИКОНКОЙ ИНФОРМАЦИИ ---
            h(
              'div',
              { className: 'flex items-center gap-2 mb-4' },
              h('h2', { className: 'text-xl font-bold text-gray-900 dark:text-white' }, 'Инсайты'),
              h(InfoTooltip, {
                text: 'Инсайты — это автоматически генерируемые выводы на основе ваших записей. Система анализирует ваши данные и выделяет ключевые закономерности: лучшие дни недели для работы, часы с максимальной ставкой, текущий тренд заработка и аномалии. Это помогает вам лучше понимать свою продуктивность и принимать более осознанные решения.',
              })
            ),
            h(
              'div',
              { className: 'grid grid-cols-1 md:grid-cols-5 gap-4' },
              allInsights.map(insight =>
                h(
                  'div',
                  {
                    key: insight.id,
                    className: `relative overflow-hidden rounded-xl p-4 text-white transition-all duration-300 timeline-info-card hover:-translate-y-0.5 ${insight.gradient} border border-${insight.accentClass}/40 flex flex-col justify-end`,
                  },
                  // Иконка (маленькая, в правом нижнем углу, полупрозрачная)
                  h(
                    'div',
                    {
                      className: `absolute right-4 bottom-4 w-16 h-16 text-${insight.accentClass}/30 dark:text-${insight.accentClass}/30 opacity-40 insight-icon`,
                    },
                    insight.icon
                  ),
                  // Текст внизу, белый
                  h(
                    'div',
                    { className: 'relative z-10' },
                    h(
                      'h3',
                      {
                        className:
                          'font-bold text-sm mb-1 text-gray-900 dark:text-white text-shadow',
                      },
                      insight.title
                    ),
                    h(
                      'p',
                      { className: 'text-xs text-gray-900 dark:text-white text-shadow' },
                      insight.description
                    )
                  )
                )
              )
            )
          )
        }
        const AnalyticsSection = () => {
          const { entries } = useData()
          const { settings, setSettings } = useSettings()
          const dailyPlan = settings?.dailyPlan || 6000
          const [chartVisibility, setChartVisibility] = useState(settings.defaultChartVisibility)
          const [chartFilter, setChartFilter] = useState(settings.defaultChartFilter || 'month')
          const [scatterDomain, setScatterDomain] = useState({
            x: ['auto', 'auto'],
            y: ['auto', 'auto'],
          })
          const [scatterZoom, setScatterZoom] = useState({ xMin: '', xMax: '', yMin: '', yMax: '' })
          const handleChartVisibilityChange = chartKey => {
            setChartVisibility(v => ({ ...v, [chartKey]: !v[chartKey] }))
          }
          const handleSetDefaultChartVisibility = chartKey => {
            const newDefaults = {
              ...settings.defaultChartVisibility,
              [chartKey]: !settings.defaultChartVisibility[chartKey],
            }
            setSettings(s => ({ ...s, defaultChartVisibility: newDefaults }))
            setChartVisibility(newDefaults)
          }
          const handleChartDisplayChange = display => {
            setSettings(s => ({ ...s, chartDisplay: display }))
          }
          const { monthlyPlan } = (() => {
            const now = new Date()
            const currentYear = now.getFullYear()
            const currentMonth = now.getMonth()

            // Рассчитываем рабочие дни в текущем месяце на основе настроек
            const workingDaysInMonth = calculateWorkingDaysInMonth(
              currentYear,
              currentMonth,
              1,
              null,
              settings
            )

            const dailyPlanValue = typeof dailyPlan === 'number' && dailyPlan > 0 ? dailyPlan : 6000
            const calculatedMonthlyPlan = Math.round(dailyPlanValue * workingDaysInMonth)

            return { monthlyPlan: calculatedMonthlyPlan }
          })()
          const filteredChartEntries = getFilteredEntries(
            entries,
            chartFilter,
            settings.customDateFrom,
            settings.customDateTo
          )
          const calendarData = entries.reduce((acc, entry) => {
            if (!entry.date) return acc
            if (!acc[entry.date]) {
              acc[entry.date] = { totalEarned: 0, totalHours: 0, rates: [] }
            }
            const hours = calculateDuration(entry.start, entry.end)
            acc[entry.date].totalEarned += entry.earned
            acc[entry.date].totalHours += hours
            if (entry.rate > 0) acc[entry.date].rates.push({ rate: entry.rate, hours })
            return acc
          }, {})
          Object.keys(calendarData).forEach(date => {
            const day = calendarData[date]
            if (day.totalHours > 0) {
              const totalWeightedRate = day.rates.reduce((sum, r) => sum + r.rate * r.hours, 0)
              const totalHoursWithRate = day.rates.reduce((sum, r) => sum + r.hours, 0)
              day.avgRate = totalHoursWithRate > 0 ? totalWeightedRate / totalHoursWithRate : 0
            } else {
              day.avgRate = 0
            }
            delete day.rates
          })
          const chartData =
            chartFilter === 'today' && filteredChartEntries.length > 0
              ? filteredChartEntries
                  .sort((a, b) => a.start.localeCompare(b.start))
                  .map(e => ({ time: e.start, earned: e.earned, avgRate: e.rate }))
              : Object.values(
                  filteredChartEntries.reduce((acc, e) => {
                    if (!acc[e.date]) acc[e.date] = { date: e.date, earned: 0, rates: [] }
                    acc[e.date].earned += e.earned
                    acc[e.date].rates.push(e.rate)
                    return acc
                  }, {})
                )
                  .map(d => ({
                    ...d,
                    avgRate: d.rates.reduce((a, b) => a + b, 0) / d.rates.length,
                  }))
                  .sort((a, b) => a.date.localeCompare(b.date))
          const weekdayData = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'].map((day, index) => {
            const totals = [0, 0, 0, 0, 0, 0, 0]
            filteredChartEntries.forEach(entry => {
              totals[new Date(entry.date).getDay()] += entry.earned
            })
            return { day, earned: totals[(index + 1) % 7] }
          })
          const rateDistributionData = (() => {
            if (filteredChartEntries.length === 0) return []
            const rates = filteredChartEntries.map(e => e.rate)
            const minRate = Math.min(...rates)
            const maxRate = Math.max(...rates)
            const step = Math.max(100, Math.round((maxRate - minRate) / 8 / 100) * 100)
            if (step === 0) return [{ range: `${minRate}`, count: rates.length }]
            const bins = {}
            for (let i = Math.floor(minRate / step) * step; i <= maxRate; i += step) {
              bins[`${i}-${i + step - 1}`] = 0
            }
            rates.forEach(rate => {
              const binStart = Math.floor(rate / step) * step
              const range = `${binStart}-${binStart + step - 1}`
              if (bins[range] !== undefined) bins[range]++
            })
            return Object.entries(bins).map(([range, count]) => ({ range, count }))
          })()
          const scatterData = Object.values(
            filteredChartEntries.reduce((acc, entry) => {
              const date = entry.date
              if (!acc[date]) {
                acc[date] = { date: date, hours: 0, earned: 0 }
              }
              acc[date].hours += calculateDuration(entry.start, entry.end)
              acc[date].earned += entry.earned
              return acc
            }, {})
          )
          const { colorScale } = (() => {
            if (scatterData.length === 0) return { colorScale: () => '#ef4444' }
            const earnings = scatterData.map(d => d.earned)
            const min = Math.min(...earnings)
            const max = Math.max(...earnings)
            const getColor = value => {
              const ratio = max > min ? (value - min) / (max - min) : 0.5
              const blue = Math.round(255 * (1 - ratio))
              const red = Math.round(255 * ratio)
              return `rgb(${red}, 80, ${blue})`
            }
            return { colorScale: getColor }
          })()

          // === ДАННЫЕ ДЛЯ ГРАФИКОВ ПО КАТЕГОРИЯМ ===
          const categoryEfficiencyData = (() => {
            if (filteredChartEntries.length === 0) return []
            const categoryStats = {}

            filteredChartEntries.forEach(entry => {
              const categoryId = entry.categoryId || 'uncategorized'
              const category = settings.categories?.find(cat => cat.id === categoryId)
              const categoryName = category?.name || 'Без категории'
              const categoryColor = category?.color || '#6b7280'

              if (!categoryStats[categoryId]) {
                categoryStats[categoryId] = {
                  categoryId,
                  name: categoryName,
                  color: categoryColor,
                  totalEarned: 0,
                  totalHours: 0,
                  totalRate: 0,
                  entryCount: 0,
                }
              }

              const hours = calculateDuration(entry.start, entry.end)
              categoryStats[categoryId].totalEarned += entry.earned
              categoryStats[categoryId].totalHours += hours
              categoryStats[categoryId].totalRate += entry.rate
              categoryStats[categoryId].entryCount += 1
            })

            return Object.values(categoryStats)
              .map(stat => ({
                name: stat.name,
                earned: stat.totalEarned,
                hours: stat.totalHours,
                avgRate: stat.totalHours > 0 ? stat.totalEarned / stat.totalHours : 0,
                entryCount: stat.entryCount,
                color: stat.color,
              }))
              .sort((a, b) => b.earned - a.earned)
          })()

          const timeDistributionData = (() => {
            if (filteredChartEntries.length === 0) return []
            const categoryStats = {}

            filteredChartEntries.forEach(entry => {
              const categoryId = entry.categoryId || 'uncategorized'
              const category = settings.categories?.find(cat => cat.id === categoryId)
              const categoryName = category?.name || 'Без категории'
              const categoryColor = category?.color || '#6b7280'

              if (!categoryStats[categoryId]) {
                categoryStats[categoryId] = {
                  name: categoryName,
                  color: categoryColor,
                  hours: 0,
                  percentage: 0,
                }
              }

              const hours = calculateDuration(entry.start, entry.end)
              categoryStats[categoryId].hours += hours
            })

            const totalHours = Object.values(categoryStats).reduce(
              (sum, stat) => sum + stat.hours,
              0
            )

            return Object.values(categoryStats)
              .map(stat => ({
                name: stat.name,
                hours: stat.hours,
                percentage: totalHours > 0 ? (stat.hours / totalHours) * 100 : 0,
                color: stat.color,
              }))
              .sort((a, b) => b.hours - a.hours)
          })()
          const idealDayFilteredEntries = getFilteredEntries(
            entries,
            chartFilter,
            settings.customDateFrom,
            settings.customDateTo
          )
          const idealDayData = idealDayFilteredEntries
            .reduce(
              (hourlyStats, entry) => {
                if (!entry.start || !entry.end) return hourlyStats
                const duration = calculateDuration(entry.start, entry.end)
                if (duration <= 0) return hourlyStats
                const rate = entry.earned / duration
                const startMinutes = timeToMinutes(entry.start)
                const endMinutes = timeToMinutes(entry.start) + duration * 60
                let currentMinute = startMinutes
                while (currentMinute < endMinutes) {
                  const hour = Math.floor((currentMinute / 60) % 24)
                  const minutesToProcess = Math.min(
                    60 - (currentMinute % 60),
                    endMinutes - currentMinute
                  )
                  hourlyStats[hour].totalEarned += (minutesToProcess / 60) * rate
                  hourlyStats[hour].totalDuration += minutesToProcess / 60
                  currentMinute += minutesToProcess
                }
                return hourlyStats
              },
              Array.from({ length: 24 }, () => ({ totalEarned: 0, totalDuration: 0 }))
            )
            .map((stat, index) => ({
              hour: `${String(index).padStart(2, '0')}`,
              avgRate: stat.totalDuration > 0 ? stat.totalEarned / stat.totalDuration : 0,
            }))
          const forecastData = (() => {
            const now = new Date()
            const validDailyPlan = typeof dailyPlan === 'number' && dailyPlan > 0 ? dailyPlan : 6000
            if (chartFilter === 'today') {
              const todayEntries = getFilteredEntries(entries, 'today')
              if (!validDailyPlan && todayEntries.length === 0) return []
              const currentHour = now.getHours()
              const hourlyTotals = Array.from({ length: 24 }, () => 0)
              todayEntries.forEach(entry => {
                if (!entry.start) return
                const end = entry.end || now.toTimeString().slice(0, 5)
                const duration = calculateDuration(entry.start, end)
                if (duration <= 0) return
                const rate = entry.rate
                const startMinutes = timeToMinutes(entry.start)
                const endMinutes = timeToMinutes(entry.start) + duration * 60
                let currentMinute = startMinutes
                while (currentMinute < endMinutes) {
                  const hour = Math.floor((currentMinute / 60) % 24)
                  const minutesInHour = 60 - (currentMinute % 60)
                  const minutesToEnd = endMinutes - currentMinute
                  const minutesToProcess = Math.min(minutesInHour, minutesToEnd)
                  hourlyTotals[hour] += (minutesToProcess / 60) * rate
                  currentMinute += minutesToProcess
                }
              })
              const earnedSoFar = hourlyTotals.slice(0, currentHour + 1).reduce((a, b) => a + b, 0)
              const hoursWorked = todayEntries.reduce(
                (sum, e) =>
                  sum + calculateDuration(e.start, e.end || now.toTimeString().slice(0, 5)),
                0
              )
              const avgHourlyEarn = hoursWorked > 0 ? earnedSoFar / hoursWorked : 0
              let cumulativeActual = 0
              const chartData = Array.from({ length: 24 }, (_, i) => {
                const hour = i
                const plan = (hour + 1) * (validDailyPlan / 24)
                if (hour <= currentHour) {
                  cumulativeActual += hourlyTotals[hour]
                  return {
                    hour: String(hour).padStart(2, '0'),
                    actual: cumulativeActual,
                    forecast: cumulativeActual,
                    plan,
                  }
                }
                return { hour: String(hour).padStart(2, '0'), actual: null, plan }
              })
              let forecastValue = cumulativeActual
              if (avgHourlyEarn > 0) {
                for (let i = currentHour + 1; i < 24; i++) {
                  forecastValue += avgHourlyEarn
                  chartData[i].forecast = forecastValue
                }
              } else if (cumulativeActual > 0) {
                for (let i = currentHour + 1; i < 24; i++) {
                  chartData[i].forecast = cumulativeActual
                }
              }
              return chartData
            } else if (chartFilter === 'week') {
              const weekEntries = getFilteredEntries(entries, 'week')
              if (weekEntries.length === 0) return []
              const monday = new Date(now)
              monday.setDate(now.getDate() - now.getDay() + 1)
              const today = now.getDate()
              const dayOfWeek = now.getDay()
              const daysInWeek = 7
              const chartData = []
              for (let i = 0; i < daysInWeek; i++) {
                const date = new Date(monday)
                date.setDate(monday.getDate() + i)
                const dayName = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'][i]
                const dayEntries = weekEntries.filter(
                  e => e.date === date.toISOString().split('T')[0]
                )
                const dayEarned = dayEntries.reduce((sum, e) => sum + (e.earned || 0), 0)
                const dayPlan = validDailyPlan
                chartData.push({
                  day: dayName,
                  plan: dayPlan,
                  actual: dayEarned,
                  forecast: i <= dayOfWeek - 1 ? dayEarned : null,
                })
              }
              // Прогноз для оставшихся дней недели
              const workedDays = chartData.filter(d => d.actual > 0).length
              const totalEarned = chartData.reduce((sum, d) => sum + (d.actual || 0), 0)
              const avgDailyEarn = workedDays > 0 ? totalEarned / workedDays : 0
              if (avgDailyEarn > 0) {
                let lastActual = totalEarned
                for (let i = dayOfWeek; i < daysInWeek; i++) {
                  lastActual += avgDailyEarn
                  chartData[i].forecast = lastActual
                }
              }
              return chartData
            } else if (chartFilter === 'month') {
              const currentMonthEntries = getFilteredEntries(entries, 'month')
              if (currentMonthEntries.length === 0) return []
              const year = now.getFullYear()
              const month = now.getMonth()
              const today = now.getDate()
              const daysInMonth = new Date(year, month + 1, 0).getDate()
              const dailyTotals = {}
              currentMonthEntries.forEach(e => {
                dailyTotals[e.date] = (dailyTotals[e.date] || 0) + e.earned
              })
              const daysWorked = Object.keys(dailyTotals).filter(
                date => new Date(date).getDate() <= today
              ).length
              const earnedSoFar = Object.values(dailyTotals).reduce((a, b) => a + b, 0)
              const avgDailyEarn = daysWorked > 0 ? earnedSoFar / daysWorked : 0
              let cumulativeActual = 0
              const chartData = Array.from({ length: daysInMonth }, (_, i) => {
                const day = i + 1
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`
                const plan = day * (monthlyPlan / daysInMonth)
                if (day <= today) {
                  cumulativeActual += dailyTotals[dateStr] || 0
                  return { day, actual: cumulativeActual, forecast: cumulativeActual, plan }
                }
                return { day, actual: null, plan }
              })
              let lastActual = cumulativeActual
              if (avgDailyEarn > 0) {
                for (let i = today; i < daysInMonth; i++) {
                  lastActual += avgDailyEarn
                  chartData[i].forecast = lastActual
                }
              }
              return chartData
            } else if (chartFilter === 'year') {
              const yearEntries = getFilteredEntries(entries, 'year')
              if (yearEntries.length === 0) return []
              const year = now.getFullYear()
              const currentMonthIndex = now.getMonth()
              const monthNames = [
                'Янв',
                'Фев',
                'Мар',
                'Апр',
                'Май',
                'Июн',
                'Июл',
                'Авг',
                'Сен',
                'Окт',
                'Ноя',
                'Дек',
              ]
              const monthlyTotals = Array.from({ length: 12 }, () => 0)
              yearEntries.forEach(e => {
                const monthIndex = new Date(e.date).getMonth()
                monthlyTotals[monthIndex] += e.earned
              })
              const monthsWorked = monthlyTotals
                .slice(0, currentMonthIndex + 1)
                .filter((total, index) => {
                  const entriesInMonth = yearEntries.filter(
                    e => new Date(e.date).getMonth() === index
                  )
                  return entriesInMonth.length > 0
                }).length
              const earnedSoFar = monthlyTotals
                .slice(0, currentMonthIndex + 1)
                .reduce((a, b) => a + b, 0)
              const avgMonthlyEarn = monthsWorked > 0 ? earnedSoFar / monthsWorked : 0
              const yearlyPlan = monthlyPlan * 12
              let cumulativeActual = 0
              const chartData = monthNames.map((monthName, index) => {
                const plan = (index + 1) * (yearlyPlan / 12)
                if (index <= currentMonthIndex) {
                  cumulativeActual += monthlyTotals[index]
                  return {
                    month: monthName,
                    actual: cumulativeActual,
                    forecast: cumulativeActual,
                    plan,
                  }
                }
                return { month: monthName, actual: null, plan }
              })
              let lastActual = cumulativeActual
              if (avgMonthlyEarn > 0) {
                for (let i = currentMonthIndex + 1; i < 12; i++) {
                  lastActual += avgMonthlyEarn
                  chartData[i].forecast = lastActual
                }
              } else if (cumulativeActual > 0) {
                for (let i = currentMonthIndex + 1; i < 12; i++) {
                  chartData[i].forecast = cumulativeActual
                }
              }
              return chartData
            } else if (chartFilter === 'all') {
              // Для "Все время" показываем только исторические данные без прогноза
              const allEntries = getFilteredEntries(entries, 'all')
              if (allEntries.length === 0) return []

              // Группируем по месяцам для отображения
              const monthlyData = allEntries.reduce((acc, entry) => {
                const date = new Date(entry.date)
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`
                if (!acc[monthKey]) {
                  acc[monthKey] = { month: monthKey, earned: 0, count: 0 }
                }
                acc[monthKey].earned += entry.earned || 0
                acc[monthKey].count += 1
                return acc
              }, {})

              const monthNames = [
                'Янв',
                'Фев',
                'Мар',
                'Апр',
                'Май',
                'Июн',
                'Июл',
                'Авг',
                'Сен',
                'Окт',
                'Ноя',
                'Дек',
              ]
              let cumulativeActual = 0

              return Object.values(monthlyData)
                .sort((a, b) => a.month.localeCompare(b.month))
                .map((data, index) => {
                  cumulativeActual += data.earned
                  return {
                    month: `${monthNames[new Date(data.month + '-01').getMonth()]} ${new Date(data.month + '-01').getFullYear()}`,
                    actual: cumulativeActual,
                    forecast: null, // Нет прогноза для "Все время"
                    plan: null, // Нет плана для "Все время"
                  }
                })
            }
            return []
          })()
          const isAnyChartVisible = Object.values(chartVisibility).some(v => v)
          const tooltipStyle = getChartTooltipStyle(settings.theme === 'dark')
          return h(
            'div',
            {
              className:
                'glass-effect rounded-xl shadow-lg p-6 mb-6 border border-gray-200 dark:border-gray-500/20',
            },
            h(
              'div',
              { className: 'flex flex-col sm:flex-row justify-between items-center mb-4' },
              h(
                'div',
                { className: 'flex items-center gap-2' },
                h(
                  'h2',
                  { className: 'text-xl font-bold text-gray-900 dark:text-white' },
                  'Аналитика'
                ),
                h(Dropdown, {
                  options: CHART_FILTER_OPTIONS,
                  selected: chartFilter,
                  onSelect: setChartFilter,
                  buttonClassName:
                    'glass-button glass-button-gray px-2 py-1 rounded-lg text-sm w-32 text-left flex justify-between items-center transition-all duration-200 hover:scale-105 hover:shadow-lg opacity-70 hover:opacity-100',
                  children: ({ optionKey, label, closeMenu }) =>
                    h(
                      'div',
                      {
                        key: optionKey,
                        className:
                          'flex items-center justify-between w-full px-2 py-1.5 text-sm hover:bg-gray-500/10 rounded-md text-gray-800 dark:text-gray-200 transition-colors duration-150 menu-item-hover',
                      },
                      h(
                        'span',
                        {
                          onClick: () => {
                            setChartFilter(optionKey)
                            closeMenu()
                          },
                          className: 'flex-1 text-left cursor-pointer',
                        },
                        label
                      ),
                      h(
                        'button',
                        {
                          onClick: e => {
                            e.stopPropagation()
                            setSettings(s => ({ ...s, defaultChartFilter: optionKey }))
                          },
                          className: `p-1 rounded transition-colors ${optionKey === settings.defaultChartFilter ? 'text-blue-500' : 'text-gray-400 hover:text-gray-600 dark:hover:text-gray-300'}`,
                          title:
                            optionKey === settings.defaultChartFilter
                              ? 'Закреплено по умолчанию'
                              : 'Закрепить по умолчанию',
                        },
                        h(Pin, { size: 12 })
                      )
                    ),
                })
              ),
              chartFilter === 'custom' &&
                h(
                  'div',
                  { className: 'flex gap-2' },
                  h('input', {
                    type: 'date',
                    value: settings.customDateFrom,
                    onChange: e => setSettings(s => ({ ...s, customDateFrom: e.target.value })),
                    className:
                      'px-2 py-1 border rounded-lg text-sm bg-white/50 dark:bg-gray-900/30 border-gray-300 dark:border-gray-500/30 text-gray-800 dark:text-gray-200',
                  }),
                  h('input', {
                    type: 'date',
                    value: settings.customDateTo,
                    onChange: e => setSettings(s => ({ ...s, customDateTo: e.target.value })),
                    className:
                      'px-2 py-1 border rounded-lg text-sm bg-white/50 dark:bg-gray-900/30 border-gray-300 dark:border-gray-500/30 text-gray-800 dark:text-gray-200',
                  })
                ),
              h(ChartManager, {
                chartVisibility,
                onVisibilityChange: handleChartVisibilityChange,
                onSetDefault: handleSetDefaultChartVisibility,
                defaultSettings: settings.defaultChartVisibility,
                chartDisplay: settings.chartDisplay,
                onDisplayChange: handleChartDisplayChange,
              })
            ),
            isAnyChartVisible
              ? h(
                  'div',
                  { className: 'grid grid-cols-1 lg:grid-cols-2 gap-6' },
                  settings.chartDisplay === 'separate' &&
                    chartVisibility.dynamics &&
                    h(
                      'div',
                      {
                        className:
                          'bg-white/50 dark:bg-gray-900/50 rounded-xl p-4 border border-gray-200 dark:border-gray-700/50',
                      },
                      h(
                        'div',
                        { className: 'flex justify-between items-center mb-4' },
                        h(
                          'h3',
                          {
                            className:
                              'text-lg font-bold flex items-center gap-2 text-gray-900 dark:text-white',
                          },
                          'Динамика доходов',
                          h(InfoTooltip, {
                            text: 'Показывает ваш ежедневный заработок за выбранный период.',
                          })
                        ),
                        h(ChartTypeSwitcher, {
                          currentType: settings.dynamicsChartType,
                          onChange: type => setSettings(s => ({ ...s, dynamicsChartType: type })),
                        })
                      ),
                      h(
                        ResponsiveContainer,
                        { width: '100%', height: 300 },
                        settings.dynamicsChartType === 'area'
                          ? h(
                              AreaChart,
                              { data: chartData },
                              h(
                                'defs',
                                {},
                                h(
                                  'linearGradient',
                                  { id: 'colorEarned', x1: '0', y1: '0', x2: '0', y2: '1' },
                                  h('stop', {
                                    offset: '5%',
                                    stopColor: '#3b82f6',
                                    stopOpacity: 0.8,
                                  }),
                                  h('stop', { offset: '95%', stopColor: '#3b82f6', stopOpacity: 0 })
                                )
                              ),
                              h(CartesianGrid, {
                                strokeDasharray: '3 3',
                                stroke: settings.theme === 'dark' ? '#374151' : '#e5e7eb',
                              }),
                              h(XAxis, {
                                dataKey: chartFilter === 'today' ? 'time' : 'date',
                                fontSize: 12,
                                tickFormatter: tick =>
                                  chartFilter === 'today'
                                    ? tick
                                    : new Date(tick).toLocaleDateString('ru-RU', {
                                        month: 'short',
                                        day: 'numeric',
                                      }),
                              }),
                              h(YAxis, { fontSize: 12 }),
                              h(Tooltip, {
                                ...tooltipStyle,
                                formatter: value => `${value.toLocaleString('ru-RU')} ₽`,
                              }),
                              h(Area, {
                                type: 'monotone',
                                dataKey: 'earned',
                                name: 'Доход',
                                stroke: '#3b82f6',
                                fillOpacity: 1,
                                fill: 'url(#colorEarned)',
                              })
                            )
                          : settings.dynamicsChartType === 'line'
                            ? h(
                                LineChart,
                                { data: chartData },
                                h(CartesianGrid, {
                                  strokeDasharray: '3 3',
                                  stroke: settings.theme === 'dark' ? '#374151' : '#e5e7eb',
                                }),
                                h(XAxis, {
                                  dataKey: chartFilter === 'today' ? 'time' : 'date',
                                  fontSize: 12,
                                  tickFormatter: tick =>
                                    chartFilter === 'today'
                                      ? tick
                                      : new Date(tick).toLocaleDateString('ru-RU', {
                                          month: 'short',
                                          day: 'numeric',
                                        }),
                                }),
                                h(YAxis, { fontSize: 12 }),
                                h(Tooltip, {
                                  ...tooltipStyle,
                                  formatter: value => `${value.toLocaleString('ru-RU')} ₽`,
                                }),
                                h(Line, {
                                  type: 'monotone',
                                  dataKey: 'earned',
                                  name: 'Доход',
                                  stroke: '#3b82f6',
                                })
                              )
                            : h(
                                BarChart,
                                { data: chartData },
                                h(CartesianGrid, {
                                  strokeDasharray: '3 3',
                                  stroke: settings.theme === 'dark' ? '#374151' : '#e5e7eb',
                                }),
                                h(XAxis, {
                                  dataKey: chartFilter === 'today' ? 'time' : 'date',
                                  fontSize: 12,
                                  tickFormatter: tick =>
                                    chartFilter === 'today'
                                      ? tick
                                      : new Date(tick).toLocaleDateString('ru-RU', {
                                          month: 'short',
                                          day: 'numeric',
                                        }),
                                }),
                                h(YAxis, { fontSize: 12 }),
                                h(Tooltip, {
                                  ...tooltipStyle,
                                  formatter: value => `${value.toLocaleString('ru-RU')} ₽`,
                                }),
                                h(Bar, { dataKey: 'earned', name: 'Доход', fill: '#3b82f6' })
                              )
                      )
                    ),
                  settings.chartDisplay === 'separate' &&
                    chartVisibility.rate &&
                    h(
                      'div',
                      {
                        className:
                          'bg-white/50 dark:bg-gray-900/50 rounded-xl p-4 border border-gray-200 dark:border-gray-700/50',
                      },
                      h(
                        'div',
                        { className: 'flex justify-between items-center mb-4' },
                        h(
                          'h3',
                          {
                            className:
                              'text-lg font-bold flex items-center gap-2 text-gray-900 dark:text-white',
                          },
                          'Динамика руб/час',
                          h(InfoTooltip, {
                            text: 'Показывает вашу среднюю почасовую ставку за каждый отработанный день.',
                          })
                        ),
                        h(ChartTypeSwitcher, {
                          currentType: settings.rateChartType,
                          onChange: type => setSettings(s => ({ ...s, rateChartType: type })),
                        })
                      ),
                      h(
                        ResponsiveContainer,
                        { width: '100%', height: 300 },
                        settings.rateChartType === 'line'
                          ? h(
                              LineChart,
                              { data: chartData },
                              h(CartesianGrid, {
                                strokeDasharray: '3 3',
                                stroke: settings.theme === 'dark' ? '#374151' : '#e5e7eb',
                              }),
                              h(XAxis, {
                                dataKey: chartFilter === 'today' ? 'time' : 'date',
                                fontSize: 12,
                                tickFormatter: tick =>
                                  chartFilter === 'today'
                                    ? tick
                                    : new Date(tick).toLocaleDateString('ru-RU', {
                                        month: 'short',
                                        day: 'numeric',
                                      }),
                              }),
                              h(YAxis, { fontSize: 12 }),
                              h(Tooltip, {
                                ...tooltipStyle,
                                formatter: value => `${Math.round(value)} ₽/ч`,
                              }),
                              h(Legend, {}),
                              h(Line, {
                                type: 'monotone',
                                dataKey: 'avgRate',
                                stroke: '#8b5cf6',
                                strokeWidth: 3,
                                name: 'Ставка',
                              })
                            )
                          : settings.rateChartType === 'area'
                            ? h(
                                AreaChart,
                                { data: chartData },
                                h(CartesianGrid, {
                                  strokeDasharray: '3 3',
                                  stroke: settings.theme === 'dark' ? '#374151' : '#e5e7eb',
                                }),
                                h(XAxis, {
                                  dataKey: chartFilter === 'today' ? 'time' : 'date',
                                  fontSize: 12,
                                  tickFormatter: tick =>
                                    chartFilter === 'today'
                                      ? tick
                                      : new Date(tick).toLocaleDateString('ru-RU', {
                                          month: 'short',
                                          day: 'numeric',
                                        }),
                                }),
                                h(YAxis, { fontSize: 12 }),
                                h(Tooltip, {
                                  ...tooltipStyle,
                                  formatter: value => `${Math.round(value)} ₽/ч`,
                                }),
                                h(Legend, {}),
                                h(Area, {
                                  type: 'monotone',
                                  dataKey: 'avgRate',
                                  name: 'Ставка',
                                  stroke: '#8b5cf6',
                                  fill: '#8b5cf6',
                                  fillOpacity: 0.3,
                                })
                              )
                            : h(
                                BarChart,
                                { data: chartData },
                                h(CartesianGrid, {
                                  strokeDasharray: '3 3',
                                  stroke: settings.theme === 'dark' ? '#374151' : '#e5e7eb',
                                }),
                                h(XAxis, {
                                  dataKey: chartFilter === 'today' ? 'time' : 'date',
                                  fontSize: 12,
                                  tickFormatter: tick =>
                                    chartFilter === 'today'
                                      ? tick
                                      : new Date(tick).toLocaleDateString('ru-RU', {
                                          month: 'short',
                                          day: 'numeric',
                                        }),
                                }),
                                h(YAxis, { fontSize: 12 }),
                                h(Tooltip, {
                                  ...tooltipStyle,
                                  formatter: value => `${Math.round(value)} ₽/ч`,
                                }),
                                h(Legend, {}),
                                h(Bar, { dataKey: 'avgRate', name: 'Ставка', fill: '#8b5cf6' })
                              )
                      )
                    ),
                  settings.chartDisplay === 'combined' &&
                    (chartVisibility.dynamics || chartVisibility.rate) &&
                    h(
                      'div',
                      {
                        className:
                          'bg-white/50 dark:bg-gray-900/50 rounded-xl p-4 lg:col-span-2 border border-gray-200 dark:border-gray-700/50',
                      },
                      h(
                        'div',
                        {
                          className:
                            'flex flex-col sm:flex-row justify-between items-center mb-4 gap-2',
                        },
                        h(
                          'h3',
                          {
                            className:
                              'text-lg font-bold flex items-center gap-2 text-gray-900 dark:text-white',
                          },
                          'Общая динамика',
                          h(InfoTooltip, {
                            text: 'Совмещенный график дохода и почасовой ставки для сравнения.',
                          })
                        ),
                        h(
                          'div',
                          { className: 'flex items-center gap-4' },
                          chartVisibility.dynamics &&
                            h(
                              'div',
                              { className: 'flex items-center gap-2' },
                              h('span', { className: 'text-sm' }, 'Доход:'),
                              h(ChartTypeSwitcher, {
                                currentType: settings.combinedDynamicsType,
                                onChange: type =>
                                  setSettings(s => ({ ...s, combinedDynamicsType: type })),
                              })
                            ),
                          chartVisibility.rate &&
                            h(
                              'div',
                              { className: 'flex items-center gap-2' },
                              h('span', { className: 'text-sm' }, 'Ставка:'),
                              h(ChartTypeSwitcher, {
                                currentType: settings.combinedRateType,
                                onChange: type =>
                                  setSettings(s => ({ ...s, combinedRateType: type })),
                              })
                            )
                        )
                      ),
                      h(
                        ResponsiveContainer,
                        { width: '100%', height: 300 },
                        h(
                          ComposedChart,
                          { data: chartData },
                          h(
                            'defs',
                            {},
                            h(
                              'linearGradient',
                              { id: 'colorEarnedCombined', x1: '0', y1: '0', x2: '0', y2: '1' },
                              h('stop', { offset: '5%', stopColor: '#3b82f6', stopOpacity: 0.8 }),
                              h('stop', { offset: '95%', stopColor: '#3b82f6', stopOpacity: 0 })
                            )
                          ),
                          h(CartesianGrid, {
                            strokeDasharray: '3 3',
                            stroke: settings.theme === 'dark' ? '#374151' : '#e5e7eb',
                          }),
                          h(XAxis, {
                            dataKey: chartFilter === 'today' ? 'time' : 'date',
                            fontSize: 12,
                            tickFormatter: tick =>
                              chartFilter === 'today'
                                ? tick
                                : new Date(tick).toLocaleDateString('ru-RU', {
                                    month: 'short',
                                    day: 'numeric',
                                  }),
                          }),
                          chartVisibility.dynamics &&
                            h(YAxis, {
                              yAxisId: 'left',
                              orientation: 'left',
                              stroke: '#3b82f6',
                              fontSize: 12,
                            }),
                          chartVisibility.rate &&
                            h(YAxis, {
                              yAxisId: 'right',
                              orientation: 'right',
                              stroke: '#8b5cf6',
                              fontSize: 12,
                            }),
                          h(Tooltip, {
                            ...tooltipStyle,
                            formatter: (value, name) =>
                              name === 'Доход'
                                ? `${value.toLocaleString('ru-RU')} ₽`
                                : `${Math.round(value)} ₽/ч`,
                          }),
                          h(Legend, {}),
                          chartVisibility.dynamics &&
                            settings.combinedDynamicsType === 'area' &&
                            h(Area, {
                              yAxisId: 'left',
                              type: 'monotone',
                              dataKey: 'earned',
                              name: 'Доход',
                              stroke: '#3b82f6',
                              fillOpacity: 1,
                              fill: 'url(#colorEarnedCombined)',
                            }),
                          chartVisibility.dynamics &&
                            settings.combinedDynamicsType === 'line' &&
                            h(Line, {
                              yAxisId: 'left',
                              type: 'monotone',
                              dataKey: 'earned',
                              name: 'Доход',
                              stroke: '#3b82f6',
                            }),
                          chartVisibility.dynamics &&
                            settings.combinedDynamicsType === 'bar' &&
                            h(Bar, {
                              yAxisId: 'left',
                              dataKey: 'earned',
                              name: 'Доход',
                              fill: '#3b82f6',
                            }),
                          chartVisibility.rate &&
                            settings.combinedRateType === 'line' &&
                            h(Line, {
                              yAxisId: 'right',
                              type: 'monotone',
                              dataKey: 'avgRate',
                              name: 'Ставка',
                              stroke: '#8b5cf6',
                              strokeWidth: 3,
                            }),
                          chartVisibility.rate &&
                            settings.combinedRateType === 'area' &&
                            h(Area, {
                              yAxisId: 'right',
                              type: 'monotone',
                              dataKey: 'avgRate',
                              name: 'Ставка',
                              stroke: '#8b5cf6',
                              fill: '#8b5cf6',
                              fillOpacity: 0.3,
                            }),
                          chartVisibility.rate &&
                            settings.combinedRateType === 'bar' &&
                            h(Bar, {
                              yAxisId: 'right',
                              dataKey: 'avgRate',
                              name: 'Ставка',
                              fill: '#8b5cf6',
                            }),
                          h(Brush, {
                            dataKey: chartFilter === 'today' ? 'time' : 'date',
                            height: 30,
                            stroke: '#8884d8',
                          })
                        )
                      )
                    ),
                  chartVisibility.weekday &&
                    h(
                      'div',
                      {
                        className:
                          'bg-white/50 dark:bg-gray-900/50 rounded-xl p-4 border border-gray-200 dark:border-gray-700/50',
                      },
                      h(
                        'div',
                        { className: 'flex justify-between items-center mb-4' },
                        h(
                          'h3',
                          {
                            className:
                              'text-lg font-bold flex items-center gap-2 text-gray-900 dark:text-white',
                          },
                          'Доход по дням недели',
                          h(InfoTooltip, {
                            text: 'Суммарный заработок за каждый день недели. Помогает определить самые продуктивные дни.',
                          })
                        ),
                        h(ChartTypeSwitcher, {
                          currentType: settings.weekdayChartType,
                          onChange: type => setSettings(s => ({ ...s, weekdayChartType: type })),
                        })
                      ),
                      h(
                        ResponsiveContainer,
                        { width: '100%', height: 300 },
                        settings.weekdayChartType === 'bar'
                          ? h(
                              BarChart,
                              { data: weekdayData },
                              h(CartesianGrid, {
                                strokeDasharray: '3 3',
                                stroke: settings.theme === 'dark' ? '#374151' : '#e5e7eb',
                              }),
                              h(XAxis, { dataKey: 'day', fontSize: 12 }),
                              h(YAxis, { fontSize: 12 }),
                              h(Tooltip, {
                                ...tooltipStyle,
                                formatter: value => `${value.toLocaleString('ru-RU')} ₽`,
                              }),
                              h(
                                Bar,
                                { dataKey: 'earned', name: 'Заработано' },
                                weekdayData.map((entry, index) =>
                                  h(Cell, {
                                    key: `cell-${index}`,
                                    fill: [
                                      '#3b82f6',
                                      '#10b981',
                                      '#ef4444',
                                      '#f97316',
                                      '#8b5cf6',
                                      '#eab308',
                                      '#6b7280',
                                    ][index % 7],
                                  })
                                )
                              )
                            )
                          : settings.weekdayChartType === 'line'
                            ? h(
                                LineChart,
                                { data: weekdayData },
                                h(CartesianGrid, {
                                  strokeDasharray: '3 3',
                                  stroke: settings.theme === 'dark' ? '#374151' : '#e5e7eb',
                                }),
                                h(XAxis, { dataKey: 'day', fontSize: 12 }),
                                h(YAxis, { fontSize: 12 }),
                                h(Tooltip, {
                                  ...tooltipStyle,
                                  formatter: value => `${value.toLocaleString('ru-RU')} ₽`,
                                }),
                                h(Line, {
                                  type: 'monotone',
                                  dataKey: 'earned',
                                  name: 'Заработано',
                                  stroke: '#3b82f6',
                                })
                              )
                            : settings.weekdayChartType === 'area'
                              ? h(
                                  AreaChart,
                                  { data: weekdayData },
                                  h(CartesianGrid, {
                                    strokeDasharray: '3 3',
                                    stroke: settings.theme === 'dark' ? '#374151' : '#e5e7eb',
                                  }),
                                  h(XAxis, { dataKey: 'day', fontSize: 12 }),
                                  h(YAxis, { fontSize: 12 }),
                                  h(Tooltip, {
                                    ...tooltipStyle,
                                    formatter: value => `${value.toLocaleString('ru-RU')} ₽`,
                                  }),
                                  h(Area, {
                                    type: 'monotone',
                                    dataKey: 'earned',
                                    name: 'Заработано',
                                    stroke: '#3b82f6',
                                    fill: '#3b82f6',
                                    fillOpacity: 0.3,
                                  })
                                )
                              : h(
                                  BarChart,
                                  { data: weekdayData },
                                  h(CartesianGrid, {
                                    strokeDasharray: '3 3',
                                    stroke: settings.theme === 'dark' ? '#374151' : '#e5e7eb',
                                  }),
                                  h(XAxis, { dataKey: 'day', fontSize: 12 }),
                                  h(YAxis, { fontSize: 12 }),
                                  h(Tooltip, {
                                    ...tooltipStyle,
                                    formatter: value => `${value.toLocaleString('ru-RU')} ₽`,
                                  }),
                                  h(
                                    Bar,
                                    { dataKey: 'earned', name: 'Заработано' },
                                    weekdayData.map((entry, index) =>
                                      h(Cell, {
                                        key: `cell-${index}`,
                                        fill: [
                                          '#3b82f6',
                                          '#10b981',
                                          '#ef4444',
                                          '#f97316',
                                          '#8b5cf6',
                                          '#eab308',
                                          '#6b7280',
                                        ][index % 7],
                                      })
                                    )
                                  )
                                )
                      )
                    ),
                  chartVisibility.distribution &&
                    h(
                      'div',
                      {
                        className:
                          'bg-white/50 dark:bg-gray-900/50 rounded-xl p-4 border border-gray-200 dark:border-gray-700/50',
                      },
                      h(
                        'div',
                        { className: 'flex justify-between items-center mb-4' },
                        h(
                          'h3',
                          {
                            className:
                              'text-lg font-bold flex items-center gap-2 text-gray-900 dark:text-white',
                          },
                          'Распределение ставок',
                          h(InfoTooltip, {
                            text: 'Как часто встречаются разные диапазоны ваших почасовых ставок.',
                          })
                        ),
                        h(ChartTypeSwitcher, {
                          currentType: settings.distributionChartType,
                          onChange: type =>
                            setSettings(s => ({ ...s, distributionChartType: type })),
                        })
                      ),
                      h(
                        ResponsiveContainer,
                        { width: '100%', height: 300 },
                        settings.distributionChartType === 'bar'
                          ? h(
                              BarChart,
                              { data: rateDistributionData },
                              h(CartesianGrid, {
                                strokeDasharray: '3 3',
                                stroke: settings.theme === 'dark' ? '#374151' : '#e5e7eb',
                              }),
                              h(XAxis, { dataKey: 'range', fontSize: 12 }),
                              h(YAxis, { fontSize: 12 }),
                              h(Tooltip, { ...tooltipStyle, formatter: value => `${value} раз` }),
                              h(Bar, { dataKey: 'count', fill: '#10b981', name: 'Кол-во раз' })
                            )
                          : settings.distributionChartType === 'line'
                            ? h(
                                LineChart,
                                { data: rateDistributionData },
                                h(CartesianGrid, {
                                  strokeDasharray: '3 3',
                                  stroke: settings.theme === 'dark' ? '#374151' : '#e5e7eb',
                                }),
                                h(XAxis, { dataKey: 'range', fontSize: 12 }),
                                h(YAxis, { fontSize: 12 }),
                                h(Tooltip, { ...tooltipStyle, formatter: value => `${value} раз` }),
                                h(Line, {
                                  type: 'monotone',
                                  dataKey: 'count',
                                  name: 'Кол-во раз',
                                  stroke: '#10b981',
                                })
                              )
                            : h(
                                AreaChart,
                                { data: rateDistributionData },
                                h(CartesianGrid, {
                                  strokeDasharray: '3 3',
                                  stroke: settings.theme === 'dark' ? '#374151' : '#e5e7eb',
                                }),
                                h(XAxis, { dataKey: 'range', fontSize: 12 }),
                                h(YAxis, { fontSize: 12 }),
                                h(Tooltip, { ...tooltipStyle, formatter: value => `${value} раз` }),
                                h(Area, {
                                  type: 'monotone',
                                  dataKey: 'count',
                                  name: 'Кол-во раз',
                                  stroke: '#10b981',
                                  fill: '#10b981',
                                  fillOpacity: 0.3,
                                })
                              )
                      )
                    ),
                  chartVisibility.scatter &&
                    h(
                      'div',
                      {
                        className:
                          'bg-white/50 dark:bg-gray-900/50 rounded-xl p-4 border border-gray-200 dark:border-gray-700/50',
                      },
                      h(
                        'h3',
                        {
                          className:
                            'text-lg font-bold flex items-center gap-2 text-gray-900 dark:text-white',
                        },
                        'Соотношение Часы vs Доход',
                        h(InfoTooltip, {
                          text: 'Каждая точка - один рабочий день. Размер и цвет точки зависят от суммы заработка. Помогает увидеть зависимость дохода от отработанных часов.',
                        })
                      ),
                      h(
                        ResponsiveContainer,
                        { width: '100%', height: 300 },
                        h(
                          ScatterChart,
                          {},
                          h(CartesianGrid, {
                            stroke: settings.theme === 'dark' ? '#374151' : '#e5e7eb',
                          }),
                          h(XAxis, {
                            type: 'number',
                            dataKey: 'hours',
                            name: 'Часы',
                            unit: ' ч',
                            fontSize: 12,
                            domain: scatterDomain.x,
                            allowDataOverflow: true,
                          }),
                          h(YAxis, {
                            type: 'number',
                            dataKey: 'earned',
                            name: 'Заработано',
                            unit: ' ₽',
                            fontSize: 12,
                            domain: scatterDomain.y,
                            allowDataOverflow: true,
                          }),
                          h(ZAxis, {
                            type: 'number',
                            dataKey: 'earned',
                            range: [100, 1000],
                            name: 'Заработано',
                          }),
                          h(Tooltip, {
                            cursor: { strokeDasharray: '3 3' },
                            content: h(ScatterCustomTooltip, {}),
                          }),
                          h(
                            Scatter,
                            { name: 'Рабочий день', data: scatterData },
                            scatterData.map((entry, index) =>
                              h(Cell, { key: `cell-${index}`, fill: colorScale(entry.earned) })
                            )
                          )
                        )
                      ),
                      h(
                        'div',
                        {
                          className:
                            'flex items-center justify-center flex-wrap gap-2 mt-2 text-sm',
                        },
                        h(
                          'div',
                          { className: 'flex items-center gap-1' },
                          h('label', {}, 'Часы:'),
                          h('input', {
                            type: 'number',
                            name: 'xMin',
                            value: scatterZoom.xMin,
                            onChange: e =>
                              setScatterZoom(prev => ({ ...prev, xMin: e.target.value })),
                            placeholder: 'Min',
                            className:
                              'w-16 p-1 border rounded bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600',
                          }),
                          h('span', {}, '-'),
                          h('input', {
                            type: 'number',
                            name: 'xMax',
                            value: scatterZoom.xMax,
                            onChange: e =>
                              setScatterZoom(prev => ({ ...prev, xMax: e.target.value })),
                            placeholder: 'Max',
                            className:
                              'w-16 p-1 border rounded bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600',
                          })
                        ),
                        h(
                          'div',
                          { className: 'flex items-center gap-1' },
                          h('label', {}, 'Доход:'),
                          h('input', {
                            type: 'number',
                            name: 'yMin',
                            value: scatterZoom.yMin,
                            onChange: e =>
                              setScatterZoom(prev => ({ ...prev, yMin: e.target.value })),
                            placeholder: 'Min',
                            className:
                              'w-16 p-1 border rounded bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600',
                          }),
                          h('span', {}, '-'),
                          h('input', {
                            type: 'number',
                            name: 'yMax',
                            value: scatterZoom.yMax,
                            onChange: e =>
                              setScatterZoom(prev => ({ ...prev, yMax: e.target.value })),
                            placeholder: 'Max',
                            className:
                              'w-16 p-1 border rounded bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600',
                          })
                        ),
                        h(
                          'button',
                          {
                            onClick: () =>
                              setScatterDomain({
                                x: [scatterZoom.xMin || 'auto', scatterZoom.xMax || 'auto'],
                                y: [scatterZoom.yMin || 'auto', scatterZoom.yMax || 'auto'],
                              }),
                            className:
                              'glass-button glass-button-blue px-3 py-1 rounded-lg text-xs',
                          },
                          'Применить'
                        ),
                        h(
                          'button',
                          {
                            onClick: () => {
                              setScatterZoom({ xMin: '', xMax: '', yMin: '', yMax: '' })
                              setScatterDomain({ x: ['auto', 'auto'], y: ['auto', 'auto'] })
                            },
                            className:
                              'px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 text-xs',
                          },
                          'Сброс'
                        )
                      )
                    ),
                  chartVisibility.idealDay &&
                    h(
                      'div',
                      {
                        className:
                          'bg-white/50 dark:bg-gray-900/50 rounded-xl p-4 border border-gray-200 dark:border-gray-700/50',
                      },
                      h(
                        'div',
                        { className: 'flex justify-between items-center mb-4' },
                        h(
                          'h3',
                          {
                            className:
                              'text-lg font-bold flex items-center gap-2 text-gray-900 dark:text-white',
                          },
                          'Идеальный час',
                          h(InfoTooltip, {
                            text: 'Средняя почасовая ставка для каждого часа суток. Помогает определить самые выгодные часы для работы.',
                          })
                        ),
                        h(ChartTypeSwitcher, {
                          currentType: settings.idealDayChartType,
                          onChange: type => setSettings(s => ({ ...s, idealDayChartType: type })),
                        })
                      ),
                      h(
                        ResponsiveContainer,
                        { width: '100%', height: 300 },
                        settings.idealDayChartType === 'bar'
                          ? h(
                              BarChart,
                              { data: idealDayData },
                              h(CartesianGrid, {
                                strokeDasharray: '3 3',
                                stroke: settings.theme === 'dark' ? '#374151' : '#e5e7eb',
                              }),
                              h(XAxis, { dataKey: 'hour', fontSize: 12 }),
                              h(YAxis, { fontSize: 12 }),
                              h(Tooltip, {
                                ...tooltipStyle,
                                formatter: value => `${Math.round(value)} ₽/ч`,
                              }),
                              h(Bar, {
                                dataKey: 'avgRate',
                                name: 'Средняя ставка',
                                fill: '#f59e0b',
                              })
                            )
                          : settings.idealDayChartType === 'line'
                            ? h(
                                LineChart,
                                { data: idealDayData },
                                h(CartesianGrid, {
                                  strokeDasharray: '3 3',
                                  stroke: settings.theme === 'dark' ? '#374151' : '#e5e7eb',
                                }),
                                h(XAxis, { dataKey: 'hour', fontSize: 12 }),
                                h(YAxis, { fontSize: 12 }),
                                h(Tooltip, {
                                  ...tooltipStyle,
                                  formatter: value => `${Math.round(value)} ₽/ч`,
                                }),
                                h(Line, {
                                  type: 'monotone',
                                  dataKey: 'avgRate',
                                  name: 'Средняя ставка',
                                  stroke: '#f59e0b',
                                })
                              )
                            : settings.idealDayChartType === 'area'
                              ? h(
                                  AreaChart,
                                  { data: idealDayData },
                                  h(CartesianGrid, {
                                    strokeDasharray: '3 3',
                                    stroke: settings.theme === 'dark' ? '#374151' : '#e5e7eb',
                                  }),
                                  h(XAxis, { dataKey: 'hour', fontSize: 12 }),
                                  h(YAxis, { fontSize: 12 }),
                                  h(Tooltip, {
                                    ...tooltipStyle,
                                    formatter: value => `${Math.round(value)} ₽/ч`,
                                  }),
                                  h(Area, {
                                    type: 'monotone',
                                    dataKey: 'avgRate',
                                    name: 'Средняя ставка',
                                    stroke: '#f59e0b',
                                    fill: '#f59e0b',
                                    fillOpacity: 0.3,
                                  })
                                )
                              : h(
                                  BarChart,
                                  { data: idealDayData },
                                  h(CartesianGrid, {
                                    strokeDasharray: '3 3',
                                    stroke: settings.theme === 'dark' ? '#374151' : '#e5e7eb',
                                  }),
                                  h(XAxis, { dataKey: 'hour', fontSize: 12 }),
                                  h(YAxis, { fontSize: 12 }),
                                  h(Tooltip, {
                                    ...tooltipStyle,
                                    formatter: value => `${Math.round(value)} ₽/ч`,
                                  }),
                                  h(Bar, {
                                    dataKey: 'avgRate',
                                    name: 'Средняя ставка',
                                    fill: '#f59e0b',
                                  })
                                )
                      )
                    ),
                  chartVisibility.forecast &&
                    h(
                      'div',
                      {
                        className:
                          'bg-white/50 dark:bg-gray-900/50 rounded-xl p-4 lg:col-span-2 border border-gray-200 dark:border-gray-700/50',
                      },
                      h(
                        'div',
                        { className: 'flex justify-between items-center mb-4' },
                        h(
                          'h3',
                          {
                            className:
                              'text-lg font-bold flex items-center gap-2 text-gray-900 dark:text-white',
                          },
                          'Прогноз заработка',
                          h(InfoTooltip, {
                            text: 'Сравнение вашего фактического кумулятивного дохода с планом и прогнозом до конца периода.',
                          })
                        ),
                        h(ChartTypeSwitcher, {
                          currentType: settings.forecastChartType,
                          onChange: type => setSettings(s => ({ ...s, forecastChartType: type })),
                        })
                      ),
                      h(
                        ResponsiveContainer,
                        { width: '100%', height: 300 },
                        h(
                          ComposedChart,
                          { data: forecastData },
                          h(
                            'defs',
                            {},
                            h(
                              'linearGradient',
                              { id: 'colorForecastPlan', x1: '0', y1: '0', x2: '0', y2: '1' },
                              h('stop', { offset: '5%', stopColor: '#ef4444', stopOpacity: 0.8 }),
                              h('stop', { offset: '95%', stopColor: '#ef4444', stopOpacity: 0 })
                            ),
                            h(
                              'linearGradient',
                              { id: 'colorForecastActual', x1: '0', y1: '0', x2: '0', y2: '1' },
                              h('stop', { offset: '5%', stopColor: '#22c55e', stopOpacity: 0.8 }),
                              h('stop', { offset: '95%', stopColor: '#22c55e', stopOpacity: 0 })
                            ),
                            h(
                              'linearGradient',
                              { id: 'colorForecastForecast', x1: '0', y1: '0', x2: '0', y2: '1' },
                              h('stop', { offset: '5%', stopColor: '#3b82f6', stopOpacity: 0.8 }),
                              h('stop', { offset: '95%', stopColor: '#3b82f6', stopOpacity: 0 })
                            )
                          ),
                          h(CartesianGrid, {
                            strokeDasharray: '3 3',
                            stroke: settings.theme === 'dark' ? '#374151' : '#e5e7eb',
                          }),
                          h(XAxis, {
                            dataKey:
                              chartFilter === 'year' || chartFilter === 'all'
                                ? 'month'
                                : chartFilter === 'today'
                                  ? 'hour'
                                  : chartFilter === 'week'
                                    ? 'day'
                                    : 'day',
                            fontSize: 12,
                          }),
                          h(YAxis, { fontSize: 12 }),
                          h(Tooltip, {
                            ...tooltipStyle,
                            formatter: value => `${Math.round(value)} ₽`,
                          }),
                          h(Legend, {}),
                          chartFilter !== 'all' &&
                            settings.forecastChartType === 'line' &&
                            h(Line, {
                              type: 'monotone',
                              dataKey: 'plan',
                              name: 'План',
                              stroke: '#ef4444',
                              strokeWidth: 3,
                              strokeDasharray: '10 5',
                              dot: false,
                            }),
                          chartFilter !== 'all' &&
                            settings.forecastChartType === 'bar' &&
                            h(Bar, {
                              dataKey: 'plan',
                              name: 'План',
                              fill: '#ef4444',
                              fillOpacity: 0.3,
                            }),
                          chartFilter !== 'all' &&
                            settings.forecastChartType === 'area' &&
                            h(Area, {
                              type: 'monotone',
                              dataKey: 'plan',
                              name: 'План',
                              stroke: '#ef4444',
                              strokeWidth: 3,
                              strokeDasharray: '10 5',
                              fillOpacity: 1,
                              fill: 'url(#colorForecastPlan)',
                            }),
                          settings.forecastChartType === 'line' &&
                            h(Line, {
                              type: 'monotone',
                              dataKey: 'actual',
                              name: 'Факт',
                              stroke: '#22c55e',
                              strokeWidth: 4,
                              dot: { r: 4 },
                            }),
                          settings.forecastChartType === 'bar' &&
                            h(Bar, { dataKey: 'actual', name: 'Факт', fill: '#22c55e' }),
                          settings.forecastChartType === 'area' &&
                            h(Area, {
                              type: 'monotone',
                              dataKey: 'actual',
                              name: 'Факт',
                              stroke: '#22c55e',
                              strokeWidth: 4,
                              fillOpacity: 1,
                              fill: 'url(#colorForecastActual)',
                            }),
                          chartFilter !== 'all' &&
                            settings.forecastChartType === 'line' &&
                            h(Line, {
                              type: 'monotone',
                              dataKey: 'forecast',
                              name: 'Прогноз',
                              stroke: '#3b82f6',
                              strokeWidth: 2,
                              strokeDasharray: '2 2',
                              dot: { r: 2 },
                            }),
                          chartFilter !== 'all' &&
                            settings.forecastChartType === 'bar' &&
                            h(Bar, {
                              dataKey: 'forecast',
                              name: 'Прогноз',
                              fill: '#3b82f6',
                              fillOpacity: 0.5,
                            }),
                          chartFilter !== 'all' &&
                            settings.forecastChartType === 'area' &&
                            h(Area, {
                              type: 'monotone',
                              dataKey: 'forecast',
                              name: 'Прогноз',
                              stroke: '#3b82f6',
                              strokeWidth: 2,
                              strokeDasharray: '2 2',
                              fillOpacity: 1,
                              fill: 'url(#colorForecastForecast)',
                            })
                        )
                      )
                    ),
                  // === ГРАФИКИ ПО КАТЕГОРИЯМ ===
                  chartVisibility.categoryEfficiency &&
                    h(
                      'div',
                      {
                        className:
                          'bg-white/50 dark:bg-gray-900/50 rounded-xl p-4 border border-gray-200 dark:border-gray-700/50',
                      },
                      h(
                        'div',
                        { className: 'flex items-center justify-between mb-4' },
                        h(
                          'h3',
                          {
                            className:
                              'text-lg font-bold flex items-center gap-2 text-gray-900 dark:text-white',
                          },
                          'Доходы по категориям',
                          h(InfoTooltip, {
                            text: 'Показывает доходы и среднюю ставку по каждой категории.',
                          })
                        ),
                        h(ChartTypeSwitcher, {
                          currentType: settings.categoryEfficiencyChartType,
                          onChange: type =>
                            setSettings(s => ({ ...s, categoryEfficiencyChartType: type })),
                        })
                      ),
                      h(
                        ResponsiveContainer,
                        { width: '100%', height: 300 },
                        settings.categoryEfficiencyChartType === 'bar'
                          ? h(
                              BarChart,
                              { data: categoryEfficiencyData },
                              h(CartesianGrid, {
                                strokeDasharray: '3 3',
                                stroke: settings.theme === 'dark' ? '#374151' : '#e5e7eb',
                              }),
                              h(XAxis, {
                                dataKey: 'name',
                                fontSize: 12,
                                angle: -45,
                                textAnchor: 'end',
                                height: 80,
                              }),
                              h(YAxis, { fontSize: 12 }),
                              h(Tooltip, {
                                contentStyle: tooltipStyle.contentStyle,
                                formatter: (value, name) => [
                                  name === 'earned'
                                    ? `${value.toLocaleString('ru-RU')} ₽`
                                    : `${value.toFixed(1)} ₽/ч`,
                                  name === 'earned' ? 'Доход' : 'Средняя ставка',
                                ],
                              }),
                              h(Bar, {
                                dataKey: 'earned',
                                name: 'earned',
                                fill: '#3b82f6',
                                radius: [4, 4, 0, 0],
                              })
                            )
                          : settings.categoryEfficiencyChartType === 'line'
                            ? h(
                                LineChart,
                                { data: categoryEfficiencyData },
                                h(CartesianGrid, {
                                  strokeDasharray: '3 3',
                                  stroke: settings.theme === 'dark' ? '#374151' : '#e5e7eb',
                                }),
                                h(XAxis, {
                                  dataKey: 'name',
                                  fontSize: 12,
                                  angle: -45,
                                  textAnchor: 'end',
                                  height: 80,
                                }),
                                h(YAxis, { fontSize: 12 }),
                                h(Tooltip, {
                                  contentStyle: tooltipStyle.contentStyle,
                                  formatter: (value, name) => [
                                    name === 'earned'
                                      ? `${value.toLocaleString('ru-RU')} ₽`
                                      : `${value.toFixed(1)} ₽/ч`,
                                    name === 'earned' ? 'Доход' : 'Средняя ставка',
                                  ],
                                }),
                                h(Line, {
                                  type: 'monotone',
                                  dataKey: 'earned',
                                  stroke: '#3b82f6',
                                  strokeWidth: 3,
                                  name: 'earned',
                                })
                              )
                            : h(
                                AreaChart,
                                { data: categoryEfficiencyData },
                                h(
                                  'defs',
                                  {},
                                  h(
                                    'linearGradient',
                                    {
                                      id: 'colorCategoryEfficiency',
                                      x1: '0',
                                      y1: '0',
                                      x2: '0',
                                      y2: '1',
                                    },
                                    h('stop', {
                                      offset: '5%',
                                      stopColor: '#3b82f6',
                                      stopOpacity: 0.8,
                                    }),
                                    h('stop', {
                                      offset: '95%',
                                      stopColor: '#3b82f6',
                                      stopOpacity: 0,
                                    })
                                  )
                                ),
                                h(CartesianGrid, {
                                  strokeDasharray: '3 3',
                                  stroke: settings.theme === 'dark' ? '#374151' : '#e5e7eb',
                                }),
                                h(XAxis, {
                                  dataKey: 'name',
                                  fontSize: 12,
                                  angle: -45,
                                  textAnchor: 'end',
                                  height: 80,
                                }),
                                h(YAxis, { fontSize: 12 }),
                                h(Tooltip, {
                                  contentStyle: tooltipStyle.contentStyle,
                                  formatter: (value, name) => [
                                    name === 'earned'
                                      ? `${value.toLocaleString('ru-RU')} ₽`
                                      : `${value.toFixed(1)} ₽/ч`,
                                    name === 'earned' ? 'Доход' : 'Средняя ставка',
                                  ],
                                }),
                                h(Area, {
                                  type: 'monotone',
                                  dataKey: 'earned',
                                  stroke: '#3b82f6',
                                  fillOpacity: 1,
                                  fill: 'url(#colorCategoryEfficiency)',
                                })
                              )
                      )
                    ),
                  chartVisibility.timeDistribution &&
                    h(
                      'div',
                      {
                        className:
                          'bg-white/50 dark:bg-gray-900/50 rounded-xl p-4 border border-gray-200 dark:border-gray-700/50',
                      },
                      h(
                        'div',
                        { className: 'flex items-center justify-between mb-4' },
                        h(
                          'h3',
                          {
                            className:
                              'text-lg font-bold flex items-center gap-2 text-gray-900 dark:text-white',
                          },
                          'Время по категориям',
                          h(InfoTooltip, {
                            text: 'Показывает, сколько времени вы тратите на каждую категорию.',
                          })
                        ),
                        h(ChartTypeSwitcher, {
                          currentType: settings.timeDistributionChartType,
                          onChange: type =>
                            setSettings(s => ({ ...s, timeDistributionChartType: type })),
                        })
                      ),
                      h(
                        ResponsiveContainer,
                        { width: '100%', height: 300 },
                        settings.timeDistributionChartType === 'pie'
                          ? h(
                              PieChart,
                              { data: timeDistributionData },
                              h(
                                Pie,
                                {
                                  dataKey: 'hours',
                                  nameKey: 'name',
                                  cx: '50%',
                                  cy: '50%',
                                  outerRadius: 80,
                                  fill: '#8884d8',
                                  data: timeDistributionData.map((item, index) => ({
                                    ...item,
                                    fill: item.color,
                                  })),
                                },
                                timeDistributionData.map((entry, index) =>
                                  h(Cell, { key: `cell-${index}`, fill: entry.color })
                                )
                              ),
                              h(Tooltip, {
                                contentStyle: tooltipStyle.contentStyle,
                                formatter: (value, name, props) => [
                                  `${value.toFixed(1)} ч (${props.payload.percentage.toFixed(1)}%)`,
                                  props.payload.name,
                                ],
                              }),
                              h(Legend, {
                                formatter: (value, entry) =>
                                  `${value} (${entry.payload.percentage.toFixed(1)}%)`,
                                wrapperStyle: { fontSize: '12px' },
                              })
                            )
                          : settings.timeDistributionChartType === 'bar'
                            ? h(
                                BarChart,
                                { data: timeDistributionData },
                                h(CartesianGrid, {
                                  strokeDasharray: '3 3',
                                  stroke: settings.theme === 'dark' ? '#374151' : '#e5e7eb',
                                }),
                                h(XAxis, {
                                  dataKey: 'name',
                                  fontSize: 12,
                                  angle: -45,
                                  textAnchor: 'end',
                                  height: 80,
                                }),
                                h(YAxis, { fontSize: 12 }),
                                h(Tooltip, {
                                  contentStyle: tooltipStyle.contentStyle,
                                  formatter: (value, name, props) => [
                                    `${value.toFixed(1)} ч (${props.payload.percentage.toFixed(1)}%)`,
                                    'Часы',
                                  ],
                                }),
                                h(Bar, {
                                  dataKey: 'hours',
                                  name: 'hours',
                                  fill: '#8b5cf6',
                                  radius: [4, 4, 0, 0],
                                })
                              )
                            : h(
                                AreaChart,
                                { data: timeDistributionData },
                                h(
                                  'defs',
                                  {},
                                  h(
                                    'linearGradient',
                                    {
                                      id: 'colorTimeDistribution',
                                      x1: '0',
                                      y1: '0',
                                      x2: '0',
                                      y2: '1',
                                    },
                                    h('stop', {
                                      offset: '5%',
                                      stopColor: '#8b5cf6',
                                      stopOpacity: 0.8,
                                    }),
                                    h('stop', {
                                      offset: '95%',
                                      stopColor: '#8b5cf6',
                                      stopOpacity: 0,
                                    })
                                  )
                                ),
                                h(CartesianGrid, {
                                  strokeDasharray: '3 3',
                                  stroke: settings.theme === 'dark' ? '#374151' : '#e5e7eb',
                                }),
                                h(XAxis, {
                                  dataKey: 'name',
                                  fontSize: 12,
                                  angle: -45,
                                  textAnchor: 'end',
                                  height: 80,
                                }),
                                h(YAxis, { fontSize: 12 }),
                                h(Tooltip, {
                                  contentStyle: tooltipStyle.contentStyle,
                                  formatter: (value, name, props) => [
                                    `${value.toFixed(1)} ч (${props.payload.percentage.toFixed(1)}%)`,
                                    'Часы',
                                  ],
                                }),
                                h(Area, {
                                  type: 'monotone',
                                  dataKey: 'hours',
                                  stroke: '#8b5cf6',
                                  fillOpacity: 1,
                                  fill: 'url(#colorTimeDistribution)',
                                })
                              )
                      )
                    ),
                  chartVisibility.calendar &&
                    h(
                      'div',
                      {
                        className:
                          'bg-white/50 dark:bg-gray-900/50 rounded-xl p-4 lg:col-span-2 border border-gray-200 dark:border-gray-700/50',
                      },
                      h(CalendarHeatmap, { data: calendarData, theme: settings.theme })
                    )
                )
              : h(
                  'div',
                  {
                    className:
                      'flex items-center justify-center h-64 bg-white/50 dark:bg-gray-900/50 rounded-xl border border-dashed border-gray-300 dark:border-gray-700',
                  },
                  h(
                    'p',
                    { className: 'text-gray-500' },
                    'Выберите графики для отображения в настройках'
                  )
                )
          )
        }

        const TimelineView = ({
          groupedEntries,
          dailyPlan,
          editingEntryId,
          setEditingEntryId,
          updateEntry,
          deleteEntry,
          openEditModal,
          selectionMode,
          selectedEntries,
          toggleSelection,
          newEntryIds,
          shouldAnimateEntries,
          settings,
        }) => {
          const getPlanStatus = total => {
            const percentage = dailyPlan > 0 ? (total / dailyPlan) * 100 : 0
            // 1. от 0 до 49% - красный
            if (percentage <= 49) {
              return {
                colorClass: 'text-red-500 dark:text-red-400',
                iconSvg: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,
              }
            }
            // 2. от 50 до 99% - желтый
            if (percentage <= 99) {
              return {
                colorClass: 'text-yellow-500 dark:text-yellow-400',
                iconSvg: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`,
              }
            }
            // 3. от 100% и выше - зеленый
            return {
              colorClass: 'text-green-600 dark:text-green-400',
              iconSvg: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><path d="M20 6 9 17l-5-5"/></svg>`,
            }
          }
          const processDayData = dayEntries => {
            let longestSession = 0,
              longestBreak = 0,
              totalWorkMinutes = 0
            const sortedEntries = [...dayEntries].sort((a, b) => a.start.localeCompare(b.start))
            sortedEntries.forEach((entry, i) => {
              const duration = timeToMinutes(entry.end) - timeToMinutes(entry.start)
              totalWorkMinutes += duration
              if (duration > longestSession) longestSession = duration
              if (i < sortedEntries.length - 1) {
                const breakDuration =
                  timeToMinutes(sortedEntries[i + 1].start) - timeToMinutes(entry.end)
                if (breakDuration > longestBreak) longestBreak = breakDuration
                entry.breakAfter = breakDuration > 0 ? minutesToTime(breakDuration) : null
              }
            })
            const totalEarned = dayEntries.reduce((sum, e) => sum + e.earned, 0)
            return {
              longestSession: minutesToTime(longestSession),
              longestBreak: minutesToTime(longestBreak),
              avgRate:
                (totalWorkMinutes > 0 ? totalEarned / (totalWorkMinutes / 60) : 0).toFixed(0) +
                ' ₽/ч',
            }
          }

          return h(
            'div',
            { className: 'max-h-[70vh] overflow-y-auto pr-2 custom-scrollbar' }, // SCROLL WRAPPER
            h(
              'div',
              { className: 'relative timeline max-w-5xl mx-auto pt-8' },
              groupedEntries.map(([date, dayEntries]) => {
                const dayStats = processDayData(dayEntries)
                const totalDayEarned = dayEntries.reduce((sum, e) => sum + e.earned, 0)
                const planStatus = getPlanStatus(totalDayEarned)

                return h(
                  'div',
                  { key: date, className: 'timeline-item relative mb-8 overflow-visible' },
                  h('div', { className: 'timeline-dot' }),
                  h(
                    'div',
                    { className: 'timeline-main w-[45%] overflow-visible' },
                    h(
                      'div',
                      {
                        className:
                          'timeline-main-card bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm rounded-xl shadow-lg p-4 border border-gray-200 dark:border-gray-700/50 overflow-visible',
                      }, // UPDATED STYLES + HOVER
                      h(
                        'div',
                        {
                          className:
                            'card-header flex justify-between items-center text-gray-500 dark:text-gray-400 text-sm',
                        },
                        h(
                          'h4',
                          { className: 'font-semibold text-gray-800 dark:text-white' },
                          new Date(date)
                            .toLocaleDateString('ru-RU', {
                              weekday: 'short',
                              day: '2-digit',
                              month: '2-digit',
                              year: '2-digit',
                            })
                            .replace(/, /g, ' ')
                        ),
                        h('div', {
                          className: 'flex items-center gap-1',
                          dangerouslySetInnerHTML: {
                            __html: `${planStatus.iconSvg}<span class="font-bold ${planStatus.colorClass}">${totalDayEarned.toLocaleString('ru-RU')} ₽</span>`,
                          },
                        })
                      ),
                      h(
                        'div',
                        { className: 'mt-3 overflow-visible' },
                        // Заголовки столбцов (видимые)
                        h(
                          'div',
                          {
                            className:
                              'flex items-center text-xs font-semibold text-gray-500 dark:text-gray-400 mb-2 px-2',
                          },
                          h('span', { className: 'w-[90px] flex-shrink-0' }, 'Время'),
                          h('span', { className: 'w-[45px] flex-shrink-0 ml-4' }, 'Перерыв'),
                          h('span', { className: 'w-[130px] flex-shrink-0 ml-1' }, 'Категория'),
                          h(
                            'span',
                            { className: 'w-[65px] flex-shrink-0 ml-1 text-center' },
                            'Ставка'
                          ),
                          h(
                            'span',
                            { className: 'w-[65px] flex-shrink-0 ml-0 text-right' },
                            'Сумма'
                          )
                        ),
                        h(
                          'div',
                          { className: 'space-y-2 text-sm overflow-y-visible custom-scrollbar' },
                          dayEntries.map(entry => {
                            const isNewEntry = newEntryIds && newEntryIds.has(entry.id)
                            console.log(
                              'TimelineView entry:',
                              entry.id,
                              'isNewEntry:',
                              isNewEntry,
                              'shouldAnimateEntries:',
                              shouldAnimateEntries
                            )

                            // Рендерим обычную строку с кнопками
                            const animationClass = isNewEntry
                              ? 'entry-item-new'
                              : `entry-item-animated ${shouldAnimateEntries ? 'animate' : ''}`
                            console.log('TimelineView animationClass:', animationClass)
                            return h(
                              'div',
                              {
                                key: entry.id,
                                className: `${animationClass} ${shouldAnimateEntries ? 'cascade-drop' : ''} group relative p-2 bg-black/5 dark:bg-gray-800/50 rounded-md cursor-pointer min-w-fit max-w-[95%]`,
                                onDoubleClick: () => openEditModal(entry),
                                onContextMenu: e => {
                                  e.preventDefault()
                                  // Закрываем все существующие меню
                                  const existingMenus =
                                    document.querySelectorAll('.timeline-context-menu')
                                  existingMenus.forEach(menu => {
                                    if (menu.parentNode) {
                                      menu.parentNode.removeChild(menu)
                                    }
                                  })

                                  // Создаем контекстное меню
                                  const menu = document.createElement('div')
                                  menu.className =
                                    'timeline-context-menu fixed bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-xl z-50 p-1'
                                  menu.style.left = e.clientX + 'px'
                                  menu.style.top = e.clientY + 'px'

                                  const editBtn = document.createElement('button')
                                  editBtn.className =
                                    'w-full text-left flex items-center gap-2 px-2 py-1.5 text-sm hover:bg-blue-500/10 rounded-md text-blue-600 dark:text-blue-400'
                                  editBtn.innerHTML =
                                    '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>Редактировать'
                                  editBtn.onclick = () => {
                                    openEditModal(entry)
                                    document.body.removeChild(menu)
                                  }

                                  const deleteBtn = document.createElement('button')
                                  deleteBtn.className =
                                    'w-full text-left flex items-center gap-2 px-2 py-1.5 text-sm text-red-500 hover:bg-red-500/10 rounded-md'
                                  deleteBtn.innerHTML =
                                    '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"></polyline><path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path></svg>Удалить'
                                  deleteBtn.onclick = () => {
                                    deleteEntry(entry.id)
                                    document.body.removeChild(menu)
                                  }

                                  menu.appendChild(editBtn)
                                  menu.appendChild(deleteBtn)
                                  document.body.appendChild(menu)

                                  // Закрываем меню при клике вне его
                                  const closeMenu = e => {
                                    if (!menu.contains(e.target)) {
                                      document.body.removeChild(menu)
                                      document.removeEventListener('click', closeMenu)
                                    }
                                  }
                                  setTimeout(() => document.addEventListener('click', closeMenu), 0)
                                },
                              },
                              // Внутренний flex с точечным контролем отступов
                              h(
                                'div',
                                { className: 'flex items-center text-sm' },
                                // Чекбокс для выбора (если включен режим выбора)
                                selectionMode &&
                                  h(
                                    'div',
                                    { className: 'w-6 flex-shrink-0 mr-2' },
                                    h('input', {
                                      type: 'checkbox',
                                      checked: selectedEntries.has(entry.id),
                                      onChange: () => toggleSelection(entry.id),
                                      className:
                                        'w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600',
                                    })
                                  ),
                                // 1. Время (90px) - супер компактно
                                h(
                                  'span',
                                  {
                                    className:
                                      'w-[90px] flex-shrink-0 font-mono text-xs text-gray-800 dark:text-gray-200 truncate',
                                  },
                                  `${entry.start} → ${entry.end}`
                                ),

                                // 2. Перерыв (45px) - максимальный отступ 16px для разделения с Категорией
                                h(
                                  'div',
                                  { className: 'w-[45px] flex-shrink-0 ml-4' },
                                  entry.breakAfter
                                    ? h(
                                        'span',
                                        {
                                          className:
                                            'font-mono text-xs text-blue-700 dark:text-blue-300 bg-blue-100 dark:bg-blue-900/40 px-0.5 py-0.5 rounded whitespace-nowrap inline-block w-full text-center',
                                        },
                                        entry.breakAfter
                                      )
                                    : h('span', {}, '')
                                ),

                                // 3. Категория (130px) - УВЕЛИЧЕНО! Было 80px + 50px от Часов = 130px, отступ 4px
                                h(
                                  'div',
                                  {
                                    className:
                                      'w-[130px] flex-shrink-0 ml-1 flex items-center gap-0.5 overflow-hidden',
                                  },
                                  entry.categoryId &&
                                    settings.categories &&
                                    (() => {
                                      const category = settings.categories.find(
                                        cat => cat.id === entry.categoryId
                                      )
                                      return category
                                        ? h(
                                            'div',
                                            {
                                              className:
                                                'flex items-center gap-0.5 overflow-hidden',
                                            },
                                            h(getCategoryIcon(category.icon), {
                                              size: 11,
                                              className: 'flex-shrink-0',
                                              style: { color: category.color },
                                            }),
                                            h(
                                              'span',
                                              {
                                                className: 'text-xs truncate',
                                                style: { color: category.color },
                                              },
                                              category.name
                                            )
                                          )
                                        : null
                                    })()
                                ),

                                // 4. Ставка (65px) - минимальный, только цифры, отступ 4px
                                h(
                                  'div',
                                  { className: 'w-[65px] flex-shrink-0 ml-1' },
                                  h(
                                    'span',
                                    {
                                      className:
                                        'font-mono text-xs text-teal-700 dark:text-teal-300 bg-teal-100 dark:bg-teal-900/40 px-0.5 py-0.5 rounded whitespace-nowrap inline-block w-full text-center',
                                    },
                                    `${(entry.rate || 0).toLocaleString('ru-RU')}`
                                  )
                                ),

                                // 5. Сумма (65px, по правому краю), только цифры, БЕЗ отступа
                                h(
                                  'span',
                                  {
                                    className:
                                      'w-[65px] flex-shrink-0 ml-0 font-semibold text-xs text-gray-800 dark:text-white text-right',
                                  },
                                  `${entry.earned.toLocaleString('ru-RU')}`
                                )
                              )
                            )
                          })
                        )
                      )
                    )
                  ),
                  h(
                    'div',
                    { className: 'timeline-info w-[45%] absolute top-1/2 -translate-y-1/2' },
                    h(
                      'div',
                      {
                        className: 'timeline-info-card glass-effect rounded-lg p-4 space-y-3',
                        style: { boxShadow: '0 0 20px 2px rgba(59, 130, 246, 0.25)' },
                      },
                      h(
                        'div',
                        { className: 'flex justify-between items-center' },
                        h(
                          'span',
                          {
                            className:
                              'text-sm text-gray-600 dark:text-gray-400 flex items-center gap-2',
                          },
                          h(Clock, {
                            size: 16,
                            className: 'insight-icon text-purple-500 dark:text-purple-400',
                          }),
                          'Макс. сессия'
                        ),
                        h(
                          'strong',
                          { className: 'insight-value font-mono text-gray-800 dark:text-white' },
                          dayStats.longestSession
                        )
                      ),
                      h(
                        'div',
                        { className: 'flex justify-between items-center' },
                        h(
                          'span',
                          {
                            className:
                              'text-sm text-gray-600 dark:text-gray-400 flex items-center gap-2',
                          },
                          h(AlertTriangle, {
                            size: 16,
                            className: 'insight-icon text-orange-500 dark:text-orange-400',
                          }),
                          'Макс. перерыв'
                        ),
                        h(
                          'strong',
                          { className: 'insight-value font-mono text-gray-800 dark:text-white' },
                          dayStats.longestBreak
                        )
                      ),
                      h(
                        'div',
                        { className: 'flex justify-between items-center' },
                        h(
                          'span',
                          {
                            className:
                              'text-sm text-gray-600 dark:text-gray-400 flex items-center gap-2',
                          },
                          h(DollarSign, {
                            size: 16,
                            className: 'insight-icon text-teal-500 dark:text-teal-400',
                          }),
                          'Сред. ставка'
                        ),
                        h(
                          'strong',
                          { className: 'insight-value font-mono text-gray-800 dark:text-white' },
                          dayStats.avgRate
                        )
                      )
                    )
                  )
                )
              })
            )
          )
        }

        // Новый компонент для контекстного меню
        const EntryContextMenu = ({
          targetRef,
          onClose,
          onEdit,
          onDelete,
          openEditModal,
          entry,
          mousePosition,
        }) => {
          const menuRef = React.useRef(null)

          // Используем позицию мыши если есть, иначе позицию элемента
          const { style } = mousePosition
            ? {
                style: {
                  position: 'fixed',
                  left: mousePosition.x,
                  top: mousePosition.y,
                  zIndex: 9999,
                },
              }
            : usePortalPosition({
                triggerRef: targetRef,
                portalRef: menuRef,
                isOpen: true,
                gap: 4,
              })

          React.useEffect(() => {
            const handleClickOutside = event => {
              if (menuRef.current && !menuRef.current.contains(event.target)) {
                onClose()
              }
            }
            document.addEventListener('mousedown', handleClickOutside)
            return () => document.removeEventListener('mousedown', handleClickOutside)
          }, [onClose])

          return createPortal(
            h(
              'div',
              {
                ref: menuRef,
                style: style,
                className:
                  'w-36 glass-effect rounded-lg shadow-xl z-50 p-1 border border-gray-200 dark:border-gray-700',
              },
              h(
                'button',
                {
                  onClick: onEdit,
                  className:
                    'w-full text-left flex items-center gap-2 px-2 py-1.5 text-sm hover:bg-blue-500/10 rounded-md text-blue-600 dark:text-blue-400',
                },
                h(Edit2, { size: 16 }),
                'Редактировать'
              ),
              h(
                'button',
                {
                  onClick: onDelete,
                  className:
                    'w-full text-left flex items-center gap-2 px-2 py-1.5 text-sm text-red-500 hover:bg-red-500/10 rounded-md',
                },
                h(Trash2, { size: 14 }),
                'Удалить'
              )
            ),
            document.getElementById('portal-container')
          )
        }

        // Новый, правильный компонент для одной записи в режиме "Сетка"
        const GridEntryRow = ({
          entry,
          editingEntryId,
          setEditingEntryId,
          updateEntry,
          deleteEntry,
          openEditModal,
          selectionMode,
          selectedEntries,
          toggleSelection,
          newEntryIds,
          shouldAnimateEntries,
        }) => {
          // Теперь хуки вызываются на верхнем уровне этого компонента - это ПРАВИЛЬНО.
          const { settings } = useSettings()
          const buttonRef = React.useRef(null)
          const [isMenuOpen, setIsMenuOpen] = useState(false)
          const [mousePosition, setMousePosition] = useState(null)

          // Логика открытия/закрытия меню теперь инкапсулирована здесь
          const handleMenuToggle = () => {
            setIsMenuOpen(prev => !prev)
          }

          const handleCloseMenu = () => {
            setIsMenuOpen(false)
          }

          const handleEdit = () => {
            if (openEditModal && entry) {
              openEditModal(entry)
            }
            handleCloseMenu()
          }

          const handleDelete = () => {
            deleteEntry(entry.id)
            handleCloseMenu()
          }

          // Обработчики для двойного клика и правого клика
          const handleDoubleClick = () => {
            if (openEditModal && entry) {
              openEditModal(entry)
            }
          }

          const handleContextMenu = e => {
            e.preventDefault()
            setMousePosition({ x: e.clientX, y: e.clientY })
            setIsMenuOpen(true)
          }

          // Рендеринг обычной карточки в сетке
          const duration = calculateDuration(entry.start, entry.end)
          // Вычисление перерыва (break after previous entry)
          const breakAfter = entry.breakAfter || null

          const isNewEntry = newEntryIds && newEntryIds.has(entry.id)
          return h(
            'div',
            {
              className: `${isNewEntry ? 'entry-item-new' : `entry-item-animated ${shouldAnimateEntries ? 'animate' : ''}`} ${shouldAnimateEntries ? 'cascade-drop' : ''} flex items-center py-1.5 px-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-md text-sm group cursor-pointer ${selectedEntries.has(entry.id) ? 'bg-blue-50 dark:bg-blue-900/20 border border-blue-300 dark:border-blue-700' : ''}`,
              onDoubleClick: handleDoubleClick,
              onContextMenu: handleContextMenu,
            },
            // Чекбокс для выбора (если включен режим выбора)
            selectionMode &&
              h(
                'div',
                { className: 'w-6 flex-shrink-0 mr-2' },
                h('input', {
                  type: 'checkbox',
                  checked: selectedEntries.has(entry.id),
                  onChange: () => toggleSelection(entry.id),
                  className:
                    'w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600',
                })
              ),
            // 1. Время (120px)
            h(
              'span',
              {
                className: 'w-[120px] font-mono text-xs text-gray-800 dark:text-gray-200 truncate',
              },
              `${entry.start} → ${entry.end}`
            ),

            // 2. Перерыв (60px) - с заливкой как ставка, только если есть значение, отступ ml-0.5 (уменьшен в 3 раза)
            h(
              'div',
              { className: 'w-[60px] ml-0.5' },
              breakAfter
                ? h(
                    'span',
                    {
                      className:
                        'font-mono text-xs text-blue-700 dark:text-blue-300 bg-blue-100 dark:bg-blue-900/40 px-1 py-0.5 rounded-md whitespace-nowrap inline-block w-full text-center',
                    },
                    breakAfter
                  )
                : h('span', {}, '')
            ),

            // 3. Категория (40px) - ТОЛЬКО ИКОНКА И ЦВЕТ, отступ ml-2
            h(
              'div',
              { className: 'w-[40px] ml-2 flex items-center justify-center' },
              entry.categoryId &&
                settings.categories &&
                (() => {
                  const category = settings.categories.find(cat => cat.id === entry.categoryId)
                  return category
                    ? h(
                        'div',
                        {
                          className: 'group/tooltip relative',
                          style: { cursor: 'help', color: category.color },
                        },
                        h(getCategoryIcon(category.icon), {
                          size: 14,
                        }),
                        // Кастомный tooltip
                        h(
                          'div',
                          {
                            className:
                              'absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 glass-effect text-gray-900 dark:text-white text-xs rounded shadow-lg opacity-0 group-hover/tooltip:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-50 border border-gray-200 dark:border-gray-700',
                            style: { fontSize: '11px' },
                          },
                          category.name
                        )
                      )
                    : null
                })()
            ),

            // 4. Ставка (63px, уменьшена на 30% от 90px) - отступ ml-2
            h(
              'div',
              { className: 'w-[63px] ml-2' },
              h(
                'span',
                {
                  className:
                    'font-mono text-xs text-teal-700 dark:text-teal-300 bg-teal-100 dark:bg-teal-900/40 px-1 py-0.5 rounded-md whitespace-nowrap inline-block w-full text-center',
                },
                `${(entry.rate || 0).toLocaleString('ru-RU')}`
              )
            ),

            // 5. Сумма (70px, по правому краю), отступ ml-1 (уменьшен в 2 раза от ml-2)
            h(
              'span',
              {
                className:
                  'w-[70px] ml-1 font-semibold text-sm text-gray-800 dark:text-white text-right',
              },
              `${entry.earned.toLocaleString('ru-RU')}`
            ),

            // Контекстное меню (появляется при правом клике)
            isMenuOpen &&
              h(EntryContextMenu, {
                targetRef: React.createRef(), // Создаем пустой ref для позиционирования
                onClose: handleCloseMenu,
                onEdit: handleEdit,
                onDelete: handleDelete,
                openEditModal: openEditModal,
                entry: entry,
                mousePosition: mousePosition,
              })
          )
        }

        const EntriesList = ({
          editingEntryId,
          setEditingEntryId,
          addEntry,
          updateEntry,
          deleteEntry,
          openEditModal,
          openNewEntryModal,
          setEntries,
          onClearAll,
          onExport,
          onImport,
          activeTimer,
          elapsedTime,
          handleStartTimer,
          stopTimerAndEdit,
          handleAddNewEntry,
          onCheckBackups,
          newEntryIds,
          setNewEntryIds,
          shouldAnimateEntries,
        }) => {
          const { settings, setSettings } = useSettings()
          const { entries } = useData()
          const dailyPlan = settings?.dailyPlan || 6000
          const { undo, redo, canUndo, canRedo, undoDescription } = useHistory()
          const [tableFilter, setTableFilter] = useState(settings.defaultTableFilter)
          const [tableCustomDateFrom, setTableCustomDateFrom] = useState('')
          const [tableCustomDateTo, setTableCustomDateTo] = useState('')
          const [moreMenuOpen, setMoreMenuOpen] = useState(false)
          const [activeEntryMenu, setActiveEntryMenu] = useState(null)
          const [showCategoryManager, setShowCategoryManager] = useState(false)
          const moreMenuRef = useRef(null)

          // Стабильная функция для закрытия CategoryManager
          const handleCloseCategoryManager = useCallback(() => {
            setShowCategoryManager(false)
          }, [])

          // Состояние для массовых операций
          const [selectionMode, setSelectionMode] = useState(false)
          const [selectedEntries, setSelectedEntries] = useState(new Set())
          const [showBulkModal, setShowBulkModal] = useState(false)
          const [bulkActionType, setBulkActionType] = useState(null)
          const [selectedCategoryId, setSelectedCategoryId] = useState('')

          // Состояние для анимаций (получаем из MainApp)
          console.log('EntriesList: shouldAnimateEntries =', shouldAnimateEntries)

          // Блокируем скролл фона при открытии модального окна
          useEffect(() => {
            if (showBulkModal && bulkActionType === 'category') {
              document.body.style.overflow = 'hidden'
              return () => {
                document.body.style.overflow = ''
              }
            }
          }, [showBulkModal, bulkActionType])

          // Функции для массовых операций
          const toggleSelection = entryId => {
            setSelectedEntries(prev => {
              const newSet = new Set(prev)
              if (newSet.has(entryId)) {
                newSet.delete(entryId)
              } else {
                newSet.add(entryId)
              }
              return newSet
            })
          }

          const selectAllEntries = () => {
            const allEntryIds = Object.values(groupedEntries)
              .flat()
              .map(entry => entry.id)
            setSelectedEntries(new Set(allEntryIds))
          }

          const clearSelection = () => {
            setSelectedEntries(new Set())
            setSelectionMode(false)
          }

          const handleBulkAction = actionType => {
            if (actionType === 'export') {
              // Экспорт выполняется сразу без модального окна
              const selectedIds = Array.from(selectedEntries)
              const selectedEntriesData = entries.filter(entry => selectedIds.includes(entry.id))

              const exportData = {
                entries: selectedEntriesData,
                exportedAt: new Date().toISOString(),
                count: selectedEntriesData.length,
              }
              const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                type: 'application/json',
              })
              const url = URL.createObjectURL(blob)
              const a = document.createElement('a')
              a.href = url
              a.download = `selected_entries_${new Date().toISOString().split('T')[0]}.json`
              a.click()
              URL.revokeObjectURL(url)
              alert(`Экспортировано ${selectedIds.length} записей`)
              // Сбрасываем выбор после экспорта
              setSelectedEntries(new Set())
              setSelectionMode(false)
            } else if (actionType === 'delete') {
              // Удаление выполняется сразу с подтверждением
              console.log('Delete action triggered, selectedEntries:', selectedEntries)
              if (
                confirm(`Удалить ${selectedEntries.size} записей? Это действие нельзя отменить.`)
              ) {
                const selectedIds = Array.from(selectedEntries)
                console.log('Selected IDs to delete:', selectedIds)
                console.log('Current entries before deletion:', entries.length)
                // Простое уведомление
                alert(`Удалено ${selectedIds.length} записей`)
                setEntries(entries.filter(entry => !selectedIds.includes(entry.id)))
                // Сбрасываем выбор после удаления
                setSelectedEntries(new Set())
                setSelectionMode(false)
                console.log('Deletion completed')
              }
            } else {
              setBulkActionType(actionType)
              setShowBulkModal(true)
            }
          }

          const executeBulkAction = actionData => {
            const selectedIds = Array.from(selectedEntries)
            const selectedEntriesData = entries.filter(entry => selectedIds.includes(entry.id))

            switch (bulkActionType) {
              case 'category':
                undo(`Изменить категорию для ${selectedIds.length} записей`)
                setEntries(
                  entries.map(entry =>
                    selectedIds.includes(entry.id)
                      ? { ...entry, categoryId: actionData.categoryId }
                      : entry
                  )
                )
                // Сбрасываем выбор после изменения категории
                setSelectedEntries(new Set())
                setSelectionMode(false)
                // Без уведомления - действие выполняется тихо
                break
              case 'export':
                const exportData = {
                  entries: selectedEntriesData,
                  exportedAt: new Date().toISOString(),
                  count: selectedEntriesData.length,
                }
                const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                  type: 'application/json',
                })
                const url = URL.createObjectURL(blob)
                const a = document.createElement('a')
                a.href = url
                a.download = `selected_entries_${new Date().toISOString().split('T')[0]}.json`
                a.click()
                URL.revokeObjectURL(url)
                // Простое уведомление
                alert(`Экспортировано ${selectedIds.length} записей`)
                break
            }

            setShowBulkModal(false)
            setBulkActionType(null)
            clearSelection()
          }

          const groupedEntries = getFilteredEntries(
            entries,
            tableFilter,
            tableCustomDateFrom,
            tableCustomDateTo
          ).reduce((acc, entry) => {
            if (!acc[entry.date]) acc[entry.date] = []
            acc[entry.date].push(entry)
            return acc
          }, {})

          Object.values(groupedEntries).forEach(dayEntries =>
            dayEntries.sort((a, b) => a.start.localeCompare(b.start))
          )
          const grouped = Object.entries(groupedEntries).sort(([a], [b]) => b.localeCompare(a))

          const handleSetDefaultTableFilter = filter => {
            setSettings(s => ({ ...s, defaultTableFilter: filter }))
          }
          const formatDateWithWeekday = dateString =>
            new Date(dateString)
              .toLocaleDateString('ru-RU', {
                year: '2-digit',
                month: '2-digit',
                day: '2-digit',
                weekday: 'short',
              })
              .replace(/, /g, ' ')
              .toUpperCase()

          useEffect(() => {
            const handleClickOutside = event => {
              if (moreMenuRef.current && !moreMenuRef.current.contains(event.target)) {
                setMoreMenuOpen(false)
              }
              if (!event.target.closest('.context-menu-container')) {
                setActiveEntryMenu(null)
              }
            }
            document.addEventListener('mousedown', handleClickOutside)
            return () => document.removeEventListener('mousedown', handleClickOutside)
          }, [])

          return h(
            'div',
            {
              className:
                'glass-effect rounded-xl shadow-lg p-6 border border-gray-200 dark:border-gray-500/20',
            },
            // Top control panel
            h(
              'div',
              { className: 'flex flex-col sm:flex-row justify-between items-center mb-4 gap-3' },
              h(
                'div',
                { className: 'flex items-center gap-3' },
                h(
                  'h3',
                  { className: 'text-xl font-bold text-gray-900 dark:text-white' },
                  'Записи о работе'
                ),
                h(
                  'div',
                  { className: 'flex items-center gap-1' },
                  h(
                    'button',
                    {
                      onClick: undo,
                      disabled: !canUndo,
                      className:
                        'button-undo p-2 rounded-full hover:bg-gray-500/10 disabled:opacity-50 disabled:cursor-not-allowed transition-colors',
                      title: canUndo ? undoDescription : 'Нечего отменять',
                    },
                    h(CornerUpLeft, { size: 18 })
                  ),
                  h(
                    'button',
                    {
                      onClick: redo,
                      disabled: !canRedo,
                      className:
                        'button-redo p-2 rounded-full hover:bg-gray-500/10 disabled:opacity-50 disabled:cursor-not-allowed transition-colors',
                      title: canRedo ? 'Повторить' : 'Нечего повторять',
                    },
                    h(CornerUpRight, { size: 18 })
                  )
                ),
                h(
                  'div',
                  { className: 'flex items-center gap-1' },
                  h('span', { className: 'text-sm text-gray-600 dark:text-gray-400' }, 'Вид:'),
                  h(
                    'div',
                    { className: 'flex items-center gap-1' },
                    h(
                      'button',
                      {
                        onClick: () => setSettings(s => ({ ...s, listView: 'list' })),
                        className: `button-animated p-2 rounded-full hover:bg-gray-500/10 transition-colors ${settings.listView === 'list' ? 'text-blue-500' : 'text-gray-600 dark:text-gray-400'}`,
                        title: 'Список',
                      },
                      h(List, { size: 16 })
                    ),
                    h(
                      'button',
                      {
                        onClick: () => setSettings(s => ({ ...s, listView: 'grid' })),
                        className: `button-animated p-2 rounded-full hover:bg-gray-500/10 transition-colors ${settings.listView === 'grid' ? 'text-blue-500' : 'text-gray-600 dark:text-gray-400'}`,
                        title: 'Сетка',
                      },
                      h(Grid, { size: 16 })
                    ),
                    h(
                      'button',
                      {
                        onClick: () => setSettings(s => ({ ...s, listView: 'timeline' })),
                        className: `button-animated p-2 rounded-full hover:bg-gray-500/10 transition-colors ${settings.listView === 'timeline' ? 'text-blue-500' : 'text-gray-600 dark:text-gray-400'}`,
                        title: 'Таймлайн',
                      },
                      h(TimelineIcon, { size: 16 })
                    )
                  )
                )
              ),
              h(
                'div',
                { className: 'flex flex-wrap items-center gap-3 ml-auto' },
                !activeTimer
                  ? h(
                      'button',
                      {
                        onClick: handleStartTimer,
                        className:
                          'button-animated glass-button glass-button-green flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold',
                      },
                      h(Play, { size: 16 }),
                      ' Старт'
                    )
                  : h(
                      'button',
                      {
                        onClick: stopTimerAndEdit,
                        className:
                          'button-animated glass-button glass-button-red flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold',
                      },
                      h(Square, { size: 16 }),
                      ` Стоп (${new Date(elapsedTime).toISOString().substr(11, 8)})`
                    ),
                !selectionMode
                  ? h(
                      'button',
                      {
                        onClick: () => setSelectionMode(true),
                        className:
                          'button-animated glass-button glass-button-gray flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold',
                      },
                      h(CheckSquare, { size: 16 }),
                      'Выбрать'
                    )
                  : h(
                      'button',
                      {
                        onClick: clearSelection,
                        className:
                          'button-animated glass-button glass-button-red flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold',
                      },
                      h(X, { size: 16 }),
                      'Отменить'
                    ),
                h(
                  'button',
                  {
                    onClick: openNewEntryModal,
                    className:
                      'button-animated glass-button glass-button-blue flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold',
                  },
                  h(PlusCircle, { size: 16 }),
                  'Добавить'
                ),
                h(
                  Dropdown,
                  {
                    options: {
                      import: h(
                        'div',
                        { className: 'flex items-center gap-2' },
                        h(Download, { size: 16, className: 'text-gray-500 dark:text-gray-400' }),
                        'Импорт базы'
                      ),
                      export: h(
                        'div',
                        { className: 'flex items-center gap-2' },
                        h(Upload, { size: 16, className: 'text-gray-500 dark:text-gray-400' }),
                        'Экспорт базы'
                      ),
                      backups: h(
                        'div',
                        { className: 'flex items-center gap-2' },
                        h(Database, { size: 16, className: 'text-gray-500 dark:text-gray-400' }),
                        'Проверка бэкапов'
                      ),
                      categories: h(
                        'div',
                        { className: 'flex items-center gap-2' },
                        h(Grid, { size: 16, className: 'text-gray-500 dark:text-gray-400' }),
                        'Настройка категорий'
                      ),
                    },
                    onSelect: action => {
                      if (action === 'import') onImport()
                      if (action === 'export') onExport()
                      if (action === 'backups') onCheckBackups()
                      if (action === 'categories') setShowCategoryManager(true)
                    },
                    buttonClassName:
                      'button-animated glass-button glass-button-gray p-2 rounded-full transition-colors opacity-70 hover:opacity-100',
                  },
                  h(Settings, { size: 16, className: 'text-gray-600 dark:text-white' })
                )
              )
            ),

            // Панель массовых действий
            selectionMode &&
              selectedEntries.size > 0 &&
              h(
                'div',
                {
                  className:
                    'mb-4 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg',
                },
                h(
                  'div',
                  { className: 'flex items-center justify-between' },
                  h(
                    'div',
                    { className: 'flex items-center gap-3' },
                    h(
                      'span',
                      { className: 'text-sm font-medium text-blue-800 dark:text-blue-200' },
                      `Выбрано: ${selectedEntries.size} записей`
                    ),
                    h(
                      'button',
                      {
                        onClick: selectAllEntries,
                        className:
                          'text-xs text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 underline',
                      },
                      'Выбрать все'
                    ),
                    h(
                      'button',
                      {
                        onClick: () => setSelectedEntries(new Set()),
                        className:
                          'text-xs text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-200 underline ml-2',
                      },
                      'Отменить все'
                    )
                  ),
                  h(
                    'div',
                    { className: 'flex items-center gap-2' },
                    h(
                      'button',
                      {
                        onClick: () => handleBulkAction('category'),
                        className:
                          'button-bulk-category glass-button glass-button-green px-3 py-1 rounded text-sm',
                      },
                      'Изменить категорию'
                    ),
                    h(
                      'button',
                      {
                        onClick: () => handleBulkAction('export'),
                        className:
                          'button-bulk-export glass-button glass-button-purple px-3 py-1 rounded text-sm',
                      },
                      'Экспортировать'
                    ),
                    h(
                      'button',
                      {
                        onClick: () => handleBulkAction('delete'),
                        className:
                          'button-bulk-delete glass-button glass-button-red px-3 py-1 rounded text-sm',
                      },
                      'Удалить'
                    )
                  )
                )
              ),

            h(
              'div',
              { className: 'relative' },
              // Timeline View
              h(
                'div',
                {
                  className: `view-content ${settings.listView === 'timeline' ? 'active' : ''}`,
                  style: {
                    display: settings.listView === 'timeline' ? 'block' : 'none',
                  },
                },
                h(TimelineView, {
                  groupedEntries: grouped,
                  dailyPlan,
                  editingEntryId,
                  setEditingEntryId,
                  updateEntry,
                  deleteEntry,
                  openEditModal,
                  selectionMode,
                  selectedEntries,
                  toggleSelection,
                  newEntryIds,
                  shouldAnimateEntries,
                  settings,
                })
              ),
              // List/Grid View
              h(
                'div',
                {
                  className: `view-content ${settings.listView !== 'timeline' ? 'active' : ''} ${settings.listView === 'grid' ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4' : 'space-y-4'} mt-2 max-h-[70vh] overflow-y-auto overflow-x-hidden pr-2 custom-scrollbar`,
                  style: {
                    display: settings.listView !== 'timeline' ? 'block' : 'none',
                  },
                },
                grouped.length === 0
                  ? h(
                      'div',
                      { className: 'text-center py-8 text-gray-500 dark:text-gray-400' },
                      h('div', { className: 'text-lg mb-2' }, '📝'),
                      h('div', { className: 'text-sm' }, 'Нет записей для отображения'),
                      h(
                        'div',
                        { className: 'text-xs mt-1' },
                        "Добавьте первую запись, нажав кнопку 'Добавить'"
                      )
                    )
                  : grouped.map(([date, dateEntries], idx) => {
                      const dailyTotal = dateEntries.reduce((sum, entry) => sum + entry.earned, 0)
                      const totalDuration = dateEntries.reduce(
                        (sum, e) => sum + calculateDuration(e.start, e.end),
                        0
                      )
                      const progress =
                        dailyPlan > 0 ? Math.min(100, (dailyTotal / dailyPlan) * 100) : 0
                      const entriesWithBreaks = [...dateEntries]
                        .sort((a, b) => a.start.localeCompare(b.start))
                        .map((entry, i, arr) => {
                          let breakAfter = null
                          // Если это не последняя запись за день
                          if (i < arr.length - 1) {
                            const nextEntry = arr[i + 1]
                            // Считаем разницу в минутах между концом текущей и началом следующей
                            const gapMinutes =
                              timeToMinutes(nextEntry.start) - timeToMinutes(entry.end)
                            if (gapMinutes > 0) {
                              breakAfter = minutesToTime(gapMinutes) // Используем существующую утилиту
                            }
                          }
                          return { ...entry, breakAfter } // Возвращаем запись с новым свойством
                        })
                      const renderEntryRow = (entry, index, isGrid) => {
                        // вычисление перерыва до текущей записи
                        let breakText = null
                        if (index > 0) {
                          const prev = dateEntries[index - 1]
                          const gap =
                            (timeToMinutes(entry.start) + 24 * 60 - timeToMinutes(prev.end)) %
                            (24 * 60)
                          if (gap > 0) {
                            const hGap = Math.floor(gap / 60)
                            const mGap = Math.round(gap % 60)
                            breakText = `${String(hGap).padStart(2, '0')}:${String(mGap).padStart(2, '0')}`
                          }
                        }

                        // Новый, правильный код
                        if (isGrid) {
                          return h(GridEntryRow, {
                            key: entry.id,
                            entry: entry,
                            editingEntryId: editingEntryId,
                            setEditingEntryId: setEditingEntryId,
                            updateEntry: updateEntry,
                            deleteEntry: deleteEntry,
                            openEditModal: openEditModal,
                            selectionMode,
                            selectedEntries,
                            toggleSelection,
                            newEntryIds,
                            shouldAnimateEntries,
                          })
                        }

                        const isNewEntry = false // Можно добавить логику для определения новых записей
                        return h(
                          'div',
                          {
                            key: entry.id,
                            className: `${isNewEntry ? 'entry-item-new' : `entry-item-animated ${shouldAnimateEntries ? 'animate' : ''}`} ${shouldAnimateEntries ? 'cascade-drop' : ''} group relative flex items-center py-1.5 px-2 rounded-md hover:bg-black/5 dark:hover:bg-white/5 cursor-pointer ${selectedEntries.has(entry.id) ? 'bg-blue-50 dark:bg-blue-900/20 border border-blue-300 dark:border-blue-700' : ''}`,
                            onDoubleClick: () => openEditModal(entry),
                            onContextMenu: e => {
                              e.preventDefault()
                              setActiveEntryMenu(entry.id)
                            },
                          },
                          // Чекбокс для выбора (если включен режим выбора)
                          selectionMode &&
                            h(
                              'div',
                              { className: 'w-6 flex-shrink-0 mr-2' },
                              h('input', {
                                type: 'checkbox',
                                checked: selectedEntries && selectedEntries.has(entry.id),
                                onChange: e => {
                                  e.stopPropagation()
                                  toggleSelection(entry.id)
                                },
                                onClick: e => e.stopPropagation(),
                                className:
                                  'w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600',
                              })
                            ),
                          h(
                            'div',
                            { className: 'truncate flex-grow flex items-baseline gap-2' },
                            h(
                              'span',
                              { className: 'font-mono text-gray-800 dark:text-gray-200' },
                              `${entry.start} → ${entry.end}`
                            ),
                            breakText &&
                              h(
                                'span',
                                { className: 'font-mono text-xs text-blue-500 dark:text-blue-400' },
                                breakText
                              )
                          ),
                          h(
                            'span',
                            {
                              className:
                                'text-sm text-gray-700 dark:text-gray-300 w-20 text-center font-semibold',
                            },
                            `${calculateDuration(entry.start, entry.end).toFixed(2)} ч`
                          ),
                          h(
                            'div',
                            { className: 'flex items-center gap-1 justify-center' },
                            entry.categoryId &&
                              settings.categories &&
                              (() => {
                                const category = settings.categories.find(
                                  cat => cat.id === entry.categoryId
                                )
                                return category
                                  ? h(
                                      'div',
                                      { className: 'flex items-center gap-1' },
                                      h('div', {
                                        className: 'w-2 h-2 rounded-full',
                                        style: { backgroundColor: category.color },
                                      }),
                                      h(getCategoryIcon(category.icon), {
                                        size: 12,
                                        className: 'text-gray-500 dark:text-gray-400',
                                      }),
                                      h(
                                        'span',
                                        { className: 'text-xs text-gray-500 dark:text-gray-400' },
                                        category.name
                                      )
                                    )
                                  : null
                              })()
                          ),
                          h(
                            'p',
                            {
                              className:
                                'font-semibold text-gray-800 dark:text-gray-200 text-right w-20',
                            },
                            `${(entry.earned || 0).toLocaleString('ru-RU')} ₽`
                          ),

                          // Контекстное меню (появляется при правом клике)
                          activeEntryMenu === entry.id &&
                            h(
                              'div',
                              {
                                className:
                                  'absolute right-0 top-full mt-1 w-32 glass-effect rounded-lg shadow-xl z-20 p-1 border border-gray-200 dark:border-gray-700',
                              },
                              h(
                                'button',
                                {
                                  onClick: () => {
                                    openEditModal(entry)
                                    setActiveEntryMenu(null)
                                  },
                                  className:
                                    'w-full text-left flex items-center gap-2 px-2 py-1.5 text-sm hover:bg-gray-500/10 rounded-md text-blue-600 dark:text-blue-400',
                                },
                                h(Edit2, { size: 16 }),
                                'Редактировать'
                              ),
                              h(
                                'button',
                                {
                                  onClick: () => {
                                    deleteEntry(entry.id)
                                    setActiveEntryMenu(null)
                                  },
                                  className:
                                    'w-full text-left flex items-center gap-2 px-2 py-1.5 text-sm text-red-500 hover:bg-red-500/10 rounded-md',
                                },
                                h(Trash2, { size: 14 }),
                                'Удалить'
                              )
                            )
                        )
                      }
                      if (settings.listView === 'list') {
                        // Метрики дня для панелей инсайтов
                        const sortedByStart = [...dateEntries].sort((a, b) =>
                          (a.start || '').localeCompare(b.start || '')
                        )
                        let longestSessionMin = 0
                        let longestBreakMin = 0
                        let totalHoursForAvg = 0
                        let totalEarnedInDay = 0
                        for (let i = 0; i < sortedByStart.length; i++) {
                          const e = sortedByStart[i]
                          const durHours = calculateDuration(e.start, e.end)
                          if (durHours * 60 > longestSessionMin) longestSessionMin = durHours * 60
                          totalHoursForAvg += Math.max(0, durHours)
                          totalEarnedInDay += e.earned || 0
                          if (i > 0) {
                            const prev = sortedByStart[i - 1]
                            const gapMin =
                              (timeToMinutes(e.start) + 24 * 60 - timeToMinutes(prev.end)) %
                              (24 * 60)
                            if (gapMin > longestBreakMin) longestBreakMin = gapMin
                          }
                        }
                        const toHM = minutes => {
                          const h = Math.floor(minutes / 60)
                          const m = Math.round(minutes % 60)
                          return `${String(h)}:${String(m).padStart(2, '0')}`
                        }
                        const maxSession = toHM(longestSessionMin)
                        const maxBreak = toHM(longestBreakMin)
                        const avgRate =
                          totalHoursForAvg > 0
                            ? `${Math.round(totalEarnedInDay / totalHoursForAvg)} ₽/ч`
                            : '0 ₽/ч'

                        // Статус дня относительно плана
                        let status = {
                          text: 'Близко к плану',
                          colorText: 'text-yellow-500',
                          sumColor: 'text-yellow-400',
                          icon: h(AlertTriangle, { size: 12 }),
                        }
                        if (dailyPlan > 0) {
                          const ratio = dailyTotal / dailyPlan
                          if (ratio >= 1) {
                            status = {
                              text: 'План выполнен',
                              colorText: 'text-green-500',
                              sumColor: 'text-green-400',
                              icon: h(CheckCircle, { size: 12 }),
                            }
                          } else if (ratio >= 0.5) {
                            // 0.50–0.99
                            status = {
                              text: 'Близко к плану',
                              colorText: 'text-yellow-500',
                              sumColor: 'text-yellow-400',
                              icon: h(AlertTriangle, { size: 12 }),
                            }
                          } else {
                            // < 0.50
                            status = {
                              text: 'План не выполнен',
                              colorText: 'text-red-500',
                              sumColor: 'text-red-400',
                              icon: h(AlertTriangle, { size: 12 }),
                            }
                          }
                        }
                        // Новый аккордеон-список на основе zapici_o_rabote_spisok_c_1.html
                        return h(
                          'details',
                          {
                            key: date,
                            className:
                              'bg-white dark:bg-gray-800/50 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700/50 overflow-visible transition-all duration-300 mb-3',
                            open: idx === 0, // первый по умолчанию открыт
                          },
                          h(
                            'summary',
                            {
                              className:
                                'p-4 cursor-pointer list-none hover:bg-gray-100/50 dark:hover:bg-gray-900/20',
                            },
                            // Одна строка: дата + инсайты + итого
                            h(
                              'div',
                              { className: 'flex items-center gap-4' },
                              // Левая часть: дата + статус
                              h(
                                'div',
                                { className: 'flex items-center gap-3 min-w-0' },
                                h(
                                  'div',
                                  { className: 'details-icon text-gray-400 flex-shrink-0' },
                                  h(ChevronDown, { size: 18 })
                                ),
                                h(
                                  'div',
                                  { className: 'min-w-0' },
                                  h(
                                    'h4',
                                    {
                                      className:
                                        'font-bold text-gray-800 dark:text-white whitespace-nowrap',
                                    },
                                    formatDateWithWeekday(date)
                                  ),
                                  h(
                                    'div',
                                    {
                                      className: `flex items-center gap-1 text-xs ${status.colorText}`,
                                    },
                                    status.icon,
                                    h('span', {}, status.text)
                                  )
                                )
                              ),
                              // Центр: инсайты (3 плашки)
                              h(
                                'div',
                                { className: 'flex gap-3 flex-1 justify-center' },
                                // max session
                                h(
                                  'div',
                                  {
                                    className:
                                      'bg-blue-50 dark:bg-blue-900/30 px-5 py-4 rounded-lg flex items-center gap-4 min-w-[160px]',
                                  },
                                  h('div', { className: 'text-blue-500' }, h(Clock, { size: 20 })),
                                  h(
                                    'div',
                                    { className: 'flex items-center gap-2' },
                                    h(
                                      'span',
                                      { className: 'text-sm text-blue-800 dark:text-blue-300' },
                                      'Макс. сессия:'
                                    ),
                                    h(
                                      'span',
                                      {
                                        className:
                                          'font-bold text-base text-blue-900 dark:text-white',
                                      },
                                      `${maxSession}`
                                    )
                                  )
                                ),
                                // max break
                                h(
                                  'div',
                                  {
                                    className:
                                      'bg-yellow-50 dark:bg-yellow-900/30 px-5 py-4 rounded-lg flex items-center gap-4 min-w-[160px]',
                                  },
                                  h(
                                    'div',
                                    { className: 'text-yellow-500' },
                                    h(AlertTriangle, { size: 20 })
                                  ),
                                  h(
                                    'div',
                                    { className: 'flex items-center gap-2' },
                                    h(
                                      'span',
                                      { className: 'text-sm text-yellow-800 dark:text-yellow-300' },
                                      'Макс. перерыв:'
                                    ),
                                    h(
                                      'span',
                                      {
                                        className:
                                          'font-bold text-base text-yellow-900 dark:text-white',
                                      },
                                      `${maxBreak}`
                                    )
                                  )
                                ),
                                // avg rate
                                h(
                                  'div',
                                  {
                                    className:
                                      'bg-teal-50 dark:bg-teal-900/30 px-5 py-4 rounded-lg flex items-center gap-4 min-w-[160px]',
                                  },
                                  h(
                                    'div',
                                    { className: 'text-teal-500' },
                                    h(DollarSign, { size: 20 })
                                  ),
                                  h(
                                    'div',
                                    { className: 'flex items-center gap-2' },
                                    h(
                                      'span',
                                      { className: 'text-sm text-teal-800 dark:text-teal-300' },
                                      'Сред. ставка:'
                                    ),
                                    h(
                                      'span',
                                      {
                                        className:
                                          'font-bold text-base text-teal-900 dark:text-white',
                                      },
                                      `${avgRate}`
                                    )
                                  )
                                )
                              ),
                              // Правая часть: итого
                              h(
                                'div',
                                { className: 'text-right flex-shrink-0' },
                                h(
                                  'span',
                                  { className: 'text-xs text-gray-500 dark:text-gray-400' },
                                  'ИТОГО ЗА ДЕНЬ'
                                ),
                                h(
                                  'p',
                                  { className: `font-extrabold text-2xl ${status.sumColor}` },
                                  `${dailyTotal.toLocaleString('ru-RU')} ₽`
                                )
                              )
                            )
                          ),
                          h(
                            'div',
                            { className: 'details-content overflow-visible' },
                            h(
                              'div',
                              { className: 'border-t border-gray-200 dark:border-gray-700/50' },
                              h(
                                'div',
                                { className: 'p-4' },
                                // ...
                                // Заголовки столбцов
                                h(
                                  'div',
                                  {
                                    className:
                                      'grid grid-cols-[140px_80px_minmax(180px,1fr)_90px_110px_100px] gap-3 px-2 pt-0 pb-2 text-xs font-semibold text-gray-500 dark:text-gray-400 border-b border-gray-200 dark:border-gray-700',
                                  },
                                  h('span', {}, 'Время'),
                                  h('span', {}, 'Перерыв'),
                                  h('span', {}, 'Категория'),
                                  h('span', {}, 'Часы'),
                                  h('span', { className: 'text-center' }, 'Ставка'),
                                  h('span', { className: 'text-right' }, 'Сумма')
                                ),
                                h(
                                  'div',
                                  { className: 'space-y-1' },
                                  entriesWithBreaks.map(
                                    (
                                      entry,
                                      index // <-- ИСПОЛЬЗУЕМ НОВЫЙ МАССИВ
                                    ) =>
                                      (() => {
                                        // СТАРАЯ ЛОГИКА УДАЛЕНА
                                        const isNewEntry = newEntryIds && newEntryIds.has(entry.id)
                                        return h(
                                          'div',
                                          {
                                            key: entry.id,
                                            className: `${isNewEntry ? 'entry-item-new' : `entry-item-animated ${shouldAnimateEntries ? 'animate' : ''}`} ${shouldAnimateEntries ? 'cascade-drop' : ''} grid ${selectionMode ? 'grid-cols-[auto_140px_80px_minmax(180px,1fr)_90px_110px_100px]' : 'grid-cols-[140px_80px_minmax(180px,1fr)_90px_110px_100px]'} gap-3 items-center py-1.5 px-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-md text-sm group cursor-pointer ${selectedEntries && selectedEntries.has(entry.id) ? 'bg-blue-50 dark:bg-blue-900/20 border border-blue-300 dark:border-blue-700' : ''}`,
                                            onDoubleClick: () => openEditModal(entry),
                                            onContextMenu: e => {
                                              e.preventDefault()
                                              // Закрываем все существующие меню
                                              const existingMenus =
                                                document.querySelectorAll('.list-context-menu')
                                              existingMenus.forEach(menu => {
                                                if (menu.parentNode) {
                                                  menu.parentNode.removeChild(menu)
                                                }
                                              })

                                              // Создаем контекстное меню
                                              const menu = document.createElement('div')
                                              menu.className =
                                                'list-context-menu fixed bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-xl z-50 p-1'
                                              menu.style.left = e.clientX + 'px'
                                              menu.style.top = e.clientY + 'px'

                                              const editBtn = document.createElement('button')
                                              editBtn.className =
                                                'w-full text-left flex items-center gap-2 px-2 py-1.5 text-sm hover:bg-blue-500/10 rounded-md text-blue-600 dark:text-blue-400'
                                              editBtn.innerHTML =
                                                '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>Редактировать'
                                              editBtn.onclick = () => {
                                                openEditModal(entry)
                                                document.body.removeChild(menu)
                                              }

                                              const deleteBtn = document.createElement('button')
                                              deleteBtn.className =
                                                'w-full text-left flex items-center gap-2 px-2 py-1.5 text-sm text-red-500 hover:bg-red-500/10 rounded-md'
                                              deleteBtn.innerHTML =
                                                '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"></polyline><path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path></svg>Удалить'
                                              deleteBtn.onclick = () => {
                                                deleteEntry(entry.id)
                                                document.body.removeChild(menu)
                                              }

                                              menu.appendChild(editBtn)
                                              menu.appendChild(deleteBtn)
                                              document.body.appendChild(menu)

                                              // Закрываем меню при клике вне его
                                              const closeMenu = e => {
                                                if (!menu.contains(e.target)) {
                                                  document.body.removeChild(menu)
                                                  document.removeEventListener('click', closeMenu)
                                                }
                                              }
                                              setTimeout(
                                                () => document.addEventListener('click', closeMenu),
                                                0
                                              )
                                            },
                                          },
                                          // Чекбокс для выбора (если включен режим выбора)
                                          selectionMode &&
                                            h(
                                              'div',
                                              { className: 'flex items-center justify-center' },
                                              h('input', {
                                                type: 'checkbox',
                                                checked:
                                                  selectedEntries && selectedEntries.has(entry.id),
                                                onChange: e => {
                                                  e.stopPropagation()
                                                  toggleSelection(entry.id)
                                                },
                                                onClick: e => e.stopPropagation(),
                                                className:
                                                  'w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600',
                                              })
                                            ),
                                          // 1. Время (140px)
                                          h(
                                            'span',
                                            {
                                              className:
                                                'font-mono text-gray-800 dark:text-gray-200 truncate',
                                            },
                                            `${entry.start} → ${entry.end}`
                                          ),

                                          // 2. Перерыв (80px) - с заливкой как ставка, только если есть значение
                                          h(
                                            'div',
                                            { className: 'w-full' },
                                            entry.breakAfter
                                              ? h(
                                                  'span',
                                                  {
                                                    className:
                                                      'font-mono text-xs text-blue-700 dark:text-blue-300 bg-blue-100 dark:bg-blue-900/40 px-2 py-0.5 rounded-md whitespace-nowrap inline-block w-full text-center',
                                                  },
                                                  entry.breakAfter
                                                )
                                              : h('span', {}, '')
                                          ),

                                          // 3. Категория (гибкая, минимум 180px)
                                          h(
                                            'div',
                                            { className: 'flex items-center gap-1 min-w-0' },
                                            entry.categoryId &&
                                              settings.categories &&
                                              (() => {
                                                const category = settings.categories.find(
                                                  cat => cat.id === entry.categoryId
                                                )
                                                return category
                                                  ? h(
                                                      'div',
                                                      {
                                                        className:
                                                          'flex items-center gap-1 overflow-hidden',
                                                      },
                                                      h(getCategoryIcon(category.icon), {
                                                        size: 14,
                                                        className: 'flex-shrink-0',
                                                        color: category.color,
                                                      }),
                                                      h(
                                                        'span',
                                                        {
                                                          className: 'text-xs truncate',
                                                          style: { color: category.color },
                                                        },
                                                        category.name
                                                      )
                                                    )
                                                  : null
                                              })()
                                          ),

                                          // 4. Часы (90px)
                                          h(
                                            'span',
                                            {
                                              className:
                                                'text-sm text-gray-700 dark:text-gray-300 font-semibold whitespace-nowrap',
                                            },
                                            `${calculateDuration(entry.start, entry.end).toFixed(2)} ч`
                                          ),

                                          // 5. Ставка (110px) - одинаковая ширина заливки
                                          h(
                                            'div',
                                            { className: 'w-full' },
                                            h(
                                              'span',
                                              {
                                                className:
                                                  'font-mono text-xs text-teal-700 dark:text-teal-300 bg-teal-100 dark:bg-teal-900/40 px-2 py-0.5 rounded-md whitespace-nowrap inline-block w-full text-center',
                                              },
                                              `${(entry.rate || 0).toLocaleString('ru-RU')} ₽/ч`
                                            )
                                          ),

                                          // 6. Сумма (100px, по правому краю)
                                          h(
                                            'span',
                                            {
                                              className:
                                                'font-semibold text-gray-800 dark:text-white text-right',
                                            },
                                            `${entry.earned.toLocaleString('ru-RU')} ₽`
                                          )
                                        )
                                      })()
                                  )
                                )
                              )
                            )
                          )
                        )
                      } else {
                        // GRID VIEW (Concept 4)
                        return h(
                          'div',
                          {
                            key: date,
                            className:
                              'relative bg-gradient-to-br from-blue-200 to-blue-50 dark:from-blue-500/10 dark:to-gray-900/20 rounded-xl shadow-lg border border-blue-200/50 dark:border-gray-700/50 p-4 flex flex-col transition-all duration-300 hover:-translate-y-1 hover:z-10',
                          },
                          h(
                            'div',
                            { className: 'flex justify-between items-center pb-2 mb-2' },
                            h(
                              'h4',
                              { className: 'font-bold text-gray-800 dark:text-gray-200' },
                              formatDateWithWeekday(date)
                            ),
                            h(
                              'div',
                              { className: 'text-right' },
                              h(
                                'span',
                                { className: 'text-xs text-gray-500 dark:text-gray-400 block' },
                                'ИТОГО'
                              ),
                              h(
                                'p',
                                {
                                  className: 'font-extrabold text-lg',
                                  style: getDailyTotalStyle(dailyTotal, dailyPlan, settings.theme),
                                },
                                `${dailyTotal.toLocaleString('ru-RU', { maximumFractionDigits: 0 })} ₽`
                              )
                            )
                          ),
                          h(
                            'div',
                            {
                              className:
                                'flex justify-between items-center text-xs text-gray-600 dark:text-gray-400 mb-2',
                            },
                            h('span', {}, `${totalDuration.toFixed(2)} ч`),
                            h('span', {}, `План: ${dailyPlan.toLocaleString('ru-RU')} ₽`)
                          ),
                          h(
                            'div',
                            {
                              className:
                                'w-full bg-black/10 dark:bg-gray-700 rounded-full h-1.5 mb-3',
                            },
                            h('div', {
                              className: 'bg-indigo-500 h-1.5 rounded-full',
                              style: { width: `${progress}%` },
                            })
                          ),
                          h(
                            'div',
                            {},
                            // Заголовки столбцов для СЕТКА
                            h(
                              'div',
                              {
                                className:
                                  'flex items-center px-2 py-2 text-xs font-semibold text-gray-500 dark:text-gray-400 border-b border-gray-200 dark:border-gray-700 mb-1',
                              },
                              h('span', { className: 'w-[120px]' }, 'Время'),
                              h('span', { className: 'w-[60px] ml-0.5' }, 'Перерыв'),
                              h('span', { className: 'w-[40px] ml-2' }, 'Кат.'),
                              h('span', { className: 'w-[63px] ml-2 text-center' }, 'Ставка'),
                              h('span', { className: 'w-[70px] ml-1 text-right' }, 'Сумма')
                            ),
                            h(
                              'div',
                              { className: 'space-y-1 text-sm' },
                              entriesWithBreaks.map((entry, index) =>
                                renderEntryRow(entry, index, true)
                              )
                            )
                          )
                        )
                      }
                    })
              ),

              // Bottom panel
              h(
                'div',
                { className: 'flex justify-between items-center mt-4' },
                h(
                  'button',
                  {
                    onClick: onClearAll,
                    className:
                      'flex items-center gap-2 bg-red-100 text-red-700 px-4 py-2 rounded-lg hover:bg-red-200 dark:bg-red-900/50 dark:text-red-300 dark:hover:bg-red-900/80 transition text-sm font-semibold',
                  },
                  h(Trash2, { size: 16 }),
                  'Очистить базу'
                ),
                h(
                  'div',
                  { className: 'flex items-center gap-1' },
                  h('span', { className: 'text-sm text-gray-600 dark:text-gray-400' }, 'Фильтр:'),
                  h(
                    Dropdown,
                    {
                      options: FILTER_OPTIONS,
                      selected: tableFilter,
                      onSelect: setTableFilter,
                      buttonClassName:
                        'glass-button glass-button-gray px-3 py-2 rounded-lg text-sm w-32 text-left flex justify-between items-center opacity-70 hover:opacity-100',
                    },
                    ({ optionKey, label, closeMenu }) =>
                      h(
                        'div',
                        {
                          className:
                            'flex items-center justify-between p-1 hover:bg-gray-500/10 rounded-md',
                        },
                        h(
                          'button',
                          {
                            className:
                              'text-left w-full px-2 py-1 text-gray-800 dark:text-gray-200',
                            onClick: () => {
                              setTableFilter(optionKey)
                              closeMenu()
                            },
                          },
                          label
                        ),
                        h(
                          'button',
                          {
                            onClick: () => {
                              handleSetDefaultTableFilter(optionKey)
                              closeMenu()
                            },
                            title: 'Закрепить по умолчанию',
                          },
                          h(Paperclip, {
                            size: 16,
                            className:
                              settings.defaultTableFilter === optionKey
                                ? 'text-blue-500'
                                : 'text-gray-400 hover:text-gray-600',
                          })
                        )
                      )
                  ),
                  tableFilter === 'custom' &&
                    h(
                      'div',
                      { className: 'flex items-center gap-2' },
                      h('input', {
                        type: 'date',
                        value: tableCustomDateFrom,
                        onChange: e => setTableCustomDateFrom(e.target.value),
                        className:
                          'px-2 py-1 border rounded-lg text-sm bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-800 dark:text-white',
                      }),
                      h('span', { className: 'text-sm text-gray-500' }, '-'),
                      h('input', {
                        type: 'date',
                        value: tableCustomDateTo,
                        onChange: e => setTableCustomDateTo(e.target.value),
                        className:
                          'px-2 py-1 border rounded-lg text-sm bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-800 dark:text-white',
                      })
                    )
                )
              ),

              // Модальные окна для массовых операций (только для изменения категории)

              showBulkModal &&
                bulkActionType === 'category' &&
                h(
                  Portal,
                  {},
                  h(
                    'div',
                    {
                      className:
                        'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm',
                      onClick: () => {
                        setShowBulkModal(false)
                        setSelectedCategoryId('')
                      },
                    },
                    h(
                      'div',
                      {
                        className:
                          'w-96 glass-effect rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 p-6',
                        onClick: e => e.stopPropagation(),
                      },
                      h(
                        'div',
                        { className: 'flex justify-between items-center mb-6' },
                        h(
                          'h3',
                          { className: 'text-xl font-bold text-gray-900 dark:text-white' },
                          `Изменить категорию для ${selectedEntries.size} записей`
                        ),
                        h(
                          'button',
                          {
                            onClick: () => {
                              setShowBulkModal(false)
                              setSelectedCategoryId('')
                            },
                            className:
                              'p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors',
                          },
                          h(CloseIcon, { size: 20, className: 'text-gray-600 dark:text-white' })
                        )
                      ),
                      h(
                        'div',
                        { className: 'mb-6' },
                        h(
                          'label',
                          {
                            className:
                              'block text-sm font-medium mb-3 text-gray-700 dark:text-gray-300',
                          },
                          'Новая категория'
                        ),
                        h(CategoryDropdown, {
                          value: selectedCategoryId,
                          onChange: setSelectedCategoryId,
                          categories: settings.categories || [],
                          className: 'w-full',
                        })
                      ),
                      h(
                        'div',
                        { className: 'flex gap-3 justify-end' },
                        h(
                          'button',
                          {
                            onClick: () => {
                              setShowBulkModal(false)
                              setSelectedCategoryId('')
                            },
                            className:
                              'px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors font-medium',
                          },
                          'Отмена'
                        ),
                        h(
                          'button',
                          {
                            onClick: () => {
                              if (selectedCategoryId) {
                                executeBulkAction({ categoryId: selectedCategoryId })
                              }
                            },
                            disabled: !selectedCategoryId,
                            className:
                              'px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors font-medium',
                          },
                          'Применить'
                        )
                      )
                    )
                  )
                ),

              // Модальное окно управления категориями
              showCategoryManager &&
                h(CategoryManager, {
                  settings,
                  setSettings,
                  entries,
                  setEntries,
                  forceOpen: true,
                  onClose: handleCloseCategoryManager,
                })
            )
          )
        }

        const NotificationSettingsModal = ({ show, onClose, settings, setSettings }) => {
          const [customInterval, setCustomInterval] = useState('')
          const [showCustomInput, setShowCustomInput] = useState(false)
          const [isClosing, setIsClosing] = useState(false)

          // Блокировка скролла фона
          useEffect(() => {
            if (show) {
              document.body.style.overflow = 'hidden'
            } else {
              document.body.style.overflow = ''
            }
            return () => {
              document.body.style.overflow = ''
            }
          }, [show])

          // Обработка закрытия с анимацией
          const handleClose = () => {
            setIsClosing(true)
            setTimeout(() => {
              onClose()
              setIsClosing(false)
            }, 200)
          }

          if (!show) return null

          const playNotificationSound = sound => {
            try {
              if (!window.Tone) {
                console.warn('Tone.js is not loaded.')
                return
              }
              const synth = new Tone.Synth().toDestination()
              switch (sound) {
                case 'chime':
                  synth.triggerAttackRelease('E5', '8n', Tone.now())
                  synth.triggerAttackRelease('C5', '8n', Tone.now() + 0.2)
                  break
                case 'alert':
                  synth.triggerAttackRelease('G5', '16n', Tone.now())
                  synth.triggerAttackRelease('C6', '16n', Tone.now() + 0.1)
                  break
                case 'phone':
                  synth.triggerAttackRelease('C5', '4n', Tone.now())
                  synth.triggerAttackRelease('E5', '4n', Tone.now() + 0.5)
                  break
                case 'doorbell':
                  synth.triggerAttackRelease('G4', '8n', Tone.now())
                  synth.triggerAttackRelease('B4', '8n', Tone.now() + 0.3)
                  synth.triggerAttackRelease('D5', '8n', Tone.now() + 0.6)
                  break
                case 'alarm':
                  synth.triggerAttackRelease('A4', '16n', Tone.now())
                  synth.triggerAttackRelease('A4', '16n', Tone.now() + 0.2)
                  synth.triggerAttackRelease('A4', '16n', Tone.now() + 0.4)
                  break
                case 'notification':
                  synth.triggerAttackRelease('F5', '8n', Tone.now())
                  synth.triggerAttackRelease('A5', '8n', Tone.now() + 0.2)
                  break
                case 'bell':
                  synth.triggerAttackRelease('C6', '4n', Tone.now())
                  synth.triggerAttackRelease('G5', '4n', Tone.now() + 0.5)
                  break
                case 'beep':
                  synth.triggerAttackRelease('C5', '8n')
                  break
                default:
                  synth.triggerAttackRelease('C5', '8n')
                  break
              }
            } catch (e) {
              console.error('Could not play sound:', e)
            }
          }

          const handleCustomInterval = value => {
            const numValue = parseInt(value)
            if (numValue >= 1 && numValue <= 480) {
              setSettings(s => ({ ...s, notificationInterval: numValue }))
              setShowCustomInput(false)
            }
          }

          const soundOptions = [
            { value: 'beep', label: 'Бип' },
            { value: 'chime', label: 'Колокольчик' },
            { value: 'alert', label: 'Сигнал' },
            { value: 'phone', label: 'Телефон' },
            { value: 'doorbell', label: 'Дверной' },
            { value: 'alarm', label: 'Будильник' },
            { value: 'notification', label: 'Уведомление' },
            { value: 'bell', label: 'Колокол' },
          ]

          const speedOptions = [
            { value: 'slow', label: 'Медленно' },
            { value: 'normal', label: 'Нормально' },
            { value: 'fast', label: 'Быстро' },
          ]

          const colorOptions = [
            { value: '#22c55e', label: 'Зеленый', class: 'bg-green-500' },
            { value: '#3b82f6', label: 'Синий', class: 'bg-blue-500' },
            { value: '#ef4444', label: 'Красный', class: 'bg-red-500' },
            { value: '#f59e0b', label: 'Оранжевый', class: 'bg-amber-500' },
            { value: '#8b5cf6', label: 'Фиолетовый', class: 'bg-violet-500' },
            { value: '#06b6d4', label: 'Бирюзовый', class: 'bg-cyan-500' },
            { value: '#ec4899', label: 'Розовый', class: 'bg-pink-500' },
            { value: '#84cc16', label: 'Лайм', class: 'bg-lime-500' },
            { value: '#f97316', label: 'Терракотовый', class: 'bg-orange-500' },
            { value: '#6366f1', label: 'Индиго', class: 'bg-indigo-500' },
          ]

          const styleOptions = [
            { value: 'pulse', label: 'Пульсация' },
            { value: 'blink', label: 'Мигание' },
            { value: 'rotate', label: 'Вращение' },
            { value: 'wave', label: 'Волна' },
            { value: 'gradient', label: 'Градиент' },
            { value: 'morph', label: 'Яндекс Крауд' },
            { value: 'particles', label: 'Частицы' },
            { value: 'breathe', label: 'Дыхание' },
          ]

          return h(
            'div',
            {
              className: `fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 backdrop-blur-sm ${isClosing ? 'modal-backdrop-exit' : 'modal-backdrop-enter'}`,
            },
            h(
              'div',
              {
                className: `glass-effect p-4 rounded-xl shadow-2xl w-full max-w-lg max-h-[80vh] overflow-y-auto border border-gray-200 dark:border-gray-700 ${isClosing ? 'modal-exit' : 'modal-enter'}`,
              },
              // Header
              h(
                'div',
                { className: 'flex justify-between items-center mb-4' },
                h(
                  'h2',
                  {
                    className:
                      'text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2',
                  },
                  h(Volume2, { size: 20 }),
                  'Настройки уведомлений'
                ),
                h(
                  'button',
                  {
                    onClick: handleClose,
                    className:
                      'p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors',
                  },
                  h(CloseIcon, { size: 20 })
                )
              ),

              // Sound Notifications Section
              h(
                'div',
                { className: 'space-y-4' },
                h(
                  'div',
                  { className: 'p-3 rounded-lg border border-gray-200 dark:border-gray-600' },
                  h(
                    'h3',
                    {
                      className:
                        'font-semibold text-base text-gray-900 dark:text-white mb-3 flex items-center gap-2',
                    },
                    h(Volume2, { size: 18 }),
                    'Звуковые уведомления'
                  ),
                  h(
                    'div',
                    { className: 'space-y-4' },
                    h(
                      'div',
                      { className: 'flex items-center justify-between' },
                      h(
                        'label',
                        { className: 'text-sm font-medium text-gray-700 dark:text-gray-300' },
                        'Включить звуки'
                      ),
                      h(
                        'button',
                        {
                          onClick: () =>
                            setSettings(s => ({
                              ...s,
                              soundNotificationsEnabled: !s.soundNotificationsEnabled,
                            })),
                          className: `relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${settings.soundNotificationsEnabled ? 'bg-blue-600' : 'bg-gray-300 dark:bg-gray-600'}`,
                        },
                        h('span', {
                          className: `inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${settings.soundNotificationsEnabled ? 'translate-x-6' : 'translate-x-1'}`,
                        })
                      )
                    ),
                    settings.soundNotificationsEnabled &&
                      h(
                        'div',
                        { className: 'space-y-3' },
                        h(
                          'div',
                          {},
                          h(
                            'label',
                            {
                              className:
                                'text-sm font-medium text-gray-700 dark:text-gray-300 block mb-2',
                            },
                            'Интервал уведомлений'
                          ),
                          h(
                            'div',
                            { className: 'flex gap-1' },
                            [15, 30, 60].map(interval =>
                              h(
                                'button',
                                {
                                  key: interval,
                                  onClick: () => {
                                    setSettings(s => ({ ...s, notificationInterval: interval }))
                                    setShowCustomInput(false)
                                  },
                                  className: `flex-1 py-1.5 px-2 text-xs rounded-md transition-colors ${settings.notificationInterval === interval && !showCustomInput ? 'bg-blue-600 text-white font-semibold' : 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600'}`,
                                },
                                `${interval} мин`
                              )
                            ),
                            h(
                              'button',
                              {
                                onClick: () => {
                                  setShowCustomInput(!showCustomInput)
                                  if (showCustomInput) {
                                    setCustomInterval('')
                                  } else {
                                    if (![15, 30, 60].includes(settings.notificationInterval)) {
                                      setCustomInterval(settings.notificationInterval.toString())
                                    }
                                  }
                                },
                                className: `flex-1 py-1.5 px-2 text-xs rounded-md transition-colors ${showCustomInput || ![15, 30, 60].includes(settings.notificationInterval) ? 'bg-blue-600 text-white font-semibold' : 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600'}`,
                              },
                              'Кастом'
                            )
                          ),
                          showCustomInput &&
                            h(
                              'div',
                              { className: 'mt-2 flex gap-1' },
                              h('input', {
                                type: 'number',
                                min: '1',
                                max: '480',
                                placeholder: 'мин',
                                value: customInterval,
                                onChange: e => setCustomInterval(e.target.value),
                                onKeyPress: e =>
                                  e.key === 'Enter' && handleCustomInterval(customInterval),
                                className:
                                  'flex-1 px-2 py-1 text-xs border rounded-md bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-800 dark:text-white',
                              }),
                              h(
                                'button',
                                {
                                  onClick: () => handleCustomInterval(customInterval),
                                  disabled:
                                    !customInterval || customInterval < 1 || customInterval > 480,
                                  className:
                                    'px-2 py-1 text-xs bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors',
                                },
                                '✓'
                              )
                            )
                        ),
                        h(
                          'div',
                          {},
                          h(
                            'label',
                            {
                              className:
                                'text-sm font-medium text-gray-700 dark:text-gray-300 block mb-2',
                            },
                            'Тип звука'
                          ),
                          h(
                            'div',
                            { className: 'grid grid-cols-2 gap-1' },
                            soundOptions.map(opt =>
                              h(
                                'div',
                                {
                                  key: opt.value,
                                  className:
                                    'flex items-center justify-between p-2 hover:bg-gray-500/10 rounded-md border border-gray-200 dark:border-gray-600',
                                },
                                h(
                                  'label',
                                  { className: 'flex items-center gap-2 cursor-pointer flex-1' },
                                  h('input', {
                                    type: 'radio',
                                    name: 'notificationSound',
                                    value: opt.value,
                                    checked: settings.notificationSound === opt.value,
                                    onChange: e =>
                                      setSettings(s => ({
                                        ...s,
                                        notificationSound: e.target.value,
                                      })),
                                    className:
                                      'form-radio h-4 w-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-1 dark:bg-gray-700 dark:border-gray-600',
                                  }),
                                  h(
                                    'span',
                                    { className: 'text-xs text-gray-700 dark:text-gray-200' },
                                    opt.label
                                  )
                                ),
                                h(
                                  'button',
                                  {
                                    onClick: () => playNotificationSound(opt.value),
                                    className:
                                      'p-1 rounded-full hover:bg-gray-500/20 text-gray-600 dark:text-gray-300 dark:hover:text-white transition-colors flex-shrink-0',
                                  },
                                  h(Volume2, { size: 12 })
                                )
                              )
                            )
                          )
                        )
                      )
                  )
                ),

                // Icon Animation Section
                h(
                  'div',
                  { className: 'p-3 rounded-lg border border-gray-200 dark:border-gray-600' },
                  h(
                    'h3',
                    {
                      className:
                        'font-semibold text-base text-gray-900 dark:text-white mb-3 flex items-center gap-2',
                    },
                    h(Activity, { size: 18 }),
                    'Анимация иконки'
                  ),
                  h(
                    'div',
                    { className: 'space-y-3' },
                    h(
                      'div',
                      { className: 'flex items-center justify-between' },
                      h(
                        'label',
                        { className: 'text-sm font-medium text-gray-700 dark:text-gray-300' },
                        'Анимация в заголовке'
                      ),
                      h(
                        'button',
                        {
                          onClick: () =>
                            setSettings(s => ({
                              ...s,
                              faviconAnimationEnabled: !s.faviconAnimationEnabled,
                            })),
                          className: `relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${settings.faviconAnimationEnabled ? 'bg-blue-600' : 'bg-gray-300 dark:bg-gray-600'}`,
                        },
                        h('span', {
                          className: `inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${settings.faviconAnimationEnabled ? 'translate-x-6' : 'translate-x-1'}`,
                        })
                      )
                    ),
                    settings.faviconAnimationEnabled &&
                      h(
                        'div',
                        { className: 'space-y-3' },
                        h(
                          'div',
                          {},
                          h(
                            'label',
                            {
                              className:
                                'text-sm font-medium text-gray-700 dark:text-gray-300 block mb-2',
                            },
                            'Стиль анимации'
                          ),
                          h(
                            'div',
                            { className: 'grid grid-cols-2 gap-1' },
                            styleOptions.map(opt =>
                              h(
                                'button',
                                {
                                  key: opt.value,
                                  onClick: () =>
                                    setSettings(s => ({ ...s, faviconAnimationStyle: opt.value })),
                                  className: `py-1 px-2 text-xs rounded-md transition-colors border ${settings.faviconAnimationStyle === opt.value ? 'bg-blue-600 text-white font-semibold border-blue-600' : 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 border-gray-300 dark:border-gray-600'}`,
                                },
                                opt.label
                              )
                            )
                          )
                        ),
                        h(
                          'div',
                          {},
                          h(
                            'label',
                            {
                              className:
                                'text-sm font-medium text-gray-700 dark:text-gray-300 block mb-2',
                            },
                            'Скорость анимации'
                          ),
                          h(
                            'div',
                            { className: 'flex gap-1' },
                            speedOptions.map(opt =>
                              h(
                                'button',
                                {
                                  key: opt.value,
                                  onClick: () =>
                                    setSettings(s => ({ ...s, faviconAnimationSpeed: opt.value })),
                                  className: `flex-1 py-1 px-2 text-xs rounded-md transition-colors ${settings.faviconAnimationSpeed === opt.value ? 'bg-blue-600 text-white font-semibold' : 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600'}`,
                                },
                                opt.label
                              )
                            )
                          )
                        ),
                        h(
                          'div',
                          {},
                          h(
                            'label',
                            {
                              className:
                                'text-sm font-medium text-gray-700 dark:text-gray-300 block mb-2',
                            },
                            'Цвет анимации'
                          ),
                          h(
                            'div',
                            { className: 'grid grid-cols-5 gap-1' },
                            colorOptions.map(opt =>
                              h('button', {
                                key: opt.value,
                                onClick: () =>
                                  setSettings(s => ({ ...s, faviconAnimationColor: opt.value })),
                                className: `w-8 h-8 rounded-full transition-all ${opt.class} ${settings.faviconAnimationColor === opt.value ? 'ring-2 ring-offset-1 ring-offset-gray-300 dark:ring-offset-gray-800 ring-blue-500' : 'hover:scale-110'}`,
                                title: opt.label,
                              })
                            )
                          )
                        )
                      )
                  )
                )
              )
            )
          )
        }

        // ================================================================================= //
        // MARK: - CATEGORY INPUT COMPONENT
        // ================================================================================= //

        const CategoryInput = React.memo(({ onValueChange, placeholder }) => {
          const inputRef = useRef(null)

          useEffect(() => {
            const input = inputRef.current
            if (!input) return

            const handleInput = e => {
              onValueChange(e.target.value)
            }

            input.addEventListener('input', handleInput)
            return () => input.removeEventListener('input', handleInput)
          }, [onValueChange])

          return h('input', {
            ref: inputRef,
            type: 'text',
            placeholder: placeholder,
            autoFocus: true,
            className:
              'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white text-sm',
          })
        })

        // ================================================================================= //
        // MARK: - CATEGORY MANAGER
        // ================================================================================= //

        // Вынесенная модалка: стабильный тип компонента, чтобы не размонтировалась при каждом вводе
        const CategoryManagerModal = React.memo(
          ({
            isOpen,
            onClose,
            settingsRef,
            settings,
            editingCategory,
            setEditingCategory,
            newCategory,
            setNewCategory,
            colorOptions,
            iconOptions,
            getCategoryIcon,
            handleAddCategory,
            handleEditCategory,
            handleSetDefault,
            handleDeleteCategory,
            setIsOpen,
          }) => {
            const inputRef = useRef(null)
            const editInputRef = useRef(null)
            const [isClosing, setIsClosing] = useState(false)
            const [enteredOnce, setEnteredOnce] = useState(false)

            const handleClose = useCallback(() => {
              if (isClosing) return
              setIsClosing(true)
              setTimeout(() => {
                setIsOpen(false)
                if (onClose) onClose()
                setIsClosing(false)
              }, 200)
            }, [isClosing, onClose, setIsOpen])

            useEffect(() => {
              setEnteredOnce(true)
              const timer = setTimeout(() => setEnteredOnce(false), 200)
              return () => clearTimeout(timer)
            }, [])

            useLayoutEffect(() => {
              if (isOpen && inputRef.current && !editingCategory) {
                inputRef.current.focus()
              }
            }, [isOpen, editingCategory])

            useLayoutEffect(() => {
              if (editingCategory && editInputRef.current) {
                editInputRef.current.focus()
              }
            }, [editingCategory])

            const handleInputChange = useCallback(
              e => {
                setNewCategory(prev => ({ ...prev, name: e.target.value }))
              },
              [setNewCategory]
            )

            return h(
              Portal,
              {},
              h(
                'div',
                {
                  className: `fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm ${isClosing ? 'modal-backdrop-exit' : enteredOnce ? 'modal-backdrop-enter' : ''}`,
                },
                h(
                  'div',
                  {
                    ref: settingsRef,
                    className: `w-96 glass-effect rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 p-6 ${isClosing ? 'modal-exit' : enteredOnce ? 'modal-enter' : ''}`,
                    onClick: e => e.stopPropagation(),
                  },
                  h(
                    'div',
                    { className: 'flex items-center justify-between mb-4' },
                    h(
                      'h3',
                      {
                        className:
                          'text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2',
                      },
                      h(Grid, { size: 20, className: 'text-gray-600 dark:text-white' }),
                      'Управление категориями'
                    ),
                    h(
                      'button',
                      {
                        onClick: handleClose,
                        className:
                          'p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors',
                      },
                      h(CloseIcon, { size: 18, className: 'text-gray-600 dark:text-white' })
                    )
                  ),
                  h(
                    'div',
                    { className: 'space-y-4' },
                    // Добавить новую категорию
                    h(
                      'div',
                      { className: 'border-b border-gray-200 dark:border-gray-700 pb-4' },
                      h(
                        'h4',
                        {
                          className: 'text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2',
                        },
                        'Добавить категорию'
                      ),
                      h(
                        'div',
                        { className: 'space-y-2' },
                        h('input', {
                          ref: inputRef,
                          type: 'text',
                          value: newCategory.name,
                          onChange: handleInputChange,
                          placeholder: 'Название категории',
                          className:
                            'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500',
                        }),
                        h(
                          'div',
                          { className: 'flex gap-2' },
                          h(
                            'div',
                            { className: 'flex-1' },
                            h(
                              'label',
                              { className: 'block text-xs text-gray-500 dark:text-gray-400 mb-1' },
                              'Цвет'
                            ),
                            h(
                              'div',
                              { className: 'flex gap-1 flex-wrap' },
                              colorOptions.map(opt =>
                                h('button', {
                                  key: opt.value,
                                  onClick: () =>
                                    setNewCategory(prev => ({ ...prev, color: opt.value })),
                                  className: `w-6 h-6 rounded-full ${opt.class} ${newCategory.color === opt.value ? 'ring-2 ring-offset-2 ring-blue-500' : ''}`,
                                  title: opt.label,
                                })
                              )
                            )
                          ),
                          h(
                            'div',
                            { className: 'flex-1' },
                            h(
                              'label',
                              { className: 'block text-xs text-gray-500 dark:text-gray-400 mb-1' },
                              'Иконка'
                            ),
                            h(
                              'div',
                              { className: 'flex gap-1 flex-wrap' },
                              iconOptions.map(opt =>
                                h(
                                  'button',
                                  {
                                    key: opt.name,
                                    onClick: () =>
                                      setNewCategory(prev => ({ ...prev, icon: opt.name })),
                                    className: `p-1 rounded ${newCategory.icon === opt.name ? 'bg-blue-100 dark:bg-blue-900/30' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}`,
                                    title: opt.name,
                                  },
                                  h(opt.component, {
                                    size: 16,
                                    className: 'text-gray-600 dark:text-white',
                                  })
                                )
                              )
                            )
                          )
                        ),
                        h(
                          'button',
                          {
                            onClick: handleAddCategory,
                            disabled: !newCategory.name.trim(),
                            className:
                              'w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-sm',
                          },
                          'Добавить категорию'
                        )
                      )
                    ),
                    // Редактирование категории
                    editingCategory &&
                      h(
                        'div',
                        { className: 'border-b border-gray-200 dark:border-gray-700 pb-4' },
                        h(
                          'h4',
                          {
                            className:
                              'text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2',
                          },
                          'Редактировать категорию'
                        ),
                        h(
                          'div',
                          { className: 'space-y-2' },
                          h('input', {
                            ref: editInputRef,
                            type: 'text',
                            value: editingCategory.name,
                            onChange: e =>
                              setEditingCategory({ ...editingCategory, name: e.target.value }),
                            className:
                              'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500',
                          }),
                          h(
                            'div',
                            { className: 'flex gap-2' },
                            h(
                              'div',
                              { className: 'flex-1' },
                              h(
                                'label',
                                {
                                  className: 'block text-xs text-gray-500 dark:text-gray-400 mb-1',
                                },
                                'Цвет'
                              ),
                              h(
                                'div',
                                { className: 'flex gap-1 flex-wrap' },
                                colorOptions.map(opt =>
                                  h('button', {
                                    key: opt.value,
                                    onClick: () =>
                                      setEditingCategory({ ...editingCategory, color: opt.value }),
                                    className: `w-6 h-6 rounded-full ${opt.class} ${editingCategory.color === opt.value ? 'ring-2 ring-offset-2 ring-blue-500' : ''}`,
                                    title: opt.label,
                                  })
                                )
                              )
                            ),
                            h(
                              'div',
                              { className: 'flex-1' },
                              h(
                                'label',
                                {
                                  className: 'block text-xs text-gray-500 dark:text-gray-400 mb-1',
                                },
                                'Иконка'
                              ),
                              h(
                                'div',
                                { className: 'flex gap-1 flex-wrap' },
                                iconOptions.map(opt =>
                                  h(
                                    'button',
                                    {
                                      key: opt.name,
                                      onClick: () =>
                                        setEditingCategory({ ...editingCategory, icon: opt.name }),
                                      className: `p-1 rounded ${editingCategory.icon === opt.name ? 'bg-blue-100 dark:bg-blue-900/30' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}`,
                                      title: opt.name,
                                    },
                                    h(opt.component, {
                                      size: 16,
                                      className: 'text-gray-600 dark:text-white',
                                    })
                                  )
                                )
                              )
                            )
                          ),
                          h(
                            'div',
                            { className: 'flex gap-2' },
                            h(
                              'button',
                              {
                                onClick: () => {
                                  handleEditCategory(editingCategory.id, editingCategory)
                                  setEditingCategory(null)
                                },
                                className:
                                  'flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm',
                              },
                              'Сохранить'
                            ),
                            h(
                              'button',
                              {
                                onClick: () => setEditingCategory(null),
                                className:
                                  'flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm',
                              },
                              'Отмена'
                            )
                          )
                        )
                      ),
                    // Существующие категории
                    h(
                      'div',
                      {},
                      h(
                        'h4',
                        {
                          className: 'text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2',
                        },
                        'Существующие категории'
                      ),
                      h(
                        'div',
                        { className: 'space-y-2 max-h-48 overflow-y-auto custom-scrollbar' },
                        settings.categories.map(category =>
                          h(
                            'div',
                            {
                              key: category.id,
                              className:
                                'flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg',
                            },
                            h(
                              'div',
                              { className: 'flex items-center gap-2' },
                              h('div', {
                                className: 'w-4 h-4 rounded-full',
                                style: { backgroundColor: category.color },
                              }),
                              h(getCategoryIcon(category.icon), {
                                size: 16,
                                className: 'text-white',
                              }),
                              h(
                                'span',
                                { className: 'text-sm text-gray-800 dark:text-gray-200' },
                                category.name
                              )
                            ),
                            h(
                              'div',
                              { className: 'flex items-center gap-1' },
                              h(
                                'button',
                                {
                                  onClick: () => setEditingCategory(category),
                                  className:
                                    'p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-gray-600 dark:text-gray-400',
                                  title: 'Редактировать',
                                },
                                h(Edit2, { size: 16, className: 'text-gray-600 dark:text-white' })
                              ),
                              h(
                                'button',
                                {
                                  onClick: () => handleSetDefault(category.id),
                                  className:
                                    'p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors',
                                  title: 'Установить по умолчанию',
                                },
                                h(Paperclip, {
                                  size: 16,
                                  className: category.isDefault
                                    ? 'text-blue-500'
                                    : 'text-gray-400 hover:text-gray-600 dark:hover:text-gray-300',
                                })
                              ),
                              h(
                                'button',
                                {
                                  onClick: () => handleDeleteCategory(category.id),
                                  className:
                                    'p-1 rounded hover:bg-red-200 dark:hover:bg-red-900/30 transition-colors text-red-600',
                                  title: 'Удалить',
                                },
                                h(Trash2, { size: 16, className: 'text-red-600 dark:text-red-400' })
                              )
                            )
                          )
                        )
                      )
                    )
                  )
                )
              )
            )
          }
        )

        const CategoryManager = React.memo(
          ({ settings, setSettings, entries, setEntries, forceOpen = false, onClose }) => {
            const [isOpen, setIsOpen] = useState(forceOpen)
            const [editingCategory, setEditingCategory] = useState(null)
            const [newCategory, setNewCategory] = useState({
              name: '',
              color: '#3b82f6',
              icon: 'Grid',
            })
            const settingsRef = useRef(null)
            const buttonRef = useRef(null)
            const inputRef = useRef(null)
            const addCategoryRef = useRef(null)

            // Модальное окно теперь позиционируется через flexbox в Portal

            // Полностью отключаем глобальный обработчик и блокируем скролл при открытии модального окна
            useEffect(() => {
              if (!isOpen) return

              // Блокируем скролл фона
              document.body.style.overflow = 'hidden'

              // Получаем ссылку на глобальный обработчик
              const globalHandler = window._globalKeyDownHandler

              // Временно отключаем глобальный обработчик
              if (globalHandler) {
                document.removeEventListener('keydown', globalHandler)
              }

              // Создаем локальный обработчик только для Escape
              const handleLocalKeyDown = e => {
                if (e.code === 'Escape') {
                  e.preventDefault()
                  setIsOpen(false)
                  if (onClose) onClose()
                }
              }

              document.addEventListener('keydown', handleLocalKeyDown)

              return () => {
                // Восстанавливаем скролл фона
                document.body.style.overflow = ''

                // Восстанавливаем глобальный обработчик
                if (globalHandler) {
                  document.addEventListener('keydown', globalHandler)
                }
                document.removeEventListener('keydown', handleLocalKeyDown)
              }
            }, [isOpen, onClose])

            // Функция для обработки изменений (чистый HTML input) - стабилизирована
            const handleInput = useCallback(e => {
              const input = document.getElementById('category-name-input')
              if (input) {
                setNewCategory(prev => ({ ...prev, name: input.value }))
              }
            }, [])

            // Обработчик клавиш (как в рабочих input'ах) - стабилизирован и без TDZ
            const handleKeyDown = useCallback(
              e => {
                if (e.code === 'Enter') {
                  e.preventDefault()
                  if (addCategoryRef.current) {
                    addCategoryRef.current()
                  }
                } else if (e.code === 'Escape') {
                  e.preventDefault()
                  setIsOpen(false)
                  if (onClose) onClose()
                }
                // Предотвращаем всплытие события к глобальному обработчику
                e.stopPropagation()
              },
              [onClose]
            )

            // Обработчики фокуса - стабилизированы
            const handleFocus = useCallback(e => {
              e.stopPropagation()
            }, [])

            const handleBlur = useCallback(e => {
              e.stopPropagation()
            }, [])

            // Предотвращаем потерю фокуса при клике на модальное окно

            // Принудительно устанавливаем фокус на input при открытии модального окна (только для non-forceOpen)
            useLayoutEffect(() => {
              if (isOpen && !forceOpen && inputRef.current) {
                // Небольшая задержка для гарантированного фокуса
                const timeoutId = setTimeout(() => {
                  if (inputRef.current) {
                    inputRef.current.focus()
                  }
                }, 100)

                return () => clearTimeout(timeoutId)
              }
            }, [isOpen, forceOpen])

            // УБРАЛИ обработчик клика вне модального окна - теперь закрывается только по крестику

            // Добавляем обработчик скролла для обновления позиции (только для dropdown, не для forceOpen модального окна)
            useEffect(() => {
              if (!isOpen || forceOpen) return // Отключаем для forceOpen модальных окон

              const handleScroll = () => {
                // Принудительно обновляем позицию при скролле
                if (buttonRef.current && settingsRef.current) {
                  const rect = buttonRef.current.getBoundingClientRect()
                  const modalWidth = 384
                  const modalHeight = 500
                  const spaceRight = window.innerWidth - rect.right
                  const spaceLeft = rect.left
                  const spaceBottom = window.innerHeight - rect.bottom

                  let top = rect.bottom + 8
                  let left = rect.left

                  if (spaceBottom < modalHeight && rect.top > modalHeight) {
                    top = rect.top - modalHeight - 8
                  }

                  if (spaceRight < modalWidth && spaceLeft > modalWidth) {
                    left = rect.left - modalWidth + rect.width
                  }

                  settingsRef.current.style.top = `${top}px`
                  settingsRef.current.style.left = `${left}px`
                }
              }

              window.addEventListener('scroll', handleScroll, true)
              return () => window.removeEventListener('scroll', handleScroll, true)
            }, [isOpen, forceOpen, onClose])

            const colorOptions = [
              { value: '#1e40af', label: 'Темно-синий', class: 'bg-blue-800' },
              { value: '#dc2626', label: 'Красный', class: 'bg-red-600' },
              { value: '#7c2d12', label: 'Темно-красный', class: 'bg-red-800' },
              { value: '#92400e', label: 'Темно-оранжевый', class: 'bg-orange-800' },
              { value: '#eab308', label: 'Желтый', class: 'bg-yellow-500' },
              { value: '#0891b2', label: 'Бирюзовый', class: 'bg-cyan-600' },
              { value: '#be185d', label: 'Розовый', class: 'bg-pink-700' },
              { value: '#374151', label: 'Серый', class: 'bg-gray-700' },
              { value: '#059669', label: 'Изумрудный', class: 'bg-emerald-600' },
              { value: '#a16207', label: 'Коричневый', class: 'bg-amber-700' },
            ]

            const iconOptions = [
              { name: 'Grid', component: Grid },
              { name: 'Activity', component: Activity },
              { name: 'Calendar', component: Calendar },
              { name: 'Clock', component: Clock },
              { name: 'DollarSign', component: DollarSign },
              { name: 'Settings', component: Settings },
              { name: 'Play', component: Play },
              { name: 'CheckCircle', component: CheckCircle },
              { name: 'Bell', component: Bell },
              { name: 'Upload', component: Upload },
              { name: 'Download', component: Download },
              { name: 'Database', component: Database },
              { name: 'Folder', component: Folder },
              { name: 'FileText', component: FileText },
              { name: 'Users', component: Users },
            ]

            const handleAddCategory = useCallback(() => {
              setNewCategory(currentCategory => {
                if (!currentCategory.name.trim()) return currentCategory

                const categoryId = `category_${Date.now()}`
                const category = {
                  id: categoryId,
                  name: currentCategory.name.trim(),
                  color: currentCategory.color,
                  icon: currentCategory.icon,
                  isDefault: false,
                }

                setSettings(s => ({
                  ...s,
                  categories: [...s.categories, category],
                }))

                return { name: '', color: '#3b82f6', icon: 'Grid' }
              })
            }, [setSettings])

            // Привязываем актуальный обработчик к ref, чтобы избежать TDZ в местах вызова до инициализации
            useEffect(() => {
              addCategoryRef.current = handleAddCategory
            }, [handleAddCategory])

            const handleEditCategory = (categoryId, updates) => {
              setSettings(s => ({
                ...s,
                categories: s.categories.map(cat =>
                  cat.id === categoryId ? { ...cat, ...updates } : cat
                ),
              }))
            }

            const handleDeleteCategory = categoryId => {
              // Проверяем, используется ли категория
              const isUsed = entries.some(entry => entry.categoryId === categoryId)
              if (isUsed) {
                alert('Нельзя удалить категорию, которая используется в записях')
                return
              }

              setSettings(s => ({
                ...s,
                categories: s.categories.filter(cat => cat.id !== categoryId),
              }))
            }

            const handleSetDefault = categoryId => {
              const oldDefaultId = settings.defaultCategoryId
              setSettings(s => ({
                ...s,
                categories: s.categories.map(cat => ({
                  ...cat,
                  isDefault: cat.id === categoryId,
                })),
                defaultCategoryId: categoryId,
              }))

              // Обновляем записи, которые использовали старую категорию по умолчанию или не имеют категории
              if (oldDefaultId !== categoryId) {
                const updatedEntries = entries.map(entry => {
                  // Обновляем записи с старой категорией по умолчанию
                  if (entry.categoryId === oldDefaultId) {
                    return { ...entry, categoryId: categoryId }
                  }
                  // Обновляем записи без категории
                  if (!entry.categoryId) {
                    return { ...entry, categoryId: categoryId }
                  }
                  return entry
                })
                setEntries(updatedEntries)
              }
            }

            // Убрали внутреннее объявление модалки

            return h(
              'div',
              { className: 'relative' },
              h(
                'button',
                {
                  ref: buttonRef,
                  onClick: () => setIsOpen(o => !o),
                  className: 'p-2 rounded-full hover:bg-gray-500/10 transition-colors',
                  title: 'Управление категориями',
                },
                h(Grid, { size: 16, className: 'text-gray-600 dark:text-white' })
              ),
              isOpen &&
                h(CategoryManagerModal, {
                  isOpen,
                  onClose,
                  settingsRef,
                  settings,
                  editingCategory,
                  setEditingCategory,
                  newCategory,
                  setNewCategory,
                  colorOptions,
                  iconOptions,
                  getCategoryIcon,
                  handleAddCategory,
                  handleEditCategory,
                  handleSetDefault,
                  handleDeleteCategory,
                  setIsOpen,
                })
            )
          },
          (prevProps, nextProps) => {
            // Сравниваем только релевантные пропсы
            return (
              prevProps.forceOpen === nextProps.forceOpen &&
              prevProps.onClose === nextProps.onClose &&
              prevProps.settings.categories === nextProps.settings.categories &&
              prevProps.setSettings === nextProps.setSettings &&
              prevProps.setEntries === nextProps.setEntries
            )
          }
        )

        // ================================================================================= //
        // MARK: - APP ROOT
        // ================================================================================= //
        const AppProviders = ({ children }) => {
          const [settings, setSettings] = useLocalStorage('timeTrackerSettings_v2.7', {
            listView: 'list',
            defaultListView: 'list',
            logoUrl: 'logo.png',
            defaultTableFilter: 'today',
            defaultChartVisibility: {
              dynamics: true,
              rate: true,
              weekday: false,
              distribution: false,
              scatter: false,
              idealDay: false,
              forecast: false,
              calendar: true,
              categoryEfficiency: true,
              timeDistribution: true,
            },
            defaultHeaderFilter: 'month',
            defaultChartFilter: 'month',
            chartDisplay: 'separate',
            weekdayChartType: 'bar',
            distributionChartType: 'bar',
            dynamicsChartType: 'area',
            rateChartType: 'line',
            idealDayChartType: 'bar',
            forecastChartType: 'line',
            combinedDynamicsType: 'area',
            combinedRateType: 'line',
            categoryEfficiencyChartType: 'bar',
            timeDistributionChartType: 'pie',
            categoryEfficiencyTimeRange: 'month',
            timeDistributionTimeRange: 'month',
            theme: 'dark',
            soundNotificationsEnabled: true,
            notificationInterval: 60,
            notificationSound: 'beep',
            headerFilter: 'month',
            customDateFrom: '',
            customDateTo: '',
            faviconAnimationEnabled: true,
            faviconAnimationStyle: 'pulse',
            faviconAnimationSpeed: 'normal',
            faviconAnimationColor: '#22c55e',
            // === АНИМАЦИИ ===
            animationsEnabled: true,
            // === ПЛАВАЮЩАЯ ПАНЕЛЬ ===
            floatingPanelEnabled: true,
            floatingPanelPosition: { x: 20, y: 20 },
            floatingPanelSize: 'compact', // 'compact' | 'expanded'
            floatingPanelTheme: 'glass', // 'glass' | 'solid' | 'minimal'
            // === КАТЕГОРИИ ===
            categories: [
              { id: 'project1', name: 'Проект 1', color: '#3b82f6', icon: 'Grid', isDefault: true },
              {
                id: 'project2',
                name: 'Проект 2',
                color: '#10b981',
                icon: 'Activity',
                isDefault: false,
              },
              {
                id: 'project3',
                name: 'Проект 3',
                color: '#8b5cf6',
                icon: 'Calendar',
                isDefault: false,
              },
              { id: 'mix', name: 'MIX', color: '#f59e0b', icon: 'Layers', isDefault: false },
            ],
            defaultCategoryId: 'project1',
          })
          const [entries, setEntriesRaw, entriesSaveStatus] = useDebouncedLocalStorage(
            'timeTrackerEntries',
            []
          )
          const [dailyPlan, setDailyPlan] = useLocalStorage('timeTrackerDailyPlan', 6000)
          const [showRecoveryModal, setShowRecoveryModal] = useState(false)
          const [initializing, setInitializing] = useState(true)
          const { showNotification, NotificationComponent } = useNotifications()

          const setEntries = useCallback(
            value => {
              setEntriesRaw(value)
            },
            [setEntriesRaw]
          )

          // Миграция записей для добавления категорий
          const migrateEntriesToCategories = useCallback(
            entries => {
              if (!Array.isArray(entries)) return []
              return entries.map(entry => {
                if (entry.categoryId) return entry
                return {
                  ...entry,
                  categoryId: settings.defaultCategoryId || 'project1',
                }
              })
            },
            [settings.defaultCategoryId]
          )

          useEffect(() => {
            const initialize = async () => {
              const localStorageEntries = JSON.parse(
                localStorage.getItem('timeTrackerEntries') || '[]'
              )
              const migratedEntries = migrateEntriesToCategories(localStorageEntries)

              // Если записи были мигрированы, сохраняем их обратно
              if (
                migratedEntries.length !== localStorageEntries.length ||
                migratedEntries.some(
                  (entry, index) => entry.categoryId !== localStorageEntries[index]?.categoryId
                )
              ) {
                setEntries(migratedEntries)
                localStorage.setItem('timeTrackerEntries', JSON.stringify(migratedEntries))
              }

              if (localStorageEntries.length === 0) {
                const backups = await backupManager.listBackups()
                if (backups.length > 0) {
                  setShowRecoveryModal(true)
                }
              }

              // Применяем настройки по умолчанию для фильтров
              setSettings(currentSettings => {
                const updatedSettings = { ...currentSettings }
                if (!currentSettings.headerFilter || currentSettings.headerFilter === 'month') {
                  updatedSettings.headerFilter = currentSettings.defaultHeaderFilter || 'month'
                }
                return updatedSettings
              })

              setInitializing(false)
            }
            initialize()
          }, [migrateEntriesToCategories, setEntries])

          const handleRestoreFromBackup = async timestamp => {
            const data = await backupManager.restoreBackup(timestamp)
            if (data) {
              setEntries(data.entries || [])
              if (typeof data.dailyPlan === 'number') setDailyPlan(data.dailyPlan)
              localStorage.setItem('timeTrackerEntries', JSON.stringify(data.entries || []))
              localStorage.setItem('timeTrackerDailyPlan', JSON.stringify(data.dailyPlan || 6000))
              showNotification('Данные успешно восстановлены из резервной копии!')
            } else {
              showNotification('Не удалось восстановить данные', 'error')
            }
            setShowRecoveryModal(false)
          }

          // Миграция/добавление недостающих полей настроек из локального хранилища
          useEffect(() => {
            const needPatch = !settings.logoUrl
            if (needPatch) {
              setSettings(s => ({ ...s, logoUrl: 'logo.png' }))
            }
          }, [settings.logoUrl, setSettings])

          const settingsContextValue = useMemo(
            () => ({ settings, setSettings }),
            [settings, setSettings]
          )
          const dataContextValue = useMemo(
            () => ({ entries, setEntries, dailyPlan, setDailyPlan, entriesSaveStatus }),
            [entries, setEntries, dailyPlan, setDailyPlan, entriesSaveStatus]
          )

          useEffect(() => {
            const root = document.documentElement
            if (settings.theme === 'dark') {
              root.classList.add('dark')
              root.classList.remove('light')
            } else {
              root.classList.remove('dark')
              root.classList.add('light')
            }
          }, [settings.theme])

          if (initializing) {
            return h(
              'div',
              {
                style: {
                  display: 'flex',
                  flexDirection: 'column',
                  justifyContent: 'center',
                  alignItems: 'center',
                  height: '100vh',
                  fontFamily: 'Inter, sans-serif',
                  color: '#4A5568',
                  textAlign: 'center',
                  padding: '1rem',
                },
              },
              h('p', {}, 'Инициализация...')
            )
          }

          return h(
            SettingsContext.Provider,
            { value: settingsContextValue },
            h(
              DataContext.Provider,
              { value: dataContextValue },
              h(
                HistoryProvider,
                {
                  entries: dataContextValue.entries,
                  setEntries: dataContextValue.setEntries,
                  showNotification,
                  handleExport: () => {},
                },
                h(
                  'div',
                  { className: settings.theme },
                  children,
                  h(RecoveryModal, {
                    show: showRecoveryModal,
                    onClose: () => setShowRecoveryModal(false),
                    onRestore: handleRestoreFromBackup,
                  })
                )
              )
            )
          )
        }

        const Header = ({
          onShowTutorial,
          onShowAbout,
          compareMode,
          setCompareMode,
          entriesSaveStatus,
        }) => {
          const { settings, setSettings } = useSettings()
          const { entries, setEntries } = useData()
          const [showNotificationModal, setShowNotificationModal] = useState(false)
          const [showFloatingPanelSettings, setShowFloatingPanelSettings] = useState(false)
          const handleFilterChange = value => setSettings(s => ({ ...s, headerFilter: value }))
          const handleDateChange = (field, value) => setSettings(s => ({ ...s, [field]: value }))
          const handleThemeChange = () =>
            setSettings(s => ({ ...s, theme: s.theme === 'light' ? 'dark' : 'light' }))
          return h(
            'div',
            {},
            h(
              'header',
              {
                className:
                  'glass-effect rounded-xl shadow-lg p-1 md:p-2 mb-6 border border-gray-200 dark:border-gray-500/20',
              },
              h(
                'div',
                {
                  className:
                    'flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4',
                },
                h(
                  'div',
                  { className: 'flex items-center gap-1' },
                  settings.logoUrl
                    ? h('img', {
                        src: settings.logoUrl,
                        alt: 'Логотип',
                        className: 'w-24 h-24 object-contain select-none app-logo',
                        draggable: false,
                      })
                    : h(ProgramLogo, { size: 96, className: 'self-center', theme: settings.theme }),
                  h(
                    'div',
                    {},
                    h(
                      'div',
                      { className: 'flex items-center gap-3 mb-1' },
                      h(
                        'h1',
                        {
                          className: 'text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white',
                        },
                        'Трекер рабочего времени'
                      ),
                      // Индикатор состояния сохранения
                      h(
                        'div',
                        { className: 'flex items-center gap-1 text-xs' },
                        entriesSaveStatus === 'saving' &&
                          h(
                            'div',
                            {
                              className:
                                'flex items-center gap-1 text-yellow-600 dark:text-yellow-400',
                            },
                            h('div', {
                              className: 'w-2 h-2 bg-yellow-500 rounded-full animate-pulse',
                            }),
                            h('span', {}, 'Сохранение...')
                          ),
                        entriesSaveStatus === 'saved' &&
                          h(
                            'div',
                            {
                              className:
                                'flex items-center gap-1 text-green-600 dark:text-green-400',
                            },
                            h('div', { className: 'w-2 h-2 bg-green-500 rounded-full' }),
                            h('span', {}, 'Сохранено')
                          ),
                        entriesSaveStatus === 'error' &&
                          h(
                            'div',
                            { className: 'flex items-center gap-1 text-red-600 dark:text-red-400' },
                            h('div', { className: 'w-2 h-2 bg-red-500 rounded-full' }),
                            h('span', {}, 'Ошибка')
                          )
                      )
                    ),
                    h(
                      'p',
                      { className: 'text-gray-600 dark:text-gray-400' },
                      'Единая система учета времени и доходов'
                    )
                  )
                ),
                h(
                  'div',
                  { className: 'flex flex-wrap gap-2 items-center' },
                  h(
                    'button',
                    {
                      onClick: () => setCompareMode(c => !c),
                      className: `button-animated p-2 rounded-full hover:bg-gray-500/10 transition-colors ${compareMode ? 'text-blue-500' : 'text-gray-600 dark:text-gray-400'}`,
                      title: compareMode ? 'Отключить сравнение' : 'Включить сравнение',
                    },
                    h(BarChart2, { size: 20 })
                  ),
                  h(Dropdown, {
                    options: HEADER_FILTER_OPTIONS,
                    selected: settings.headerFilter,
                    onSelect: handleFilterChange,
                    buttonClassName:
                      'glass-button glass-button-gray px-3 py-2 rounded-lg text-sm w-32 text-left flex justify-between items-center transition-all duration-200 hover:scale-105 hover:shadow-lg opacity-70 hover:opacity-100',
                    children: ({ optionKey, label, closeMenu }) =>
                      h(
                        'div',
                        {
                          key: optionKey,
                          className:
                            'flex items-center justify-between w-full px-2 py-1.5 text-sm hover:bg-gray-500/10 rounded-md text-gray-800 dark:text-gray-200',
                        },
                        h(
                          'span',
                          {
                            onClick: () => {
                              handleFilterChange(optionKey)
                              closeMenu()
                            },
                            className: 'flex-1 text-left cursor-pointer',
                          },
                          label
                        ),
                        h(
                          'button',
                          {
                            onClick: e => {
                              e.stopPropagation()
                              setSettings(s => ({ ...s, defaultHeaderFilter: optionKey }))
                            },
                            className: `p-1 rounded transition-colors ${optionKey === settings.defaultHeaderFilter ? 'text-blue-500' : 'text-gray-400 hover:text-gray-600 dark:hover:text-gray-300'}`,
                            title:
                              optionKey === settings.defaultHeaderFilter
                                ? 'Закреплено по умолчанию'
                                : 'Закрепить по умолчанию',
                          },
                          h(Pin, { size: 12 })
                        )
                      ),
                  }),
                  settings.headerFilter === 'custom' &&
                    h(
                      'div',
                      { className: 'flex gap-2' },
                      h('input', {
                        type: 'date',
                        value: settings.customDateFrom,
                        onChange: e => handleDateChange('customDateFrom', e.target.value),
                        className:
                          'px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm bg-white/50 dark:bg-gray-900/30 border-gray-300 dark:border-gray-500/30',
                      }),
                      h('input', {
                        type: 'date',
                        value: settings.customDateTo,
                        onChange: e => handleDateChange('customDateTo', e.target.value),
                        className:
                          'px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm bg-white/50 dark:bg-gray-900/30 border-gray-300 dark:border-gray-500/30',
                      })
                    ),
                  h(
                    'button',
                    {
                      onClick: onShowTutorial,
                      className:
                        'button-animated p-2 rounded-full hover:bg-gray-500/10 transition-colors',
                      title: 'Помощь',
                    },
                    h(HelpCircle, { size: 20 })
                  ),
                  h(
                    'button',
                    {
                      onClick: onShowAbout,
                      className:
                        'button-animated p-2 rounded-full hover:bg-gray-500/10 transition-colors',
                      title: 'О программе',
                    },
                    h(Info, { size: 20 })
                  ),
                  h(
                    'button',
                    {
                      onClick: () => setShowNotificationModal(true),
                      className:
                        'button-animated p-2 rounded-full hover:bg-gray-500/10 transition-colors',
                      title: settings.soundNotificationsEnabled
                        ? 'Настройки уведомлений'
                        : 'Уведомления выключены',
                    },
                    settings.soundNotificationsEnabled
                      ? h(Bell, { size: 20 })
                      : h(BellOff, { size: 20 })
                  ),
                  h(
                    'button',
                    {
                      onClick: () =>
                        setSettings(s => ({ ...s, animationsEnabled: !s.animationsEnabled })),
                      className: `button-animated p-2 rounded-full hover:bg-gray-500/10 transition-colors ${settings.animationsEnabled ? 'text-green-500' : 'text-gray-400'}`,
                      title: settings.animationsEnabled
                        ? 'Отключить анимации'
                        : 'Включить анимации',
                    },
                    settings.animationsEnabled ? h(Play, { size: 20 }) : h(Pause, { size: 20 })
                  ),
                  h(
                    'button',
                    {
                      onClick: () => setShowFloatingPanelSettings(true),
                      className: `button-animated p-2 rounded-full hover:bg-gray-500/10 transition-colors ${settings.floatingPanelEnabled ? 'text-blue-500' : 'text-gray-400'}`,
                      title: 'Настройки плавающей панели',
                    },
                    h(
                      'svg',
                      {
                        width: 20,
                        height: 20,
                        fill: 'none',
                        stroke: 'currentColor',
                        viewBox: '0 0 24 24',
                      },
                      h('path', {
                        strokeLinecap: 'round',
                        strokeLinejoin: 'round',
                        strokeWidth: 2,
                        d: 'M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z',
                      })
                    )
                  ),
                  h(
                    'button',
                    {
                      onClick: handleThemeChange,
                      className:
                        'button-animated p-2 rounded-full hover:bg-gray-500/10 transition-colors',
                    },
                    settings.theme === 'light' ? h(Moon, { size: 20 }) : h(Sun, { size: 20 })
                  )
                )
              )
            ),
            h(NotificationSettingsModal, {
              show: showNotificationModal,
              onClose: () => setShowNotificationModal(false),
              settings,
              setSettings,
            }),
            h(FloatingPanelSettingsModal, {
              show: showFloatingPanelSettings,
              onClose: () => setShowFloatingPanelSettings(false),
              settings,
              setSettings,
            })
          )
        }

        // ================================================================================= //
        // MARK: - FLOATING PANEL SETTINGS MODAL
        // ================================================================================= //
        const FloatingPanelSettingsModal = ({ show, onClose, settings, setSettings }) => {
          const [isClosing, setIsClosing] = useState(false)

          // Отключение скролла фона при открытом модальном окне
          useEffect(() => {
            if (show) {
              document.body.style.overflow = 'hidden'
            } else {
              document.body.style.overflow = 'unset'
            }

            // Очистка при размонтировании
            return () => {
              document.body.style.overflow = 'unset'
            }
          }, [show])

          const handleClose = () => {
            setIsClosing(true)
            setTimeout(() => {
              onClose()
              setIsClosing(false)
            }, 300) // Длительность анимации
          }

          if (!show) return null

          const handleTogglePanel = () => {
            setSettings(prev => ({
              ...prev,
              floatingPanelEnabled: !prev.floatingPanelEnabled,
            }))
          }

          const handleSizeChange = size => {
            setSettings(prev => ({
              ...prev,
              floatingPanelSize: size,
            }))
          }

          const handleThemeChange = theme => {
            setSettings(prev => ({
              ...prev,
              floatingPanelTheme: theme,
            }))
          }

          const handleResetPosition = () => {
            setSettings(prev => ({
              ...prev,
              floatingPanelPosition: { x: 20, y: 20 },
            }))
          }

          return h(
            'div',
            {
              className: `fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm transition-opacity duration-300 ${isClosing ? 'opacity-0' : 'opacity-100'}`,
            },
            h(
              'div',
              {
                className: `glass-effect rounded-xl shadow-2xl w-full max-w-md border border-gray-200 dark:border-gray-700 floating-panel-settings-modal ${isClosing ? 'closing' : ''}`,
              },
              h(
                'div',
                { className: 'p-6' },
                // Заголовок
                h(
                  'div',
                  { className: 'flex items-center justify-between mb-6' },
                  h(
                    'h2',
                    {
                      className:
                        'text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2',
                    },
                    h(
                      'div',
                      {
                        className:
                          'w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center',
                      },
                      h(
                        'svg',
                        {
                          width: 20,
                          height: 20,
                          fill: 'none',
                          stroke: 'currentColor',
                          viewBox: '0 0 24 24',
                        },
                        h('path', {
                          strokeLinecap: 'round',
                          strokeLinejoin: 'round',
                          strokeWidth: 2,
                          d: 'M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z',
                        })
                      )
                    ),
                    'Настройки плавающей панели'
                  ),
                  h(
                    'button',
                    {
                      onClick: handleClose,
                      className:
                        'p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors',
                    },
                    h(
                      'svg',
                      {
                        width: 20,
                        height: 20,
                        fill: 'none',
                        stroke: 'currentColor',
                        viewBox: '0 0 24 24',
                      },
                      h('path', {
                        strokeLinecap: 'round',
                        strokeLinejoin: 'round',
                        strokeWidth: 2,
                        d: 'M6 18L18 6M6 6l12 12',
                      })
                    )
                  )
                ),

                // Основные настройки
                h(
                  'div',
                  { className: 'space-y-6 floating-panel-settings-content' },
                  // Включение/выключение
                  h(
                    'div',
                    { className: 'flex items-center justify-between' },
                    h(
                      'div',
                      {},
                      h(
                        'h3',
                        { className: 'text-sm font-semibold text-gray-900 dark:text-white' },
                        'Включить панель'
                      ),
                      h(
                        'p',
                        { className: 'text-xs text-gray-500 dark:text-gray-400' },
                        'Показывать плавающую панель на экране'
                      )
                    ),
                    h(
                      'button',
                      {
                        onClick: handleTogglePanel,
                        className: `relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${settings.floatingPanelEnabled ? 'bg-blue-600' : 'bg-gray-300 dark:bg-gray-600'}`,
                      },
                      h('span', {
                        className: `inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${settings.floatingPanelEnabled ? 'translate-x-6' : 'translate-x-1'}`,
                      })
                    )
                  ),

                  // Размер панели
                  h(
                    'div',
                    {},
                    h(
                      'h3',
                      { className: 'text-sm font-semibold text-gray-900 dark:text-white mb-3' },
                      'Размер панели'
                    ),
                    h(
                      'div',
                      { className: 'grid grid-cols-2 gap-2' },
                      h(
                        'button',
                        {
                          onClick: () => handleSizeChange('compact'),
                          className: `p-3 rounded-lg border transition-colors ${settings.floatingPanelSize === 'compact' ? 'bg-blue-50 dark:bg-blue-900/30 border-blue-500 text-blue-700 dark:text-blue-300' : 'bg-gray-50 dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300'}`,
                          style: {
                            backgroundColor:
                              settings.floatingPanelSize === 'compact'
                                ? 'rgba(59, 130, 246, 0.1)'
                                : undefined,
                          },
                        },
                        h(
                          'div',
                          { className: 'text-center' },
                          h('div', { className: 'text-sm font-medium' }, 'Компактный'),
                          h(
                            'div',
                            { className: 'text-xs text-gray-500 dark:text-gray-400 mt-1' },
                            '200×80px'
                          )
                        )
                      ),
                      h(
                        'button',
                        {
                          onClick: () => handleSizeChange('expanded'),
                          className: `p-3 rounded-lg border transition-colors ${settings.floatingPanelSize === 'expanded' ? 'bg-blue-50 dark:bg-blue-900/30 border-blue-500 text-blue-700 dark:text-blue-300' : 'bg-gray-50 dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300'}`,
                          style: {
                            backgroundColor:
                              settings.floatingPanelSize === 'expanded'
                                ? 'rgba(59, 130, 246, 0.1)'
                                : undefined,
                          },
                        },
                        h(
                          'div',
                          { className: 'text-center' },
                          h('div', { className: 'text-sm font-medium' }, 'Расширенный'),
                          h(
                            'div',
                            { className: 'text-xs text-gray-500 dark:text-gray-400 mt-1' },
                            '300×120px'
                          )
                        )
                      )
                    )
                  ),

                  // Тема панели
                  h(
                    'div',
                    {},
                    h(
                      'h3',
                      { className: 'text-sm font-semibold text-gray-900 dark:text-white mb-3' },
                      'Тема панели'
                    ),
                    h(
                      'div',
                      { className: 'grid grid-cols-3 gap-2' },
                      h(
                        'button',
                        {
                          onClick: () => handleThemeChange('glass'),
                          className: `p-3 rounded-lg border transition-colors ${settings.floatingPanelTheme === 'glass' ? 'bg-blue-50 dark:bg-blue-900/30 border-blue-500' : 'bg-gray-50 dark:bg-gray-800 border-gray-300 dark:border-gray-600'}`,
                          style: {
                            backgroundColor:
                              settings.floatingPanelTheme === 'glass'
                                ? 'rgba(59, 130, 246, 0.1)'
                                : undefined,
                          },
                        },
                        h(
                          'div',
                          { className: 'text-center' },
                          h('div', { className: 'text-sm font-medium' }, 'Стеклянная'),
                          h(
                            'div',
                            { className: 'text-xs text-gray-500 dark:text-gray-400 mt-1' },
                            'Размытие'
                          )
                        )
                      ),
                      h(
                        'button',
                        {
                          onClick: () => handleThemeChange('solid'),
                          className: `p-3 rounded-lg border transition-colors ${settings.floatingPanelTheme === 'solid' ? 'bg-blue-50 dark:bg-blue-900/30 border-blue-500' : 'bg-gray-50 dark:bg-gray-800 border-gray-300 dark:border-gray-600'}`,
                          style: {
                            backgroundColor:
                              settings.floatingPanelTheme === 'solid'
                                ? 'rgba(59, 130, 246, 0.1)'
                                : undefined,
                          },
                        },
                        h(
                          'div',
                          { className: 'text-center' },
                          h('div', { className: 'text-sm font-medium' }, 'Твердая'),
                          h(
                            'div',
                            { className: 'text-xs text-gray-500 dark:text-gray-400 mt-1' },
                            'Непрозрачная'
                          )
                        )
                      ),
                      h(
                        'button',
                        {
                          onClick: () => handleThemeChange('minimal'),
                          className: `p-3 rounded-lg border transition-colors ${settings.floatingPanelTheme === 'minimal' ? 'bg-blue-50 dark:bg-blue-900/30 border-blue-500' : 'bg-gray-50 dark:bg-gray-800 border-gray-300 dark:border-gray-600'}`,
                          style: {
                            backgroundColor:
                              settings.floatingPanelTheme === 'minimal'
                                ? 'rgba(59, 130, 246, 0.1)'
                                : undefined,
                          },
                        },
                        h(
                          'div',
                          { className: 'text-center' },
                          h('div', { className: 'text-sm font-medium' }, 'Минимальная'),
                          h(
                            'div',
                            { className: 'text-xs text-gray-500 dark:text-gray-400 mt-1' },
                            'Простая'
                          )
                        )
                      )
                    )
                  ),

                  // Дополнительные действия
                  h(
                    'div',
                    { className: 'flex gap-2' },
                    h(
                      'button',
                      {
                        onClick: handleResetPosition,
                        className:
                          'flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm',
                      },
                      'Сбросить позицию'
                    ),
                    h(
                      'button',
                      {
                        onClick: handleClose,
                        className:
                          'flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm',
                      },
                      'Готово'
                    )
                  )
                )
              )
            )
          )
        }

        // ================================================================================= //
        // MARK: - WORK SCHEDULE MODAL
        // ================================================================================= //
        const WorkScheduleModal = ({ show, onClose, settings, setSettings }) => {
          const [isClosing, setIsClosing] = useState(false)
          const [activeTab, setActiveTab] = useState('templates')
          const [selectedTemplate, setSelectedTemplate] = useState(
            settings?.workScheduleTemplate || '5/2'
          )
          const [startDay, setStartDay] = useState(settings?.workScheduleStartDay || 1) // 1 = ПН

          // Синхронизация локальных состояний с settings при открытии модального окна
          useEffect(() => {
            if (show) {
              setSelectedTemplate(settings?.workScheduleTemplate || '5/2')
              setStartDay(settings?.workScheduleStartDay || 1)
            }
          }, [show, settings?.workScheduleTemplate, settings?.workScheduleStartDay])

          // Вспомогательные функции для работы с днями недели
          const getWeekDays = () => {
            const days = ['ПН', 'ВТ', 'СР', 'ЧТ', 'ПТ', 'СБ', 'ВС']
            return [...days.slice(startDay - 1), ...days.slice(0, startDay - 1)]
          }

          const getWorkDays = template => {
            const weekDays = getWeekDays()
            const patterns = {
              '5/2': 5,
              '2/2': 2,
              '3/3': 3,
              '5/5': 5,
            }
            const workCount = patterns[template] || 5
            return weekDays.slice(0, workCount)
          }

          const getWorkDaysFromSettings = () => {
            if (settings?.customWorkDates) {
              return Object.values(settings.customWorkDates).filter(day => day !== false).length
            }
            return 0
          }

          // Функция для генерации календаря месяца с рабочими днями по шаблону
          const generateMonthCalendar = (template, workStartDay = 1) => {
            const now = new Date()
            const year = now.getFullYear()
            const month = now.getMonth()
            const daysInMonth = new Date(year, month + 1, 0).getDate()
            const calendar = []

            // Добавляем пустые ячейки в начале для правильного выравнивания
            const firstDayOfMonth = new Date(year, month, 1)
            let firstDayWeekday = firstDayOfMonth.getDay() // 0 = Sunday, 1 = Monday
            firstDayWeekday = firstDayWeekday === 0 ? 7 : firstDayWeekday // Конвертируем: 1 = Monday, 7 = Sunday

            // Добавляем пустые ячейки (с понедельника)
            for (let i = 1; i < firstDayWeekday; i++) {
              calendar.push({ day: null, isWorkDay: false })
            }

            if (template === '5/2') {
              // Стандартный график: учитываем начало рабочей недели
              for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day)
                let dayOfWeek = date.getDay() // 0 = Sunday, 1 = Monday

                // Конвертируем в систему где Monday = 1
                dayOfWeek = dayOfWeek === 0 ? 7 : dayOfWeek

                // Сдвигаем относительно начального дня недели
                const adjustedDay = (dayOfWeek - workStartDay + 7) % 7

                // Первые 5 дней недели - рабочие
                const isWorkDay = adjustedDay < 5
                calendar.push({ day, isWorkDay })
              }
            } else {
              // Сменные графики: начинаются с выбранного дня недели
              const patterns = {
                '2/2': { work: 2, total: 4 },
                '3/3': { work: 3, total: 6 },
                '5/5': { work: 5, total: 10 },
              }

              const pattern = patterns[template]
              if (pattern) {
                // Находим первый день месяца, который соответствует началу рабочей недели
                let firstWorkDay = 1
                for (let day = 1; day <= 7; day++) {
                  const date = new Date(year, month, day)
                  let dayOfWeek = date.getDay()
                  dayOfWeek = dayOfWeek === 0 ? 7 : dayOfWeek

                  if (dayOfWeek === workStartDay) {
                    firstWorkDay = day
                    break
                  }
                }

                // Рассчитываем рабочие дни относительно первого рабочего дня
                for (let day = 1; day <= daysInMonth; day++) {
                  const daysSinceFirstWorkDay = day - firstWorkDay
                  const cyclePosition =
                    ((daysSinceFirstWorkDay % pattern.total) + pattern.total) % pattern.total
                  const isWorkDay = cyclePosition < pattern.work
                  calendar.push({ day, isWorkDay })
                }
              }
            }

            return calendar
          }

          // Функция для генерации кастомного календаря с выбором дней
          const generateCustomCalendar = () => {
            const now = new Date()
            const year = now.getFullYear()
            const month = now.getMonth()
            const daysInMonth = new Date(year, month + 1, 0).getDate()
            const calendar = []

            // Добавляем пустые ячейки в начале
            const firstDayOfMonth = new Date(year, month, 1)
            let firstDayWeekday = firstDayOfMonth.getDay()
            firstDayWeekday = firstDayWeekday === 0 ? 7 : firstDayWeekday

            for (let i = 1; i < firstDayWeekday; i++) {
              calendar.push({ day: null, isWorkDay: false })
            }

            // Добавляем дни месяца с проверкой кастомных настроек
            for (let day = 1; day <= daysInMonth; day++) {
              const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`

              // Проверяем настройки: если нет кастомных дат, по умолчанию все дни рабочие
              const isWorkDay = settings?.customWorkDates
                ? settings.customWorkDates[dateKey] !== false
                : true

              calendar.push({ day, dateKey, isWorkDay })
            }

            return calendar
          }

          // Отключение скролла фона при открытом модальном окне
          useEffect(() => {
            if (show) {
              document.body.style.overflow = 'hidden'
            } else {
              document.body.style.overflow = 'unset'
            }

            // Очистка при размонтировании
            return () => {
              document.body.style.overflow = 'unset'
            }
          }, [show])

          const handleClose = () => {
            if (isClosing) return // Предотвращаем повторные вызовы
            setIsClosing(true)
            setTimeout(() => {
              setIsClosing(false)
              onClose()
            }, 300) // Длительность анимации
          }

          if (!show) return null

          return h(
            Portal,
            {},
            h(
              'div',
              {
                className: `fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 backdrop-blur-sm ${isClosing ? 'modal-backdrop-exit' : 'modal-backdrop-enter'}`,
              },
              h(
                'div',
                {
                  className: `glass-effect p-8 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col border border-gray-200 dark:border-gray-700 transition-all duration-300 ease-in-out ${isClosing ? 'modal-exit' : 'modal-enter'}`,
                  onClick: e => e.stopPropagation(),
                },
                // Заголовок
                h(
                  'div',
                  { className: 'flex justify-between items-center mb-4' },
                  h(
                    'div',
                    {},
                    h(
                      'h2',
                      { className: 'text-2xl font-bold text-gray-900 dark:text-white' },
                      'Настройка рабочего графика'
                    ),
                    settings?.customWorkDates &&
                      Object.keys(settings.customWorkDates).length > 0 &&
                      h(
                        'div',
                        { className: 'mt-1 flex items-center gap-2' },
                        h(
                          'span',
                          {
                            className:
                              'px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 text-xs rounded-full',
                          },
                          'Кастомный режим'
                        ),
                        h(
                          'span',
                          { className: 'text-xs text-gray-500 dark:text-gray-400' },
                          `${getWorkDaysFromSettings()} рабочих дней`
                        )
                      )
                  ),
                  h(
                    'button',
                    {
                      onClick: handleClose,
                      className:
                        'p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-gray-600 dark:text-white',
                    },
                    h(CloseIcon, { size: 24 })
                  )
                ),

                // Содержимое
                h(
                  'div',
                  { className: 'flex-1 overflow-y-auto custom-scrollbar pr-4' },
                  h(
                    'div',
                    { className: 'space-y-4' },
                    h(
                      'h3',
                      { className: 'text-lg font-semibold text-gray-900 dark:text-white mb-4' },
                      'Выберите шаблон рабочего графика на ',
                      h(
                        'span',
                        { className: 'text-blue-600 dark:text-blue-400 uppercase' },
                        new Date().toLocaleDateString('ru-RU', { month: 'long' })
                      )
                    ),
                    h(
                      'div',
                      { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4' },
                      // Шаблон 5/2 (5 рабочих, 2 выходных)
                      h(
                        'div',
                        {
                          className: `p-4 border rounded-lg transition-colors cursor-pointer ${selectedTemplate === '5/2' ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20' : 'border-gray-200 dark:border-gray-700 hover:border-blue-500 dark:hover:border-blue-400'}`,
                          onClick: () => setSelectedTemplate('5/2'),
                        },
                        h(
                          'div',
                          { className: 'flex items-center justify-between mb-3' },
                          h(
                            'h4',
                            { className: 'font-medium text-gray-900 dark:text-white' },
                            'Стандартный 5/2'
                          ),
                          h(
                            'span',
                            {
                              className:
                                'px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 text-xs rounded-full',
                            },
                            'Популярный'
                          )
                        ),
                        // Календарь месяца для шаблона 5/2
                        h(
                          'div',
                          { className: 'mb-3' },
                          h(
                            'div',
                            { className: 'grid grid-cols-7 gap-1 text-xs' },
                            generateMonthCalendar('5/2', startDay).map((dayInfo, i) =>
                              h(
                                'div',
                                {
                                  key: i,
                                  className: `w-6 h-6 rounded text-xs flex items-center justify-center font-medium ${
                                    dayInfo.day === null
                                      ? 'opacity-0'
                                      : dayInfo.isWorkDay
                                        ? 'workday-indicator'
                                        : 'glass-button glass-button-green'
                                  }`,
                                },
                                dayInfo.day || ''
                              )
                            )
                          )
                        ),
                        h(
                          'p',
                          { className: 'text-sm text-gray-600 dark:text-gray-400' },
                          `${generateMonthCalendar('5/2', startDay).filter(d => d.isWorkDay).length} рабочих дней в месяце`
                        )
                      ),

                      // Шаблон 2/2 (сменный график)
                      h(
                        'div',
                        {
                          className: `p-4 border rounded-lg transition-colors cursor-pointer ${selectedTemplate === '2/2' ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20' : 'border-gray-200 dark:border-gray-700 hover:border-blue-500 dark:hover:border-blue-400'}`,
                          onClick: () => setSelectedTemplate('2/2'),
                        },
                        h(
                          'div',
                          { className: 'flex items-center justify-between mb-3' },
                          h(
                            'h4',
                            { className: 'font-medium text-gray-900 dark:text-white' },
                            'Сменный 2/2'
                          ),
                          h(
                            'span',
                            {
                              className:
                                'px-2 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 text-xs rounded-full',
                            },
                            'Сменный'
                          )
                        ),
                        // Календарь месяца для шаблона 2/2
                        h(
                          'div',
                          { className: 'mb-3' },
                          h(
                            'div',
                            { className: 'grid grid-cols-7 gap-1 text-xs' },
                            generateMonthCalendar('2/2', startDay).map((dayInfo, i) =>
                              h(
                                'div',
                                {
                                  key: i,
                                  className: `w-6 h-6 rounded text-xs flex items-center justify-center font-medium ${
                                    dayInfo.day === null
                                      ? 'opacity-0'
                                      : dayInfo.isWorkDay
                                        ? 'workday-indicator'
                                        : 'glass-button glass-button-green'
                                  }`,
                                },
                                dayInfo.day || ''
                              )
                            )
                          )
                        ),
                        h(
                          'p',
                          { className: 'text-sm text-gray-600 dark:text-gray-400' },
                          `${generateMonthCalendar('2/2', startDay).filter(d => d.isWorkDay).length} рабочих дней в месяце`
                        )
                      ),

                      // Шаблон 3/3 (сменный график)
                      h(
                        'div',
                        {
                          className: `p-4 border rounded-lg transition-colors cursor-pointer ${selectedTemplate === '3/3' ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20' : 'border-gray-200 dark:border-gray-700 hover:border-blue-500 dark:hover:border-blue-400'}`,
                          onClick: () => setSelectedTemplate('3/3'),
                        },
                        h(
                          'div',
                          { className: 'flex items-center justify-between mb-3' },
                          h(
                            'h4',
                            { className: 'font-medium text-gray-900 dark:text-white' },
                            'Сменный 3/3'
                          ),
                          h(
                            'span',
                            {
                              className:
                                'px-2 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 text-xs rounded-full',
                            },
                            'Сменный'
                          )
                        ),
                        // Календарь месяца для шаблона 3/3
                        h(
                          'div',
                          { className: 'mb-3' },
                          h(
                            'div',
                            { className: 'grid grid-cols-7 gap-1 text-xs' },
                            generateMonthCalendar('3/3', startDay).map((dayInfo, i) =>
                              h(
                                'div',
                                {
                                  key: i,
                                  className: `w-6 h-6 rounded text-xs flex items-center justify-center font-medium ${
                                    dayInfo.day === null
                                      ? 'opacity-0'
                                      : dayInfo.isWorkDay
                                        ? 'workday-indicator'
                                        : 'glass-button glass-button-green'
                                  }`,
                                },
                                dayInfo.day || ''
                              )
                            )
                          )
                        ),
                        h(
                          'p',
                          { className: 'text-sm text-gray-600 dark:text-gray-400' },
                          `${generateMonthCalendar('3/3', startDay).filter(d => d.isWorkDay).length} рабочих дней в месяце`
                        )
                      ),

                      // Шаблон 5/5 (сменный график)
                      h(
                        'div',
                        {
                          className: `p-4 border rounded-lg transition-colors cursor-pointer ${selectedTemplate === '5/5' ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20' : 'border-gray-200 dark:border-gray-700 hover:border-blue-500 dark:hover:border-blue-400'}`,
                          onClick: () => setSelectedTemplate('5/5'),
                        },
                        h(
                          'div',
                          { className: 'flex items-center justify-between mb-3' },
                          h(
                            'h4',
                            { className: 'font-medium text-gray-900 dark:text-white' },
                            'Сменный 5/5'
                          ),
                          h(
                            'span',
                            {
                              className:
                                'px-2 py-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 text-xs rounded-full',
                            },
                            'Интенсивный'
                          )
                        ),
                        // Календарь месяца для шаблона 5/5
                        h(
                          'div',
                          { className: 'mb-3' },
                          h(
                            'div',
                            { className: 'grid grid-cols-7 gap-1 text-xs' },
                            generateMonthCalendar('5/5', startDay).map((dayInfo, i) =>
                              h(
                                'div',
                                {
                                  key: i,
                                  className: `w-6 h-6 rounded text-xs flex items-center justify-center font-medium ${
                                    dayInfo.day === null
                                      ? 'opacity-0'
                                      : dayInfo.isWorkDay
                                        ? 'workday-indicator'
                                        : 'glass-button glass-button-green'
                                  }`,
                                },
                                dayInfo.day || ''
                              )
                            )
                          )
                        ),
                        h(
                          'p',
                          { className: 'text-sm text-gray-600 dark:text-gray-400' },
                          `${generateMonthCalendar('5/5', startDay).filter(d => d.isWorkDay).length} рабочих дней в месяце`
                        )
                      ),

                      // 5-й блок: Кастомный календарь
                      h(
                        'div',
                        {
                          className: `p-4 border rounded-lg transition-colors cursor-pointer ${selectedTemplate === 'custom' ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20' : 'border-gray-200 dark:border-gray-700 hover:border-blue-500 dark:hover:border-blue-400'}`,
                          onClick: () => setSelectedTemplate('custom'),
                        },
                        h(
                          'div',
                          { className: 'flex items-center justify-between mb-3' },
                          h(
                            'h4',
                            { className: 'font-medium text-gray-900 dark:text-white' },
                            'Кастомный'
                          ),
                          h(
                            'span',
                            {
                              className:
                                'px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 text-xs rounded-full',
                            },
                            'Индивидуальный'
                          )
                        ),
                        // Кастомный календарь с кликабельными днями
                        h(
                          'div',
                          { className: 'mb-3' },
                          h(
                            'div',
                            { className: 'grid grid-cols-7 gap-1 text-xs' },
                            generateCustomCalendar().map((dayInfo, i) => {
                              if (dayInfo.day === null) {
                                return h('div', { key: i, className: 'w-6 h-6 opacity-0' })
                              }

                              return h(
                                'button',
                                {
                                  key: i,
                                  onClick: e => {
                                    e.stopPropagation() // Предотвращаем выбор шаблона при клике на день
                                    setSettings(prev => ({
                                      ...prev,
                                      customWorkDates: {
                                        ...prev.customWorkDates,
                                        [dayInfo.dateKey]: !dayInfo.isWorkDay,
                                      },
                                    }))
                                  },
                                  className: `w-6 h-6 rounded text-xs flex items-center justify-center font-medium transition-all duration-200 ${
                                    dayInfo.isWorkDay
                                      ? 'workday-indicator cursor-pointer hover:opacity-80'
                                      : 'glass-button glass-button-green cursor-pointer hover:opacity-80'
                                  }`,
                                },
                                dayInfo.day
                              )
                            })
                          )
                        ),
                        h(
                          'p',
                          { className: 'text-sm text-gray-600 dark:text-gray-400' },
                          `${generateCustomCalendar().filter(d => d.day && d.isWorkDay).length} рабочих дней в месяце`
                        )
                      ),

                      // 6-й блок: Настройки
                      h(
                        'div',
                        {
                          className: 'p-4 border border-gray-200 dark:border-gray-700 rounded-lg',
                        },
                        h(
                          'div',
                          { className: 'flex items-center justify-between mb-3' },
                          h(
                            'h4',
                            { className: 'font-medium text-gray-900 dark:text-white' },
                            'Настройки'
                          ),
                          h(
                            'span',
                            {
                              className:
                                'px-2 py-1 bg-gray-100 dark:bg-gray-800/50 text-gray-600 dark:text-gray-400 text-xs rounded-full',
                            },
                            'Дополнительно'
                          )
                        ),

                        // Настройка дневного плана
                        h(
                          'div',
                          { className: 'space-y-4' },
                          h(
                            'div',
                            {},
                            h(
                              'label',
                              {
                                className:
                                  'block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2',
                              },
                              'План на день:'
                            ),
                            h(
                              'div',
                              { className: 'flex items-center gap-2' },
                              h('input', {
                                type: 'number',
                                value: settings?.dailyPlan || 6000,
                                onChange: e => {
                                  const value = parseInt(e.target.value) || 6000
                                  setSettings(prev => ({ ...prev, dailyPlan: value }))
                                },
                                className:
                                  'flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent min-w-0',
                              }),
                              h(
                                'span',
                                {
                                  className:
                                    'text-sm text-gray-500 dark:text-gray-400 whitespace-nowrap',
                                },
                                '₽'
                              )
                            )
                          ),

                          // Автоматический расчет месячного плана
                          h(
                            'div',
                            {
                              className:
                                'p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-500/30',
                            },
                            h(
                              'div',
                              { className: 'flex items-start gap-2 mb-2' },
                              h(
                                'span',
                                {
                                  className:
                                    'text-sm font-medium text-blue-700 dark:text-blue-300 flex-shrink-0',
                                },
                                'План на месяц:'
                              ),
                              h(
                                'span',
                                {
                                  className:
                                    'text-base font-bold text-blue-800 dark:text-blue-200 whitespace-nowrap',
                                },
                                `${Math.round(
                                  (settings?.dailyPlan || 6000) *
                                    calculateWorkingDaysInMonth(
                                      new Date().getFullYear(),
                                      new Date().getMonth(),
                                      1,
                                      null,
                                      {
                                        ...settings,
                                        workScheduleTemplate: selectedTemplate,
                                        workScheduleStartDay: startDay,
                                        customWorkDates:
                                          selectedTemplate === 'custom'
                                            ? settings?.customWorkDates || {}
                                            : {},
                                      }
                                    )
                                ).toLocaleString('ru-RU')}\u00A0₽`
                              )
                            ),
                            h(
                              'p',
                              { className: 'text-xs text-blue-600 dark:text-blue-400 break-words' },
                              `Автоматически рассчитано: ${(settings?.dailyPlan || 6000).toLocaleString('ru-RU')}\u00A0₽ × ${calculateWorkingDaysInMonth(
                                new Date().getFullYear(),
                                new Date().getMonth(),
                                1,
                                null,
                                {
                                  ...settings,
                                  workScheduleTemplate: selectedTemplate,
                                  workScheduleStartDay: startDay,
                                  customWorkDates:
                                    selectedTemplate === 'custom'
                                      ? settings?.customWorkDates || {}
                                      : {},
                                }
                              )} рабочих дней`
                            )
                          )
                        )
                      )
                    ),

                    // Легенда
                    h(
                      'div',
                      {
                        className:
                          'mt-4 p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg flex items-center gap-3 text-xs',
                      },
                      h(
                        'span',
                        { className: 'font-medium text-gray-900 dark:text-white mr-2' },
                        'Легенда:'
                      ),
                      h('div', {
                        className: 'w-6 h-6 workday-indicator rounded inline-block align-middle',
                      }),
                      h(
                        'span',
                        { className: 'mx-1 text-gray-600 dark:text-gray-400' },
                        'Рабочий день'
                      ),
                      h('div', {
                        className:
                          'w-6 h-6 glass-button glass-button-green rounded inline-block align-middle',
                      }),
                      h(
                        'span',
                        { className: 'mx-1 text-gray-600 dark:text-gray-400' },
                        'Выходной день'
                      )
                    ),

                    // Селектор начального дня недели (перемещен ниже шаблонов)
                    h(
                      'div',
                      { className: 'mt-6 p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg' },
                      h(
                        'div',
                        { className: 'flex items-center gap-3 flex-wrap' },
                        h(
                          'span',
                          { className: 'text-sm font-medium text-gray-900 dark:text-white' },
                          'Начало рабочей недели:'
                        ),
                        h(
                          'div',
                          { className: 'flex gap-1' },
                          ['ПН', 'ВТ', 'СР', 'ЧТ', 'ПТ', 'СБ', 'ВС'].map((day, index) =>
                            h(
                              'button',
                              {
                                key: index + 1,
                                onClick: () => setStartDay(index + 1),
                                className: `px-2 py-1 text-xs rounded transition-colors ${startDay === index + 1 ? 'bg-blue-500 text-white' : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600'}`,
                              },
                              day
                            )
                          )
                        )
                      )
                    ),

                    h(
                      'div',
                      { className: 'mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg' },
                      h(
                        'h4',
                        {
                          className:
                            'font-medium text-blue-900 dark:text-blue-300 mb-2 flex items-center gap-2',
                        },
                        h(Info, { className: 'w-4 h-4 text-blue-600 dark:text-blue-400' }),
                        'Как это работает?'
                      ),
                      h(
                        'p',
                        { className: 'text-sm text-blue-700 dark:text-blue-400' },
                        'Выберите подходящий шаблон рабочего графика. Система автоматически рассчитает ваши рабочие дни и учтет их при планировании и аналитике.'
                      )
                    )
                  )
                ),

                // Кнопки действий
                h(
                  'div',
                  { className: 'flex gap-3 mt-6' },
                  h(
                    'button',
                    {
                      onClick: handleClose,
                      className:
                        'px-6 py-2 glass-button glass-button-gray rounded-lg font-medium text-white',
                    },
                    'Отмена'
                  ),
                  h(
                    'button',
                    {
                      onClick: () => {
                        // Сохраняем настройки перед закрытием
                        setSettings(prev => ({
                          ...prev,
                          workScheduleTemplate: selectedTemplate,
                          workScheduleStartDay: startDay,
                          customWorkDates:
                            selectedTemplate === 'custom' ? settings?.customWorkDates || {} : {},
                        }))
                        onClose()
                      },
                      className:
                        'flex-1 px-6 py-2 glass-button glass-button-blue rounded-lg font-medium text-white',
                    },
                    'Сохранить'
                  )
                )
              )
            )
          )
        }

        // ================================================================================= //
        // MARK: - FLOATING PANEL COMPONENT
        // ================================================================================= //
        const FloatingPanel = ({
          activeTimer,
          elapsedTime,
          onStart,
          onStop,
          onPause,
          settings,
          setSettings,
          entries = [],
          isVisible = true,
        }) => {
          const [isDragging, setIsDragging] = useState(false)
          const [dragStart, setDragStart] = useState({ x: 0, y: 0 })
          const [position, setPosition] = useState(() => {
            return settings?.floatingPanelPosition || { x: 20, y: 20 }
          })
          const [isExpanded, setIsExpanded] = useState(() => {
            return settings?.floatingPanelSize === 'expanded'
          })
          const panelRef = useRef(null)

          // Синхронизация с настройками
          useEffect(() => {
            if (settings) {
              setIsExpanded(settings.floatingPanelSize === 'expanded')
            }
          }, [settings?.floatingPanelSize])

          useEffect(() => {
            if (settings) {
              setPosition(settings.floatingPanelPosition || { x: 20, y: 20 })
            }
          }, [settings?.floatingPanelPosition])

          // Обработка перетаскивания - оптимизированная версия
          const handleMouseDown = useCallback(e => {
            if (e.target.closest('.floating-panel-button')) return

            setIsDragging(true)
            const rect = panelRef.current.getBoundingClientRect()
            setDragStart({
              x: e.clientX - rect.left,
              y: e.clientY - rect.top,
            })
            e.preventDefault()
          }, [])

          const handleMouseMove = useCallback(
            e => {
              if (!isDragging) return

              const newX = e.clientX - dragStart.x
              const newY = e.clientY - dragStart.y

              // Ограничиваем позицию в пределах экрана
              const maxX = window.innerWidth - (isExpanded ? 300 : 200)
              const maxY = window.innerHeight - (isExpanded ? 120 : 80)

              const clampedX = Math.max(0, Math.min(newX, maxX))
              const clampedY = Math.max(0, Math.min(newY, maxY))

              setPosition({ x: clampedX, y: clampedY })
            },
            [isDragging, dragStart, isExpanded]
          )

          const handleMouseUp = useCallback(() => {
            if (isDragging) {
              setIsDragging(false)
              // Сохраняем позицию в настройках
              setSettings(prev => ({
                ...prev,
                floatingPanelPosition: position,
              }))
            }
          }, [isDragging, position, setSettings])

          // Обработчики событий
          useEffect(() => {
            if (isDragging) {
              document.addEventListener('mousemove', handleMouseMove)
              document.addEventListener('mouseup', handleMouseUp)
              return () => {
                document.removeEventListener('mousemove', handleMouseMove)
                document.removeEventListener('mouseup', handleMouseUp)
              }
            }
          }, [isDragging, handleMouseMove, handleMouseUp])

          // Переключение размера панели
          const toggleSize = useCallback(() => {
            const newExpanded = !isExpanded
            setIsExpanded(newExpanded)
            setSettings(prev => ({
              ...prev,
              floatingPanelSize: newExpanded ? 'expanded' : 'compact',
            }))
          }, [isExpanded, setSettings])

          // Определяем статус таймера
          const getTimerStatus = () => {
            if (activeTimer) return 'active'
            return 'stopped'
          }

          // Форматирование времени
          const formatTime = time => {
            const hours = Math.floor(time / 3600000)
            const minutes = Math.floor((time % 3600000) / 60000)
            const seconds = Math.floor((time % 60000) / 1000)
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`
          }

          // Быстрая статистика для расширенного режима
          const getQuickStats = () => {
            const today = new Date().toISOString().split('T')[0]
            const todayEntries = entries.filter(entry => entry.date === today)

            const totalHours = todayEntries.reduce((sum, entry) => {
              if (entry.start && entry.end) {
                const [sh, sm] = entry.start.split(':').map(Number)
                const [eh, em] = entry.end.split(':').map(Number)
                const startMinutes = sh * 60 + sm
                let endMinutes = eh * 60 + em
                if (endMinutes < startMinutes) endMinutes += 24 * 60
                return sum + Math.max(0, (endMinutes - startMinutes) / 60)
              }
              return sum
            }, 0)

            const totalEarned = todayEntries.reduce((sum, entry) => sum + (entry.earned || 0), 0)
            const activeEntries = todayEntries.filter(entry => !entry.end).length

            // Расчет средней ставки
            const averageRate = totalHours > 0 ? totalEarned / totalHours : 0

            return {
              totalHours: totalHours.toFixed(1),
              totalEarned: totalEarned.toLocaleString('ru-RU'),
              averageRate: averageRate.toFixed(0),
              activeEntries,
            }
          }

          // Обработчик настроек панели
          const handleSettingsClick = () => {
            // Переключаем тему панели
            const themes = ['glass', 'solid', 'minimal']
            const currentIndex = themes.indexOf(settings.floatingPanelTheme)
            const nextTheme = themes[(currentIndex + 1) % themes.length]

            setSettings(prev => ({
              ...prev,
              floatingPanelTheme: nextTheme,
            }))
          }

          if (!isVisible || settings?.floatingPanelEnabled === false) return null

          return h(
            'div',
            {
              ref: panelRef,
              className: `floating-panel ${settings?.floatingPanelTheme || 'glass'}-theme ${isExpanded ? 'expanded' : 'compact'} ${isDragging ? 'dragging' : ''} floating-panel-size-transition floating-panel-theme-transition`,
              style: {
                left: `${position?.x || 20}px`,
                top: `${position?.y || 20}px`,
                cursor: isDragging ? 'grabbing' : 'move',
              },
              onMouseDown: handleMouseDown,
            },
            h(
              'div',
              { className: 'floating-panel-content' },
              // Заголовок с таймером и статусом
              h(
                'div',
                { className: 'floating-panel-header' },
                h(
                  'div',
                  { className: 'flex items-center gap-2' },
                  h('div', { className: `floating-panel-status-dot ${getTimerStatus()}` }),
                  h(
                    'div',
                    { className: 'floating-panel-timer' },
                    activeTimer ? formatTime(elapsedTime) : '00:00:00'
                  )
                ),
                h(
                  'button',
                  {
                    onClick: toggleSize,
                    className: 'floating-panel-button toggle',
                    title: isExpanded ? 'Свернуть' : 'Развернуть',
                  },
                  isExpanded ? '−' : '+'
                )
              ),

              // Расширенный контент (только в expanded режиме)
              isExpanded &&
                h(
                  'div',
                  { className: 'floating-panel-stats' },
                  (() => {
                    const stats = getQuickStats()
                    return h(
                      'div',
                      { className: 'grid grid-cols-3 gap-1 text-xs' },
                      // Часы работы - синий акцент
                      h(
                        'div',
                        { className: 'floating-stat-card hours-stat' },
                        h('div', { className: 'stat-value' }, `${stats.totalHours}ч`),
                        h('div', { className: 'stat-label' }, 'Часы')
                      ),
                      // Средняя ставка - зеленый акцент
                      h(
                        'div',
                        { className: 'floating-stat-card rate-stat' },
                        h('div', { className: 'stat-value' }, `${stats.averageRate}₽/ч`),
                        h('div', { className: 'stat-label' }, 'Ставка')
                      ),
                      // Заработок - фиолетовый акцент
                      h(
                        'div',
                        { className: 'floating-stat-card earned-stat' },
                        h('div', { className: 'stat-value' }, `${stats.totalEarned}₽`),
                        h('div', { className: 'stat-label' }, 'Доход')
                      )
                    )
                  })()
                ),

              // Элементы управления
              h(
                'div',
                { className: 'floating-panel-controls' },
                !activeTimer
                  ? h(
                      'button',
                      {
                        onClick: onStart,
                        className: 'floating-panel-button start',
                        title: 'Старт',
                      },
                      '▶'
                    )
                  : h(
                      'button',
                      {
                        onClick: onStop,
                        className: 'floating-panel-button stop',
                        title: 'Стоп',
                      },
                      '⏹'
                    ),

                h(
                  'button',
                  {
                    onClick: handleSettingsClick,
                    className: 'floating-panel-button settings',
                    title: `Тема: ${settings.floatingPanelTheme} (клик для смены)`,
                  },
                  '⚙'
                )
              )
            )
          )
        }

        const MainApp = () => {
          const { entries, setEntries, dailyPlan, setDailyPlan, entriesSaveStatus } = useData()
          const { settings, setSettings } = useSettings()
          const { pushToUndo, undo, redo } = useHistory()
          const { NotificationComponent, showNotification } = useNotifications()
          const [showClearConfirmModal, setShowClearConfirmModal] = useState(false)
          const [showTutorial, setShowTutorial] = useState(false)
          const [showAbout, setShowAbout] = useState(false)
          const [showWorkScheduleModal, setShowWorkScheduleModal] = useState(false)
          const [compareMode, setCompareMode] = useState(false)
          const [editingEntryId, setEditingEntryId] = useState(null)
          const [modalEntry, setModalEntry] = useState(null)
          const [newEntryIds, setNewEntryIds] = useState(new Set())
          const [isModalOpen, setIsModalOpen] = useState(false)
          const [shouldAnimateEntries, setShouldAnimateEntries] = useState(false)

          // Управление анимациями
          useEffect(() => {
            if (settings.animationsEnabled) {
              document.body.classList.remove('animations-disabled')
            } else {
              document.body.classList.add('animations-disabled')
            }
          }, [settings.animationsEnabled])

          // Активируем анимации записей
          useEffect(() => {
            console.log('Активация анимаций записей...', settings.listView)
            const timer = setTimeout(() => {
              setShouldAnimateEntries(true)
              console.log('shouldAnimateEntries установлен в true')
            }, 100)
            return () => clearTimeout(timer)
          }, [settings.listView])

          // Логика для определения новых записей
          useEffect(() => {
            // Очищаем старые ID новых записей через 3 секунды
            const timer = setTimeout(() => {
              setNewEntryIds(new Set())
            }, 3000)
            return () => clearTimeout(timer)
          }, [newEntryIds])

          // Функции для работы с модальным окном
          const openEditModal = entry => {
            setModalEntry(entry)
            setIsModalOpen(true)
          }

          const openNewEntryModal = () => {
            setModalEntry(null)
            setIsModalOpen(true)
          }

          const closeModal = () => {
            setIsModalOpen(false)
            setModalEntry(null)
          }

          const saveModalEntry = updatedEntry => {
            // Автоматически рассчитываем ставку
            const duration = calculateDuration(updatedEntry.start, updatedEntry.end)
            const calculatedRate = duration > 0 ? Math.round(updatedEntry.earned / duration) : 0

            const entryWithRate = {
              ...updatedEntry,
              rate: calculatedRate,
            }

            if (modalEntry) {
              // Редактирование существующей записи
              updateEntry(entryWithRate.id, entryWithRate)
            } else {
              // Создание новой записи
              const newEntry = {
                ...entryWithRate,
                id: Date.now().toString(),
                date: new Date().toISOString().split('T')[0],
              }
              addEntry(newEntry)
            }
          }
          const [showAnalytics, setShowAnalytics] = useState(false)
          const fileImportRef = useRef(null)

          const exportData = () => {
            const dataToSave = { entries, dailyPlan }
            const blob = new Blob([JSON.stringify(dataToSave, null, 2)], {
              type: 'application/json',
            })
            const url = URL.createObjectURL(blob)
            const a = document.createElement('a')
            a.href = url
            const now = new Date()
            const date = `${String(now.getDate()).padStart(2, '0')}_${String(now.getMonth() + 1).padStart(2, '0')}_${now.getFullYear()}`
            const time = `${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}`
            a.download = `tracker-data_${date}_${time}.json`
            a.click()
            URL.revokeObjectURL(url)
          }

          const addEntry = useCallback(
            newEntry => {
              const entryWithCategory = {
                ...newEntry,
                categoryId: newEntry.categoryId || settings.defaultCategoryId || 'project1',
              }
              pushToUndo(entries, `Добавить запись от ${newEntry.date}`)
              setEntries(prev => [entryWithCategory, ...prev])

              // Добавляем новую запись в newEntryIds для анимации
              setNewEntryIds(prev => new Set([...prev, entryWithCategory.id]))
            },
            [setEntries, entries, pushToUndo, settings.defaultCategoryId, setNewEntryIds]
          )

          // Функция для исправления записей без категорий
          const fixEntriesWithoutCategories = useCallback(
            entries => {
              if (!Array.isArray(entries)) return entries
              return entries.map(entry => {
                if (entry.categoryId) return entry
                return {
                  ...entry,
                  categoryId: settings.defaultCategoryId || 'project1',
                }
              })
            },
            [settings.defaultCategoryId]
          )

          // Проверяем и исправляем записи без категорий при каждом обновлении
          useEffect(() => {
            if (entries.length > 0) {
              const entriesWithoutCategories = entries.filter(entry => !entry.categoryId)
              if (entriesWithoutCategories.length > 0) {
                const fixedEntries = fixEntriesWithoutCategories(entries)
                setEntries(fixedEntries)
                localStorage.setItem('timeTrackerEntries', JSON.stringify(fixedEntries))
              }
            }
          }, [entries, fixEntriesWithoutCategories, setEntries])

          const updateEntry = useCallback(
            (id, updater) => {
              pushToUndo(entries, `Изменить запись`)
              setEntries(prev =>
                prev.map(e =>
                  e.id === id ? (typeof updater === 'function' ? updater(e) : updater) : e
                )
              )
            },
            [setEntries, entries, pushToUndo]
          )

          const deleteEntry = useCallback(
            id => {
              const entryToDelete = entries.find(e => e.id === id)
              pushToUndo(entries, `Удалить запись от ${entryToDelete.date} ${entryToDelete.start}`)
              setEntries(prev => prev.filter(e => e.id !== id))
              showNotification('Запись удалена', 'error', { showUndo: true, onUndo: undo })
            },
            [setEntries, entries, pushToUndo, showNotification, undo]
          )

          const { activeTimer, elapsedTime, handleStartTimer, handleStopTimer } = useTimer(
            entries,
            addEntry,
            updateEntry
          )

          const handleAddNewEntry = useCallback(() => {
            const now = new Date()
            const newId = Date.now()
            const newEntry = {
              id: newId,
              date: now.toISOString().split('T')[0],
              start: '',
              end: '',
              rate: 0,
              earned: 0,
            }
            addEntry(newEntry)
            setEditingEntryId(newId)
          }, [addEntry])

          const stopTimerAndEdit = useCallback(async () => {
            if (!activeTimer) return
            const now = new Date()
            const endTime = now.toTimeString().slice(0, 5)

            // Сначала обновляем запись с временем окончания
            const stoppedEntryId = activeTimer.id
            const currentEntry = entries.find(entry => entry.id === stoppedEntryId)
            if (currentEntry) {
              const hours = calculateDuration(currentEntry.start, endTime)
              const updatedEntry = {
                ...currentEntry,
                end: endTime,
                earned: Math.round(hours * (currentEntry.rate || 0)),
              }

              // Обновляем запись
              updateEntry(stoppedEntryId, updatedEntry)

              // Останавливаем таймер через handleStopTimer
              handleStopTimer()

              // Открываем модальное окно с обновленной записью
              setTimeout(() => {
                openEditModal(updatedEntry)
              }, 50)
            }
          }, [activeTimer, entries, updateEntry, openEditModal, handleStopTimer])

          const clearAllEntries = () => {
            pushToUndo(entries, 'Очистить все записи')
            setEntries([])
            setShowClearConfirmModal(false)
          }

          const handleExport = useCallback(() => {
            exportData()
          }, [])

          const validateImport = data => {
            if (!Array.isArray(data.entries)) throw new Error('entries должен быть массивом')
            for (const e of data.entries) {
              if (typeof e.id !== 'number') throw new Error('id должен быть числом')
              if (!/^\d{4}-\d{2}-\d{2}$/.test(e.date))
                throw new Error('date должен быть в формате YYYY-MM-DD')
              if (e.start && !/^\d{2}:\d{2}$/.test(e.start))
                throw new Error('start должен быть HH:mm или пустым')
              if (e.end && !/^\d{2}:\d{2}$/.test(e.end))
                throw new Error('end должен быть HH:mm или пустым')
              if (typeof e.rate !== 'number' || typeof e.earned !== 'number')
                throw new Error('rate и earned должны быть числами')
            }
          }

          const handleFileImport = event => {
            const file = event.target.files[0]
            if (!file) return
            const reader = new FileReader()
            reader.onload = e => {
              try {
                const data = JSON.parse(e.target.result)

                // --- Strict Validation ---
                if (!data.entries || !Array.isArray(data.entries)) {
                  throw new Error('"entries" должен быть массивом')
                }
                for (const entry of data.entries) {
                  if (typeof entry.id !== 'number')
                    throw new Error(`id должен быть числом: ${entry.id}`)
                  if (!/^\d{4}-\d{2}-\d{2}$/.test(entry.date))
                    throw new Error(`date должен быть в формате YYYY-MM-DD: ${entry.date}`)
                  if (entry.start && !/^\d{1,2}:\d{2}$/.test(entry.start))
                    throw new Error(`start должен быть HH:mm или пустым: ${entry.start}`)
                  if (entry.end && !/^\d{1,2}:\d{2}$/.test(entry.end))
                    throw new Error(`end должен быть HH:mm или пустым: ${entry.end}`)
                  if (typeof entry.rate !== 'number' || typeof entry.earned !== 'number')
                    throw new Error(
                      `rate и earned должны быть числами: ${entry.rate}, ${entry.earned}`
                    )
                }
                // --- End Validation ---

                pushToUndo(entries, 'Импортировать записи')
                setEntries(data.entries)

                if (typeof data.dailyPlan === 'number') setDailyPlan(data.dailyPlan)
                showNotification('Данные успешно импортированы!')
              } catch (err) {
                console.error('Import error:', err.message)
                showNotification(`Ошибка в структуре файла: ${err.message}`, 'error')
                handleCriticalError()
              }
            }
            reader.onerror = () => {
              showNotification('Не удалось прочитать файл.', 'error')
              handleCriticalError()
            }
            reader.readAsText(file)
            event.target.value = null // Reset file input
          }

          const handleCheckBackups = async () => {
            const backups = await backupManager.listBackups()
            if (backups.length === 0) {
              showNotification('Резервные копии не найдены', 'error')
            } else {
              showNotification(`Найдено ${backups.length} резервных копий`, 'success')
            }
          }

          useEffect(() => {
            const tutorialShown = localStorage.getItem('timeTrackerTutorialShown_v1')
            if (!tutorialShown) {
              setShowTutorial(true)
              localStorage.setItem('timeTrackerTutorialShown_v1', 'true')
            }
            const handleKeyDown = e => {
              const isInputFocused =
                document.activeElement.tagName === 'INPUT' ||
                document.activeElement.tagName === 'TEXTAREA' ||
                document.activeElement.tagName === 'SELECT' ||
                document.activeElement.contentEditable === 'true'

              // Дополнительная проверка для модального окна CategoryManager
              const isInModal =
                document.activeElement.closest('.glass-effect') ||
                document.activeElement.closest('[data-category-manager]') ||
                document.querySelector('[data-category-manager]')?.contains(document.activeElement)

              // Отладочная информация
              if (e.code === 'KeyS' || e.code === 'KeyN' || e.code === 'KeyT') {
                console.log(
                  'Key pressed:',
                  e.code,
                  'isInputFocused:',
                  isInputFocused,
                  'isInModal:',
                  isInModal,
                  'activeElement:',
                  document.activeElement
                )
              }
              if (e.ctrlKey && e.code === 'KeyZ') {
                e.preventDefault()
                if (e.shiftKey) {
                  redo()
                } else {
                  undo()
                }
              } else if (e.ctrlKey && e.code === 'KeyY') {
                e.preventDefault()
                redo()
              }
              if (e.code === 'Escape') {
                setEditingEntryId(null)
              }
              if (isInputFocused || isInModal) return
              if (!isInputFocused && !isInModal) {
                if (e.code === 'KeyN' || e.code === 'KeyT') {
                  e.preventDefault()
                  handleAddNewEntry()
                } else if (e.code === 'KeyS' || e.code === 'KeyY') {
                  e.preventDefault()
                  activeTimer ? stopTimerAndEdit() : handleStartTimer()
                }
              }
            }
            // Сохраняем ссылку на глобальный обработчик для возможности временного отключения
            window._globalKeyDownHandler = handleKeyDown
            document.addEventListener('keydown', handleKeyDown)
            return () => document.removeEventListener('keydown', handleKeyDown)
          }, [activeTimer, handleAddNewEntry, stopTimerAndEdit, handleStartTimer, undo, redo])

          return h(
            'div',
            {
              className:
                'min-h-screen bg-gray-100 dark:bg-[#111827] text-gray-800 dark:text-gray-200 p-4 sm:p-6 transition-colors duration-300 test-fade',
            },
            NotificationComponent,
            h(TutorialModal, {
              show: showTutorial,
              onClose: () => {
                setShowTutorial(false)
                // Создаем пустую базу данных, чтобы модальное окно больше не показывалось
                localStorage.setItem('timeTrackerEntries', JSON.stringify([]))
              },
              onImport: () => {
                setShowTutorial(false)
                fileImportRef.current.click()
              },
            }),
            h(AboutModal, { show: showAbout, onClose: () => setShowAbout(false) }),
            h(WorkScheduleModal, {
              show: showWorkScheduleModal,
              onClose: () => setShowWorkScheduleModal(false),
              settings,
              setSettings,
            }),
            h(
              ConfirmModal,
              {
                show: showClearConfirmModal,
                onClose: () => setShowClearConfirmModal(false),
                onConfirm: clearAllEntries,
                title: 'Очистить базу?',
              },
              'Вы уверены, что хотите удалить все записи? Это действие необратимо.'
            ),
            h(EditEntryModal, {
              isOpen: isModalOpen,
              onClose: closeModal,
              entry: modalEntry,
              onSave: saveModalEntry,
              categories: settings.categories,
              allEntries: entries,
            }),
            // Плавающая панель
            h(FloatingPanel, {
              activeTimer,
              elapsedTime,
              onStart: handleStartTimer,
              onStop: stopTimerAndEdit,
              onPause: () => console.log('Pause not implemented yet'),
              settings,
              setSettings,
              entries,
              isVisible: true,
            }),
            h(
              'div',
              { className: 'max-w-7xl mx-auto' },
              h(Header, {
                onShowTutorial: () => setShowTutorial(true),
                onShowAbout: () => setShowAbout(true),
                compareMode,
                setCompareMode,
                entriesSaveStatus,
              }),
              h(StatisticsDashboard, { compareMode }),
              h(PlanFactCompactView, { onShowWorkSchedule: () => setShowWorkScheduleModal(true) }),
              h(InsightsPanel),
              showAnalytics
                ? h(AnalyticsSection)
                : h(
                    'div',
                    {
                      className:
                        'glass-effect rounded-xl shadow-lg p-6 mb-6 border border-gray-200 dark:border-gray-500/20 text-center',
                    },
                    h(
                      'h2',
                      { className: 'text-xl font-bold text-gray-900 dark:text-white mb-4' },
                      'Аналитика'
                    ),
                    h(
                      'p',
                      { className: 'text-gray-500 dark:text-gray-400 mb-4' },
                      'Графики и подробная статистика будут загружены по требованию для ускорения работы приложения.'
                    ),
                    h(
                      'button',
                      {
                        onClick: () => setShowAnalytics(true),
                        className:
                          'glass-button glass-button-blue px-4 py-2 rounded-lg text-sm font-semibold',
                      },
                      'Загрузить раздел аналитики'
                    )
                  ),
              h(EntriesList, {
                editingEntryId,
                setEditingEntryId,
                addEntry,
                updateEntry,
                deleteEntry,
                setEntries,
                onClearAll: () => setShowClearConfirmModal(true),
                onExport: handleExport,
                onImport: () => fileImportRef.current.click(),
                activeTimer,
                openEditModal,
                openNewEntryModal,
                elapsedTime,
                handleStartTimer,
                stopTimerAndEdit,
                newEntryIds,
                setNewEntryIds,
                shouldAnimateEntries,
                handleAddNewEntry,
                onCheckBackups: handleCheckBackups,
              }),
              h('input', {
                type: 'file',
                accept: '.json',
                ref: fileImportRef,
                onChange: handleFileImport,
                style: { display: 'none' },
              }),
              h(
                'footer',
                { className: 'text-center text-sm text-gray-500 dark:text-gray-500 mt-8 pb-4' },
                'Time Tracker Dashboard v0.8.0_beta'
              )
            )
          )
        }

        console.log('Creating App component...')
        const App = () => h(AppProviders, {}, h(MainApp))

        console.log('Getting root container...')
        const container = document.getElementById('root')
        console.log('Creating React root...')
        const root = ReactDOM.createRoot(container)
        console.log('Rendering app...')
        root.render(h(App))
        console.log('App rendered successfully!')
      }
    </script>

    <!-- Водяной знак отключен для отладки
<div id="watermark" style="position: fixed; bottom: 10px; right: 10px; 
                          color: rgba(0,0,0,0.1); font-size: 12px; 
                          pointer-events: none; z-index: 9999;">
    © 2024 Time Tracker Dashboard
</div>
-->
    <!-- Updated: 2024-12-19 15:30:00 -->
  </body>
</html>
